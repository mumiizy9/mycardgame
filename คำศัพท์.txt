‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ

‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå \index.html
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Epic Seven Card Auto Battle</title>
    <link rel="stylesheet" href="css/style.css" />
    <link rel="icon" href="favicon.ico" />
</head>
<body class="dark-bg">

    <!-- NAVBAR -->
    <header>
        <nav class="navbar">
            <div class="logo">EPIC Seven - Card Battle</div>
            <ul class="menu">
                <li><button id="btnTeam">‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏°</button></li>
                <li><button id="btnBattle">‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ</button></li>
                <li><button id="btnInventory">‡∏Ñ‡∏•‡∏±‡∏á‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°</button></li>
                <li><button id="btnQuest">‡πÄ‡∏Ñ‡∏ß‡∏™‡∏ï‡πå</button></li>
                <li><button id="btnShop">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</button></li>
                <li><button id="btnGacha">‡∏Å‡∏≤‡∏ä‡∏≤</button></li>
                <li><button id="btnCharacter">‡∏Ñ‡∏•‡∏±‡∏á‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£</button></li>
                <li><button id="btnAnnouncement">‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</button></li>
                <li><button id="btnChat">‡πÅ‡∏ä‡∏ó</button></li>
            </ul>
            <div class="profile">
                <span id="playerName"></span>
                <button id="btnLogin">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
        </nav>
    </header>

    <!-- POPUP LAYER (‡∏ó‡∏∏‡∏Å feature ‡πÄ‡∏õ‡πá‡∏ô popup ‡πÑ‡∏°‡πà reload ‡∏´‡∏ô‡πâ‡∏≤/‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô) -->
    <div id="popupLayer"></div>

    <!-- MAIN BATTLE FIELD (‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡∏°/‡∏°‡∏≠‡∏ô‡πÄ‡∏ï‡∏≠‡∏£‡πå/auto battle) -->
    <main id="mainBattlefield" class="hide">
        <section class="battlefield">
            <!-- PLAYER TEAM (4 ‡πÉ‡∏ö) -->
            <div class="card-row user">
                <!-- card generation by JS -->
            </div>
            <!-- MONSTER TEAM (4 ‡πÉ‡∏ö) -->
            <div class="card-row monster">
                <!-- card generation by JS -->
            </div>
            <!-- SPD BARS -->
            <div class="spd-bar-container">
                <!-- generated by JS -->
            </div>
        </section>
        <section class="battle-controls">
            <button id="btnStartAuto" class="primary-btn">Auto Battle</button>
            <button id="btnBack" class="secondary-btn">‡∏Å‡∏•‡∏±‡∏ö</button>
        </section>
    </main>

    <!-- FOOTER -->
    <footer>
        <small style="color: #aaa;">&copy; 2024 - Epic Seven Fan Project Demo Frontend</small>
    </footer>

    <!-- JS -->
    <script src="js/utils.js"></script>
    <script src="js/reward.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/team.js"></script>
    <script src="js/battle.js"></script>
    <script src="js/ai.js"></script>
    <script src="js/animationEngine.js"></script>
    <script src="js/effect.js"></script>
    <script src="js/result.js"></script>
    <script src="js/popupManager.js"></script>
    <script src="js/inventory.js"></script>
    <script src="js/upgrade.js"></script>
    <script src="js/rune.js"></script>
    <script src="js/gacha.js"></script>
    <script src="js/quest.js"></script>
    <script src="js/stage.js"></script>
    <script src="js/shop.js"></script>
    <script src="js/announcement.js"></script>
    <script src="js/redeem.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/characterCollection.js"></script>
    <script src="js/passive.js"></script>
    <script src="js/chat.js"></script>
    <script src="js/gachaLog.js"></script>
    <script src="js/energy.js"></script>
    <script src="js/localization.js"></script>
</body>
</html>

‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå js\ui.js
// js/ui.js
document.addEventListener('DOMContentLoaded', () => {
    // Menu button event mapping: [btnId, popupId or function]
    const menuActions = {
        btnTeam: () => openPopup('team'),
        btnBattle: () => openPopup('Battle'),
        btnInventory: () => openPopup('inventory'),
        btnQuest: () => openPopup('quest'),
        btnShop: () => openPopup('shop'),
        btnGacha: () => openPopup('gacha'),
        btnCharacter: () => openPopup('characterCollection'),
        btnAnnouncement: () => openPopup('announcement'),
        btnChat: () => openPopup('chat'),
        btnLogin: () => openPopup('login'),
    };

    Object.entries(menuActions).forEach(([btnId, action]) => {
        const btn = document.getElementById(btnId);
        if (btn) btn.addEventListener('click', action);
    });

    // Popup Layer logic
    window.openPopup = function(type, data = {}) {
        const popupLayer = document.getElementById('popupLayer');
        popupLayer.innerHTML = renderPopup(type, data);
        popupLayer.classList.add('active');
    };

    // Close popup
    window.closePopup = function() {
        const popupLayer = document.getElementById('popupLayer');
        popupLayer.innerHTML = '';
        popupLayer.classList.remove('active');
    };

    // Render central popup UI (type: string, data: Object)
    function renderPopup(type, data) {
        // Popup templates for each feature
        const templates = {
            team: `<div class="popup"><button class="close" onclick="closePopup()">√ó</button>
                <h2>‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏°</h2><div id="teamEditArea"></div></div>`,
            inventory: `<div class="popup"><button class="close" onclick="closePopup()">√ó</button>
                <h2>‡∏Ñ‡∏•‡∏±‡∏á‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°</h2><div id="inventoryArea"></div></div>`,
            quest: `<div class="popup"><button class="close" onclick="closePopup()">√ó</button>
                <h2>‡πÄ‡∏Ñ‡∏ß‡∏™‡∏ï‡πå</h2><div id="questArea"></div></div>`,
            shop: `<div class="popup"><button class="close" onclick="closePopup()">√ó</button>
                <h2>‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</h2><div id="shopArea"></div></div>`,
            gacha: `<div class="popup"><button class="close" onclick="closePopup()">√ó</button>
                <h2>‡∏Å‡∏≤‡∏ä‡∏≤</h2><div id="gachaArea"></div></div>`,
            characterCollection: `<div class="popup"><button class="close" onclick="closePopup()">√ó</button>
                <h2>‡∏Ñ‡∏•‡∏±‡∏á‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£</h2><div id="characterArea"></div></div>`,
            announcement: `<div class="popup large"><button class="close" onclick="closePopup()">√ó</button>
                <h2>‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</h2><div id="announcementArea"></div></div>`,
            chat: `<div class="popup tall"><button class="close" onclick="closePopup()">√ó</button>
                <h2>‡πÅ‡∏ä‡∏ó</h2><div id="chatArea"></div></div>`,
            login: `<div class="popup small"><button class="close" onclick="closePopup()">√ó</button>
                <h2>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
                <input id="userId" placeholder="User ID" /><input id="userPass" type="password" placeholder="Password" />
                <button id="doLoginBtn">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                <div id="loginHint"></div>
                </div>`,
        };
        if (!templates[type]) return '<div class="popup"><button class="close" onclick="closePopup()">√ó</button><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö</p></div>';
        return templates[type];
    }

    // Escape popup with ESC key
    document.addEventListener('keyup', (ev) => {
        if (ev.key === 'Escape') closePopup();
    });

    // Hide battlefield when clicking "Back"
    const btnBack = document.getElementById('btnBack');
    if (btnBack) btnBack.addEventListener('click', () => {
        document.getElementById('mainBattlefield').classList.add('hide');
    });

    // Responsive popup layer CSS logic (for .active popup display)
    // (Style in css/style.css, eg. for .popup, .popup.large, .popup.tall, etc.)

    // Helper: show player name if logged in
    window.setPlayerName = function(name) {
        document.getElementById('playerName').textContent = name || '';
    };

    // Helper: trigger noti dot (menu) if new message (ex. quest, announcement)
    window.setMenuNoti = function(btnId, show) {
        const btn = document.getElementById(btnId);
        if (btn) {
            if (show) btn.classList.add('noti');
            else btn.classList.remove('noti');
        }
    };

    // Helper: clear all popup
    window.clearAllPopup = closePopup;
});

‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå css\style.css
/* Main color theme */
:root {
  --dark-bg: #191c21;
  --panel-bg: #23242a;
  --pop-bg: #1d2230;
  --accent: #3fa8ff;
  --accent2: #ff6565;
  --secondary: #e6f1ff;
  --border: #33364a;
  --card-bg: #25293c;
  --font-main: 'Prompt', 'Sarabun', Arial, sans-serif;
}

body,
html {
  margin: 0;
  padding: 0;
  background: var(--dark-bg);
  color: var(--secondary);
  font-family: var(--font-main);
  font-size: 17px;
  transition: background 0.2s;
  height: 100%;
  min-height: 100vh;
}
.dark-bg {
  background: var(--dark-bg)!important;
}

header, nav {
  width: 100vw;
  background: var(--panel-bg);
  position: sticky; top: 0;
  z-index: 40;
}

.navbar {
  display: flex; justify-content: space-between;
  align-items: center; padding: 0.3em 3vw;
}
.logo {
  font-weight: bold;
  font-size: 1.2em;
  letter-spacing: 1px;
  color: var(--accent);
}
.menu {
  list-style: none; display: flex; align-items: center; gap: .6em;
  margin: 0; padding: 0;
}
.menu li button {
  background: transparent; border: none; color: var(--secondary);
  font-size: 1em; padding: .45em 1em;
  border-radius: 30px; cursor: pointer;
  transition: background .14s;
  position: relative;
}
.menu li button.noti::after {
  content: "";
  background: var(--accent2);
  width: 10px; height: 10px;
  border-radius:100%; position: absolute;
  top: .3em; right: .7em;
  box-shadow: 0 0 6px 3px #ffabab77;
}

.menu li button:hover,
.menu li button:focus {
  background: #2c2e39;
  color: var(--accent);
}
.profile { display: flex; align-items: center; gap: 1em; }
#playerName { font-weight: 600; }
.hide { display: none!important; }


/* ========== MAIN BATTLEFIELD ========== */
main#mainBattlefield {
  max-width: 1180px;
  margin: 1.3em auto 0 auto;
  background: var(--panel-bg);
  border-radius: 15px;
  box-shadow: 0 2px 50px #0004;
  padding: 1.2em .5em 1.5em .5em;
  min-height: 430px;
  display: block;
  transition: all .18s;
}
.battlefield {
  position: relative;
  width: 100%;
  min-height: 320px;
  background: linear-gradient(0deg, #202639 80%, #1a222e 100%);
  border-radius: 16px;
  margin: 0 auto 10px auto; 
  box-shadow: 0 0 35px 10px #04071c30 inset;
  overflow: hidden;
  padding: 1em 0;
}
.card-row {
  display: flex;
  justify-content: space-evenly;
  align-items: flex-end;
  margin: 0.4em auto;
  gap: 13px;
  min-height: 130px;
  z-index: 2;
  position: relative;
}

/* User's team on top, monsters below */
.card-row.user { margin-bottom: 46px; }
.card-row.monster { margin-bottom: 18px; }

.spd-bar-container {
  position: absolute; width: 100%;
  left: 0; top: 48%;
  transform: translateY(-50%);
  display: flex; justify-content: center;
  gap: 24px; pointer-events: none;
  z-index: 3;
}
.spd-bar {
  width: 90px; height: 8px;
  background: #303742;
  border-radius: 6px;
  margin-bottom: 3px;
  overflow: hidden;
  box-shadow: 0 2px 8px #0006 inset;
}
.spd-bar-fill {
  background: linear-gradient(90deg, var(--accent), #9be7ff 70%);
  height: 100%; border-radius: 6px;
  transition: width 0.23s;
}

.battle-controls {
  display: flex; justify-content: center;
  gap: 30px; padding: 1.2em 0;
}
.primary-btn, .secondary-btn {
  background: var(--accent);
  border: none;
  color: #fff;
  font-size: 1.04em;
  font-weight: bold;
  padding: .65em 2.2em;
  border-radius: 35px;
  cursor: pointer;
  letter-spacing: .05em;
  box-shadow: 0 2px 8px #41a5f68e;
  margin-bottom: .4em;
  transition: all .14s;
}
.primary-btn:hover { background: #135488;}
.secondary-btn {
  background: #373958; color: #ccd9ef; box-shadow: none;
}
.secondary-btn:hover { background: #29304b; color: #fff; }

/* CARD STYLE - for hero & monster */
.card {
  background: var(--card-bg);
  border-radius: 15px;
  box-shadow: 0 0 8px 1px #23294a78, 0 1px 0 #3fa8ff2a;
  width: 116px; min-height: 136px;
  position: relative;
  display: flex; flex-direction: column;
  align-items: center; justify-content: flex-end;
  transition: transform .16s;
  overflow: visible;
  border: 2px solid #1d2238;
}
.card .hero-img, .card .mon-img {
  width: 75px; height: 75px;
  border-radius: 50%;
  margin-top: 17px;
  background: #13131c;
  object-fit: cover; object-position: center;
  outline: 3px solid var(--accent);
  box-shadow: 0 0 12px #3fa8ff33;
}
.card .statbar {
  width: 85%; height: 8px;
  border-radius: 5px;
  margin: 5px auto 5px auto;
  background: #171c2d;
  box-shadow: 0 1px 8px #0006 inset;
  overflow: hidden;
}
.card .hp-fill {
  background: linear-gradient(90deg, #55dcab, #4e93f1 80%);
  height: 100%; border-radius: 3px;
  transition: width 0.27s;
}
.card .name {
  font-size: .98em; font-weight: bold; margin-top: 7px;
  text-shadow: 0 2px 9px #0008;
  color: #fff;
  letter-spacing: .03em;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 95px;
  text-align: center;
}
.card .damage-popup {
  position: absolute;
  left: 60%; top: 23%;
  font-size: 1.15em;
  color: var(--accent2);
  font-weight: bold;
  transform: translate(-50%, -60%) scale(1.05);
  opacity: 0;
  pointer-events: none;
  animation: damageJump .7s cubic-bezier(.5,-1, .2, 1.8) 1;
}

@keyframes damageJump {
  0%   { opacity: 0; transform: translate(-50%, -80%) scale(0.7);}
  21%  { opacity: 1; transform: translate(-50%, -120%) scale(1.2);}
  69%  { opacity: 1; transform: translate(-50%, -115%) scale(1.0);}
  100% { opacity: 0; transform: translate(-50%,-70%) scale(.60);}
}

/* Buff & debuff icon overlay on card */
.card .stat-icons {
  display: flex; flex-wrap: wrap;
  gap: 1px; margin-bottom: 4px; justify-content: center;
}
.card .stat-icon {
  width: 18px; height: 18px; border-radius: 50%;
  background: #232c48; border: 2px solid #6ad2ff77;
  display: flex; align-items: center; justify-content: center;
  font-size: 1em; margin-left: 1px;
  box-shadow: 0 0 5px #0088ffc9;
  position: relative;
  cursor: pointer;
}
.card .stat-icon.buff { border-color: #15ef92; }
.card .stat-icon.debuff { border-color: #eb5454; }

/* Tooltip */
.tooltip {
  position: absolute;
  left: 50%; bottom: 120%; z-index: 24;
  background: #22253c;
  color: #daf5ff;
  padding: 4px 12px;
  border-radius: 8px;
  font-size: .90em; min-width: 87px; max-width: 200px;
  box-shadow: 0 8px 25px #0079ff41;
  pointer-events: none; opacity: 0; transition: all .12s;
}
.stat-icon:hover .tooltip { opacity: 1; }

/* ========== POPUPS ========== */
#popupLayer {
  position: fixed;
  top:0; left:0; z-index: 99;
  width:100vw; height:100vh;
  display:flex; align-items:center; justify-content:center;
  background: #050925d8;
  pointer-events: none;
  opacity: 0;
  transition: opacity .18s;
}
#popupLayer.active {
  pointer-events: all; opacity: 1;
}
.popup {
  background: var(--pop-bg);
  border-radius: 18px;
  padding: 2em 1.5em 1.5em 1.5em;
  box-shadow: 0 0 80px #3138aa51, 0 1px 13px #49d9ff1b;
  min-width: 340px;
  min-height: 120px;
  max-width: 99vw;
  max-height: 90vh;
  overflow-y: auto;
  color: #fff;
  position: relative;
  animation: popupOpen .25s cubic-bezier(.7,0, .09,1.55);
}
@keyframes popupOpen {
 0% { transform: scale(.82) translateY(50px) rotate(-7deg);}
 100%{ transform: scale(1) translateY(0);}
}
.popup.large { min-width: 700px; max-width: 99vw; min-height: 340px;}
.popup.tall { min-height: 390px; max-width: 550px;}
.popup.small { min-width: 260px;max-width:327px;}

.popup .close {
  position:absolute;
  top:10px; right: 10px;
  background: #293e69;
  color: #dff6fc;
  border:none; font-size:1.45em;
  width:30px; height:30px;
  border-radius:100%; cursor:pointer;
  opacity: .85;
  z-index: 5;
  transition: background .15s;
}
.popup .close:hover { background: var(--accent2); color: #fff; }

/* Pop-up area blocks (for slot areas) */
#teamEditArea, #questArea, #gachaArea, #characterArea, #announcementArea,
#chatArea, #shopArea, #inventoryArea { margin: 16px 0 0 0;}

/* Input Buttons/Fields */
input, select, textarea {
  background: #1e2532;
  border: 2px solid #314a6a;
  color: #eee;
  padding: 9px 14px;
  border-radius: 9px;
  font-size: 1em; outline: none;
  margin: 5px 0;
  box-shadow: 0 2px 8px #0067ad20;
  transition: border .13s;
}
input:focus { border:2px solid var(--accent);}
input[type="password"] { letter-spacing: .2em; }

button:focus { outline: 2px solid var(--accent);}
button:active { filter: brightness(.93);}
::-webkit-scrollbar { width: 9px; background: #233;}
::-webkit-scrollbar-thumb { background: #303860; border-radius: 7px; box-shadow: 0 2px 12px #152a;}

/* Footer */
footer {
  margin: 0;
  background: #141520;
  color: #c9d1e6bb;
  text-align: center;
  font-size: .96em;
  padding: 16px 0 11px 0;
}

/* ========== RESPONSIVE DESIGN ========== */
@media (max-width: 750px) {
  .battlefield { min-height: 240px; }
  .card { width: 81px; min-height: 82px; }
  .card .hero-img, .card .mon-img { width: 52px; height: 52px;}
  .popup.large { min-width: 97vw;}
  .popup.tall { min-width: 97vw;}
  main#mainBattlefield { padding: .51em 0; border-radius: 6px;}
  .navbar { flex-direction:column; gap:.5em;}
  .menu { flex-wrap: wrap; gap: .19em 1em; margin-bottom:.3em;}
}

@media (max-width: 540px) {
  .card { width: 66px; }
  .popup { padding:1em .65em .8em .65em; }
}

‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå data/char/astra.json
{
  "id": "astra",
  "type": "hero",
  "name": "Astra",
  "element": "water",
  "class": "knight",
  "rarity": 5,
  "star": 5,
  "level": 1,
  "level_max": 50,
  "exp": 0,
  "exp_max": 600,
  "hp": 1064,
  "atk": 116,
  "def": 273,
  "spd": 100,
  "crit_rate": 15,
  "crit_dmg": 150,
  "effectiveness": 0,
  "resistance": 20,
  "skills": [
    {
      "id": "astra_s1",
      "name": "Sword Slash",
      "type": "attack",
      "desc": "‡πÇ‡∏à‡∏°‡∏ï‡∏µ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ 1 ‡∏ï‡∏±‡∏ß ‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏ï‡∏¥‡∏î [def break] 1 ‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô",
      "multiplier": 1.02,
      "effect": {
        "debuff": [
          { "type": "def_break", "turn": 1, "chance": 35 }
        ]
      },
      "cooldown": 0
    },
    {
      "id": "astra_s2",
      "name": "Guardian Blessing",
      "type": "buff",
      "desc": "‡πÄ‡∏û‡∏¥‡πà‡∏° DEF‡πÉ‡∏´‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏ó‡∏µ‡∏° 2 ‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô",
      "multiplier": 0,
      "effect": {
        "buff": [
          { "type": "def_up", "turn": 2 }
        ]
      },
      "cooldown": 3
    },
    {
      "id": "astra_s3",
      "name": "Aegis Pierce",
      "type": "attack",
      "desc": "‡πÇ‡∏à‡∏°‡∏ï‡∏µ‡∏´‡∏°‡∏π‡πà ‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏ï‡∏¥‡∏î stunned 1 ‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô",
      "multiplier": 1.7,
      "effect": {
        "debuff": [
          { "type": "stun", "turn": 1, "chance": 50 }
        ]
      },
      "cooldown": 5
    }
  ],
  "passive": "astra_passive",
  "img": "astra.png"
}

‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå data/char/slime_basic.json
{
  "id": "slime_basic",
  "type": "monster",
  "name": "Slime (Basic)",
  "element": "earth",
  "class": "monster",
  "rarity": 1,
  "level": 1,
  "level_max": 20,
  "exp": 0,
  "exp_max": 100,
  "hp": 240,
  "atk": 48,
  "def": 24,
  "spd": 70,
  "crit_rate": 0,
  "crit_dmg": 120,
  "effectiveness": 0,
  "resistance": 0,
  "skills": [
    {
      "id": "slime_s1",
      "name": "Bodyslam",
      "type": "attack",
      "desc": "‡πÇ‡∏à‡∏°‡∏ï‡∏µ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏î‡∏µ‡∏¢‡∏ß",
      "multiplier": 1.1,
      "effect": {},
      "cooldown": 0
    }
  ],
  "img": "slime_basic.png"
}

‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå team.html
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Epic Seven - ‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏°</title>
    <link rel="stylesheet" href="css/style.css" />
</head>
<body class="dark-bg">

<header>
    <nav class="navbar">
        <div class="logo">EPIC Seven - Card Battle</div>
        <ul class="menu">
            <li><button onclick="window.location.href='index.html'">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button></li>
            <li><button onclick="window.location.href='team.html'" class="noti">‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏°</button></li>
            <li><button id="btnBack">‡∏Å‡∏•‡∏±‡∏ö</button></li>
        </ul>
        <div class="profile">
            <span id="playerName"></span>
            <button id="btnLogin">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </nav>
</header>

<main id="mainTeamSetup" style="max-width: 1000px; margin:20px auto;background:var(--panel-bg);border-radius:12px;box-shadow:0 1px 20px #0006;padding:26px 8px;">
    <h2 style="margin-bottom:0.8em;">‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ</h2>
    <div class="team-section">
        <h3>‡∏ó‡∏µ‡∏°‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 4 ‡∏ï‡∏±‡∏ß)</h3>
        <div id="teamSlotBar" class="card-row user"></div>
        <button class="primary-btn" id="btnSaveTeam" style="margin-top:18px;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏µ‡∏°</button>
    </div>
    <hr style="margin: 32px 0 18px 0; border:1px solid var(--border);">
    <h4>‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ (‡∏•‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏ö‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏°)</h4>
    <div id="charCollection" class="card-row" style="flex-wrap:wrap; gap:15px 8px; justify-content:flex-start;"></div>
</main>

<div id="popupLayer"></div>

<footer>
    <small style="color: #aaa;">&copy; 2024 - Epic Seven Fan Project Demo Frontend</small>
</footer>

<script src="js/utils.js"></script>
<script src="js/ui.js"></script>
<script src="js/team.js"></script>
</body>
</html>

‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå js/team.js
// js/team.js

const maxTeam = 4;

let allChars = [];   // ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏°‡∏µ
let team = [];       // id ‡∏ï‡∏±‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å

/**
 * ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå (mock: as static, ‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡∏î‡∏±‡∏Å‡∏ä‡∏±‡∏ô fetch ‡∏à‡∏£‡∏¥‡∏á)
 */
async function loadCharacters() {
    // ‡∏™‡∏°‡∏°‡∏ï‡∏¥ user ‡∏°‡∏µ asra ‡∏Å‡∏±‡∏ö slime_basic (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á)
    let charIds = ['astra', 'slime_basic'];
    let res = await Promise.all(
        charIds.map(id => fetch(`data/char/${id}.json`).then(r => r.json()))
    );
    allChars = res;
}

/**
 * ‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏µ‡∏°‡∏à‡∏≤‡∏Å LocalStorage
 */
function loadTeam() {
    let t = localStorage.getItem('userTeam');
    if (!t) team = [];
    else team = JSON.parse(t);
}

/**
 * ‡πÄ‡∏ã‡∏ü‡∏ó‡∏µ‡∏°‡∏•‡∏á LocalStorage
 */
function saveTeam() {
    const cleanTeam = team.filter(id => !!id); // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏Å‡∏£‡∏≠‡∏á id ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    localStorage.setItem('userTeam', JSON.stringify(cleanTeam)); // ‡πÉ‡∏ä‡πâ cleanTeam
    alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏µ‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
}

/**
 * render UI slot ‡∏ó‡∏µ‡∏° (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 4)
 */
function renderTeamBar() {
    const el = document.getElementById('teamSlotBar');
    if (!el) return; // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ element ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠
    el.innerHTML = '';
    for (let i = 0; i < maxTeam; i++) {
        let char = allChars.find(c=>c.id===team[i]);
        let slot = document.createElement('div');
        slot.className = 'card';
        slot.style.minHeight = "140px";
        slot.dataset.idx = i;
        if (char) {
            slot.innerHTML = `
                <img src="img/char/${char.img}" class="hero-img" alt="${char.name}">
                <div class="name">${char.name}</div>
                <button class="primary-btn" style="margin:7px 0 4px 0;font-size:.93em;" onclick="removeFromTeam(${i})">‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å</button>
            `;
        } else {
            slot.innerHTML = `<div style="opacity:.44;margin-top:30px;text-align:center;">‡∏ß‡πà‡∏≤‡∏á</div>`;
            slot.style.background = '#262a39b2';
        }
        el.appendChild(slot);
    }
}

/**
 * render ‡∏Ñ‡∏•‡∏±‡∏á‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å allChars ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
 */
function renderCharCollection() {
    const el = document.getElementById('charCollection');
    if (!el) return; // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ element ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠
    el.innerHTML = '';
    allChars.forEach(c => {
        // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÉ‡∏ô‡∏ó‡∏µ‡∏°‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏•‡∏≤‡∏Å‡∏ã‡πâ‡∏≥
        let inTeam = team.includes(c.id);
        let div = document.createElement('div');
        div.className = 'card';
        div.draggable = !inTeam;
        div.style.opacity = inTeam ? '.34' : '1.0';
        div.style.cursor = inTeam ? "not-allowed" : "grab";
        div.innerHTML = `
            <img src="img/char/${c.img}" class="hero-img" alt="${c.name}" >
            <div class="name">${c.name}</div>
            <div style="font-size:.92em;margin-bottom:3px;">Lv.${c.level} &nbsp; <small class="stat-bar">${c.hp} HP</small></div>
        `;
        // Popover info
        div.addEventListener('click', e=>{
            openCharInfoPopup(c);
        });
        // Drag: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏™‡πà‡∏ó‡∏µ‡∏°
        div.addEventListener('dragstart', ev=>{
            ev.dataTransfer.setData("text/plain", c.id);
        });
        el.appendChild(div);
    });
    // ‡∏ó‡∏µ‡∏°‡∏£‡∏±‡∏ö event drop
    const teamSlots = document.querySelectorAll('#teamSlotBar .card');
    teamSlots.forEach(slot=>{
        slot.ondragover = e=>{e.preventDefault(); slot.style.borderColor='#49cfffa8';}
        slot.ondragleave = e=>{slot.style.borderColor='';}
        slot.ondrop = function(e){
            e.preventDefault();
            let dragId = e.dataTransfer.getData("text/plain");
            let idx = Number(slot.dataset.idx);
            // ‡∏Å‡∏£‡∏≠‡∏á‡∏ã‡πâ‡∏≥
            if (team.includes(dragId)) return;
            team[idx] = dragId;
            saveTeam();
            renderTeamBar();
            renderCharCollection();
        }
    });
}

/**
 * Remove ‡∏ï‡∏±‡∏ß‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡∏°
 */
window.removeFromTeam = function(idx){
    team[idx] = undefined;
    renderTeamBar(); renderCharCollection();
}

/**
 * Pop-up info ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£
 */
function openCharInfoPopup(char){
    closePopup();
    window.openPopup('charInfo', {char});
}

/**
 * ‡πÄ‡∏û‡∏¥‡πà‡∏° template popup ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£
 */
(function(){
    const origRenderPopup = window.renderPopup;
    window.renderPopup = function(type, data){
        if(type=="charInfo" && data && data.char){
            const c = data.char;
            return `<div class="popup" style="min-width:285px;">
                <button class="close" onclick="closePopup()">√ó</button>
                <img src="img/char/${c.img}" class="hero-img" style="margin:auto;display:block;" />
                <div class="name" style="text-align:center;">${c.name}</div>
                <div style="margin-top:8px;font-size:.97em;color:#87cdff;">Lv.${c.level} ‚òÖ${c.star} <span> (${c.class})</span></div>
                <hr style="margin:8px 0 8px 0;border-color:#234;">
                <div><b>HP</b> ${c.hp} &nbsp; <b>ATK</b> ${c.atk} &nbsp; <b>DEF</b> ${c.def}</div>
                <div><b>SPD</b> ${c.spd} &nbsp; <b>CRIT%:</b> ${c.crit_rate}</div>
                <div><b>Skills</b>:</div>
                <ul>${c.skills.map(s=> `<li><b>${s.name}</b>: ${s.desc}</li>`).join('')}</ul>
            </div>`;
        }
        return origRenderPopup(type, data);
    }
})();

/**
 * ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
 */
document.addEventListener('DOMContentLoaded', ()=>{
    const btnSaveTeam = document.getElementById('btnSaveTeam');
    if (btnSaveTeam) btnSaveTeam.onclick = saveTeam; // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ element ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠
});

/**
 * ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
 */
const btnBack = document.getElementById('btnBack');
if (btnBack) btnBack.onclick = ()=>{ window.location.href = 'index.html'; } // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ element ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠

/**
 * INITIALIZE
 */
(async()=>{
    await loadCharacters();
    loadTeam();
    renderTeamBar();
    renderCharCollection();
})();

‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå js/battle.js
/**
 * js/battle.js
 * Epic Seven Card Auto Battle Main Engine (Frontend 100%)
 * Full Modular, Responsive, AI, Animation, CD, Buff/Debuff, WIN/LOSE Result
 * By (yourname)
 */

/* ------------------ Config & State ------------------ */
const SPD_BAR_MAX = 100;    // SPD bar ‡πÄ‡∏ï‡πá‡∏°
const SPD_FRAME = 120;      // ms ‡∏ï‡πà‡∏≠ tick
const MAX_TEAM = 4, MAX_MON = 4;

let heroes = [];      // ‡∏ù‡∏±‡πà‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô (heroes: [{...}])
let monsters = [];    // ‡∏ù‡∏±‡πà‡∏á‡∏®‡∏±‡∏ï‡∏£‡∏π (monsters: [{...}])
let speedBars = [];   // SPD bar + Buff/Debuff refs
let autoOn = false;
let isBattling = false;

/* ------------------ 1. LOAD TEAM & ENEMY ------------------ */
async function loadBattleTeams() {
    // Load User Team
    let t = localStorage.getItem('userTeam');
    let myTeam = t ? JSON.parse(t) : [];
    heroes = [];
    for (let id of myTeam) {
        if (!id) continue;
        let c = await fetch(`data/char/${id}.json`).then(r => r.json());
        heroes.push({
            ...deepCopy(c),
            currHp: c.hp,
            alive: true,
            buffs: [],
            debuffs: [],
            cooldowns: Array((c.skills || []).length).fill(0)
        });
    }
    // Load Monsters (Mock: slime_basic N ‡∏ï‡∏±‡∏ß)
    monsters = [];
    for (let i = 0; i < MAX_MON; i++) {
        let c = await fetch(`data/char/slime_basic.json`).then(r => r.json());
        monsters.push({
            ...deepCopy(c),
            id: c.id + '_' + (i+1),
            currHp: c.hp,
            alive: true,
            buffs: [],
            debuffs: [],
            cooldowns: Array((c.skills || []).length).fill(0)
        });
    }
}

/* ------------------ 2. SPD BAR INIT ------------------ */
function initSpdBar() {
    speedBars = [];
    heroes.forEach((c, i) => {
        speedBars.push(makeSpeedObj(c, i, 'hero'));
        c.index = i; c.side = 'hero'; // Weak ref.
    });
    monsters.forEach((c, i) => {
        speedBars.push(makeSpeedObj(c, i, 'mon'));
        c.index = i; c.side = 'mon';
    });
}
function makeSpeedObj(c, i, side) {
    return {
        id: `${side}${i}`,
        side,
        name: c.name,
        spd: c.spd,
        charge: 0,
        dead: false,
        index: i,
        cooldowns: c.cooldowns,
        buffs: c.buffs,
        debuffs: c.debuffs
    };
}

/* ------------------ 3. RENDER FIELD ------------------ */
function renderBattlefield() {
    const heroRow = document.querySelector('.card-row.user');
    heroRow.innerHTML = '';
    heroes.forEach((c, idx) => {
        heroRow.appendChild(renderCard(c, idx, 'hero'));
    });
    const monRow = document.querySelector('.card-row.monster');
    monRow.innerHTML = '';
    monsters.forEach((c, idx) => {
        monRow.appendChild(renderCard(c, idx, 'mon'));
    });
    // SPD Bars
    const spdDiv = document.querySelector('.spd-bar-container');
    spdDiv.innerHTML = '';
    speedBars.forEach(bar => {
        let barWrap = document.createElement('div');
        barWrap.className = 'spd-bar';
        barWrap.title = `[${bar.side === 'hero' ? '‡∏ó‡∏µ‡∏°‡πÄ‡∏£‡∏≤':'‡∏®‡∏±‡∏ï‡∏£‡∏π'}] ${bar.name} SPD:${bar.spd}`;
        let fill = document.createElement('div');
        fill.className = 'spd-bar-fill';
        fill.style.width = Math.floor(Math.min(bar.charge, SPD_BAR_MAX)/SPD_BAR_MAX*100) + '%';
        barWrap.appendChild(fill);
        spdDiv.appendChild(barWrap);
    });
}

/* ------------------ CARD DISPLAY utils ------------------ */
function renderCard(c, idx, side='hero') {
    let d = document.createElement('div');
    d.className = 'card'; d.id = `${side}${idx}`;
    d.setAttribute('data-idx', idx);
    d.setAttribute('data-side', side);

    // Image
    let img = document.createElement('img');
    img.className = side == 'hero' ? 'hero-img' : 'mon-img';
    img.src = `img/char/${c.img}`;
    img.alt = c.name;
    d.appendChild(img);
    // Name
    d.appendChild(createDiv('name', c.name));

    // HP BAR
    let statbar = document.createElement('div');
    statbar.className = 'statbar';
    let hpfill = document.createElement('div');
    hpfill.className = 'hp-fill';
    let hppercent = Math.max(0, Math.min(1, c.currHp/c.hp));
    hpfill.style.width = (hppercent*100) + '%';
    statbar.appendChild(hpfill);
    d.appendChild(statbar);

    // Buff/Debuff
    let statIcons = document.createElement('div');
    statIcons.className = 'stat-icons';
    (c.buffs||[]).forEach(b => statIcons.appendChild(renderStatusIcon(b, 'buff')));
    (c.debuffs||[]).forEach(dbb => statIcons.appendChild(renderStatusIcon(dbb, 'debuff')));
    d.appendChild(statIcons);

    d.appendChild(createDiv('', `HP ${Math.floor(c.currHp)}/${c.hp} SPD:${c.spd}`, {fontSize: ".82em"}));
    return d;
}

function createDiv(cn, txt, styleObj) {
    let d = document.createElement("div");
    if (cn) d.className = cn; d.innerText = txt;
    if (styleObj) Object.assign(d.style, styleObj);
    return d;
}

function renderStatusIcon(stat, type='buff') {
    let e = document.createElement('div');
    e.className = 'stat-icon '+type;
    e.innerHTML = getIcon(stat.type) ;
    e.title = stat.type.toUpperCase() + (stat.turn?" ("+stat.turn+"T)":"");
    let tt = document.createElement('span');
    tt.className = 'tooltip';
    tt.innerText = statusTooltip(stat.type, type, stat);
    e.appendChild(tt);
    if (stat.turn && stat.turn>0) {
        let lbl = document.createElement('small');
        Object.assign(lbl.style,{
            position:'absolute', fontSize:'.79em', fontWeight:'bold',
            right:'2px', bottom:'1px', color: type==='buff'?'#42fcc1':'#ffc3a3'
        });
        lbl.innerText = stat.turn; e.appendChild(lbl);
    }
    return e;
}
function statusTooltip(type, side, details) {
    const lib = {
        'def_break':'DEF ‡∏•‡∏î‡∏•‡∏á ‡∏£‡∏±‡∏ö‡∏î‡∏≤‡πÄ‡∏°‡∏à‡πÄ‡∏û‡∏¥‡πà‡∏°','def_up':'DEF ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô',
        'stun':'‡∏ï‡∏¥‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏°‡∏∂‡∏ô, ‡∏Ç‡πâ‡∏≤‡∏°‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô','poison':'‡πÇ‡∏î‡∏ô‡∏û‡∏¥‡∏© (‡∏•‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î)',
        'burn':'‡πÄ‡∏ú‡∏≤‡πÑ‡∏ü (‡∏•‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏´‡∏ô‡∏±‡∏Å)','heal_ot':'‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á',
        'spd_up':'SPD ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô','spd_down':'SPD ‡∏•‡∏î‡∏•‡∏á',
        'immune':'‡∏Å‡∏±‡∏ô‡∏î‡∏µ‡∏ö‡∏±‡∏ü','silence':'‡πÉ‡∏ö‡πâ (‡πÉ‡∏ä‡πâ‡∏™‡∏Å‡∏¥‡∏•‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)',
    };
    return (lib[type]||type)+((details.turn)?" ("+details.turn+" turn)":"");
}
function getIcon(type) {
    switch(type){
        case "def_break":return "üõ†Ô∏è"; case "def_up":return "üõ°Ô∏è";
        case "stun":return "üí´"; case "heal_ot":return "üíö";
        case "poison":return "‚ò†Ô∏è"; case "burn":return "üî•";
        case "spd_up":return "üí®"; case "spd_down":return "üê¢";
        case "immune":return "üîí"; case "silence":return "üîá";
        default:return "‚ú®";
    }
}

// Window-wide Damage popup (as UI Function)
window.showDamage = function(idx, side, dmg, color='#ff5656') {
    let c = document.getElementById(`${side}${idx}`);
    if (!c) return;
    let dPop = document.createElement('span');
    dPop.className = 'damage-popup';
    dPop.innerText = (dmg<0?"+":"-")+Math.abs(dmg);
    dPop.style.color=color;
    c.appendChild(dPop);
    setTimeout(()=>{ dPop.remove(); }, 700);
};

/* ------------------ 4. SPD BAR LOOP & TURN SYSTEM------------------ */
function startBattle() {
    if (isBattling) return; isBattling = true; autoOn = true;
    async function battleLoop(){
        while(isBattling){
            for(let bar of speedBars){
                if(bar.dead) continue;
                // Refs
                let charArr = bar.side=='hero' ? heroes : monsters;
                let charPtr = charArr[bar.index];
                // 1. Process Buff/Debuff countdown&effects (HoT/Poison)
                window.effectEngine?.processStatusTurn?.(charPtr);
                if(charPtr.currHp<=0){ charPtr.alive=false; bar.dead=true; continue; }
                if(window.effectEngine?.isStunnedOrSkipped?.(charPtr)){
                    bar.cooldowns.forEach((v,i,arr)=>{ if(arr[i]>0) arr[i]--; });
                    continue;
                }
                if(!charPtr.alive) continue;
                // SPD charge
                bar.charge += getSpdCharge(bar);
                if(bar.charge >= SPD_BAR_MAX){
                    bar.charge = 0;
                    await doTurn(bar); // AI turn+animate+action
                    renderBattlefield(); // Render after turn
                    break; // sync (1 at a time)
                }
            }
            checkBattleResult();
            renderBattlefield();
            await (window.animationEngine?.sleep ?
                window.animationEngine.sleep(SPD_FRAME) :
                new Promise(r=>setTimeout(r, SPD_FRAME)));
        }
    }
    battleLoop();
}
function getSpdCharge(bar){
    let spdVal = bar.spd;
    let bonus = 1.0;
    if(bar.buffs?.some(b=>b.type=="spd_up")) bonus += 0.3;
    if(bar.debuffs?.some(b=>b.type=="spd_down")) bonus -= 0.3;
    return spdVal/10 * bonus;
}

/* ------------------ 5. TURN: AI ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢/‡∏™‡∏Å‡∏¥‡∏• & Animation ------------------ */
async function doTurn(bar){
    let charArr = bar.side=='hero'?heroes:monsters;
    let oppArr = bar.side=='hero'?monsters:heroes;
    let idx = bar.index;
    let charPtr = charArr[idx];

    window.effectEngine?.processStatusTurn?.(charPtr);
    if(window.effectEngine?.isStunnedOrSkipped?.(charPtr)){
        bar.cooldowns.forEach((v,i,arr)=>{ if(arr[i]>0) arr[i]--; });
        return;
    }
    if(!charPtr.alive) return;

    // --- PICK SKILL (AI) ---
    let skill = window.aiPickSkill ? window.aiPickSkill(charPtr, bar.cooldowns, charArr, oppArr) : pickSkill(charPtr, bar);

    // --- PICK TARGET
    let targets = [];
    if(skill.type==='attack')
        targets = [window.aiPickTarget ? window.aiPickTarget(oppArr, skill) : aiPickTarget(oppArr, skill)];
    else if(skill.type==='buff')
        targets = charArr.filter(c=>c.alive);
    else if(skill.type==='heal')
        targets = [window.aiPickTarget ? window.aiPickTarget(charArr, skill) : aiPickTarget(charArr, skill)];
    else if(skill.type==='aoe' || (skill.type==='attack' && skill.multiplier>1.2)) // AoE
        targets = oppArr.filter(o=>o.alive);
    else
        targets = [window.aiPickTarget ? window.aiPickTarget(oppArr, skill) : aiPickTarget(oppArr, skill)];
    targets = targets.filter(Boolean);

    // --- Animation Section ---
    // Card slide / AOE / Buff / Heal
    if(skill.type==='attack' && targets[0]){
        let tidx = oppArr.indexOf(targets[0]);
        await window.animationEngine?.animateAttackCard?.(idx, tidx, bar.side, bar.side==='hero'?'mon':'hero');
    }
    if((skill.type==='aoe' || (skill.type==='attack' && skill.multiplier>1.2 && targets.length>1))) {
        let tgtIdxArr = targets.map(t=>oppArr.indexOf(t));
        await window.animationEngine?.animateAoEAttack?.(idx, bar.side, bar.side==='hero'?'mon':'hero', tgtIdxArr);
    }
    if(skill.type==='heal'){
        await window.animationEngine?.animateHeal?.(idx, bar.side);
    }
    if(skill.type==='buff'){
        await window.animationEngine?.animateBuffDebuff?.(idx, bar.side, "buff");
    }

    // --- APPLY SKILL ---
    await doSkill(charPtr, skill, targets, bar.side);

    // --- Increase Cooldown ---
    if(skill.cooldown)
        bar.cooldowns[charPtr.skills.findIndex(s=>s.id==skill.id)] = skill.cooldown+1;
    bar.cooldowns.forEach((v,i,arr)=>{ if(arr[i]>0) arr[i]--; });
}

// Fallback PickSkill, PickTarget ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ ai.js
function pickSkill(char, bar){
    let order = [2,1,0];
    for(let i of order){
        if(!char.skills[i]) continue;
        if(bar.cooldowns[i]<=0) return char.skills[i];
    }
    return char.skills[0];
}
function aiPickTarget(arr, skill=null){
    // Heal: lowest HP, Buff: first, Default: hp lowest enemy
    arr = arr.filter(c=>c.alive);
    if(skill && skill.type==="heal")
        return arr.sort((a,b)=>a.currHp/a.hp - b.currHp/b.hp)[0];
    if(skill && skill.type==="buff") return arr[0];
    return arr.sort((a,b)=>a.currHp - b.currHp)[0];
}

/* ------------------ 6. Apply Damage/Effect ------------------ */
async function doSkill(source, skill, targets, sourceSide){
    if(!targets) return;
    for(let t of targets){
        if(!t.alive) continue;
        if(skill.type=="heal"){
            let healVal = Math.floor(source.atk * 0.7 + source.level * 1.5);
            t.currHp = Math.min(t.hp, t.currHp + healVal);
            window.showDamage?.(t.index, t.side, -healVal, '#59f495');
            t.alive = t.currHp>0;
            continue;
        }
        if(skill.type=="buff" && skill.effect && skill.effect.buff){
            window.effectEngine?.addEffect(t, skill.effect.buff, "buff");
            continue;
        }
        // Attack / AoE
        let dmg = Math.floor(source.atk * (skill.multiplier || 1) * (1 + (source.crit_rate || 0) / 100));
        let defReduce = t.debuffs?.some(d=>d.type=="def_break") ? 1.4 : 1;
        let defVal = t.def * defReduce;
        dmg = Math.max(Math.floor(dmg - defVal/3), 1);
        if(Math.random()*100 < (source.crit_rate||0)) dmg = Math.floor(dmg*((source.crit_dmg||150)/100));

        t.currHp = Math.max(0, t.currHp - dmg);
        t.alive = t.currHp>0;
        if(t.currHp<=0) t.alive = false;
        window.showDamage?.(t.index, t.side, dmg, '#ff5656');
        // Debuff
        if(skill.effect?.debuff) {
            window.effectEngine?.addEffect(t, skill.effect.debuff, "debuff");
        }
        // TODO: Cleanse, Remove buff/debuff future
    }
}

/* ------------------ 7. RESULT ------------------ */
function checkBattleResult(){
    let mySurvive = heroes.some(c=>c.alive);
    let monSurvive = monsters.some(c=>c.alive);
    if(!mySurvive || !monSurvive){
        isBattling = false;
        showBattleResult(mySurvive ? 'win' : 'lose');
    }
}
function showBattleResult(state){
    // ‡πÉ‡∏ä‡πâ popupManager ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ (‡∏´‡∏£‡∏∑‡∏≠ renderBattleResult)
    if(window.renderBattleResult){
        window.renderBattleResult({state});
    }else{
        setTimeout(()=>{
            openPopup('battleResult', {state});
        },800);
    }
}

/* ------------------ 8. INIT (START) ------------------ */
document.addEventListener('DOMContentLoaded', ()=>{
    const btnStartAuto = document.getElementById('btnStartAuto');
    if(btnStartAuto)
        btnStartAuto.onclick = async ()=>{
            autoOn = true;
            await loadBattleTeams();
            initSpdBar();
            renderBattlefield();
            startBattle();
        };
    // if battlefield already open
    if(document.getElementById('mainBattlefield') && 
            !document.getElementById('mainBattlefield').classList.contains('hide')) {
        loadBattleTeams().then(() => {
            initSpdBar();
            renderBattlefield();
        });
    }
});

/* ------------------ 9. Utilities ------------------ */
function deepCopy(obj) {
    return JSON.parse(JSON.stringify(obj));
}

/* 
   ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Dev/Test ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° UI 
   - ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞/‡∏ó‡∏µ‡∏°‡πÉ‡∏´‡∏°‡πà, ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏° debug ‡πÑ‡∏î‡πâ
*/

/* ------------------ 10. Export Global ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ) ------------------ */
window.battleEngine = {
    loadBattleTeams, initSpdBar, renderBattlefield, startBattle, heroes, monsters, speedBars
};

/* ------------------ Custom BattleResult Popup (‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•) ------------------ */
(function () {
    const origRenderPopup = window.renderPopup;
    window.renderPopup = function(type, data) {
        if(type === "battleResult") {
            return `<div class="popup large"><button class="close" onclick="closePopup()">√ó</button>
                <h2>‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ</h2>
                <div style="font-size:2em;text-align:center;margin-bottom:12px;">
                  ${data.state === "win" ? "üèÜ <b style='color:#54e0be'>‡∏ä‡∏ô‡∏∞!</b>" : "‚ùå <b style='color:#f47'>‡πÅ‡∏û‡πâ</b>"}
                </div>
                <button class="primary-btn" onclick="closePopup()">‡πÇ‡∏≠‡πÄ‡∏Ñ</button>
            </div>`;
        }
        return origRenderPopup(type, data);
    };
})();

/* 
 ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:
 - ‡∏´‡∏≤‡∏Å‡∏à‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏£‡∏¥‡∏á (EXP, ‡∏î‡∏£‡∏≠‡∏õ, ‡πÄ‡∏•‡πÄ‡∏ß‡∏•‡∏≠‡∏±‡∏û) ‡πÉ‡∏ä‡πâ window.renderBattleResult ‡∏à‡∏≤‡∏Å result.js ‡πÅ‡∏ó‡∏ô
 - ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ fallback popup ‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
*/

‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå js/ai.js
// js/ai.js
/**
 * Epic Seven - AI Auto Battle Engine (‡πÅ‡∏¢‡∏Å Module)
 * ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å skill ‡πÅ‡∏•‡∏∞ target ‡πÉ‡∏ô battle.js
 */

/**
 * Pick skill ‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏î‡∏¢ AI) - ‡πÅ‡∏ö‡∏ö modular
 * @param {Object} char - (obj) ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£
 * @param {Array<number>} cooldowns - cooldown ‡πÅ‡∏ï‡πà‡∏•‡∏∞ skill [s1, s2, s3...]
 * @param {Array<Object>} allies - ‡∏ù‡∏±‡πà‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô (obj)
 * @param {Array<Object>} enemies - ‡∏ù‡∏±‡πà‡∏á‡∏ï‡∏£‡∏á‡∏Ç‡πâ‡∏≤‡∏° (obj)
 * @return {Object} skill ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏ä‡πâ
 */
function aiPickSkill(char, cooldowns, allies, enemies) {
    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ö‡∏±‡∏ü, heal, ‡πÉ‡∏ä‡πâ skill aoe ‡∏Å‡πà‡∏≠‡∏ô (‡∏•‡∏≥‡∏î‡∏±‡∏ö: AoE > Heal/Buff > Single)
    // ‡πÉ‡∏ä‡πâ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç HP ‡∏ï‡πà‡∏≥, ‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏°‡∏≤‡∏Å/‡∏ô‡πâ‡∏≠‡∏¢, ‡∏´‡∏£‡∏∑‡∏≠ CD climate
    let skills = char.skills || [];
    let usable = skills.map((s, i) => ({...s, cd: cooldowns[i] || 0, idx: i }))
        .filter(s => s.cd === 0);

    // (1) Heal/Buff - ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÉ‡∏ô usable skill
    for (let s of usable) {
        if (s.type === 'heal' && needHeal(allies)) return s;
        if (s.type === 'buff' && needBuff(allies, s)) return s;
    }

    // (2) AoE - ‡∏ñ‡πâ‡∏≤ AoE ‡πÅ‡∏•‡∏∞‡∏ù‡∏±‡πà‡∏á‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏°‡∏µ 2 ‡∏ï‡∏±‡∏ß+ (‡∏´‡∏£‡∏∑‡∏≠ priority)
    for (let s of usable) {
        if ((s.type === 'attack' || s.type === 'aoe') && s.multiplier > 1.5 && (living(enemies) > 1)) {
            return s;
        }
    }

    // (3) Debuff - ‡∏ï‡∏µ‡πÄ‡∏õ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ü‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏Å‡∏£‡πà‡∏á (def break/stun)
    for (let s of usable) {
        if (s.effect && s.effect.debuff) return s;
    }

    // (4) Single Attack - ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å default
    if (usable.length > 0) return usable[0];
    // fallback: skill 1
    return skills[0];
}

/**
 * Pick target ‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡πÇ‡∏à‡∏°‡∏ï‡∏µ (AI)
 * @param {Array<Object>} arr - ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (obj)
 * @param {Object} skill - skill ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏ä‡πâ
 * @return {Object}
 */
function aiPickTarget(arr, skill = null) {
    // ‡∏ï‡∏µ‡∏ï‡∏±‡∏ß HP ‡∏ô‡πâ‡∏≠‡∏¢‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô ‡πÄ‡∏ß‡πâ‡∏ô‡∏ñ‡πâ‡∏≤ skill ‡πÄ‡∏õ‡πá‡∏ô heal/buff
    arr = arr.filter(c => c.alive);
    // Heal: ‡∏´‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏Ñ‡∏∑‡∏≠‡∏ù‡∏±‡πà‡∏á‡πÄ‡∏£‡∏≤ (lowest HP)
    if (skill && skill.type === 'heal') {
        return arr.sort((a, b) => a.currHp / a.hp - b.currHp / b.hp)[0];
    }
    // Buff: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡∏ù‡∏±‡πà‡∏á‡πÄ‡∏£‡∏≤ alive
    if (skill && skill.type === 'buff') {
        // ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡πà logic   --> ‡πÉ‡∏™‡πà‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å index 0
        return arr[0];
    }
    // AoE: ‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏¢
    if (skill && (skill.type === 'aoe' || (skill.type === 'attack' && skill.multiplier > 1.5))) {
        return arr; // ‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ñ‡∏ß enemy
    }
    // Debuff: ‡∏ï‡∏µ tank ‡∏Å‡πà‡∏≠‡∏ô (defense/high HP), ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏ô‡πâ‡∏ô ‡∏´‡∏≤ HP ‡∏ô‡πâ‡∏≠‡∏¢‡∏™‡∏∏‡∏î
    let sorted = arr.sort((a, b) => a.currHp - b.currHp);
    return sorted[0];
}

/**
 * ‡πÉ‡∏Ñ‡∏£‡πÉ‡∏ô‡∏ó‡∏µ‡∏° HP ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 60% ‡πÉ‡∏´‡πâ heal
 * @param {Array<Object>} team
 */
function needHeal(team) {
    for (let c of team) {
        if (c.alive && c.currHp / c.hp < 0.6) return true;
    }
    return false;
}

/**
 * ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ö‡∏±‡∏ü‡∏ó‡∏µ‡πà skill ‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ó‡∏µ‡∏°‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÅ‡∏•‡πâ‡∏ß‡∏Ç‡πâ‡∏≤‡∏°)
 * @param {Array<Object>} team
 * @param {Object} skill
 */
function needBuff(team, skill) {
    let buffs = (skill && skill.effect && skill.effect.buff) || [];
    for (let btype of buffs.map(b => b.type)) {
        // ‡∏ñ‡πâ‡∏≤ buff ‡∏ô‡∏µ‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏ó‡∏µ‡∏°‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏°‡∏î ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ
        let count = team.filter(c => c.alive && c.buffs && c.buffs.some(bf => bf.type === btype)).length;
        if (count < team.length) return true; // ‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏Ñ‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ buff ‡∏ô‡∏µ‡πâ
    }
    return false;
}

/**
 * ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏≤‡∏¢
 */
function living(arr) {
    return arr ? arr.filter(c => c.alive).length : 0;
}

// ---- ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡∏±‡∏ö battle.js ----
// Expose ‡πÄ‡∏õ‡πá‡∏ô global ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ
window.aiPickSkill = aiPickSkill;
window.aiPickTarget = aiPickTarget;

‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå js/animationEngine.js
/* Epic Seven Card Auto Battle - Animation Engine */
/* ‡∏ß‡∏≤‡∏á‡πÉ‡∏ô /js/animationEngine.js */

window.animationEngine = (function () {
    /** Card slide animation to attack */
    async function animateAttackCard(fromIdx, toIdx, fromSide, toSide, type = 'single') {
        const fromCard = document.getElementById(`${fromSide}${fromIdx}`);
        const toCard = document.getElementById(`${toSide}${toIdx}`);
        if (!fromCard || !toCard) return;
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á overlay
        const rectFrom = fromCard.getBoundingClientRect();
        const rectTo = toCard.getBoundingClientRect();
        // Absolute overlay clone
        const clone = fromCard.cloneNode(true);
        clone.style.position = "fixed";
        clone.style.left = rectFrom.left + 'px';
        clone.style.top = rectFrom.top + 'px';
        clone.style.width = rectFrom.width + 'px';
        clone.style.zIndex = "2000";
        clone.style.transition = 'all 0.35s cubic-bezier(.6,0,.2,1.4)';
        // Hide original
        fromCard.style.opacity = "0.4";
        document.body.appendChild(clone);
        await sleep(30);

        // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÑ‡∏õ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢
        clone.style.left = rectTo.left + 'px';
        clone.style.top = rectTo.top + 'px';
        clone.style.boxShadow = "0 0 32px #e7ff79c8, 0 0 80px #e3e37044";
        clone.style.transform = "scale(1.10) rotate(-3deg)";
        await sleep(330);

        // Flash/Shake ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢
        shakeCard(toCard);
        // Remove overlay
        setTimeout(() => {
            clone.remove();
            fromCard.style.opacity = "1";
        }, 110);

        await sleep(180);
    }

    /** AoE Animation (wave blast) */
    async function animateAoEAttack(fromIdx, fromSide, toSide, targets) {
        const fromCard = document.getElementById(`${fromSide}${fromIdx}`);
        if (!fromCard) return;
        // Pulse the card
        pulseCard(fromCard, "#f2d13e");
        // Wave line to center
        targets.forEach((t) => {
            const tgt = document.getElementById(`${toSide}${t}`);
            if (tgt) {
                flashCard(tgt, "#ffd058");
                shakeCard(tgt);
            }
        });
        await sleep(340);
    }

    /** Heal effect (green glow, upward effect) */
    async function animateHeal(toIdx, toSide) {
        const tgt = document.getElementById(`${toSide}${toIdx}`);
        if (!tgt) return;
        glowCard(tgt, "#68eccc");
        // Heal "plus" popup up
        let plus = document.createElement('span');
        plus.textContent = "+HP";
        plus.style = "color:#68fdd8;font-weight:bold;font-size:1.18em;position:absolute;left:42%;top:17%;opacity:0;transition:top .4s,opacity .2s;";
        tgt.appendChild(plus);
        setTimeout(() => {
            plus.style.top = "-6%";
            plus.style.opacity = "1";
        }, 20);
        setTimeout(() => plus.remove(), 650);
        await sleep(390);
    }

    /** Buff/Debuff effect on card */
    async function animateBuffDebuff(toIdx, toSide, type = "buff") {
        const tgt = document.getElementById(`${toSide}${toIdx}`);
        if (!tgt) return;
        glowCard(tgt, type === "buff" ? "#98deff" : "#ff7b7b");
        await sleep(260);
    }

    // --- Utilities (Shake, Glow, Flash, Pulse) ---
    function shakeCard(card) {
        if (!card) return;
        card.animate([
            { transform: "translateX(0)" },
            { transform: "translateX(-12px)" },
            { transform: "translateX(13px)" },
            { transform: "translateX(-7px)" },
            { transform: "translateX(0)" }
        ], { duration: 320, easing: "ease-in" });
    }
    function glowCard(card, color) {
        if (!card) return;
        card.style.boxShadow = `0 0 15px 6px ${color}66`;
        setTimeout(() => (card.style.boxShadow = ""), 380);
    }
    function flashCard(card, color = "#fff") {
        if (!card) return;
        card.style.background = color;
        setTimeout(() => (card.style.background = ""), 170);
    }
    function pulseCard(card, color) {
        if (!card) return;
        card.animate([
            { boxShadow: `0 0 0px 0px ${color}40` },
            { boxShadow: `0 0 15px 8px ${color}bb` },
            { boxShadow: `0 0 0px 0px ${color}00` }
        ], { duration: 410 });
    }
    function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

    // --- Expose ---

    return {
        animateAttackCard,
        animateAoEAttack,
        animateHeal,
        animateBuffDebuff,
        shakeCard,
        glowCard,
        flashCard,
        pulseCard,
        sleep
    };
})();

‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå js/effect.js
// js/effect.js

/**
 * ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ü/‡∏î‡∏µ‡∏ö‡∏±‡∏ü/‡∏Æ‡∏µ‡∏• Auto Battle Engine (Epic Seven Version)
 * ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö: Buff, Debuff, Immunity, Stack, Countdown Turn, Remove, Tooltip
 * ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å battle.js, ai.js, animationEngine.js
 */

/**
 * ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (Buff/Debuff) ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö character
 * @param {Object} target - ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢
 * @param {Array<Object>} effects - [{type, turn, [chance]}]
 * @param {string} effectType - 'buff' ‡∏´‡∏£‡∏∑‡∏≠ 'debuff'
 */
function addEffect(target, effects, effectType) {
    if (!effects || !Array.isArray(effects)) return;

    for (let eff of effects) {
        // Anti-stack: debuff/buff ‡πÅ‡∏ö‡∏ö non-stack
        if (effectType === "buff") {
            if (target.buffs.some(b => b.type === eff.type)) continue;
        } else if (effectType === "debuff") {
            if (target.debuffs.some(b => b.type === eff.type)) continue;
        }
        // Immunity: ‡∏´‡∏≤‡∏Å‡∏ï‡∏¥‡∏î immunity (multi N turn) ‡∏à‡∏∞‡∏Å‡∏±‡∏ô‡∏î‡∏µ‡∏ö‡∏±‡∏ü (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô stun/burn ‡∏Ø)
        if (effectType === "debuff" && (target.buffs || []).some(b => b.type === "immune" && b.turn > 0)) {
            continue;
        }
        // Stackable Debuff (‡πÄ‡∏ä‡πà‡∏ô poison) *Option
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ stack ‡πÑ‡∏î‡πâ‡∏´‡∏≤‡∏Å type ‡πÄ‡∏õ‡πá‡∏ô poison/burn
        if (effectType === "debuff" && ["poison", "burn"].includes(eff.type)) {
            target.debuffs.push({...eff});
            continue;
        }
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        if (effectType === "buff") target.buffs.push({...eff});
        else if (effectType === "debuff") target.debuffs.push({...eff});
    }
}

/**
 * ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏° turn ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏î countdown & remove state ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏
 * @param {Object} char - ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£
 */
function processStatusTurn(char) {
    ['buffs', 'debuffs'].forEach(listType => {
        if (!char[listType]) return;
        for (let i = char[listType].length - 1; i >= 0; i--) {
            let st = char[listType][i];
            // ‡∏•‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô turn
            if (st.turn && st.turn > 0) st.turn--;
            // ‡πÄ‡∏≠‡∏≤‡∏≠‡∏≠‡∏Å‡∏ñ‡πâ‡∏≤‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏
            if (st.turn === 0) char[listType].splice(i, 1);
        }
    });
    // Heal Over Time (HoT)/Poison/Burn
    if (char.debuffs) {
        char.debuffs.forEach(df => {
            if (df.type === "poison") {
                let val = Math.round(char.hp * 0.05);
                char.currHp = Math.max(0, char.currHp - val);
                window.showDamage?.(char.index || 0, char.side || 'hero', val, "#ffd155");
            }
            if (df.type === "burn") {
                let val = Math.round(char.hp * 0.12);
                char.currHp = Math.max(0, char.currHp - val);
                window.showDamage?.(char.index || 0, char.side || 'hero', val, "#ff6633");
            }
        });
    }
    if (char.buffs) {
        char.buffs.forEach(bf => {
            if (bf.type === "heal_ot") { // Heal over time
                let val = Math.round(char.hp * 0.06);
                char.currHp = Math.min(char.hp, char.currHp + val);
                window.showDamage?.(char.index || 0, char.side || 'hero', -val, "#24eeba");
            }
        });
    }
}

/**
 * ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ‡πÇ‡∏î‡∏ô Stun ‡∏´‡∏£‡∏∑‡∏≠ Debuff Skip Turn ‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
 */
function isStunnedOrSkipped(char) {
    return (char.debuffs || []).some(df => ["stun", "sleep", "freeze", "silence"].includes(df.type));
}

/**
 * ‡∏•‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ buff/debuff ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Cleanse/Purge) ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î
 * @param {Object} char
 * @param {string} [type] "buff"/"debuff"/"all" (default: all)
 */
function removeStatus(char, type = "all") {
    if (!char) return;
    if (type === "all") {
        char.buffs = [];
        char.debuffs = [];
    }
    if (type === "buff") char.buffs = [];
    if (type === "debuff") char.debuffs = [];
}

/**
 * ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ô UI ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á icon + ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô turn ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡∏ó‡∏µ‡πà‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ö‡∏ô‡∏™‡∏ô‡∏≤‡∏°
 * (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ UI ‡∏à‡∏∞‡∏≠‡πà‡∏≤‡∏ô char.buffs, char.debuffs [])
 */

/**
 * ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡πÉ‡∏ô battle.js:
 * - ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏° turn, processStatusTurn()
 * - check ‡∏ß‡πà‡∏≤ stun/skip turn ‡πÑ‡∏°‡πà‡πÇ‡∏à‡∏°‡∏ï‡∏µ
 * - ‡∏´‡∏•‡∏±‡∏á heal/attack/addEffect ‡πÉ‡∏ä‡πâ addEffect()
 * - ‡∏•‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ removeStatus(char, type)
 */

// ---- Export (global assignment)
window.effectEngine = {
    addEffect,
    processStatusTurn,
    isStunnedOrSkipped,
    removeStatus
};

‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå js/result.js
// js/result.js

/**
 * Epic Seven Auto Battle - Battle Result Handler (Frontend Only)
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö popup ‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏≠‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ, ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï EXP, ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏î‡∏£‡∏≠‡∏õ‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°, ‡∏≠‡∏±‡∏õ‡πÄ‡∏•‡πÄ‡∏ß‡∏•, ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô ‡∏Ø‡∏•‡∏Ø
 * ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° inventory.js, team.js, battle.js, popupManager.js ‡πÅ‡∏•‡∏∞ system ‡∏≠‡∏∑‡πà‡∏ô
 * Author: <yourname> (2024)
 */

// ---------- Option: CONFIGURATION (customize ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡πà‡∏≠ database ‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï) ----------
const EXP_PER_WIN = 60;     // Exp ‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß (‡∏ä‡∏ô‡∏∞)
const EXP_PER_LOSE = 18;    // Exp ‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß (‡πÅ‡∏û‡πâ)
const BASIC_DROP_LIST = [
    { id: 'exp_potion', name: 'EXP Potion', qty_range: [1, 2], chance: 55 },
    { id: 'gold', name: 'Gold', qty_range: [200, 500], chance: 80 },
    { id: 'rune_shard', name: 'Rune Shard', qty_range: [1, 1], chance: 20 },
    // ‡πÄ‡∏û‡∏¥‡πà‡∏° drop type ‡πÑ‡∏î‡πâ‡πÉ‡∏ô inventory/item.json
];

// ---------- MAIN FUNCTION ----------
window.renderBattleResult = function (resultObj = {}) {
    // resultObj: { state: 'win'|'lose', heroes: [], monsters: [], drops: [] } (‡∏ö‡∏≤‡∏á field optional)

    // Load user team (reload for update exp)
    let team = [];
    let raw = localStorage.getItem('userTeam');
    if (raw) team = JSON.parse(raw);

    // ‡∏õ‡∏Å‡∏ï‡∏¥‡∏à‡∏∞‡∏°‡∏µ id ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡πÉ‡∏ô team
    let heroDatas = [];
    if (team.length > 0) {
        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå data/char/*.json
        heroDatas = team.map(id => {
            if (!id) return null;
            try {
                let cache = localStorage.getItem('char_' + id);
                if (cache) return JSON.parse(cache);
            } catch { }
            // Fallback fetch (sync ‡πÇ‡∏õ‡∏£‡∏î‡∏±‡∏Å‡∏ä‡∏±‡∏ô‡πÉ‡∏ä‡πâ async ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢ render)
            let obj = null;
            let xhr = new XMLHttpRequest();
            xhr.open('GET', `data/char/${id}.json`, false);
            xhr.send();
            if (xhr.status === 200) {
                obj = JSON.parse(xhr.responseText);
            }
            return obj;
        });
        heroDatas = heroDatas.filter(c => c);
    }

    // 1. EXP/LEVEL UP
    const expGet = (resultObj.state === 'win') ? EXP_PER_WIN : EXP_PER_LOSE;
    let levelUps = [];
    heroDatas.forEach((c, i) => {
        if (!c) return;
        c.exp = (c.exp || 0) + expGet;
        let up = false;
        while (c.exp >= (c.exp_max || 99999)) {
            c.exp -= c.exp_max;
            c.level = (c.level || 1) + 1;
            up = true;
            // ‡∏≠‡∏±‡∏õ cap = ‡πÄ‡∏û‡∏¥‡πà‡∏° exp_max? ‡πÄ‡∏û‡∏¥‡πà‡∏° config ‡πÑ‡∏î‡πâ
        }
        if (up) levelUps.push(c.name);
        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å state cache ‡πÄ‡∏ú‡∏∑‡πà‡∏≠ future ‡πÉ‡∏ä‡πâ‡πÄ‡∏£‡πá‡∏ß
        localStorage.setItem('char_' + c.id, JSON.stringify(c));
    });

    // 2. DROP SYSTEM (Mock)
    let dropItems = [];
    if (resultObj.state == 'win') {
        BASIC_DROP_LIST.forEach(d => {
            if (Math.random() * 100 < d.chance) {
                let qty = randomInt(d.qty_range[0], d.qty_range[1]);
                dropItems.push({
                    id: d.id,
                    name: d.name,
                    qty: qty
                });
                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏•‡∏±‡∏á‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
                addToInventory(d.id, qty);
            }
        });
    }

    // 3. Save Update ‡∏Ç‡∏≠‡∏á Hero ‡∏Å‡∏•‡∏±‡∏ö (option ‡∏£‡∏ß‡∏° cache ‡∏ï‡∏≤‡∏° system ‡∏à‡∏£‡∏¥‡∏á)
    // (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏≠‡∏á‡πÉ‡∏ô inventory ‡∏õ‡∏Å‡∏ï‡∏¥‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô inventory.js, ‡πÅ‡∏ï‡πà‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡∏à‡∏∞ simulate if not loaded)

    // 4. Render HTML Popup
    let popupHtml = `
    <div class="popup large">
      <button class="close" onclick="closePopup()">√ó</button>
      <h2 style="margin-bottom:0.4em;">${resultObj.state === "win" ? "üèÜ <b style='color:#54e0be'>‡∏ä‡∏ô‡∏∞!</b>" : "‚ùå <b style='color:#f47'>‡πÅ‡∏û‡πâ</b>"}</h2>
      <div style="font-size:1.2em;color:#bdf;">${resultObj.state === "win" ? "‡∏Ñ‡∏∏‡∏ì‡∏ú‡πà‡∏≤‡∏ô‡∏î‡πà‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•" : "‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö EXP ‡∏õ‡∏•‡∏≠‡∏ö‡πÉ‡∏à"}</div>
      <hr style="margin:10px 0 10px 0; border:1px solid #234a76;">
      <div style="margin-bottom:8px;"><b>üéñ EXP ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö:</b> <span style="color:#7cffda">${expGet}</span> / ‡∏ï‡∏±‡∏ß</div>
      <table style="width:98%;margin:10px 0 18px 0;background:#222a38;border-radius:12px;">
        <tr>
          ${heroDatas.map(c => `<td style="text-align:center;">
            <img src="img/char/${c?.img||'noimg.png'}" alt="${c?.name}" style="width:37px;border-radius:50%;box-shadow:0 0 10px #57faf840;">
            <div style="font-size:.97em;margin-top:7px;">${c?.name}</div>
            <div style="font-size:.9em;margin-top:2px;">LV. <b>${c?.level||'-'}</b> <span style="color:${levelUps.includes(c?.name) ? '#45ff77' : '#aaa'}">${levelUps.includes(c?.name) ? '‚Üë UP!' : ''}</span></div>
          </td>`).join('')}
        </tr>
      </table>
      ${dropItems.length > 0 ? `
      <div style="margin-bottom:7px;"><b>üéÅ ‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö</b>:</div>
      <div style="display:flex;gap:15px;flex-wrap:wrap;">
        ${dropItems.map(d => 
          `<div style="background:#23343b;padding:11px 18px;border-radius:8px;box-shadow:0 2px 15px #25f3f026;">
              <b style="font-size:1.17em;">${d.name}</b><br>
              <span style="font-size:.93em;color:#81e6ae;">x${d.qty}</span>
          </div>`
        ).join('')}
      </div>
      ` : ''}
      <div style="margin-top:24px;text-align:center;">
        <button class="primary-btn" onclick="closePopupAndReturn()">‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
      </div>
    </div>
    `;

    // Push popup to #popupLayer (use popupManager)
    let popupLayer = document.getElementById('popupLayer');
    if (!popupLayer) {
        popupLayer = document.createElement('div');
        popupLayer.id = 'popupLayer';
        document.body.appendChild(popupLayer);
    }
    popupLayer.innerHTML = popupHtml;
    popupLayer.classList.add('active');

    // Special: ‡∏õ‡∏¥‡∏î popup ‡πÅ‡∏•‡∏∞ refresh field (‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏°‡∏ô‡∏π‡∏´‡∏•‡∏±‡∏Å/refresh battlefield)
    window.closePopupAndReturn = function() {
        // ‡∏ã‡πà‡∏≠‡∏ô popup, ‡∏Å‡∏•‡∏±‡∏ö index.html
        closePopup();
        if (window.location.pathname.indexOf('index.html') === -1) {
            window.location.href = 'index.html';
        } else {
            // reload team or UI if needed
            if (window.renderBattlefield) window.renderBattlefield();
        }
    }
};

// ---------- INVENTORY ADD HELPER ----------
/**
 * ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏•‡∏±‡∏á (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å inventory.js ‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏£‡∏∞‡∏ö‡∏ö)
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ mock ‡πÑ‡∏ß‡πâ‡πÄ‡∏ú‡∏∑‡πà‡∏≠ inventory.js ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÇ‡∏´‡∏•‡∏î
 */
function addToInventory(itemId, qty) {
    let items = [];
    try {
        let raw = localStorage.getItem('user_inventory') || '[]';
        items = JSON.parse(raw);
    } catch { items = []; }
    let item = items.find(x => x.id === itemId);
    if (item) {
        item.qty += qty;
    } else {
        items.push({ id: itemId, qty: qty });
    }
    localStorage.setItem('user_inventory', JSON.stringify(items));
}

// ---------- UTILS ----------
function randomInt(min, max) {
    if (min === max) return min;
    return Math.floor(Math.random() * (max - min + 1)) + min;
}

// ---------- END OF FILE ----------
/**
 * ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏î‡∏™‡∏≠‡∏ö:
 * - ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å window.renderBattleResult({ state: "win" }) ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ
 * - ‡∏î‡∏π popup ‡πÅ‡∏™‡∏î‡∏á exp, ‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°, ‡∏≠‡∏±‡∏õ‡πÄ‡∏•‡πÄ‡∏ß‡∏•, ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ "‡∏Å‡∏•‡∏±‡∏ö" ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å‡πÑ‡∏î‡πâ
 * - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö LocalStorage: char_*, user_inventory, userTeam
 */

‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå js/popupManager.js
// /js/popupManager.js

/**
 * popupManager.js
 * Epic Seven Auto Battle - Popup System (v1.0)
 * ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î-‡∏õ‡∏¥‡∏î Pop-up ‡∏Å‡∏•‡∏≤‡∏á / popover ‡∏ã‡πâ‡∏≠‡∏ô
 * ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö HTML Content, Callback, Responsive
 * ‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö index.html, ui.js, ‡∏ó‡∏∏‡∏Å module
 * Author: (‡∏Ñ‡∏∏‡∏ì)
 */

// ‡πÄ‡∏Å‡πá‡∏ö Stack ‡∏Ç‡∏≠‡∏á popup ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏¥‡∏î‡∏ã‡πâ‡∏≠‡∏ô
let popupStack = [];

/**
 * ‡πÄ‡∏õ‡∏¥‡∏î Popup ‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠
 * @param {Object} options { 
 *    id: string, // ‡∏ä‡∏∑‡πà‡∏≠ feature, ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô key menu, ex: 'quest', 'inventory'
 *    title: string, // ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠
 *    content: HTML string, // ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ HTML (innerHTML)
 *    size: "normal" | "large" | "tall" | "small",
 *    onClose: function, // callback ‡πÄ‡∏°‡∏∑‡πà‡∏≠ popup ‡∏ô‡∏µ‡πâ‡∏õ‡∏¥‡∏î
 *    showCloseBtn: boolean, // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î (default: true)
 *    autoFocus: CSS selector (optional, ‡πÇ‡∏ü‡∏Å‡∏±‡∏™ input)
 * }
 */
window.popupManager = {
    open: function (options = {}) {
        // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô popup ‡∏ã‡πâ‡∏≠‡∏ô‡∏ã‡πâ‡∏≥‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏¥‡∏°
        if (popupStack.some(p => p.id === options.id)) {
            return; // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏ã‡πâ‡∏≥
        }
        const popupLayer = document.getElementById('popupLayer');
        if (!popupLayer) return;

        const { id, title, content, size, onClose, showCloseBtn, autoFocus } = options;
        const sz = size || 'normal';
        let html = `
      <div class="popup${sz === 'large' ? ' large' : sz === 'tall' ? ' tall' : sz === 'small' ? ' small' : ''}" 
        style="z-index: ${100 + popupStack.length * 2};" popup-id="${id || ''}">
          ${showCloseBtn === false ? '' : `<button class="close" onclick="popupManager.close('${id || ''}')">√ó</button>`}
          <h2 style="margin-bottom:.39em;">${title || ''}</h2>
          <div class="popup-content" style="margin-top:9px;">${content || ''}</div>
      </div>`;

        let wrap = document.createElement('div');
        wrap.className = 'popup-wrap-layer';
        wrap.style = `position:fixed; top:0; left:0; width:100vw;height:100vh;display:flex;
          align-items:center;justify-content:center;z-index:${99 + popupStack.length * 2 + 1};`;
        wrap.innerHTML = html;

        // Store info to Stack
        popupStack.push({
            id,
            wrap,
            onClose: typeof onClose === "function" ? onClose : null
        });

        popupLayer.appendChild(wrap);
        popupLayer.classList.add('active');

        // Auto focus
        if (autoFocus) {
            setTimeout(() => {
                const el = wrap.querySelector(autoFocus);
                if (el) el.focus();
            }, 150);
        }
    },

    /**
     * ‡∏õ‡∏¥‡∏î Popup (‡∏õ‡∏¥‡∏î‡∏ö‡∏ô‡∏™‡∏∏‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏≤‡∏° id)
     * @param {string} id
     */
    close: function (id = '') {
        const popupLayer = document.getElementById('popupLayer');
        if (!popupLayer) return;
        if (popupStack.length === 0) return;
        let pop;
        if (id) {
            let idx = popupStack.findIndex(p => p.id === id);
            if (idx === -1) return;
            pop = popupStack.splice(idx, 1)[0];
            if (pop && pop.wrap) {
                pop.wrap.remove();
            }
        } else {
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡πà‡∏á id ‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡∏ß‡∏ö‡∏ô‡∏™‡∏∏‡∏î
            pop = popupStack.pop();
            if (pop && pop.wrap) {
                pop.wrap.remove();
            }
        }
        // onClose callback
        if (pop && pop.onClose) pop.onClose();

        // ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ popup ‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î layer
        if (popupStack.length === 0) {
            popupLayer.classList.remove('active');
        }
    },

    /**
     * ‡∏õ‡∏¥‡∏î Popups ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (reset stack)
     */
    closeAll: function () {
        const popupLayer = document.getElementById('popupLayer');
        popupStack.forEach(p => {
            if (p.wrap) p.wrap.remove();
            if (typeof p.onClose === "function") p.onClose();
        });
        popupStack = [];
        if (popupLayer) popupLayer.classList.remove('active');
    },

    /**
     * Render content ‡πÉ‡∏´‡∏°‡πà‡∏ö‡∏ô popup id ‡∏ô‡∏µ‡πâ (‡πÄ‡∏ä‡πà‡∏ô refetch/refresh)
     * @param {string} id
     * @param {string} content HTML
     */
    update: function (id, content) {
        let pop = popupStack.find(p => p.id === id);
        if (pop && pop.wrap) {
            let inner = pop.wrap.querySelector('.popup-content');
            if (inner) inner.innerHTML = content;
        }
    },

    /**
     * ‡∏î‡∏∂‡∏á Stack popups
     */
    getStack: function () { return [...popupStack]; }
};

// [Global shortcut]
window.openPopup = function (id, content = '', size = 'normal', title = '', options = {}) {
    // For backward compat: openPopup(type, html, size, title, { ... })
    window.popupManager.open({
        id, title: title || id, content, size, ...options
    });
}
window.closePopup = function (id = '') { window.popupManager.close(id); }
window.closeAllPopup = function () { window.popupManager.closeAll(); }

// Escape = close popup ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
document.addEventListener('keyup', ev => {
    if (ev.key === 'Escape') popupManager.close();
});

// Click shadow layer (‡∏õ‡∏¥‡∏î popup ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ popup ‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï)
document.getElementById('popupLayer')?.addEventListener('mousedown', ev => {
    if (ev.target.classList.contains('popup-wrap-layer')) {
        // ‡∏´‡∏≤‡∏Å popup ‡∏ö‡∏ô‡∏™‡∏∏‡∏î‡∏°‡∏µ showCloseBtn = false => ‡πÑ‡∏°‡πà‡∏õ‡∏¥‡∏î ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏•‡∏¥‡∏Å
        if (popupStack.length === 0) return;
        let last = popupStack[popupStack.length - 1];
        if (last && last.wrap && last.wrap.querySelector('.close')) {
            window.popupManager.close();
        }
    }
});

‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå data/item.json
[
  {
    "id": "gold",
    "name": "Gold",
    "type": "currency",
    "description": "‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏ó‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏ä‡∏≤",
    "img": "gold.png",
    "rarity": 1,
    "usable": false,
    "price": 0
  },
  {
    "id": "diamond",
    "name": "Crystal",
    "type": "currency",
    "description": "‡πÄ‡∏û‡∏ä‡∏£ ‡πÉ‡∏ä‡πâ‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏ä‡∏≤ ‡∏û‡∏¥‡πÄ‡∏®‡∏©",
    "img": "diamond.png",
    "rarity": 2,
    "usable": false,
    "price": 0
  },
  {
    "id": "exp_potion",
    "name": "EXP Potion",
    "type": "xp_item",
    "description": "‡πÄ‡∏û‡∏¥‡πà‡∏° EXP ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢",
    "img": "exp_potion.png",
    "rarity": 2,
    "usable": true,
    "effect": { "exp": 500 },
    "price": 200
  },
  {
    "id": "skill_book",
    "name": "Skill Book",
    "type": "upgrade",
    "description": "‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏™‡∏Å‡∏¥‡∏•‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ (‡∏™‡∏∏‡πà‡∏° 1 skill)",
    "img": "skill_book.png",
    "rarity": 3,
    "usable": true,
    "effect": { "skillup": 1 },
    "price": 900
  },
  {
    "id": "rune_shard",
    "name": "Rune Shard",
    "type": "rune_material",
    "description": "‡πÄ‡∏®‡∏©‡∏£‡∏π‡∏ô ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏ô",
    "img": "rune_shard.png",
    "rarity": 2,
    "usable": false,
    "price": 150
  },
  {
    "id": "heal_potion",
    "name": "Heal Potion",
    "type": "heal",
    "description": "‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°‡πÉ‡∏ä‡πâ‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π HP 50% ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å",
    "img": "heal_potion.png",
    "rarity": 2,
    "usable": true,
    "effect": { "hp_pct": 50 },
    "price": 120
  }
]

‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå js/inventory.js
// js/inventory.js

let itemData = [];
let inventory = [];

/** ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°‡∏à‡∏≤‡∏Å data/item.json */
async function loadItemData() {
  if (itemData.length) return;
  itemData = await fetch('data/item.json').then(r => r.json());
}
/** ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô (‡∏à‡∏≤‡∏Å localStorage) */
function loadInventory() {
  let raw = localStorage.getItem('user_inventory');
  inventory = raw ? JSON.parse(raw) : [];
}
/** ‡πÄ‡∏ã‡∏ü inventory */
function saveInventory() {
  localStorage.setItem('user_inventory', JSON.stringify(inventory));
}

/** ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°‡πÉ‡∏ô data/item.json */
function findItemById(id) {
  return itemData.find(i => i.id === id);
}
/** render UI ‡∏Ñ‡∏•‡∏±‡∏á‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏° */
function renderInventoryUI() {
  let html = `
    <div style="display:flex;flex-direction:column;gap:7px;max-height:420px;overflow-y:auto;">
      ${inventory.length === 0 ? '<div style="color:#bbb;text-align:center;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°</div>' :
        inventory.map(item => {
          let info = findItemById(item.id) || {};
          return `
          <div style="display:flex;align-items:center;background:#272b38;padding:10px 16px;border-radius:10px;gap:19px;">
            <div style="width:36px;height:36px;border-radius:8px;background:#201624;display:flex;justify-content:center;align-items:center;">
              ${info.img ? `<img src="img/item/${info.img}" alt="${info.name}" style="width:32px;">` : "üéí"}
            </div>
            <div style="flex-grow:1;">
              <b>${info.name || item.id}</b>
              <div style="font-size:.91em;color:#84ccff;margin-top:2px;">${info.description || ''}</div>
            </div>
            <div style="color:#aaffbe;font-weight:bold;font-size:1.07em;">x${item.qty}</div>
            ${info.usable ? `<button class="primary-btn" style="padding:5px 1em 5px 1em;font-size:.96em;" onclick="useItemPrompt('${item.id}')">‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏¢</button>` : ""}
          </div>`
        }).join('')}
    </div>
  `;
  document.getElementById('inventoryArea').innerHTML = html;
}

/** ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô popup ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏° */
window.useItemPrompt = function(itemId) {
  let info = findItemById(itemId);
  window.openPopup('useItem', `
    <div style="text-align:center;">
      <img src="img/item/${info.img}" style="width:52px;margin-bottom:8px;">
      <div style="font-size:1.09em;">${info.name}</div>
      <div style="margin:.6em 0 1.1em 0;font-size:.97em;color:#7cf;">${info.description}</div>
      <button class="primary-btn" style="margin:.8em .3em 0 .3em;padding:.5em 2.1em;" onclick="useItemNow('${itemId}')">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÉ‡∏ä‡πâ‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°</button>
      <button class="secondary-btn" style="margin:.8em .3em 0 .3em;" onclick="closePopup()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
  `, 'small', `‡πÉ‡∏ä‡πâ ${info.name}`);
}

/** ‡πÉ‡∏ä‡πâ‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡∏•‡∏î qty, ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å effect, update ui) */
window.useItemNow = function(itemId) {
  let idx = inventory.findIndex(i => i.id === itemId);
  let info = findItemById(itemId);
  if (idx === -1 || !info) return;
  if (inventory[idx].qty <= 0) return;
  // Effect (mock: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï character / heal / exp ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)
  if (info.effect && info.effect.exp) {
    // ‡πÄ‡∏û‡∏¥‡πà‡∏° exp ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡πÅ‡∏£‡∏Å‡πÉ‡∏ô team (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á)
    let t = JSON.parse(localStorage.getItem('userTeam') || "[]");
    if (t.length) {
      let cid = t[0];
      let cdata = JSON.parse(localStorage.getItem("char_" + cid) || '{}');
      if (cdata) {
        cdata.exp = (cdata.exp || 0) + info.effect.exp;
        localStorage.setItem("char_" + cid, JSON.stringify(cdata));
        alert(`‡πÄ‡∏û‡∏¥‡πà‡∏° EXP ‡πÉ‡∏´‡πâ ${cdata.name} +${info.effect.exp}`);
      }
    }
  }
  // TODO: ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö heal, skillup, hp_pct, etc. ‡∏ï‡πà‡∏≠
  inventory[idx].qty--;
  if (inventory[idx].qty === 0) inventory.splice(idx, 1);
  saveInventory();
  window.closePopup();
  renderInventoryUI();
}

/** ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°‡πÄ‡∏Ç‡πâ‡∏≤ inventory */
window.addToInventory = function(itemId, qty) {
  if (!itemId || !qty) return;
  let idx = inventory.findIndex(i => i.id === itemId);
  if (idx >= 0) inventory[idx].qty += qty;
  else inventory.push({ id: itemId, qty });
  saveInventory();
}

/** ‡∏•‡∏ö‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏° (admin, debug) */
window.removeFromInventory = function(itemId, qty) {
  let idx = inventory.findIndex(i => i.id === itemId);
  if (idx >= 0) {
    inventory[idx].qty -= qty;
    if (inventory[idx].qty <= 0) inventory.splice(idx, 1);
    saveInventory();
  }
}

/** ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö popups (‡πÄ‡∏ä‡πà‡∏ô index.html, quest, shop ‡∏Ø‡∏•‡∏Ø) */
document.addEventListener('DOMContentLoaded', async () => {
  await loadItemData();
  loadInventory();
  // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° hook popup
  const showInvPopup = () => {
    window.openPopup('inventory', `
      <div id="inventoryArea"></div>
      <div style="text-align:right;"><button class="secondary-btn" onclick="closePopup()">‡∏õ‡∏¥‡∏î</button></div>
    `, 'large', "‡∏Ñ‡∏•‡∏±‡∏á‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°");
    renderInventoryUI();
  };
  let btn = document.getElementById('btnInventory');
  if (btn) btn.onclick = showInvPopup;
  // Hook ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å
  window.renderInventoryUI = renderInventoryUI;
});

/** ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API ‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ */
window.inventoryEngine = {
  load: loadInventory,
  save: saveInventory,
  add: window.addToInventory,
  remove: window.removeFromInventory,
  list: () => inventory,
  findItemById,
  reloadAll: async () => { await loadItemData(); loadInventory(); },
}

‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå data/upgrade.json
{
  "levelup": {
    "exp_required_base": 600,
    "exp_curve": 1.2,
    "exp_item": "exp_potion"
  },
  "promotion": {
    "star_max": 6,
    "requirements": [
      { "star": 3, "cost_gold": 1000, "materials": [ { "id": "rune_shard", "qty": 4 } ] },
      { "star": 4, "cost_gold": 4000, "materials": [ { "id": "rune_shard", "qty": 9 } ] },
      { "star": 5, "cost_gold": 9000, "materials": [ { "id": "rune_shard", "qty": 15 }, { "id": "heal_potion", "qty": 2 } ] }
    ]
  },
  "skillup": {
    "item": "skill_book",
    "increase_percent": 11,
    "max_lv": 6,
    "cost_gold": 700
  },
  "awaken": {
    "enabled": true,
    "require_materials": [
      { "star": 4, "materials": [ { "id": "rune_shard", "qty": 8 }, { "id": "heal_potion", "qty": 1 } ] },
      { "star": 5, "materials": [ { "id": "rune_shard", "qty": 14 }, { "id": "heal_potion", "qty": 2 } ] }
    ]
  }
}

‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå js/upgrade.js
// js/upgrade.js - Epic Seven Auto Battle - Upgrade System

let upgradeConfig = {};
let charUpgradeTarget = null;
let inventory = []; // preload via inventory.js

/** ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• config ‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏à‡∏≤‡∏Å /data/upgrade.json */
async function loadUpgradeConfig() {
  if (Object.keys(upgradeConfig).length) return;
  upgradeConfig = await fetch('data/upgrade.json').then(r => r.json());
}

/** Render ‡∏õ‡πä‡∏≠‡∏õ‡∏≠‡∏±‡∏õ‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ ‡πÇ‡∏ä‡∏ß‡πå stat + ‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏õ‡πÄ‡∏•‡πÄ‡∏ß‡∏•/‡∏≠‡∏±‡∏õ‡∏™‡∏Å‡∏¥‡∏•/‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡∏±‡πâ‡∏ô */
async function openUpgradePopup(characterId) {
  await loadUpgradeConfig();
  await window.inventoryEngine.reloadAll();
  let char = JSON.parse(localStorage.getItem('char_' + characterId)
               || localStorage.getItem('char_' + characterId.replace('_', ''))
               || '{}');
  if (!char || !char.id) {
    alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏ô‡∏µ‡πâ");
    return;
  }
  charUpgradeTarget = char; // export ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö event ‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å

  // Render main popup
  let html = `
    <div style="display:flex;flex-direction:column;align-items:center;gap:10px;">
      <img src="img/char/${char.img}" style="width:72px;border-radius:15px;box-shadow:0 0 22px #1defeb66;">
      <div style="font-size:1.18em;font-weight:bold;">${char.name}</div>
      <div>Lv. <b>${char.level}</b> <span style="color:#ffe480;">‚òÖ${char.star}</span>
          / <b>EXP</b> ${char.exp}/${char.exp_max || '?'}
      </div>
      <div style="color:#87c7ff;">HP <b>${char.hp}</b> | ATK <b>${char.atk}</b> | DEF <b>${char.def}</b> | SPD <b>${char.spd}</b></div>
      <hr style="width:88%; border:1px solid #234">
      <div style="display:flex;gap:12px;">
        <button class="primary-btn" onclick="doLevelUpChar('${char.id}')">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏•‡πÄ‡∏ß‡∏•</button>
        <button class="primary-btn" onclick="doSkillUpChar('${char.id}')">‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏™‡∏Å‡∏¥‡∏•</button>
        <button class="primary-btn" onclick="doPromoteChar('${char.id}')">‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡∏±‡πâ‡∏ô/‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏î‡∏≤‡∏ß</button>
      </div>
      <button class="secondary-btn" onclick="closePopup()">‡∏õ‡∏¥‡∏î</button>
    </div>
  `;
  window.openPopup('upgradePopup', html, 'large', '‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£');
}

/** ‡∏≠‡∏±‡∏õ‡πÄ‡∏•‡πÄ‡∏ß‡∏• (‡πÉ‡∏ä‡πâ exp_potion ‡πÑ‡∏î‡πâ‡∏Å‡πà‡∏≠‡∏ô, ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÑ‡∏î‡πâ) */
window.doLevelUpChar = function (charId) {
  let char = JSON.parse(localStorage.getItem('char_' + charId));
  if (!char) return;
  let expItem = upgradeConfig.levelup.exp_item;
  let inv = window.inventoryEngine.list();
  let owned = inv.find(i => i.id === expItem);
  if (!owned || owned.qty <= 0) {
    alert("‡πÑ‡∏°‡πà‡∏°‡∏µ EXP Potion ‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á");
    return;
  }
  // EXP ‡πÄ‡∏û‡∏¥‡πà‡∏°
  let expAdd = 500;
  char.exp = (char.exp || 0) + expAdd;
  let lvled = false;
  while (char.exp >= (char.exp_max || 99999)) {
    char.exp -= char.exp_max;
    char.level = (char.level || 1) + 1;
    lvled = true;
  }
  if (lvled) alert("Level UP!");
  // ‡πÄ‡∏û‡∏¥‡πà‡∏° status ‡∏ó‡∏∏‡∏Å‡πÄ‡∏•‡πÄ‡∏ß‡∏• (‡∏™‡∏π‡∏ï‡∏£ basic -- ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏¢‡∏á config/curve ‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ)
  char.hp = Math.round(char.hp * 1.085);
  char.atk = Math.round(char.atk * 1.08);
  char.def = Math.round(char.def * 1.09);
  localStorage.setItem('char_' + char.id, JSON.stringify(char));
  window.inventoryEngine.remove(expItem, 1);
  openUpgradePopup(char.id);
};

/** ‡∏≠‡∏±‡∏õ‡∏™‡∏Å‡∏¥‡∏• (‡πÉ‡∏ä‡πâ skill_book, ‡πÄ‡∏û‡∏¥‡πà‡∏° multiplier, ‡∏•‡∏î‡∏Ñ‡∏π‡∏•‡∏î‡∏≤‡∏ß‡∏ô‡πå) */
window.doSkillUpChar = function (charId) {
  let char = JSON.parse(localStorage.getItem('char_' + charId));
  if (!char) return;
  let inv = window.inventoryEngine.list();
  let skillBookItem = upgradeConfig.skillup.item;
  let owned = inv.find(i => i.id === skillBookItem);
  if (!owned || owned.qty <= 0) { alert("‡πÑ‡∏°‡πà‡∏°‡∏µ Skill Book ‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á"); return; }
  // Pick skill to up (‡∏™‡∏∏‡πà‡∏° 1 skill)
  let skills = char.skills || [];
  if (!skills.length) { alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏Å‡∏¥‡∏•‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î"); return; }
  let idx = Math.floor(Math.random() * skills.length);
  let sk = skills[idx];
  // ‡πÄ‡∏û‡∏¥‡πà‡∏° multiplier ‡πÅ‡∏•‡∏∞‡∏•‡∏î cooldown ‡∏ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ
  if (sk.multiplier)
    sk.multiplier = +(sk.multiplier + upgradeConfig.skillup.increase_percent/100).toFixed(2);
  if (sk.cooldown && sk.cooldown > 1)
    sk.cooldown = Math.max(1, sk.cooldown - 1);
  char.skills[idx] = sk;
  localStorage.setItem('char_' + char.id, JSON.stringify(char));
  window.inventoryEngine.remove(skillBookItem, 1);
  alert(`‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î Skill "${sk.name}" ‡πÉ‡∏´‡πâ‡πÅ‡∏£‡∏á‡∏Ç‡∏∂‡πâ‡∏ô!`);
  openUpgradePopup(char.id);
};

/** ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡∏±‡πâ‡∏ô/Promotion ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏î‡∏≤‡∏ß (‡πÉ‡∏ä‡πâ gold+materials) */
window.doPromoteChar = function (charId) {
  let char = JSON.parse(localStorage.getItem('char_' + charId));
  if (!char) return;
  let starNext = (char.star || 1) + 1;
  let prom = upgradeConfig.promotion.requirements.find(r => r.star === char.star);
  if (!prom) { alert("‡∏î‡∏≤‡∏ß‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß"); return; }
  // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ç‡∏≠‡∏á
  let inv = window.inventoryEngine.list();
  let gold = inv.find(i => i.id === 'gold');
  if (!gold || gold.qty < prom.cost_gold) {
    alert("Gold ‡πÑ‡∏°‡πà‡∏û‡∏≠");
    return;
  }
  let enough = prom.materials.every(mat =>
    inv.find(i => i.id === mat.id && i.qty >= mat.qty));
  if (!enough) { alert("‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÑ‡∏°‡πà‡∏û‡∏≠"); return; }
  // ‡∏´‡∏±‡∏Å‡∏Ç‡∏≠‡∏á
  window.inventoryEngine.remove('gold', prom.cost_gold);
  prom.materials.forEach(mat => window.inventoryEngine.remove(mat.id, mat.qty));
  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏î‡∏≤‡∏ß+‡∏≠‡∏±‡∏õ stat
  char.star = starNext;
  char.hp = Math.floor(char.hp * 1.20);
  char.atk = Math.floor(char.atk * 1.15);
  char.def = Math.floor(char.def * 1.12);
  localStorage.setItem('char_' + char.id, JSON.stringify(char));
  alert("‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏î‡∏≤‡∏ß‡πÉ‡∏´‡∏°‡πà: " + char.star);
  openUpgradePopup(char.id);
};

// ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° event ‡∏Å‡∏±‡∏ö popup
document.addEventListener('DOMContentLoaded', () => {
  // Hook ‡∏Å‡∏±‡∏ö characterCollection
  window.upgradeCharPopup = openUpgradePopup;
  // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏≤‡∏Å‡∏Ñ‡∏•‡∏±‡∏á‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:
  let area = document.getElementById('characterArea');
  if (area) area.addEventListener('click', e => {
    let target = e.target.closest('[data-upgrade]');
    if (target) openUpgradePopup(target.dataset.upgrade);
  });
});

// Expose ‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å
window.upgradeEngine = {
  open: openUpgradePopup,
  reloadConfig: loadUpgradeConfig
};

‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå data/rune.json
[
  {
    "id": "spd_rare",
    "name": "Speed Rune",
    "slot": 2,
    "main_stat": { "type": "spd", "val": 25 },
    "sub_stats": [
      { "type": "atk_pct", "val": 7 },
      { "type": "def", "val": 16 }
    ],
    "set": "speed",
    "rarity": 4,
    "icon": "üí®"
  },
  {
    "id": "atk_pure",
    "name": "Attack Rune",
    "slot": 1,
    "main_stat": { "type": "atk_pct", "val": 15 },
    "sub_stats": [
      { "type": "spd", "val": 5 }
    ],
    "set": "rage",
    "rarity": 3,
    "icon": "‚öîÔ∏è"
  },
  {
    "id": "crit_big",
    "name": "Critical Rune",
    "slot": 4,
    "main_stat": { "type": "crit_pct", "val": 12 },
    "sub_stats": [
      { "type": "atk_pct", "val": 6 },
      { "type": "spd", "val": 7 },
      { "type": "effectiveness", "val": 4 }
    ],
    "set": "critical",
    "rarity": 5,
    "icon": "üéØ"
  },
  {
    "id": "def_basic",
    "name": "Defense Rune",
    "slot": 3,
    "main_stat": { "type": "def_pct", "val": 10 },
    "sub_stats": [],
    "set": "defend",
    "rarity": 2,
    "icon": "üõ°Ô∏è"
  },
  {
    "set_bonuses": {
      "speed":    { "slot_required": 2, "bonus": { "spd": 25 },        "desc": "Speed +25%"  },
      "rage":     { "slot_required": 4, "bonus": { "atk_pct": 35 },     "desc": "ATK +35%"    },
      "critical": { "slot_required": 2, "bonus": { "crit_pct": 12 },    "desc": "Crit +12%"   },
      "defend":   { "slot_required": 2, "bonus": { "def_pct": 15 },     "desc": "DEF +15%"    }
    }
  }
]

‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå js/rune.js
// js/rune.js
let runeData = [];
let runeSetBonuses = {};
let userRunes = [];    // ‡∏£‡∏π‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô inventory (id,unlock,slot ‡∏Ø‡∏•‡∏Ø)
let equippedRunes = {}; // { char_id: [slot1, slot2, slot3, slot4] }
let currentCharEquip = null;   // ‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏ß‡∏°‡πÉ‡∏™‡πà

// ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏π‡∏ô‡∏à‡∏≤‡∏Å data/rune.json
async function loadRuneData() {
  if (runeData.length) return;
  let arr = await fetch('data/rune.json').then(r => r.json());
  runeData = arr.filter(x => !x.set_bonuses);
  runeSetBonuses = arr.find(x => x.set_bonuses)?.set_bonuses || {};
}

// ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏ô‡∏Ç‡∏≠‡∏á user (‡∏à‡∏≤‡∏Å localStorage)
function loadUserRunes() {
  userRunes = JSON.parse(localStorage.getItem('user_runes') || "[]");
  equippedRunes = JSON.parse(localStorage.getItem('equipped_runes') || "{}");
}

// ‡πÄ‡∏ã‡∏ü‡∏£‡∏π‡∏ô‡∏Å‡∏•‡∏±‡∏ö localStorage
function saveUserRunes() {
  localStorage.setItem('user_runes', JSON.stringify(userRunes));
  localStorage.setItem('equipped_runes', JSON.stringify(equippedRunes));
}

// UI - render pop-up ‡∏™‡∏ß‡∏°‡πÉ‡∏™‡πà‡∏£‡∏π‡∏ô
async function openRuneEquipPopup(char_id) {
  await loadRuneData(); loadUserRunes();
  currentCharEquip = char_id;
  // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° grid ‡∏ä‡πà‡∏≠‡∏á/‡∏£‡∏π‡∏ô
  let charRunes = equippedRunes[char_id] || [null, null, null, null];
  let runeSlotHtml = '';
  for (let slot = 1; slot <= 4; slot++) {
    let runeId = charRunes[slot - 1];
    let ru = runeData.find(r => r.id === runeId);
    runeSlotHtml += `<div style="border:1px solid #348ac9;border-radius:10px;padding:8px 7px;min-width:96px;min-height:65px;margin:3px 0;">
      <b>‡∏ä‡πà‡∏≠‡∏á ${slot}:</b> ${ru ?
        `<span title="${ru.name}" style="font-size:1.2em;vertical-align:middle;">${ru.icon ?? 'üî∏'}</span> 
        <span style="color:#7df;font-weight:600;">${ru.name}</span>
        <button class="secondary-btn" style="font-size:.96em;padding:.1em .8em;margin-left:4px;" onclick="unequipRune(${slot})">‡∏ñ‡∏≠‡∏ô</button>
        <div style="font-size:0.88em;color:#acfc94;margin-top:4px;">${mainStatText(ru.main_stat)} ${ru.sub_stats.map(mainStatText).join(', ')}</div>`
        : `<span style="color:#888;">‡∏ß‡πà‡∏≤‡∏á</span>
          <button class="primary-btn" style="font-size:.9em;" onclick="showSelectRune(${slot})">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏ô</button>`
      }
      </div>`;
  }
  const setBuffHtml = renderSetBonus(charRunes);
  const html = `
    <div style="display:flex;flex-direction:column;gap:7px;">
      <h3>‡∏£'‡∏∏‡∏ô‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏ô‡∏µ‡πâ</h3>
      ${runeSlotHtml}
      ${setBuffHtml}
      <button class="secondary-btn" onclick="closePopup()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î</button>
    </div>`;
  window.openPopup('runeEquip', html, 'large', '‡∏™‡∏ß‡∏°‡πÉ‡∏™‡πà‡∏£‡∏π‡∏ô');
}

// Render set buff ‡∏£‡∏ß‡∏° (‡∏ñ‡πâ‡∏≤‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡∏£‡∏ö)
function renderSetBonus(runeIdArr) {
  let sets = {}, slots = {};
  runeIdArr.forEach(id => {
    let r = runeData.find(a => a.id === id);
    if (r) {
      sets[r.set] = (sets[r.set] || 0) + 1;
      slots[r.slot] = 1;
    }
  });
  let buffHtml = '';
  Object.keys(sets).forEach(set => {
    const cfg = runeSetBonuses[set];
    if (cfg && sets[set] >= cfg.slot_required) {
      buffHtml += `<div style="background:#22442b;margin:13px 0;padding:7px 9px;border-radius:7px;">
          <span style="font-size:1.16em;">${cfg.desc}</span> <b style="color:#66e0ca;">(‡∏Ñ‡∏£‡∏ö‡πÄ‡∏ã‡πá‡∏ï!)</b>
        </div>`;
    }
  });
  return buffHtml ? `<div style="margin-top:14px;">${buffHtml}</div>` : '';
}

// ‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏î‡∏£‡∏π‡∏ô‡∏Å‡∏±‡∏ö‡∏ä‡πà‡∏≠‡∏á
window.showSelectRune = function(slot) {
  // ‡πÅ‡∏™‡∏î‡∏á pop-up ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á ‚Äú‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏™‡πà‡πÉ‡∏Ñ‡∏£‚Äù
  let avai = userRunes.filter(r => !Object.values(equippedRunes)
                        .flat().includes(r.rune_id) && runeData.find(x => x.id === r.rune_id)?.slot === slot);
  let html = avai.length
      ? avai.map(r => {
          let d = runeData.find(x => x.id === r.rune_id);
          return `<div style="display:flex;align-items:center;gap:9px;">
            <span style="font-size:1.3em;">${d.icon ?? 'üî∏'}</span>
            <b>${d.name}</b> <span style="font-size:0.93em;color:#d2ffee;">${mainStatText(d.main_stat)}</span>
            <button class="primary-btn" onclick="equipRuneSlot('${r.rune_id}',${slot})">‡πÉ‡∏™‡πà</button>
          </div>`;
        }).join('<hr style="margin:2px 0;">')
      : `<div style="color:#fda;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ</div>`;
  window.openPopup('selectRune', html, 'small', `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏ô ‡∏ä‡πà‡∏≠‡∏á ${slot}`);
};

// ‡πÄ‡∏™‡∏£‡∏¥‡∏°-helper
function mainStatText(stat) {
  if (!stat) return "";
  const lib = { spd: 'SPD', atk_pct: 'ATK%', def: 'DEF', def_pct: 'DEF%', crit_pct: 'CRIT%', effectiveness: 'EFF' };
  return (lib[stat.type] || stat.type) + " +" + stat.val;
}

// ‡πÉ‡∏™‡πà‡∏£‡∏π‡∏ô‡∏•‡∏á slot
window.equipRuneSlot = function(rune_id, slot) {
  let charRunes = equippedRunes[currentCharEquip] || [null,null,null,null];
  charRunes[slot - 1] = rune_id;
  equippedRunes[currentCharEquip] = charRunes;
  saveUserRunes();
  closePopup('selectRune'); // ‡∏õ‡∏¥‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏ô
  openRuneEquipPopup(currentCharEquip);
};
// ‡∏ñ‡∏≠‡∏ô‡∏£‡∏π‡∏ô (‡∏ä‡πà‡∏≠‡∏á)
window.unequipRune = function(slot) {
  let charRunes = equippedRunes[currentCharEquip] || [null,null,null,null];
  charRunes[slot - 1] = null;
  equippedRunes[currentCharEquip] = charRunes;
  saveUserRunes();
  openRuneEquipPopup(currentCharEquip);
};

// ‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏£‡∏π‡∏ô (‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö) - ‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏™‡∏∏‡πà‡∏° (Mock)
window.upgradeRune = function(rune_id) {
  // ‡∏à‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î + ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö (mock)
  alert("= Demo = ‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏±‡∏õ‡πÄ‡∏•‡πÄ‡∏ß‡∏•‡∏£‡∏π‡∏ô " + rune_id + " ‡πÅ‡∏•‡πâ‡∏ß (mock)");
};


/* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°: export ‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° */
window.runeEngine = {
  openEquipPopup: openRuneEquipPopup,
  getEquipped: function(char_id) { loadUserRunes(); return equippedRunes[char_id] || [null,null,null,null]; },
  getUserRunes: function() { loadUserRunes(); return userRunes; },
  addRune: function(rune_id) { userRunes.push({ rune_id }); saveUserRunes(); },
  removeRune: function(rune_id) { userRunes = userRunes.filter(r => r.rune_id !== rune_id); saveUserRunes(); }
};

// Hook DOM ‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ (‡πÄ‡∏ä‡πà‡∏ô‡∏õ‡∏∏‡πà‡∏°)
document.addEventListener('DOMContentLoaded', async () => {
  await loadRuneData(); loadUserRunes();
  // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏°: <button data-equiprune="cid">‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏π‡∏ô</button>
  if (document.getElementById('characterArea')) {
    document.getElementById('characterArea').addEventListener('click', e => {
      const btn = e.target.closest('[data-equiprune]');
      if (btn) openRuneEquipPopup(btn.getAttribute('data-equiprune'));
    });
  }
});

‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå data/gacha.json
{
  "gachas": [
    {
      "id": "premium_summon",
      "name": "Premium Gacha",
      "type": "normal",
      "enabled": true,
      "cost": { "item": "diamond", "amount": 50 },
      "pool": [
        { "char_id": "astra", "rarity": 5, "rate": 5 },
        { "char_id": "slime_basic", "rarity": 3, "rate": 95 }
      ],
      "pity": { "enabled": true, "max": 20, "guarantee_rarity": 5 },
      "banner_img": "gacha_premium.png",
      "desc": "‡∏™‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏π‡∏á\n‡∏¢‡∏¥‡πà‡∏á‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏¢‡∏≠‡∏∞‡∏¢‡∏¥‡πà‡∏á‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÑ‡∏î‡πâ ‚òÖ5!"
    },
    {
      "id": "event_summon_may2024",
      "name": "May 2024 Event",
      "type": "event",
      "enabled": false,
      "cost": { "item": "ticket_event", "amount": 1 },
      "pool": [
        { "char_id": "astra", "rarity": 5, "rate": 10 },
        { "char_id": "slime_basic", "rarity": 3, "rate": 90 }
      ],
      "pity": { "enabled": false },
      "banner_img": "gacha_event_may2024.png",
      "desc": "‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏¥‡∏à - ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡πã‡∏ß Event ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô"
    }
  ]
}

‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå js/gacha.js
// js/gacha.js - ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏ä‡∏≤ Epic Seven Clone Frontend

let gachaList = [];
let gachaUserLog = [];
let gachaPity = {}; // {gachaId: <count>}

// ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏ä‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
async function loadGachaData() {
    if (gachaList.length) return;
    const res = await fetch('data/gacha.json').then(r => r.json());
    gachaList = res.gachas;
}

// ‡πÇ‡∏´‡∏•‡∏î log ‡∏Å‡∏≤‡∏ä‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
function loadGachaUserLog() {
    gachaUserLog = JSON.parse(localStorage.getItem('gacha_user_log') || '[]');
    gachaPity = JSON.parse(localStorage.getItem('gacha_pity') || '{}');
}
// ‡πÄ‡∏ã‡∏ü log/pity
function saveGachaLog() {
    localStorage.setItem('gacha_user_log', JSON.stringify(gachaUserLog));
    localStorage.setItem('gacha_pity', JSON.stringify(gachaPity));
}

// Render popup UI
async function openGachaPopup() {
    await loadGachaData(); loadGachaUserLog();
    // Render ‡∏ó‡∏∏‡∏Å‡∏Å‡∏≤‡∏ä‡∏≤‡∏ó‡∏µ‡πà enabled
    let avai = gachaList.filter(g => g.enabled);
    if (!avai.length) {
        window.openPopup('gacha', `<div>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏≤‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div><button class="secondary-btn" onclick="closePopup()">‡∏õ‡∏¥‡∏î</button>`, 'large', '‡∏Å‡∏≤‡∏ä‡∏≤');
        return;
    }
    // Render banner + ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏∏‡πà‡∏°
    let html = avai.map(g => `
        <div style="background:#1b232e;padding:24px 1.5em;border-radius:18px;margin-bottom:24px;text-align:center;box-shadow:0 2px 18px #278ddf18;">
            <img src="img/gacha/${g.banner_img || 'noimg.png'}" style="width:100%;min-width:210px;max-width:330px;border-radius:9px;margin-bottom:7px;box-shadow:0 1px 40px #35cfff23;">
            <div style="font-size:1.14em;color:#7ffbfb;font-weight:600;margin-bottom:4px;">${g.name}</div>
            <div style="color:#aef;margin-bottom:1em;">${g.desc || ''}</div>
            <div style="font-size:.95em;margin-bottom:1em;"><b>‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢: </b>
                <span style="color:goldenrod;font-weight:bold;">${g.cost.amount}</span> 
                <img src="img/item/${g.cost.item}.png" style="width:19px;vertical-align:middle;" />
            </div>
            <div><button class="primary-btn" onclick="gachaSummon('${g.id}',1)">‡∏™‡∏∏‡πà‡∏° 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
            <button class="primary-btn" onclick="gachaSummon('${g.id}',10)">‡∏™‡∏∏‡πà‡∏° 10 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button></div>
            <div style="margin-top:18px;font-size:.9em;">
                <a href="#" onclick="openGachaLogPopup('${g.id}');return false;" style="color:#85deff;text-decoration:underline;">‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡πà‡∏°</a>
                ${g.pity?.enabled ? `<span style="margin-left:2em;color:#ffa;">Pity: ${gachaPity[g.id]||0}/${g.pity.max}</span>` : ''}
            </div>
        </div>
    `).join('');
    window.openPopup('gacha', html, 'large', '‡∏Å‡∏≤‡∏ä‡∏≤');
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏∏‡πà‡∏° gacha ([‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°])
window.gachaSummon = async function(gachaId, times = 1) {
    await loadGachaData(); loadGachaUserLog();
    let g = gachaList.find(x => x.id === gachaId); if (!g) return;
    // ‡∏ï‡∏£‡∏ß‡∏à inventory
    let inv = window.inventoryEngine?.list();
    let currency = inv?.find(i => i.id === g.cost.item);
    if (!currency || currency.qty < g.cost.amount * times) {
        alert(`‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ ${g.cost.item} ‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠`);
        return;
    }
    // loop draw
    let poolFlat = [];
    g.pool.forEach(entry => {
        for (let i = 0; i < entry.rate; i++) poolFlat.push(entry.char_id);
    });
    let got = [], pityFlag = false;
    for (let t = 0; t < times; t++) {
        let pity = (g.pity?.enabled ? gachaPity[g.id] || 0 : 0);
        let pick;
        // pity trigger
        if (g.pity?.enabled && g.pity.max && pity+1 >= g.pity.max) {
            pick = g.pool.find(c => c.rarity === g.pity.guarantee_rarity)?.char_id || poolFlat[0];
            gachaPity[g.id] = 0;
            pityFlag = true;
        } else {
            pick = poolFlat[Math.floor(Math.random() * poolFlat.length)];
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ï‡∏≤‡∏° pity reset
            let card = g.pool.find(c => c.char_id === pick);
            if (g.pity?.enabled) {
                if(card && card.rarity === g.pity.guarantee_rarity) gachaPity[g.id] = 0;
                else gachaPity[g.id] = (gachaPity[g.id] || 0) + 1;
            }
        }
        got.push(pick);
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏•‡∏±‡∏á (characterCollection / LocalStorage)
        window.collectCharacter?.(pick);
        // Log
        gachaUserLog.push({
            time: Date.now(),
            char: pick,
            gacha_id: g.id,
            rarity: g.pool.find(c => c.char_id === pick)?.rarity || 3
        });
    }
    // ‡∏´‡∏±‡∏Å‡∏ó‡∏∏‡∏ô
    window.inventoryEngine.remove(g.cost.item, g.cost.amount * times);
    saveGachaLog();
    // Show animation/result popup
    openGachaResult(g, got, pityFlag);
};

// Add character (‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏•‡∏±‡∏á ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ)
window.collectCharacter = function(charId) {
    // ‡πÄ‡∏≠‡∏≤‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏•‡∏á localStorage/char_collection
    let chars = JSON.parse(localStorage.getItem('char_collection') || '[]');
    if(!chars.includes(charId)) chars.push(charId);
    localStorage.setItem('char_collection', JSON.stringify(chars));
}

// ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏ä‡∏≤ (animation‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ + ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£)
function openGachaResult(gacha, resultArr, pityFlag) {
    let html = `<div style="text-align:center;">
        <div style="font-size:1.7em;margin-bottom:6px;">üé¥ Gacha Result</div>
        <div style="color:#fcc;${pityFlag ? 'font-weight:bold;' : ''}">${pityFlag ? 'Pity Triggerd! ‡∏Å‡∏≤‡∏£‡∏±‡∏ô‡∏ï‡∏µ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î!' : ''}</div>
        <div style="display:flex;justify-content:center;gap:13px;flex-wrap:wrap;margin-top:1em;">` +
        resultArr.map(cid => {
            let imgSrc = `img/char/${cid}.png`;
            return `<div style="background:#223352;border:2px solid #35aaffb7;border-radius:13px;padding:8px 12px;display:flex;flex-direction:column;align-items:center;min-width:93px;">
                <img src="${imgSrc}" style="width:58px;margin-bottom:8px;border-radius:10px;box-shadow:0 0 17px #27508080;" />
                <b style="color:#aef;">${cid}</b>
            </div>`;
        }).join('') +
        `</div>
        <div style="margin-top:18px;">
            <button class="primary-btn" onclick="closePopup();openGachaPopup();">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏ä‡∏≤</button>
        </div>
    </div>`;
    window.openPopup('gachaResult', html, 'large', '‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏ä‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
}

// ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏ä‡∏≤
window.openGachaLogPopup = function(gachaId) {
    loadGachaUserLog();
    let logs = gachaUserLog.filter(x => x.gacha_id === gachaId).slice(-30).reverse();
    let html = logs.length ? `<div style="max-height:300px;overflow-y:auto;"><table style="width:100%;">
        <tr style="color:#aae;"><th>#</th><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏ú‡∏•‡∏™‡∏∏‡πà‡∏°</th><th>Rarity</th></tr>
        ${logs.map((l,i) => `<tr>
            <td>${i+1}</td>
            <td>${(new Date(l.time)).toLocaleString()}</td>
            <td>${l.char}</td>
            <td><span style="color:${l.rarity>=5?'gold':'#fff'};">‚òÖ${l.rarity}</span></td>
        </tr>`).join('')}
        </table></div>` : `<div style="text-align:center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏ä‡∏≤</div>`;
    window.openPopup('gachaLog'+gachaId, html, 'large', "‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏ä‡∏≤");
}

// auto hook ‡∏õ‡∏∏‡πà‡∏°
document.addEventListener('DOMContentLoaded', () => {
    let btn = document.getElementById('btnGacha');
    if(btn) btn.onclick = openGachaPopup;
});

// ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö/admin ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å
window.gachaEngine = {
    open: openGachaPopup,
    log: openGachaLogPopup,
    summon: window.gachaSummon
};

‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå data/stage/chapter1.json
{
  "id": "chapter1",
  "name": "‡∏´‡∏∏‡∏ö‡πÄ‡∏Ç‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô",
  "desc": "‡∏à‡∏∏‡∏î‡∏Å‡∏≥‡πÄ‡∏ô‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏à‡∏ç‡∏†‡∏±‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ô‡πÇ‡∏•‡∏Å‡∏™‡∏∏‡∏î‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢",
  "zones": [
    {
      "id": "zone1",
      "name": "‡∏ó‡∏∏‡πà‡∏á‡∏ù‡∏∂‡∏Å‡∏ù‡∏ô",
      "stages": [
        {
          "id": "stage1",
          "name": "‡∏ó‡∏≤‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏∏‡∏ö‡πÄ‡∏Ç‡∏≤",
          "desc": "‡∏™‡∏π‡πâ‡∏Å‡∏±‡∏ö Slime ‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å! ‡∏ù‡∏∂‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ",
          "require_energy": 5,
          "waves": [
            {
              "wave_no": 1,
              "enemies": [
                { "id": "slime_basic", "level": 1 }
              ]
            }
          ],
          "unlocked_by": null,
          "drops": [
            { "id": "exp_potion", "min": 1, "max": 1, "rate": 80 },
            { "id": "gold", "min": 150, "max": 300, "rate": 100 }
          ],
          "exp_reward": 25,
          "recommended_level": 1
        },
        {
          "id": "stage2",
          "name": "‡∏™‡∏∞‡∏û‡∏≤‡∏ô‡πÇ‡∏ö‡∏£‡∏≤‡∏ì",
          "desc": "‡∏ú‡πà‡∏≤‡∏ô Slime ‡∏´‡∏•‡∏≤‡∏¢‡∏ï‡∏±‡∏ß ‡∏™‡∏π‡πà‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏∂‡∏Å",
          "require_energy": 7,
          "waves": [
            {
              "wave_no": 1,
              "enemies": [
                { "id": "slime_basic", "level": 2 },
                { "id": "slime_basic", "level": 2 }
              ]
            }
          ],
          "unlocked_by": "stage1",
          "drops": [
            { "id": "exp_potion", "min": 1, "max": 2, "rate": 70 },
            { "id": "gold", "min": 170, "max": 350, "rate": 100 }
          ],
          "exp_reward": 32,
          "recommended_level": 2
        },
        {
          "id": "stage3",
          "name": "‡∏™‡∏ô‡∏≤‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö",
          "desc": "‡∏°‡∏≠‡∏ô‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏Å‡∏•‡∏∏‡πà‡∏° ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡πâ‡∏≤‡∏ó‡∏≤‡∏¢‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô",
          "require_energy": 9,
          "waves": [
            {
              "wave_no": 1,
              "enemies": [
                { "id": "slime_basic", "level": 3 },
                { "id": "slime_basic", "level": 3 }
              ]
            },
            {
              "wave_no": 2,
              "enemies": [
                { "id": "slime_basic", "level": 4 },
                { "id": "slime_basic", "level": 4 }
              ]
            }
          ],
          "unlocked_by": "stage2",
          "drops": [
            { "id": "exp_potion", "min": 2, "max": 2, "rate": 100 },
            { "id": "rune_shard", "min": 1, "max": 1, "rate": 40 }
          ],
          "exp_reward": 48,
          "recommended_level": 3
        }
      ]
    }
  ]
}

‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå js/stage.js
// js/stage.js - ‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡∏±‡∏ô‡πÄ‡∏à‡∏µ‡πâ‡∏¢‡∏ô Stage/Map (Frontend Only)
// Author: (Your Name)
/*
‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà:
- ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà/‡∏î‡∏±‡∏ô‡πÄ‡∏à‡∏µ‡πâ‡∏¢‡∏ô‡∏à‡∏≤‡∏Å data/stage/*.json
- render UI map (‡πÄ‡∏õ‡πá‡∏ô popup) ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å chapter/zone/stage
- lock/unlock stage ‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç
- ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å battleEngine
- ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ energy
*/

let chapterData = []; // ‡∏ö‡∏ó‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÇ‡∏´‡∏•‡∏î async)
let stageProgress = {}; // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤ stage

// ‡πÇ‡∏´‡∏•‡∏î progress ‡∏à‡∏≤‡∏Å localStorage (‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß, unlock)
function loadStageProgress() {
    try {
        stageProgress = JSON.parse(localStorage.getItem('stage_progress') || '{}');
    } catch { stageProgress = {}; }
}

// ‡πÄ‡∏ã‡∏ü progress
function saveStageProgress() {
    localStorage.setItem('stage_progress', JSON.stringify(stageProgress));
}

// ‡πÇ‡∏´‡∏•‡∏î chapter ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (mock: ‡∏ó‡∏≥‡πÅ‡∏Ñ‡πà 1 file ‡∏Å‡πà‡∏≠‡∏ô)
async function loadChapters() {
    chapterData = [];
    // ‡πÉ‡∏ô production, ‡∏≠‡∏≤‡∏à fetch ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏ó‡∏à‡∏≤‡∏Å summary json
    let ch = await fetch('data/stage/chapter1.json').then(r => r.json());
    chapterData.push(ch);
}

// Render popup ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Stage (pop-up ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
async function openStageMapPopup() {
    await loadChapters();
    loadStageProgress();
    let html = '';
    chapterData.forEach(chap => {
        html += `<div style="border:2px solid #294c70;padding:18px 18px 11px 18px;margin:18px 0 0 0;border-radius:15px;background:#202d3a;">
        <h3 style="color:#7ce1ff;">${chap.name}</h3>
        <div style="font-size:.97em;color:#aad;">${chap.desc || ""}</div>
        ${chap.zones.map(zone => `
            <div style="margin-top:13px;">
                <b style="color:#ffe78c">${zone.name}</b>
                <div style="display:flex;gap:17px;margin-top:9px;">
                ${zone.stages.map(s => {
                    let unlocked = !s.unlocked_by || stageProgress[s.unlocked_by];
                    let cleared = stageProgress[s.id];
                    return `<div style="border:1.5px solid #233d7f;background:${cleared?'#25462c':'#24344b'};border-radius:14px;min-width:128px;padding:14px 8px 10px 8px;position:relative;opacity:${unlocked?1:.35};">
                            <b>${s.name}</b>
                            ${cleared?'<span style="color:#6df;font-size:.95em">‚úì ‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>':''}
                            <div style="font-size:.92em;color:#acffc3;">Energy: ${s.require_energy}</div>
                            <div style="font-size:.88em;color:#aad;margin-bottom:6px;">${s.desc}</div>
                            <button class="primary-btn" style="padding:4px 1.1em;font-size:.97em" 
                                ${unlocked ? `onclick="startStageBattle('${chap.id}','${zone.id}','${s.id}')"` : 'disabled'}>
                                ${cleared?'‡πÄ‡∏•‡πà‡∏ô‡∏ã‡πâ‡∏≥':'‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡πà‡∏≤‡∏ô'}
                            </button>
                        </div>`;
                }).join('')}
                </div>
            </div>
        `).join('')}
        </div>`;
    });
    html += `<div style="text-align:right;"><button class="secondary-btn" onclick="closePopup()">‡∏õ‡∏¥‡∏î</button></div>`;
    window.openPopup('stageMap', html, 'large', "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏±‡∏ô‡πÄ‡∏à‡∏µ‡πâ‡∏¢‡∏ô");
}

// Event - ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Stage
window.startStageBattle = async function (chapterId,zoneId,stageId) {
    // ‡πÇ‡∏´‡∏•‡∏î stage data
    let chapter = chapterData.find(ch => ch.id === chapterId);
    if(!chapter) return;
    let zone = chapter.zones.find(z => z.id === zoneId);
    if(!zone) return;
    let stage = zone.stages.find(s => s.id === stageId);
    if(!stage) return;

    // Check energy
    let energy = Number(localStorage.getItem("user_energy") || 0);
    if(energy < stage.require_energy){
        alert("Energy ‡πÑ‡∏°‡πà‡∏û‡∏≠!");
        return;
    }
    // ‡∏•‡∏î energy
    energy -= stage.require_energy;
    localStorage.setItem("user_energy",energy);

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å battle engine - Setup enemy ‡∏à‡∏≤‡∏Å waves
    // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡∏ï‡∏±‡πâ‡∏á monsters global
    window.prepareBattleFromStage(stage);

    // ‡∏õ‡∏¥‡∏î popup map, ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ô‡∏≤‡∏°‡∏£‡∏ö
    closePopup();
    document.getElementById('mainBattlefield').classList.remove('hide'); // show battlefield
    // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏° battle
    setTimeout(() => {
        if (window.battleEngine && window.battleEngine.startBattle) {
            window.battleEngine.startBattle();
        }
    }, 777); // ‡πÉ‡∏´‡πâ animation UI ‡∏ó‡∏±‡∏ô
}

// ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° data ‡∏ù‡∏±‡πà‡∏á‡∏°‡∏≠‡∏ô‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏à‡∏≤‡∏Å stage (wave 1 ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô, ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡πà‡∏≠‡∏¢‡∏≠‡∏î‡πÄ‡∏ß‡∏ü)
window.prepareBattleFromStage = function(stage) {
    // Fix: ‡∏£‡∏±‡∏ö‡πÅ‡∏Ñ‡πà wave 1 (‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï loop wave)
    if (!stage || !stage.waves || !stage.waves.length) return;
    let wave = stage.waves[0];
    window.monsters = []; // override monster global

    window.monsters = wave.enemies.map((m,ix) => ({
        ...m,
        ...window.getCharDataSync(m.id, m.level),    // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡πÄ‡∏ï‡∏ï‡∏±‡∏™ base+level
        id: m.id+"_"+(ix+1),
        currHp: m.hp,
        alive: true,
        buffs: [],
        debuffs: [],
        cooldowns: [0,0,0],
        side: 'mon',
        index: ix
    }));
    // Option: ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏ü ‡∏ï‡πâ‡∏≠‡∏á implement ‡∏Ñ‡πà‡∏≠‡∏¢‡πÜ‡∏™‡∏•‡∏±‡∏ö‡πÄ‡∏ß‡∏ü
};

// ‡∏î‡∏∂‡∏á charData (mock sync ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏°‡∏≠‡∏ô basic, ‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡πÉ‡∏ä‡πâ async + cache)
window.getCharDataSync = function(charId, lv=1) {
    // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö dev: ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å localStorage cache ‡∏Å‡πà‡∏≠‡∏ô, ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ fetch xhr
    try {
        let raw = localStorage.getItem('char_' + charId);
        if(raw) return JSON.parse(raw);
        let xhr = new XMLHttpRequest();
        xhr.open("GET", `data/char/${charId}.json`, false);
        xhr.send();
        if (xhr.status === 200) {
            let data = JSON.parse(xhr.responseText);
            // scale stat
            let stat = {...data};
            if(lv && lv > 1){
                let scale = (lv-1)*.12 + 1.0;
                stat.hp = Math.floor(stat.hp * scale);
                stat.atk = Math.floor(stat.atk * scale);
                stat.def = Math.floor(stat.def * scale);
                stat.level = lv;
            }
            return stat;
        }
    } catch { }
    return {hp:100,atk:20,def:9,level:lv};
};

// ‡∏ï‡∏£‡∏ß‡∏à‡∏ú‡∏•‡∏à‡∏ö‡∏î‡πà‡∏≤‡∏ô (win) ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ã‡∏ü progress/unlock ‡∏ï‡πà‡∏≠‡∏î‡πà‡∏≤‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
window.updateStageProgress = function(stageId) {
    loadStageProgress();
    stageProgress[stageId] = true;
    saveStageProgress();
};

// Hook UI: ‡πÄ‡∏™‡∏£‡∏¥‡∏°‡πÄ‡∏°‡∏ô‡∏π‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡∏±‡∏ô‡πÄ‡∏à‡∏µ‡πâ‡∏¢‡∏ô" (btnStage)
document.addEventListener('DOMContentLoaded', ()=>{
    let btn = document.getElementById('btnStageMap');
    if(btn) btn.onclick = openStageMapPopup;
});
// (option) ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô index.html, ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏î‡πâ‡∏ß‡∏¢ openStageMapPopup()

// export
window.stageEngine = {
    open: openStageMapPopup,
    reload: loadChapters,
    progress: ()=>stageProgress
};

‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå data/shop.json
{
  "shops": [
    {
      "id": "main",
      "name": "‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å",
      "type": "main",
      "enabled": true,
      "desc": "‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°, ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö, ‡πÅ‡∏•‡∏∞‡∏Ç‡∏≠‡∏á‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô",
      "refresh_type": "none",      // none | time | manual | daily | weekly
      "refresh_cycle_minutes": 0,
      "items": [
        {
          "id": "gold_5000",
          "item_id": "gold",
          "amount": 5000,
          "price_item": "diamond",
          "price_amount": 10,
          "desc": "‡∏£‡∏±‡∏ö 5,000 Gold ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ",
          "can_buy": 999,
          "daily_limit": 3,
          "enabled": true
        },
        {
          "id": "exp_potion_1",
          "item_id": "exp_potion",
          "amount": 1,
          "price_item": "gold",
          "price_amount": 110,
          "desc": "EXP Potion x1 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏•‡πÄ‡∏ß‡∏•‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£",
          "can_buy": 99,
          "daily_limit": 5,
          "enabled": true
        },
        {
          "id": "rune_shard_1",
          "item_id": "rune_shard",
          "amount": 1,
          "price_item": "gold",
          "price_amount": 200,
          "desc": "Rune Shard ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏ô",
          "can_buy": 50,
          "daily_limit": 0,
          "enabled": true
        }
      ]
    },
    {
      "id": "event",
      "name": "Event Shop",
      "type": "event",
      "enabled": false,
      "desc": "‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ä‡πà‡∏ß‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°",
      "refresh_type": "none",
      "items": []
    },
    {
      "id": "secret",
      "name": "Secret Shop",
      "type": "secret",
      "enabled": false,
      "desc": "‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å 30 ‡∏ô‡∏≤‡∏ó‡∏µ",
      "refresh_type": "time",
      "refresh_cycle_minutes": 30,
      "items": []
    }
  ]
}

‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå js/shop.js
// js/shop.js - Epic Seven Clone Frontend Shop System

let shopData = [];
let purchaseHistory = {}; // Log per user/day: { shopId_itemId: numBought }

async function loadShopData() {
    if (shopData.length) return;
    let res = await fetch('data/shop.json').then(r => r.json());
    shopData = res.shops;
}

function loadShopHistory() {
    try {
        purchaseHistory = JSON.parse(localStorage.getItem('shop_purchase_history') || '{}');
    } catch { purchaseHistory = {}; }
}
function saveShopHistory() {
    localStorage.setItem('shop_purchase_history', JSON.stringify(purchaseHistory));
}

// ---------- Render UI ----------
async function openShopPopup(shopId = "main") {
    await loadShopData(); loadShopHistory();
    let shop = shopData.find(s => s.id === shopId && s.enabled);
    if (!shop) {
        window.openPopup('shop', `<div>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà</div><button class="secondary-btn" onclick="closePopup()">‡∏õ‡∏¥‡∏î</button>`, 'large', '‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤');
        return;
    }

    let html = `
      <div style="font-size:1.14em;color:#dac1ff;margin-bottom:6px;">${shop.desc || ''}</div>
      <div style="display:flex;gap:17px;flex-wrap:wrap;align-items:stretch;">
        ${shop.items.filter(i => i.enabled).map(item => renderShopItem(shop, item)).join('')}
      </div>
      <div style="text-align:right;margin-top:23px;">
        <button class="secondary-btn" onclick="closePopup()">‡∏õ‡∏¥‡∏î</button>
      </div>
    `;
    window.openPopup('shop', html, 'large', shop.name);
    renderShopLiveUI(shop.id);
}

// Helper ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ 1 ‡∏≠‡∏±‡∏ô
function renderShopItem(shop, item) {
    let inv = window.inventoryEngine?.list() || [];
    let priceOwned = inv.find(i => i.id === item.price_item)?.qty || 0;
    let itemData = window.inventoryEngine.findItemById(item.item_id) || {};
    // ‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
    let key = `${shop.id}_${item.id}_${getTodayStr()}`;
    let bought = purchaseHistory[key] || 0;
    let canBuy = item.can_buy && bought < item.can_buy;
    let canBuyToday = item.daily_limit ? bought < item.daily_limit : true;
    let disabled = !canBuy || !canBuyToday || priceOwned < item.price_amount;

    return `
      <div style="background:#223246;border:2px solid #53a0fa5c;border-radius:13px;min-width:162px;flex:1 0 174px;padding:14px 12px 18px 12px;margin-bottom:.8em;display:flex;flex-direction:column;align-items:center;justify-content:space-between;">
        <img src="img/item/${itemData.img||'noimg.png'}" alt="${itemData.name||item.item_id}" style="width:38px;margin-bottom:7px;" />
        <div style="font-size:1.1em;font-weight:bold;">${itemData.name||item.item_id} x${item.amount}</div>
        <div style="color:#ffbe77;font-size:.98em;">${item.desc || (itemData && itemData.description)||''}</div>
        <div style="margin:.8em 0;font-size:.95em;">
          <b>‡∏£‡∏≤‡∏Ñ‡∏≤:</b> <span style="color: gold;font-weight:bold;">${item.price_amount}</span> <img src="img/item/${item.price_item}.png" style="width:18px;vertical-align:middle" /> 
          <br/>
          <span style="font-size:.97em;color:#cdf;">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${priceOwned}</span>
        </div>
        ${item.daily_limit ? `<div style="color:#9eecff;font-size:.92em;margin:.4em 0;">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡πâ‡∏ß: ${bought} / ${item.daily_limit}</div>` : ''}
        <button class="primary-btn" style="padding:6px 1.4em;font-size:.97em;" onclick="buyShopItem('${shop.id}','${item.id}')" ${disabled?"disabled":""}>${disabled?'‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ':'‡∏ã‡∏∑‡πâ‡∏≠'}</button>
      </div>
    `;
}

// ---------- Buy flow ----------
window.buyShopItem = function(shopId, itemId) {
    let shop = shopData.find(s => s.id === shopId);
    if (!shop) return;
    let item = shop.items.find(i => i.id === itemId);
    if (!item) return;
    let key = `${shopId}_${itemId}_${getTodayStr()}`;
    let bought = purchaseHistory[key] || 0;
    if (item.can_buy && bought >= item.can_buy) return alert("‡∏ñ‡∏∂‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≠‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß");
    if (item.daily_limit && bought >= item.daily_limit) return alert("‡∏ñ‡∏∂‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß");
    let inv = window.inventoryEngine?.list() || [];
    let owned = inv.find(i => i.id === item.price_item)?.qty || 0;
    if (owned < item.price_amount) return alert("‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠");

    // confirm popup
    let itemInfo = window.inventoryEngine.findItemById(item.item_id) || {};
    window.openPopup('confirmBuy', `
      <div style="text-align:center;">
        <img src="img/item/${itemInfo.img||'noimg.png'}" style="width:49px;margin-bottom:8px;">
        <div style="font-size:1.14em;font-weight:bold;margin-bottom:7px;">${itemInfo.name || item.item_id}</div>
        <div style="margin-bottom:8px;">${item.desc || ''} <br> <b>x${item.amount}</b></div>
        <div style="color:gold;font-size:.98em;">‡∏£‡∏≤‡∏Ñ‡∏≤ ${item.price_amount} <img src="img/item/${item.price_item}.png" style="width:17px;vertical-align:middle" /> </div>
        <button onclick="confirmShopBuy('${shopId}','${item.id}')" class="primary-btn" style="margin:.7em 1em 0 1em;">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ã‡∏∑‡πâ‡∏≠</button>
        <button onclick="closePopup()" class="secondary-btn" style="margin:.7em 0 0 0;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      </div>
    `, 'small', '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠');
}

// ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏à‡∏£‡∏¥‡∏á
window.confirmShopBuy = function(shopId, itemId) {
    let shop = shopData.find(s => s.id === shopId);
    if (!shop) return;
    let item = shop.items.find(i => i.id === itemId);
    let key = `${shopId}_${itemId}_${getTodayStr()}`;
    let bought = purchaseHistory[key] || 0;
    if (item.can_buy && bought >= item.can_buy) return alert("‡∏ñ‡∏∂‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß");
    if (item.daily_limit && bought >= item.daily_limit) return alert("‡∏ñ‡∏∂‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß");
    let inv = window.inventoryEngine?.list() || [];
    let own = inv.find(i => i.id === item.price_item);
    if (!own || own.qty < item.price_amount) return alert("‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡πÑ‡∏°‡πà‡∏û‡∏≠");
    window.inventoryEngine.remove(item.price_item, item.price_amount);
    window.inventoryEngine.add(item.item_id, item.amount);
    purchaseHistory[key] = (bought || 0) + 1;
    saveShopHistory();
    closePopup('confirmBuy');
    // popup ‡∏™‡∏£‡∏∏‡∏õ
    window.openPopup('shopResult', `
      <div style="text-align:center;color:#53fdc2;">
        <div style="font-size:1.15em;margin:11px 0;"><b>‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</b></div>
        <img src="img/item/${item.item_id}.png" style="width:47px;" />
        <div>‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö <b>${window.inventoryEngine.findItemById(item.item_id)?.name || item.item_id} x${item.amount}</b></div>
        <div style="margin-top:13px;"><button class="primary-btn" onclick="closePopup();openShopPopup('${shopId}')">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</button></div>
      </div>
    `, 'small', '‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
}

// Helper: date string ‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô
function getTodayStr() {
    let d = new Date();
    return d.getFullYear().toString() + (d.getMonth()+1).toString().padStart(2,"0") + d.getDate().toString().padStart(2,"0");
}

// Render shop item area live
function renderShopLiveUI(shopId) {
    // ‡∏Ñ‡∏ß‡∏£ refresh ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡πÄ‡∏á‡∏¥‡∏ô, ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≠‡∏ö‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏•‡∏±‡∏á‡∏ã‡∏∑‡πâ‡∏≠
    // Optional ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ trigger ‡πÉ‡∏™‡πà event ‡∏î‡πâ‡∏ß‡∏¢
}

// Auto menu bind
document.addEventListener('DOMContentLoaded', ()=> {
    let btn = document.getElementById('btnShop');
    if (btn) btn.onclick = ()=> openShopPopup('main');
});

// Expose global
window.shopEngine = {
    open: openShopPopup,
    reload: loadShopData
};

‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå js/announcement.js
// js/announcement.js

let announcementList = [];

/** ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ announcement (async) */
async function loadAnnouncements() {
    if (announcementList.length) return;
    let raw = await fetch('data/announcement.json').then(r => r.json());
    announcementList = raw.announcements || [];
}

/** Render popup ‡∏£‡∏ß‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏ï‡πà‡∏≤‡∏á‡πÜ */
async function openAnnouncementPopup() {
    await loadAnnouncements();
    // ‡πÄ‡∏ä‡πá‡∏Ñ unread ‡∏î‡πâ‡∏ß‡∏¢ localStorage
    let readIds = JSON.parse(localStorage.getItem('read_announcement_ids') || "[]");
    // Pin ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®
    let pin = announcementList.filter(a => a.pin && isAnnouncementAvailable(a));
    let normal = announcementList.filter(a => !a.pin && isAnnouncementAvailable(a));
    // Group ‡∏ï‡∏≤‡∏° type
    function groupBy(arr, key) {
        return arr.reduce((r, x) => ((r[x[key]] = r[x[key]] || []).push(x), r), {});
    }
    let normalGrp = groupBy(normal, 'type');
    let tabTypes = ['all', ...Object.keys(normalGrp)];
    let activeType = 'all';
    // Render tab & list
    let htmlTabs = tabTypes.map(type => 
        `<button class="primary-btn" style="margin-right:8px;font-weight:${type===activeType?'bold':'400'};" onclick="changeAnnouncementTab('${type}')">${type==='all'?'‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î':typeTitle(type)}</button>`
    ).join('');
    let htmlPin = pin.length ? `<div style="margin-bottom:16px;">${pin.map(renderAnnounceCard).join('')}</div>` : '';
    let htmlList = normal.map(renderAnnounceCard).join('');
    let html = `
        <div>
            <div style="margin-bottom:13px;">${htmlTabs}</div>
            ${htmlPin}
            <div id="announceMainList">${htmlList}</div>
        </div>
        <div style="text-align:right;"><button class="secondary-btn" onclick="closePopup()">‡∏õ‡∏¥‡∏î</button></div>
    `;
    window.openPopup('announcement', html, 'large', '‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®');
    // ‡∏à‡∏∏‡∏î‡πÅ‡∏î‡∏á‡πÄ‡∏°‡∏ô‡∏π
    setMenuNoti('btnAnnouncement', hasUnreadAnnouncement());
}

/** Render card ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ */
function renderAnnounceCard(a, idx = 0) {
    let readIds = JSON.parse(localStorage.getItem('read_announcement_ids') || "[]");
    let unread = !readIds.includes(a.id);
    let badge = a.type === 'patch' ? 'üõ†Ô∏è ' : a.type === 'event' ? 'üéâ ' : a.type === 'reward' ? 'üéÅ ' :
                a.type === 'shop' ? 'üõí ' : a.type === 'system' ? '‚ö†Ô∏è ' : '';
    let pin = a.pin ? '<span style="color:#fdec60;font-size:1.1em;">üìå</span>' : '';
    let statusDot = unread ? '<span style="display:inline-block;width:9px;height:9px;border-radius:7px;background:#ff6565;margin-left:6px;margin-bottom:1px;"></span>' : '';
    return `
    <div class="announce-card" style="background:#222d3d;border-radius:9px;margin-bottom:11px;padding:7px 13px 7px 13px;box-shadow:0 1px 16px #1470ad21;border:2px solid #174e8b42;cursor:pointer;transition:.14s;" onclick="viewAnnouncement('${a.id}')">
        <div style="font-size:1.02em;margin-bottom:1px;font-weight:bold;">
          ${pin} ${badge} <span>${a.title || '-'}</span> ${statusDot}
        </div>
        <div style="color:#9ad;font-size:.95em;">${a.show_time?formatTime(a.show_time):""} ${typeTitle(a.type)}</div>
        <div style="font-size:.93em;">
            ${a.short ? escapeHTML(a.short || '') : truncate(stripTags(a.content || ''), 71)}
        </div>
    </div>
    `;
}

/** ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÄ‡∏ï‡πá‡∏° */
window.viewAnnouncement = function (id) {
    let ann = announcementList.find(a => a.id === id);
    if (!ann) return;
    // Mark as read
    let readIds = JSON.parse(localStorage.getItem('read_announcement_ids') || "[]");
    if (!readIds.includes(ann.id)) {
        readIds.push(ann.id);
        localStorage.setItem('read_announcement_ids', JSON.stringify(readIds));
    }
    // ‡∏£‡∏±‡∏ô custom action (‡πÄ‡∏ä‡πà‡∏ô popup / shop ‡∏Ø‡∏•‡∏Ø)
    if (ann.force_popup) setTimeout(() => {}, 1); // ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏° logic
    // Render detail
    let badge = ann.type === 'patch' ? 'üõ†Ô∏è ' : ann.type === 'event' ? 'üéâ ' : ann.type === 'reward' ? 'üéÅ ' :
                ann.type === 'shop' ? 'üõí ' : ann.type === 'system' ? '‚ö†Ô∏è ' : '';
    let html = `
        <div style="font-size:1.19em;margin-bottom:.6em;">
            ${badge}<b>${escapeHTML(ann.title || '')}</b>
            ${ann.pin?'<span style="font-size:1.1em;color:#fdc900;">üìå</span>':''}
        </div>
        <div style="color:#bce1ff;font-size:.97em;margin-bottom:4px;">
            ‡∏´‡∏°‡∏ß‡∏î: ${typeTitle(ann.type)} &nbsp; ${ann.show_time?formatTime(ann.show_time):""}
        </div>
        <div style="margin:9px 0 18px 0;white-space:pre-line;">${richText(ann.content||'')}</div>
        ${ann.link_url ? `<div><a href="${ann.link_url}" target="_blank" style="color:#3fa8ff;text-decoration:underline;">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</a></div>` : ''}
        <div style="text-align:right;margin-top:1.1em;">
          <button class="secondary-btn" onclick="closePopup();openAnnouncementPopup();">‡∏Å‡∏•‡∏±‡∏ö</button>
        </div>
    `;
    window.openPopup('announceDetail', html, 'large', ann.title ? `${badge}${ann.title}` : "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®");
    setMenuNoti('btnAnnouncement', hasUnreadAnnouncement());
};

/** ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠ Group UI */
function typeTitle(type) {
    return {
        'patch': 'Patch Note',
        'event': '‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°',
        'reward': '‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•',
        'shop': '‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤/‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô',
        'system': '‡πÅ‡∏à‡πâ‡∏á‡∏£‡∏∞‡∏ö‡∏ö',
        'general': '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ',
        'inbox': '‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞',
    }[type] || type;
}
function stripTags(html) { return html.replace(/(<([^>]+)>)/gi, ""); }
function truncate(str, len) { return str.length <= len ? str : str.substring(0, len - 2) + "..."; }
function formatTime(ts) { if(!ts) return ""; let d = new Date(ts); return `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()}`; }
function escapeHTML(str) { return str.replace(/[<>&"]/g, c => ({'<':'&lt;','>':'&gt;','&':'&amp;','"':'&quot;'}[c])); }
function richText(str) {
    // Line breaks, emoji, bold
    return escapeHTML(str).replace(/\n/g, '<br>').replace(/\*(.*?)\*/g, '<b>$1</b>');
}
/** ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ô‡∏µ‡πâ‡∏Ñ‡∏ß‡∏£‡πÅ‡∏™‡∏î‡∏á? (‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô & flag) */
function isAnnouncementAvailable(a) {
    const now = Date.now();
    if ((a.start_time && now < a.start_time) || (a.end_time && now > a.end_time)) return false;
    return a.enabled !== false;
}
/** ‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÉ‡∏´‡∏°‡πà unread */
function hasUnreadAnnouncement() {
    let readIds = JSON.parse(localStorage.getItem('read_announcement_ids') || "[]");
    return announcementList.some(a => isAnnouncementAvailable(a) && !readIds.includes(a.id));
}
/** tab switch */
window.changeAnnouncementTab = function (type) {
    // Reload announcement popup & filter
    let list = announcementList.filter(a => isAnnouncementAvailable(a) 
        && (type === 'all' || a.type === type));
    let htmlPin = list.filter(a=>a.pin).map(renderAnnounceCard).join('');
    let htmlList = list.filter(a=>!a.pin).map(renderAnnounceCard).join('');
    document.getElementById('announceMainList').innerHTML = htmlPin + htmlList;
};

// Auto bind main menu
document.addEventListener('DOMContentLoaded', ()=> {
    let btn = document.getElementById('btnAnnouncement');
    if (btn) btn.onclick = openAnnouncementPopup;
    if (hasUnreadAnnouncement()) setMenuNoti('btnAnnouncement', true);
});

/* ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö admin: ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏ö/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç realtime ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏≤‡∏á admin.js */

// ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏∑‡πà‡∏ô (optional)
window.announcementEngine = {
    open: openAnnouncementPopup,
    getAll: () => announcementList,
    reload: async ()=>{ announcementList = []; await loadAnnouncements(); }
};

‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå data/announcement.json
{
  "announcements": [
    {
      "id": "patch_20240601",
      "type": "patch",
      "title": "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô 1.0",
      "content": "*‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö auto battle* ‡πÇ‡∏´‡∏°‡∏î‡πÉ‡∏´‡∏°‡πà: SPD BAR\nAnimation Slide ‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÇ‡∏à‡∏°‡∏ï‡∏µ‡πÅ‡∏ö‡∏ö Yu-Gi-Oh!\n\n- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏±‡∏ö EXP\n- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏ä‡∏≤‡πÅ‡∏•‡∏∞‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤",
      "start_time": 1717200000000,
      "end_time": null,
      "show_time": 1717239842000,
      "pin": true,
      "force_popup": true,
      "enabled": true
    },
    {
      "id": "reward_june2024",
      "type": "reward",
      "title": "‡πÅ‡∏à‡∏Å‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°‡∏ü‡∏£‡∏µ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô",
      "content": "‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡πÄ‡∏û‡∏ä‡∏£ 500\n‡πÅ‡∏•‡∏∞ EXP Potion x2 ‡∏ü‡∏£‡∏µ‡πÑ‡∏õ‡πÄ‡∏•‡∏¢!\n\n*‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ 1-7 ‡∏°‡∏¥.‡∏¢. 2024*",
      "start_time": 1717214400000,
      "end_time": 1717791999000,
      "show_time": 1717214500000,
      "pin": false,
      "enabled": true
    },
    {
      "id": "event_runeweek",
      "type": "event",
      "title": "‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° Rune Week",
      "content": "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô ‡∏£‡∏±‡∏ö Rune Shard x2\n‡πÅ‡∏•‡∏∞‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏ä‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏° 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô!",
      "start_time": 1717300800000,
      "end_time": 1717895999000,
      "show_time": 1717387200000,
      "pin": false,
      "enabled": true
    },
    {
      "id": "shop_promotion",
      "type": "shop",
      "title": "‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô",
      "content": "‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 30% ‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å\n*‡πÄ‡∏â‡∏û‡∏≤‡∏∞ 1-5 ‡∏°‡∏¥.‡∏¢. 2024*",
      "start_time": 1717214400000,
      "end_time": 1717559999000,
      "show_time": 1717214600000,
      "pin": false,
      "link_url": "",
      "enabled": true
    },
    {
      "id": "system_maintenance",
      "type": "system",
      "title": "‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå",
      "content": "‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 4 ‡∏°‡∏¥.‡∏¢. 2024 ‡πÄ‡∏ß‡∏•‡∏≤ 00:00-03:00 ‡∏ô.\n*‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ logout ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ*",
      "start_time": 1717430400000,
      "end_time": 1717441200000,
      "show_time": 1717430500000,
      "pin": false,
      "enabled": true
    }
  ]
}

‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå data/redeem.json
{
  "codes": [
    {
      "id": "WELCOME2024",           // ‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡πâ‡∏î
      "reward": [                    // ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ
        { "type": "item", "id": "diamond", "qty": 500 },
        { "type": "item", "id": "exp_potion", "qty": 2 }
      ],
      "desc": "‡∏£‡∏±‡∏ö‡∏ü‡∏£‡∏µ‡πÄ‡∏û‡∏ä‡∏£ 500 + EXP Potion x2 (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà)",
      "start_time": 1717200000000,  // 1 ‡∏°‡∏¥.‡∏¢. 2024
      "end_time": 1767167999000,    // 31 ‡∏ò.‡∏Ñ. 2025
      "max_usage": 10000,           // ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 10,000 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á
      "used_count": 0,              // ‡∏°‡∏µ‡∏Ñ‡∏ô‡πÉ‡∏ä‡πâ‡πÑ‡∏õ‡∏Å‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ù‡∏±‡πà‡∏á admin ‡∏´‡∏£‡∏∑‡∏≠ backend)
      "per_user": 1,                // 1 ‡πÑ‡∏≠‡∏î‡∏µ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏Å‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏ù‡∏±‡πà‡∏á user ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö)
      "enabled": true
    },
    {
      "id": "JUNE_EVENT01",
      "reward": [
        { "type": "item", "id": "rune_shard", "qty": 6 }
      ],
      "desc": "‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° Rune June ‡∏£‡∏±‡∏ö Rune Shard x6",
      "start_time": 1717214400000,  // 1 ‡∏°‡∏¥.‡∏¢. 2024, 06:00
      "end_time": 1717791999000,    // 7 ‡∏°‡∏¥.‡∏¢. 2024, 23:59
      "max_usage": 500,
      "used_count": 49,
      "per_user": 1,
      "enabled": true
    },
    {
      "id": "INDIV_CODE_DEMO_123X",
      "reward": [
        { "type": "character", "id": "astra", "qty": 1 }
      ],
      "desc": "‡πÅ‡∏à‡∏Å Astra 5‚òÖ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° DEVS",
      "start_time": 1717200000000,
      "end_time": 1720000000000,
      "max_usage": 1,
      "used_count": 0,
      "per_user": 1,
      "enabled": true
    }
  ]
}

‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå js/redeem.js
// js/redeem.js

let redeemCodeList = [];
let userUsedRedeem = []; // [{ code_id: 'WELCOME2024', redeemed_time: ... }], load/‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô localStorage

async function loadRedeemCodeList() {
  if (redeemCodeList.length) return;
  try {
    redeemCodeList = (await fetch('data/redeem.json').then(r => r.json()))?.codes || [];
  } catch { redeemCodeList = []; }
  loadUserRedeemUsed();
}
function loadUserRedeemUsed() {
  userUsedRedeem = JSON.parse(localStorage.getItem('user_used_redeem') || '[]');
}
function saveUserRedeemUsed() {
  localStorage.setItem('user_used_redeem', JSON.stringify(userUsedRedeem));
}

// ‡πÄ‡∏õ‡∏¥‡∏î Pop-up "‡∏Å‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•"
window.openRedeemPopup = function () {
  const html = `
    <div style="text-align:center;">
      <div style="font-size:1.16em;font-weight:600;margin-bottom:.88em;">üéÅ ‡∏Å‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</div>
      <input id="redeemInputBox" placeholder="‡πÉ‡∏™‡πà‡πÇ‡∏Ñ‡πâ‡∏î (A-Z, 0-9)" style="width: 90%;" maxlength="32"/>
      <div style="margin:1.3em 0;"><button class="primary-btn" onclick="checkRedeemCode()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</button></div>
      <div id="redeemResultHint" style="color:#ffc29a;font-size:.94em;margin-top:1em;"></div>
      <div style="color:#aee;margin-top:1.7em;font-size:.89em;">
        *‡πÇ‡∏Ñ‡πâ‡∏î 1 ‡∏Ñ‡∏ô‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á, ‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏, ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
      </div>
      <button class="secondary-btn" style="margin-top:2.2em;" onclick="closePopup()">‡∏õ‡∏¥‡∏î</button>
    </div>
  `;
  window.openPopup('redeem', html, 'small', '‡∏Å‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î');
  setTimeout(() => document.getElementById('redeemInputBox')?.focus(), 100);
};

// ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î
window.checkRedeemCode = async function () {
  await loadRedeemCodeList();
  const box = document.getElementById('redeemInputBox');
  if (!box) return;
  let code = box.value.trim().toUpperCase();
  let hintEl = document.getElementById('redeemResultHint');
  hintEl.innerText = "";
  if (!code.match(/^[A-Z0-9\-_]+$/)) return hintEl.innerText = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (A-Z, 0-9)";
  let redeem = redeemCodeList.find(c => c.id === code && c.enabled !== false);
  const now = Date.now();
  if (!redeem)
    return hintEl.innerText = "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏Ñ‡πâ‡∏î‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î/‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß";
  if (redeem.start_time && now < redeem.start_time)
    return hintEl.innerText = "‚ùå ‡πÇ‡∏Ñ‡πâ‡∏î‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ";
  if (redeem.end_time && now > redeem.end_time)
    return hintEl.innerText = "‚ùå ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß";
  if (redeem.max_usage && redeem.used_count >= redeem.max_usage)
    return hintEl.innerText = "‚ùå ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡πâ‡∏ß";

  // per user
  loadUserRedeemUsed();
  if (userUsedRedeem.some(u => u.code_id === code)) {
    return hintEl.innerText = "‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á";
  }

  // ‡∏ï‡∏£‡∏ß‡∏à‡πÑ‡∏≠‡∏î‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô (‡∏Ñ‡∏ß‡∏£‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô, ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ auth, ‡∏Å‡πá‡πÅ‡∏Ñ‡πà‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô)
  let curUserId = localStorage.getItem('user_id') || 'guest';
  // (‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö auth.js ‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á)

  // ‡πÅ‡∏à‡∏Å‡∏Ç‡∏≠‡∏á (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤ inventory/character)
  const rewardHtml = [];
  if (redeem.reward && Array.isArray(redeem.reward)) {
    for (let r of redeem.reward) {
      if (r.type === 'item') {
        window.addToInventory?.(r.id, r.qty || 1);
        rewardHtml.push(`<div>üéÅ ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö <b>${window.inventoryEngine?.findItemById(r.id)?.name || r.id} x${r.qty}</b></div>`);
      } else if (r.type === 'character') {
        window.collectCharacter?.(r.id);
        rewardHtml.push(`<div>üé¥ ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ <b style="color:#84bcff;">${r.id}</b></div>`);
      }
    }
  }

  // ‡πÄ‡∏ã‡∏ü userUsedRedeem
  userUsedRedeem.push({ code_id: code, time: now, user: curUserId });
  saveUserRedeemUsed();

  // (‡πÄ‡∏û‡∏¥‡πà‡∏° used_count ‡∏à‡∏∞‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏ù‡∏±‡πà‡∏á admin/‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
  // ‡πÅ‡∏™‡∏î‡∏á popup ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
  window.openPopup('redeemSuccess', `
    <div style="text-align:center;">
      <div style="font-size:1.15em;font-weight:700;color:#56f7ca;margin-bottom:9px;">‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</div>
      ${rewardHtml.join('')}
      <button class="primary-btn" style="margin-top:1.2em;" onclick="closePopup();">‡πÇ‡∏≠‡πÄ‡∏Ñ</button>
    </div>
  `, 'small', '‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•');
};

// Auto bind ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π (ID: btnRedeem ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡πÉ‡∏™‡πà‡πÄ‡∏≠‡∏á)
document.addEventListener('DOMContentLoaded', () => {
  let btn = document.getElementById('btnRedeem');
  if (btn) btn.onclick = window.openRedeemPopup;
});

// Expose export
window.redeemEngine = {
  open: window.openRedeemPopup,
  check: window.checkRedeemCode,
  reload: async () => { redeemCodeList = []; await loadRedeemCodeList(); }
};

‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå js/auth.js
// js/auth.js - Epic Seven Card Battle - Auth/Login System (Frontend only)
// Author: (yourname)
// ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö admin, player, check session, call API user info

let loginState = {
    loggedIn: false,
    isAdmin: false,
    user: null
};
let users = [];

async function loadUserList() {
    if (users.length) return;
    users = await fetch('data/user.json').then(res => res.json());
}
function saveCurrentSession(user) {
    localStorage.setItem('user_id', user.id);
    localStorage.setItem('user_name', user.name);
    localStorage.setItem('user_is_admin', user.role === "admin" ? "1" : "0");
    loginState = { loggedIn: true, isAdmin: user.role === "admin", user };
}

function clearSession() {
    localStorage.removeItem('user_id');
    localStorage.removeItem('user_name');
    localStorage.removeItem('user_is_admin');
    loginState = { loggedIn: false, isAdmin: false, user: null };
}

// UI Login - Popup HTML
function renderLoginPopup() {
    return `
    <div class="popup small">
    <button class="close" onclick="closePopup()">√ó</button>
    <h2>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
    <div id="loginErrorMsg" style="color:#f77;font-size:.9em;"></div>
    <input id="auth_user_id" placeholder="User ID..." autocomplete="username"/>
    <input id="auth_user_pw" type="password" placeholder="Password..." autocomplete="current-password" />
    <button class="primary-btn" style="margin-top:1.1em;" onclick="doLoginNow()">‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô</button>
    <button class="secondary-btn" onclick="closePopup()" style="margin:1em 0 0 0;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
    `;
}

// ‡∏ï‡∏£‡∏ß‡∏à session (‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å)
function checkSession() {
    let userId = localStorage.getItem('user_id');
    let userName = localStorage.getItem('user_name');
    let isAdmin = localStorage.getItem('user_is_admin') === "1";
    if (userId && userName) {
        loginState = { loggedIn: true, isAdmin, user: { id: userId, name: userName, role: isAdmin ? "admin" : "player" } };
    }
    setPlayerName(loginState.loggedIn ? loginState.user.name : "");
}

// ‡∏õ‡∏∏‡πà‡∏°‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏ö‡∏ô index
document.addEventListener('DOMContentLoaded', () => {
    checkSession();
    let btn = document.getElementById('btnLogin');
    if (btn) btn.onclick = openLoginPopup;
    if (loginState.loggedIn) {
        btn.textContent = "‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö";
        btn.onclick = doLogout;
    }
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
    setPlayerName(loginState.loggedIn ? loginState.user.name : "");
});

// ‡πÄ‡∏õ‡∏¥‡∏î popup ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô
window.openLoginPopup = async function () {
    await loadUserList();
    window.openPopup('login', renderLoginPopup(), 'small', '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö');
    setTimeout(() => document.getElementById('auth_user_id')?.focus(), 180);
}
// ‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö" ‡∏à‡∏£‡∏¥‡∏á
window.doLoginNow = async function () {
    await loadUserList();
    let id = document.getElementById('auth_user_id').value.trim();
    let pw = document.getElementById('auth_user_pw').value;
    let el = document.getElementById('loginErrorMsg');
    let user = users.find(u =>
        u.id === id && u.password === pw && u.enabled !== false
    );
    if (user) {
        saveCurrentSession(user);
        setPlayerName(user.name);
        closePopup();
        location.reload();
    } else {
        el.innerText = "‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!";
    }
}

// ‡∏õ‡∏∏‡πà‡∏° logout
window.doLogout = function () {
    clearSession();
    location.reload();
}

// Helper ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö/JS ‡∏≠‡∏∑‡πà‡∏ô‡∏î‡∏∂‡∏á user ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
window.getCurrentUser = function () {
    checkSession();
    return loginState.user || null;
}

window.isAdmin = function () {
    checkSession();
    return loginState.isAdmin;
}

window.isLoggedIn = function () {
    checkSession();
    return loginState.loggedIn;
}

‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå data/user.json
[
  {
    "id": "admin",
    "name": "Admin",
    "password": "adminpass123",
    "role": "admin",
    "enabled": true
  },
  {
    "id": "player1",
    "name": "Achiraya",
    "password": "p1demo!!",
    "role": "player",
    "enabled": true
  },
  {
    "id": "player2",
    "name": "Somchai",
    "password": "playerdemo2",
    "role": "player",
    "enabled": true
  }
]

‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå js/characterCollection.js
// js/characterCollection.js

/**
 * Epic Seven - Character Collection System (Frontend Only)
 * - Card grid, search, sort, filter, responsive, upgrade, show stat
 * - Data driven by: localStorage char_collection & data/char/*.json
 * - Connect: upgrade.js, rune.js, team.js, popupManager.js
 * (c) 2024
 **/

let charCollection = [];  // [{"id": ...}, ...] as owned
let charMeta = [];        // All meta (`data/char/*.json`)
let filters = { text: '', star: 0, element: 'all', class: 'all' };

// ------------ 1. Load user collection from localStorage ------------
function loadCharCollection() {
    let arr = JSON.parse(localStorage.getItem('char_collection') || "[]");
    charCollection = arr.filter((id, idx) => arr.indexOf(id) === idx); // unique
}

// ------------ 2. Load all owned char meta data ------------
async function loadCharMeta() {
    await loadCharCollection();
    // Only load characters in collection (faster)
    charMeta = await Promise.all(charCollection.map(async id => {
        try {
            let res = await fetch(`data/char/${id}.json`);
            return await res.json();
        } catch (e) { return null; }
    }));
    charMeta = charMeta.filter(c => !!c);
}

// ------------ 3. Render main UI grid ------------
function renderCharGrid() {
    let area = document.getElementById('characterArea');
    if (!area) return;
    // Filter/sort
    let cs = charMeta.slice();
    if (filters.star > 0) cs = cs.filter(c => (c.star || 0) === Number(filters.star));
    if (filters.element !== 'all') cs = cs.filter(c => (c.element || "") === filters.element);
    if (filters.class !== 'all') cs = cs.filter(c => (c.class || "") === filters.class);
    if (filters.text.length) cs = cs.filter(c => c.name.toLowerCase().includes(filters.text.toLowerCase()));
    cs.sort((a, b) => (b.star || 0) - (a.star || 0) || (a.name.localeCompare(b.name)));
    // Responsive grid: 6 col PC, 3 col mobile
    let isMobile = window.innerWidth < 650;
    let html = `<div style="display:grid;grid-template-columns:repeat(${isMobile ? 3 : 6},1fr);gap:16px;">` +
        (cs.length ? cs.map(c => charCardBox(c)).join('') : '<div style="color:#fff;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£</div>') +
        `</div>`;
    area.innerHTML = `
        <div style="display:flex;gap:10px;margin-bottom:10px;">
            <input id="charSearchBox" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠..." style="flex:1;max-width:180px;" value="${filters.text || ''}"/>
            <select id="starFilter"><option value="0">‚òÖ ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option><option value="3">‚òÖ3</option><option value="4">‚òÖ4</option><option value="5">‚òÖ5</option></select>
            <select id="eleFilter"><option value="all">‡∏ó‡∏∏‡∏Å‡∏ò‡∏≤‡∏ï‡∏∏</option><option value="fire">üî• ‡πÑ‡∏ü</option><option value="water">üíß ‡∏ô‡πâ‡∏≥</option><option value="earth">üå± ‡∏î‡∏¥‡∏ô</option><option value="dark">üåë ‡∏°‡∏∑‡∏î</option><option value="light">üåü ‡πÅ‡∏™‡∏á</option></select>
            <select id="classFilter"><option value="all">‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏•‡∏≤‡∏™</option><option value="knight">‡∏≠‡∏±‡∏®‡∏ß‡∏¥‡∏ô</option><option value="warrior">‡∏ô‡∏±‡∏Å‡∏£‡∏ö</option><option value="mage">‡∏à‡∏≠‡∏°‡πÄ‡∏ß‡∏ó‡∏¢‡πå</option><option value="ranger">‡πÄ‡∏£‡∏ô‡πÄ‡∏à‡∏≠‡∏£‡πå</option><option value="assassin">‡πÅ‡∏≠‡∏™‡∏ã‡∏≤‡∏ã‡∏¥‡∏ô</option><option value="monster">‡∏°‡∏≠‡∏ô‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡πå</option></select>
        </div>
        ${html}
    `;
    // Set filter values
    document.getElementById('starFilter').value = filters.star;
    document.getElementById('eleFilter').value = filters.element;
    document.getElementById('classFilter').value = filters.class;
    // Search events
    document.getElementById('charSearchBox').oninput = ev => { filters.text = ev.target.value.trim(); renderCharGrid(); };
    document.getElementById('starFilter').onchange = ev => { filters.star = ev.target.value; renderCharGrid(); };
    document.getElementById('eleFilter').onchange = ev => { filters.element = ev.target.value; renderCharGrid(); };
    document.getElementById('classFilter').onchange = ev => { filters.class = ev.target.value; renderCharGrid(); };
}

// ------------ 4. Card box HTML ------------
function charCardBox(c) {
    let lock = isCharLocked(c.id);
    return `
      <div class="card" data-chrid="${c.id}" style="position:relative;">
        <img src="img/char/${c.img}" class="hero-img" alt="${c.name}" />
        <div class="name">${c.name}</div>
        <div style="font-size:.93em;color:#d9d;line-height:1.2em;">Lv. ${c.level || '-'} ‚òÖ${c.star || '-'}</div>
        <div style="font-size:.89em;color:#cff;">‡∏ò‡∏≤‡∏ï‡∏∏: ${elIcon(c.element)} | ${classIcon(c.class)}</div>
        <div style="margin:6px 0;">
          <button class="primary-btn" style="padding:3px 1.1em;font-size:.97em;" onclick="showCharDetailPopup('${c.id}')">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
          <button class="secondary-btn" style="padding:3px 1.1em;font-size:.97em;" onclick="upgradeCharPopup('${c.id}')">‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î</button>
          <button class="primary-btn" style="padding:3px 1em;font-size:.93em;" onclick="runeEngine.openEquipPopup('${c.id}')">‡πÉ‡∏™‡πà‡∏£‡∏π‡∏ô</button>
        </div>
        <button style="position:absolute;top:7px;right:14px;opacity:.8;background:none;border:0;color:#fa8;font-size:1.5em;outline:none;z-index:7"
            onclick="toggleCharLock('${c.id}');event.stopPropagation()" title="${lock ? '‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å' : '‡∏•‡πá‡∏≠‡∏Å'}">
            ${lock ? 'üîí' : 'üîì'}
        </button>
      </div>`;
}
// ‡∏ò‡∏≤‡∏ï‡∏∏
function elIcon(el) {
    return { fire: 'üî•', water: 'üíß', earth: 'üå±', dark: 'üåë', light: 'üåü' }[el] || '‚ùî';
}
function classIcon(cls) {
    return { knight: 'üõ°Ô∏è', warrior: '‚öîÔ∏è', mage: 'ü¶â', ranger: 'üèπ', assassin: 'üó°Ô∏è', monster: 'üëæ' }[cls] || 'üëΩ';
}

// ------------ 5. Lock/Unlock ------------
function isCharLocked(chid) {
    let ll = JSON.parse(localStorage.getItem('char_lock') || "[]");
    return ll.includes(chid);
}
function toggleCharLock(chid) {
    let ll = JSON.parse(localStorage.getItem('char_lock') || "[]");
    let idx = ll.indexOf(chid);
    if (idx >= 0) ll.splice(idx, 1); else ll.push(chid);
    localStorage.setItem('char_lock', JSON.stringify(ll));
    renderCharGrid();
}

// ------------ 6. Popup: Char Detail ------------
window.showCharDetailPopup = async function (charId) {
    let c = charMeta.find(c => c.id === charId);
    if (!c) return;
    let html = `
        <div style="display:flex;flex-direction:column;align-items:center;gap:7px;">
            <img src="img/char/${c.img}" class="hero-img" style="width:82px;margin:0 auto 9px auto;" />
            <div style="font-size:1.22em;font-weight:600">${c.name}</div>
            <div style="color:#b6deff;">Lv.${c.level || '-'} / ‚òÖ${c.star||'-'} | ${elIcon(c.element)} ${classIcon(c.class)}</div>
            <hr style="width:86%;border:1px solid #234;" />
            <div>HP <b>${c.hp}</b> | ATK <b>${c.atk}</b> | DEF <b>${c.def}</b> | SPD <b>${c.spd}</b></div>
            <div>CRIT <b>${c.crit_rate}%</b> | CRIT DMG <b>${c.crit_dmg}%</b> | EFF <b>${c.effectiveness}%</b></div>
            <div>Skills: <ul>${(c.skills || []).map(s => `<li><b>${s.name}</b>: ${s.desc || ''}</li>`).join('')}</ul></div>
            <div style="margin-top:7px;">
                <button class="primary-btn" onclick="upgradeCharPopup('${c.id}')">‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î</button>
                <button class="primary-btn" onclick="runeEngine.openEquipPopup('${c.id}')">‡πÉ‡∏™‡πà‡∏£‡∏π‡∏ô</button>
                <button class="secondary-btn" onclick="closePopup()" style="margin-left:11px;">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>`;
    window.openPopup('charDetail', html, 'large', c.name);
}

// ------------ 7. INIT [DOM Ready, bind menu] ------------
document.addEventListener('DOMContentLoaded', async () => {
    let btn = document.getElementById('btnCharacter');
    if (btn) btn.onclick = async () => {
        await loadCharMeta();
        renderCharGrid();
        window.openPopup('characterCollection', `<div id="characterArea"></div>`, 'large', '‡∏Ñ‡∏•‡∏±‡∏á‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£');
        renderCharGrid();
    };
});

‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå js/passive.js
// js/passive.js
//
// Epic Seven Auto Battle - Passive Engine
// ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Passive ‡∏ó‡∏∏‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö (Triggered / Aura / Always) Modular based
// (c) 2024

let passiveList = []; // loaded from passive.json

// Async ‡πÇ‡∏´‡∏•‡∏î passive config ‡∏à‡∏≤‡∏Å passive.json
async function loadPassiveList() {
    if (passiveList.length) return;
    try {
        passiveList = await fetch('data/passive.json').then(r => r.json());
    } catch { passiveList = []; }
}

// ------------ Logic: Apply Passive ------------
/**
 * ‡πÄ‡∏û‡∏¥‡πà‡∏° passive effect ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ ‡∏ì ‡∏ï‡∏≠‡∏ô start battle
 * @param {Object} char ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ (obj)
 * @param {Array | string} passiveIds - ‡∏ä‡∏∑‡πà‡∏≠ passive (‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏•‡∏≤‡∏¢‡∏≠‡∏±‡∏ô)
 */
async function applyPassive(char, passiveIds) {
    await loadPassiveList();
    if (!passiveIds) return;
    let allIds = Array.isArray(passiveIds) ? passiveIds : [passiveIds];
    allIds.forEach(pid => {
        let pas = passiveList.find(p => p.id === pid);
        if (!pas) return;
        // aura (‡πÄ‡∏û‡∏¥‡πà‡∏° stat/‡∏ö‡∏±‡∏ü)
        if (pas.type === "aura" && pas.effect) {
            Object.keys(pas.effect).forEach(stat => {
                char[stat] = (char[stat] || 0) + pas.effect[stat];
            });
            // optional: ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô/‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô passive aura
            char._passiveNotes = char._passiveNotes || [];
            char._passiveNotes.push({ txt: pas.name, icon: pas.icon });
        }
        // always (flag/trace)
        if (pas.type === "always" && pas.effect) {
            char._passiveAlways = Object.assign({}, char._passiveAlways || {}, pas.effect);
        }
        // trigger passive ‡∏£‡∏≠ hook battle
        if (pas.type === "trigger") {
            char._passiveTrigger = char._passiveTrigger || [];
            char._passiveTrigger.push(pas);
        }
    });
}

/**
 * ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏¥‡∏î event ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á battle ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç trigger
 * ‡πÄ‡∏ä‡πà‡∏ô "onHit", "onDamaged", "onDeath", "onAllyDeath"
 * @param {Object} char - target (obj)
 * @param {string} event - event name (‡πÄ‡∏ä‡πà‡∏ô onHit, onDamaged)
 * @param {Object} payload - option ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
 */
function doPassiveEvent(char, event, payload = {}) {
    if (!char || !char._passiveTrigger) return;
    char._passiveTrigger.forEach(pas => {
        if (pas.event === event && Math.random() * 100 < (pas.chance || 100)) {
            // trigger buff/debuff/self effect
            if (pas.effect) {
                Object.keys(pas.effect).forEach(k => {
                    // ‡πÄ‡∏û‡∏¥‡πà‡∏° HP/ATK/DEF instant
                    if (["hp", "atk", "def", "spd"].includes(k)) {
                        char[k] += pas.effect[k];
                        popupPassive(char, pas, "+" + k.toUpperCase() + " " + pas.effect[k]);
                    }
                    // heal
                    if (k === "heal") {
                        let heal = Math.floor(char.hp * pas.effect[k]);
                        char.currHp = Math.min(char.hp, char.currHp + heal);
                        popupPassive(char, pas, "+HP " + heal);
                    }
                    // buff/debuff
                    if (k === "buff" && window.effectEngine)
                        window.effectEngine.addEffect(char, Array.isArray(pas.effect[k]) ? pas.effect[k] : [pas.effect[k]], "buff");
                    if (k === "debuff" && window.effectEngine)
                        window.effectEngine.addEffect(char, Array.isArray(pas.effect[k]) ? pas.effect[k] : [pas.effect[k]], "debuff");
                });
            }
            if (pas.showText) popupPassive(char, pas, pas.showText);
        }
    });
}

// ‡∏ù‡∏±‡∏á hook ‡πÉ‡∏ô battle.js, effect.js ‡∏´‡∏£‡∏∑‡∏≠ animation/callbacks
window.passiveEngine = {
    load: loadPassiveList,
    apply: applyPassive,
    doEvent: doPassiveEvent
};

/**
 * Show popup note passive ‡∏ö‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î
 */
function popupPassive(char, pas, txt) {
    let c = document.getElementById(`${char.side || 'hero'}${char.index || 0}`);
    if (!c) return;
    let pop = document.createElement('span');
    pop.className = "damage-popup";
    pop.style.color = pas.color || '#22ffd8';
    pop.innerHTML = pas.icon ? pas.icon + ' ' : '';
    pop.innerHTML += '<b>PASSIVE</b>: ' + (txt || pas.name);
    c.appendChild(pop);
    setTimeout(() => pop.remove(), 1100);
}

// ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
// ‡πÉ‡∏ô battle.js, ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏•‡∏î character ‡πÅ‡∏•‡πâ‡∏ß:
// await passiveEngine.apply(char, char.passive);
// doPassiveEvent(char, 'onDamaged', { ... });

‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå data/passive.json
[
  {
    "id": "counter_attack",
    "name": "Counter Strike",
    "icon": "‚Ü©Ô∏è",
    "desc": "‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™ 25% ‡πÇ‡∏ï‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ñ‡∏π‡∏Å‡πÇ‡∏à‡∏°‡∏ï‡∏µ",
    "type": "trigger",
    "event": "onDamaged",
    "chance": 25,
    "effect": {"buff":[{"type":"counter_ready","turn":1}]},
    "showText": "‡πÇ‡∏ï‡πâ‡∏Å‡∏•‡∏±‡∏ö!"
  },
  {
    "id": "team_aura_def",
    "name": "Commander Aura",
    "icon": "üõ°Ô∏è",
    "desc": "‡∏ó‡∏µ‡∏°‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö DEF+12 ‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏Ç‡∏ì‡∏∞‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ",
    "type": "aura",
    "effect": { "def": 12 }
  },
  {
    "id": "self_heal",
    "name": "Regeneration",
    "icon": "üíö",
    "desc": "‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π HP 10% ‡∏Ç‡∏≠‡∏á Max HP ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏ö‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á",
    "type": "trigger",
    "event": "onEndTurn",
    "chance": 100,
    "effect": { "heal": 0.10 },
    "showText": "Regenerate"
  },
  {
    "id": "immunity_permanent",
    "name": "Immunity Master",
    "icon": "üîí",
    "desc": "‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î debuff ‡πÄ‡∏•‡∏¢",
    "type": "always",
    "effect": { "immune_all": true }
  },
  {
    "id": "relentless_aura_spd",
    "name": "Relentless Aura",
    "icon": "üí®",
    "desc": "‡∏ó‡∏µ‡∏°‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö SPD+8",
    "type": "aura",
    "effect": { "spd": 8 }
  },
  {
    "id": "burn_on_hit",
    "name": "Inferno Retaliate",
    "icon": "üî•",
    "desc": "‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™ 30% ‡∏ï‡∏¥‡∏î burn ‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏ï‡∏µ‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ",
    "type": "trigger",
    "event": "onDamaged",
    "chance": 30,
    "effect": { "debuff": [{"type":"burn", "turn":2}] },
    "showText": "Burned!"
  }
]

‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå admin.html
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Admin Panel - Epic Seven Card Auto Battle</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body class="dark-bg">
<header>
  <nav class="navbar">
    <div class="logo">ADMIN - Epic Seven Card Battle</div>
    <ul class="menu">
      <li><button onclick="window.location.href='index.html'">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏Å‡∏°</button></li>
      <li><button id="btnUserMgr">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</button></li>
      <li><button id="btnCharMgr">‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£/Skills</button></li>
      <li><button id="btnItemMgr">‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°</button></li>
      <li><button id="btnRuneMgr">‡∏£‡∏π‡∏ô</button></li>
      <li><button id="btnQuestMgr">‡πÄ‡∏Ñ‡∏ß‡∏™‡∏ï‡πå</button></li>
      <li><button id="btnGachaMgr">‡∏Å‡∏≤‡∏ä‡∏≤</button></li>
      <li><button id="btnStageMgr">‡∏î‡∏±‡∏ô‡πÄ‡∏à‡∏µ‡πâ‡∏¢‡∏ô</button></li>
      <li><button id="btnShopMgr">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</button></li>
      <li><button id="btnAnnounceMgr">‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</button></li>
      <li><button id="btnRedeemMgr">‡πÇ‡∏Ñ‡πâ‡∏î</button></li>
      <li><button id="btnChatMod">‡πÅ‡∏ä‡∏ó</button></li>
    </ul>
    <div class="profile">
      <span id="adminName"></span>
      <button id="btnLogout">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>
  </nav>
</header>

<main style="max-width: 1120px;margin: 1.5em auto;background:#262a38bb;border-radius:18px;box-shadow:0 2px 26px #0b0a10a6;padding:26px 24px;min-height:440px;">
  <div id="adminMainArea"></div>
</main>

<div id="popupLayer"></div>
<footer>
  <small style="color: #aaa;">&copy; 2024 - Admin Panel (For Epic Seven Fan Project)</small>
</footer>

<script src="js/utils.js"></script>
<script src="js/ui.js"></script>
<script src="js/admin.js"></script>
</body>
</html>

‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå js/admin.js
// js/admin.js (‡∏â‡∏ö‡∏±‡∏ö‡πÄ‡∏ï‡πá‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö admin panel)

/* ==== 1) LOGIN ADMIN GUARD ==== */
document.addEventListener('DOMContentLoaded', () => {
  // Check admin session
  const isAdmin = localStorage.getItem("user_is_admin") === "1";
  const adminName = localStorage.getItem("user_name");

  if (!isAdmin) {
    alert("‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô");
    window.location.href = "index.html";
    return;
  }
  document.getElementById('adminName').innerText = `üë§ ${adminName}`;
  document.getElementById("btnLogout").onclick = function () {
    localStorage.removeItem("user_id");
    localStorage.removeItem("user_name");
    localStorage.removeItem("user_is_admin");
    window.location.href = "index.html";
  };

  // Menu event mapping
  {
    let mapping = {
      btnUserMgr:   renderUserMgr,
      btnCharMgr:   renderCharMgr,
      btnItemMgr:   renderItemMgr,
      btnRuneMgr:   renderRuneMgr,
      btnQuestMgr:  renderQuestMgr,
      btnGachaMgr:  renderGachaMgr,
      btnStageMgr:  renderStageMgr,
      btnShopMgr:   renderShopMgr,
      btnAnnounceMgr: renderAnnounceMgr,
      btnRedeemMgr: renderRedeemMgr,
      btnChatMod:   renderChatMgr
    };
    Object.entries(mapping).forEach(([btn, fn])=>{
      let el = document.getElementById(btn);
      if (el) el.onclick = fn;
    });
  }

  // Default: open user mgr
  renderUserMgr();
});

// Helper: set main admin area content
function setAdminMain(html) {
  document.getElementById("adminMainArea").innerHTML = html;
}

/* ==== 2) USER MANAGEMENT ==== */
async function renderUserMgr() {
  let res = await fetch('data/user.json').then(r=>r.json());
  let html = `<h2>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h2>
    <table style="width:100%;background:#223247;border-radius:12px;">
      <tr style="color:#bfa;font-size:1.13em;"><th>ID</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>Role</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°</th></tr>
      ${res.map(u=>
        `<tr>
          <td>${u.id}</td>
          <td>${u.name}</td>
          <td>${u.role}</td>
          <td><span style="color:${u.enabled?'#7fe':'#fad'};">${u.enabled?'‚úîÔ∏è ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô':'‚ùå ‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î'}</span></td>
          <td>
            <button onclick="editUserPopup('${u.id}')" class="primary-btn" style="font-size:.95em;">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            <button onclick="banUser('${u.id}')" class="secondary-btn" style="font-size:.93em;">‡πÅ‡∏ö‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
          </td>
        </tr>`).join('')}
    </table>
    <div style="margin:16px 0 0 0;text-align:right;">
      <button class="primary-btn" onclick="addUserPopup()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
    </div>`;
  setAdminMain(html);
}
window.renderUserMgr = renderUserMgr;

window.editUserPopup = function (uid) {
  alert("‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤");
}
window.addUserPopup = function () {
  alert("‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤");
}
window.banUser = function (uid) {
  alert(`‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ö‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ "${uid}" ‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤ (‡πÉ‡∏ô‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô local ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÉ‡∏ô data/user.json ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ backend)`);
};

/* ==== 3) CHAR MANAGEMENT ==== */
async function renderCharMgr() {
  let charIds = ['astra','slime_basic'];
  let all = await Promise.all(charIds.map(id=>fetch(`data/char/${id}.json`).then(r=>r.json())));
  let html = `<h2>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ (meta-json)</h2>
    <table style="width:100%;background:#2a3247;border-radius:12px;">
      <tr><th>‡∏£‡∏π‡∏õ</th><th>ID</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‚òÖ</th><th>‡∏ò‡∏≤‡∏ï‡∏∏</th><th>class</th><th>‡∏™‡∏Å‡∏¥‡∏•</th><th>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th></tr>
      ${all.map(c=>`
        <tr>
         <td><img src="img/char/${c.img}" style="width:36px;border-radius:9px;" /></td>
         <td>${c.id}</td>
         <td>${c.name}</td>
         <td>${c.star}</td>
         <td>${c.element}</td>
         <td>${c.class}</td>
         <td>${(c.skills||[]).length}</td>
         <td><button onclick="editCharPopup('${c.id}')" class="primary-btn" style="font-size:.93em;">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button></td>
        </tr>`).join('')}
    </table>
    <div style="margin:14px 0 0 0;text-align:right;">
      <button class="primary-btn" onclick="addCharPopup()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£</button>
    </div>
    <div style="color:#aaa;padding:13px 0;">*‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏∞ Reflect ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå .json ‡∏à‡∏£‡∏¥‡∏á (auto reload)</div>`;
  setAdminMain(html);
}
window.renderCharMgr = renderCharMgr;
window.editCharPopup = function (cid) { window.openPopup('editChar',`<div>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö (‡πÇ‡∏õ‡∏£‡∏î‡πÅ‡∏Å‡πâ json ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á)</div>`,'small','‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£'); }
window.addCharPopup = function () { window.openPopup('addChar',`<div>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö (‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô .json ‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô data/char/)</div>`,'small','‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£'); }

/* ==== 4) ITEM MANAGEMENT ==== */
async function renderItemMgr() {
  let items = await fetch('data/item.json').then(r=>r.json());
  let html = `<h2>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°</h2>
    <table style="width:100%;background:#273257;border-radius:12px;">
      <tr><th>‡∏£‡∏π‡∏õ</th><th>ID</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>type</th><th>desc</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤</th></tr>
      ${items.map(it=>
        `<tr>
           <td><img src="img/item/${it.img||'noimg.png'}" style="width:32px" /></td>
           <td>${it.id}</td><td>${it.name}</td>
           <td>${it.type||'-'}</td><td>${it.description||'-'}</td>
           <td>${it.price}</td>
        </tr>`
      ).join('')}
    </table>
    <div style="margin:14px 0 0 0;text-align:right;">
      <button class="primary-btn" onclick="alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°: ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà data/item.json')">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°</button>
    </div>`;
  setAdminMain(html);
}
window.renderItemMgr = renderItemMgr;

/* ==== 5) RUNE ==== */
async function renderRuneMgr() {
  let runes = await fetch('data/rune.json').then(r=>r.json());
  let html = `<h2>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏ô (rune.json)</h2>
    <table style="width:100%;background:#223549;border-radius:12px;">
      <tr><th>ICON</th><th>id</th><th>name</th><th>slot</th><th>main stat</th><th>set</th><th>sub</th></tr>
      ${runes.filter(r=>r.id).map(r=>
        `<tr>
         <td>${r.icon||'üî∏'}</td>
         <td>${r.id}</td>
         <td>${r.name}</td>
         <td>${r.slot}</td>
         <td>${r.main_stat ? `${r.main_stat.type}+${r.main_stat.val}` : '-'}</td>
         <td>${r.set}</td>
         <td>${(r.sub_stats||[]).map(s=>`${s.type}+${s.val}`).join(', ')}</td>
        </tr>`).join('')}
    </table>
    <div style="text-align:right;margin-top:13px;">
      <button class="primary-btn" onclick="alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏ô: ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô data/rune.json')">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏ô</button>
    </div>`;
  setAdminMain(html);
}
window.renderRuneMgr = renderRuneMgr;

/* ==== 6) QUEST (JSON) ==== */
async function renderQuestMgr() {
  setAdminMain(`<h2>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏ß‡∏™‡∏ï‡πå (‡πÇ‡∏õ‡∏£‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà data/quest/*.json)</h2>
    <div>‡πÄ‡∏Ñ‡∏ß‡∏™‡∏ï‡πå/‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡πâ‡∏ß reload ‡πÄ‡∏Å‡∏°</div>
    <div style="margin:16px 0;"><button class="primary-btn" onclick="alert('‡∏£‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ñ‡∏ß‡∏™‡∏ï‡πå')">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</button></div>`);
}

/* ==== 7) GACHA ==== */
async function renderGachaMgr() {
  let gacha = await fetch('data/gacha.json').then(r=>r.json());
  let html = `<h2>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏ä‡∏≤ (gacha.json)</h2>
      <table style="width:100%;background:#243168;border-radius:12px;">
      <tr><th>id</th><th>name</th><th>‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</th><th>type</th><th>cost</th><th>pool</th><th>‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°</th></tr>
      ${gacha.gachas.map(g=>
        `<tr>
         <td>${g.id}</td>
         <td>${g.name}</td>
         <td>${g.enabled ? "‚úî" : "‚ùå"}</td>
         <td>${g.type}</td>
         <td>${g.cost.amount} ${g.cost.item}</td>
         <td>${g.pool.map(p=>`${p.char_id}(‚òÖ${p.rarity})`).join(', ')}</td>
         <td><button onclick="alert('edit gacha: ‡πÇ‡∏õ‡∏£‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà data/gacha.json')" class="primary-btn">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button></td>
        </tr>`).join('')}
      </table>
      <div style="margin-top:11px;text-align:right;">
        <button onclick="alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏ä‡∏≤: ‡πÇ‡∏õ‡∏£‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç data/gacha.json')" class="primary-btn">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏ä‡∏≤</button>
      </div>`;
  setAdminMain(html);
}
window.renderGachaMgr = renderGachaMgr;

/* ==== 8) STAGE/DUNGEON ==== */
async function renderStageMgr() {
  setAdminMain(`<h2>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Stage/Dungeon</h2>
  <div>‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà, Zone, Stage ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î config ‡πÉ‡∏ô data/stage/*.json</div>`);
}

/* ==== 9) SHOP ==== */
async function renderShopMgr() {
  let shop = await fetch('data/shop.json').then(r=>r.json());
  let html = `<h2>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
      <table style="width:100%;background:#223249;border-radius:12px;">
      <tr><th>id</th><th>name</th><th>type</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th></tr>
      ${shop.shops.map(s=>
        `<tr>
         <td>${s.id}</td>
         <td>${s.name}</td>
         <td>${s.type}</td>
         <td>${s.enabled ? "‚úî" : "‚ùå"}</td>
         <td>${(s.items||[]).length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td>
        </tr>`).join('')}
      </table>
      <div style="margin-top:10px;text-align:right;">
        <button onclick="alert('update shop: ‡πÇ‡∏õ‡∏£‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà data/shop.json')" class="primary-btn">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
      </div>`;
  setAdminMain(html);
}
window.renderShopMgr = renderShopMgr;

/* ==== 10) ANNOUNCEMENT ==== */
async function renderAnnounceMgr() {
  let ann = await fetch('data/announcement.json').then(r=>r.json());
  let html = `<h2>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</h2>
    <table style="width:100%;background:#142449;border-radius:10px;">
    <tr><th>id</th><th>title</th><th>pin</th><th>type</th><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th></tr>
    ${ann.announcements.map(a=>
      `<tr>
        <td>${a.id}</td><td>${a.title}</td>
        <td>${a.pin?'‚úî':'‚ùå'}</td>
        <td>${a.type}</td>
        <td>${a.show_time ? new Date(a.show_time).toLocaleString() : '-'}</td>
        <td><button onclick="alert('Announce: ‡πÇ‡∏õ‡∏£‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà data/announcement.json')" class="primary-btn" style="font-size:.96em;">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button></td>
      </tr>`
    ).join('')}
    </table>
    <div style="margin-top:10px;text-align:right">
     <button class="primary-btn" onclick="alert('‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®: ‡πÇ‡∏õ‡∏£‡∏î‡πÅ‡∏Å‡πâ‡∏ó‡∏µ‡πà announcement.json')">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</button>
    </div>
    <div style="color:#ead;padding:13px;">*‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÉ‡∏´‡∏°‡πà/‡∏•‡∏ö ‡∏ï‡πâ‡∏≠‡∏á reload ‡πÑ‡∏ü‡∏•‡πå announcement.json ‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÄ‡∏Å‡∏°</div>`;
  setAdminMain(html);
}
window.renderAnnounceMgr = renderAnnounceMgr;

/* ==== 11) REDEEM CODE ==== */
async function renderRedeemMgr() {
  let rc = await fetch('data/redeem.json').then(r=>r.json());
  let html = `<h2>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏Ñ‡πâ‡∏î (redeem)</h2>
    <table style="width:100%;background:#212d41;border-radius:12px;">
      <tr><th>id</th><th>desc</th><th>active</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ</th><th>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th></tr>
      ${rc.codes.map(c=>
        `<tr>
         <td>${c.id}</td>
         <td>${c.desc}</td>
         <td>${c.enabled?'‚úî':'‚ùå'}</td>
         <td>${c.used_count||0}/${c.max_usage||'-'}</td>
         <td><button onclick="alert('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏Ñ‡πâ‡∏î: ‡πÇ‡∏õ‡∏£‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏ô data/redeem.json')" class="primary-btn">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button></td>
        </tr>`
      ).join('')}
    </table>
    <div style="margin-top:11px;text-align:right;">
      <button onclick="alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î: ‡πÇ‡∏õ‡∏£‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç data/redeem.json ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á')" class="primary-btn">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î</button>
    </div>`;
  setAdminMain(html);
}
window.renderRedeemMgr = renderRedeemMgr;

/* ==== 12) CHAT MOD/PANEL ==== */
async function renderChatMgr() {
  // Load chat log, banned words
  let chat = [];
  try { chat = await fetch('data/chat.json').then(r=>r.json()); } catch { chat = []; }
  let banned = [];
  try { banned = await fetch('data/banned_words.json').then(r=>r.json()); } catch {banned = [];}
  let html = `<h2>‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÅ‡∏ä‡∏ó/‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</h2>
    <h3>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (${chat.length})</h3>
    <div style="max-height:210px;overflow-y:auto;">
      <table style="width:100%;background:#23236c;border-radius:11px;">
        <tr><th style="width:120px;">‡πÄ‡∏ß‡∏•‡∏≤</th><th style="width:180px;">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</th><th>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</th><th>‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°</th></tr>
        ${chat.slice(-50).reverse().map(c=>
          `<tr>
            <td>${c.time ? (new Date(c.time)).toLocaleTimeString() : '-'}</td>
            <td>${c.user}</td>
            <td>${escapeHTML(c.text)}</td>
            <td>
              <button class="secondary-btn" style="padding:.2em 1.2em;" onclick="alert('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ: ‡πÅ‡∏Å‡πâ chat.json')">‡∏•‡∏ö</button>
            </td>
          </tr>`
        ).join('')}
      </table>
    </div>
    <h3>‡∏Ñ‡∏≥‡∏ï‡πâ‡∏≠‡∏á‡∏´‡πâ‡∏≤‡∏° (${banned.length})</h3>
    <div>
      <ul>
      ${banned.map(word=>`<li>${escapeHTML(word)} <button class="secondary-btn" onclick="alert('‡∏•‡∏ö‡∏Ñ‡∏≥‡∏ï‡πâ‡∏≠‡∏á‡∏´‡πâ‡∏≤‡∏°: ‡πÇ‡∏õ‡∏£‡∏î‡πÅ‡∏Å‡πâ banned_words.json ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á')">‡∏•‡∏ö</button></li>`).join('')}
      </ul>
      <button class="primary-btn" onclick="alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ï‡πâ‡∏≠‡∏á‡∏´‡πâ‡∏≤‡∏°: ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô banned_words.json')">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ï‡πâ‡∏≠‡∏á‡∏´‡πâ‡∏≤‡∏°</button>
    </div>
    <div style="color:#98ffe7;margin:11px 0 0 0;">* ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏ü‡∏•‡πå JSON ‡πÅ‡∏•‡∏∞‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏à‡∏∂‡∏á‡∏à‡∏∞‡∏°‡∏µ‡∏ú‡∏•</div>`;
  setAdminMain(html);
}
window.renderChatMgr = renderChatMgr;

// Utility for safe display in table
function escapeHTML(str) {
  return (str || "").replace(/[<>&"]/g, c=>
    ({'<':'&lt;','>':'&gt;','&':'&amp;','"':'&quot;'}[c]));
}

‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå js/chat.js
// js/chat.js

/*
  Epic Seven Card Auto Battle - Chat System
  - GM / Global / System / Player Chat
  - ‡πÄ‡∏Å‡πá‡∏ö chat.json + banned_words.json
  - Responsive, security filter, limited send rate
  - ‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö popup UI
  (C) 2024
*/

let chatList = [];     // [{user, text, time}, ...]
let bannedWords = [];  // ["badword1", ...]
let chatLastTime = 0;
const CHAT_LOG_MAX = 50;

// ‡πÇ‡∏´‡∏•‡∏î chat log (localStorage/data)
async function loadChat() {
  if (!chatList.length) {
    try {
      let arr = JSON.parse(localStorage.getItem('chat_log') || "[]");
      chatList = arr;
    } catch { chatList = []; }
  }
}
function saveChat() {
  let arr = chatList.slice(-CHAT_LOG_MAX); // keep recent
  localStorage.setItem('chat_log', JSON.stringify(arr));
}

// ‡πÇ‡∏´‡∏•‡∏î banned words
async function loadBannedWords() {
  if (!bannedWords.length) {
    try {
      let arr = await fetch('data/banned_words.json').then(r=>r.json());
      bannedWords = arr;
    } catch { bannedWords = []; }
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô render popup UI
async function openChatPopup() {
  await loadChat(); await loadBannedWords();
  renderChatListUI();

  let html = `
      <div style="max-height:300px;overflow-y:auto;" id="chatAreaList"></div>
      <div style="margin-top:1.0em;display:flex;gap:7px;">
        <input id="chatInputBox" maxlength="90" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..." style="flex:1;"/>
        <button class="primary-btn" onclick="sendChatMsg()">‡∏™‡πà‡∏á</button>
      </div>
      <div style="font-size:.86em;color:#cae;margin-top:.3em;">‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡∏∞ 1 ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πà‡∏≠ 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</div>
      <button class="secondary-btn" style="margin-top:9px;" onclick="closePopup()">‡∏õ‡∏¥‡∏î</button>
  `;
  window.openPopup('chat', html, 'tall', '‡πÅ‡∏ä‡∏ó Global');

  document.getElementById('chatInputBox').focus();
  setInterval(renderChatListUI, 4000); // refresh
}

// Render ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
function renderChatListUI() {
  let el = document.getElementById('chatAreaList');
  if (!el) return;
  let arr = chatList.slice(-CHAT_LOG_MAX);
  el.innerHTML = arr.map(c =>
   `<div style="display:flex;align-items:center;gap:7px;margin-bottom:2px;">
      <span style="color:#77f;font-weight:600;font-size:.98em;">[${formatChatTime(c.time)}] ${escapeHTML(c.user)}:</span>
      <span style="font-size:.97em;">${escapeHTML(c.text)}</span>
      ${c.system ? ` <span style="color:#ef7;font-size:.89em;">[System]</span>` : ""}
    </div>`).join('');
  el.scrollTop = el.scrollHeight;
}

// ‡∏ü‡∏≠‡∏£‡πå‡πÅ‡∏°‡∏ï‡πÄ‡∏ß‡∏•‡∏≤
function formatChatTime(ts) {
  let d = new Date(ts);
  return d.getHours().toString().padStart(2,"0")+":"+d.getMinutes().toString().padStart(2,"0");
}

// ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
window.sendChatMsg = function() {
  let box = document.getElementById('chatInputBox');
  if (!box) return;
  let txt = (box.value || "").trim();
  if (!txt) return;
  if (txt.length>90) return alert('‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô 90 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£');
  let now = Date.now();
  // Anti spam/rapid
  if (now - chatLastTime < 3000) { alert("‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠ 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°"); return; }
  chatLastTime = now;
  // ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠
  let username = localStorage.getItem('user_name') || 'Guest';
  // Filter banned
  let test = txt.toLowerCase();
  if (bannedWords.some(w => test.includes(w))) { alert("‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°!"); return; }
  // Safe HTML, not allow tags
  if (txt.match(/[<>]/)) { alert("‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï HTML"); return; }
  // Push log
  chatList.push({ user: username, text: txt, time: now, system: false });
  // ‡∏ï‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏Ñ‡πà 50 messages
  chatList = chatList.slice(-CHAT_LOG_MAX);
  saveChat();
  box.value = "";
  renderChatListUI();
}

// Add system message (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å battle/gacha)
window.addSystemChat = function(msg) {
  let now = Date.now();
  chatList.push({ user: "System", text: msg, time: now, system: true });
  chatList = chatList.slice(-CHAT_LOG_MAX);
  saveChat();
  renderChatListUI();
}

// Escape HTML
function escapeHTML(str) {
  return (str || "").replace(/[<>"']/g, c =>
    ({'<':'&lt;','>':'&gt;','&':'&amp;','"':'&quot;',"'":'&#39;'}[c]));
}

// Auto mount ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏ä‡∏ó‡πÉ‡∏ô‡πÄ‡∏°‡∏ô‡∏π
document.addEventListener('DOMContentLoaded', () => {
  let btn = document.getElementById('btnChat');
  if (btn) btn.onclick = openChatPopup;
});

// Export
window.chatEngine = {
  open: openChatPopup,
  addSystem: window.addSystemChat,
  reloadWords: async()=>{bannedWords=[];await loadBannedWords();}
};

‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå data/chat.json
[
  {
    "user": "System",
    "text": "‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡πÅ‡∏ä‡∏ó Global!",
    "time": 1717214400000,
    "system": true
  }
]

‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå data/banned_words.json
[
  "‡πÄ‡∏´‡∏µ‡πâ‡∏¢","‡∏Ñ‡∏ß‡∏¢","‡∏™‡∏±‡∏™","fuck","shit","bitch","‡πÅ‡∏°‡πà‡∏á","‡∏™‡πâ‡∏ô‡∏ï‡∏µ‡∏ô"
]

‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå js/gachaLog.js
// js/gachaLog.js - Epic Seven Card System: Gacha Log ‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏ä‡∏≤

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡πà‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ log ‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏ä‡∏≤‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (‡πÄ‡∏Å‡πá‡∏ö/‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å localStorage + ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏•‡∏î/‡πÄ‡∏ã‡∏ü‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏¢‡∏Å‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï)
 * ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏î‡∏π‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á, ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£, ‡πÅ‡∏¢‡∏Å per user, per event, ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö ‡∏Ø‡∏•‡∏Ø
 * (c) 2024
 */

// ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 1 log: { user_id, time, gacha_id, char_id, rarity }

let gachaLogList = [];   // Log ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß
let gachaLogLoaded = false;

// ‡πÇ‡∏´‡∏•‡∏î log gacha (‡∏à‡∏≤‡∏Å localStorage ‡∏´‡∏£‡∏∑‡∏≠ data/gacha_log.json ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö admin/audit)
async function loadGachaLog() {
    if (gachaLogLoaded) return;
    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡∏≠‡∏á user ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏à‡∏≤‡∏Å localStorage ‡πÄ‡∏™‡∏°‡∏≠
    try {
        gachaLogList = JSON.parse(localStorage.getItem('gacha_log') || '[]');
    } catch { gachaLogList = []; }

    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô admin ‡∏´‡∏£‡∏∑‡∏≠ dev ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î data/gacha_log.json (read-only) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π log ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô (‡∏à‡∏≥‡∏•‡∏≠‡∏á)
    if (window.isAdmin && window.isAdmin()) {
        try {
            let allLog = await fetch('data/gacha_log.json').then(r => r.json());
            gachaLogList = allLog.logs || [];
        } catch { /* skip if unavailable */ }
    }
    gachaLogLoaded = true;
}

// ‡πÄ‡∏ã‡∏ü log ‡∏•‡∏á localStorage ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡πà‡∏° gacha)
function saveGachaLog() {
    localStorage.setItem('gacha_log', JSON.stringify(gachaLogList));
}

// ‡πÄ‡∏û‡∏¥‡πà‡∏° log ‡πÉ‡∏´‡∏°‡πà (‡πÉ‡∏ä‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏´‡∏•‡∏±‡∏á‡∏™‡∏∏‡πà‡∏° gacha ‡πÑ‡∏î‡πâ ‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏•‡∏≤‡∏¢‡πÉ‡∏ö)
window.addGachaLog = function({ user_id, gacha_id, char_id, rarity }) {
    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å timestamp + id ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
    const entry = {
        user_id: user_id || (localStorage.getItem('user_id') || 'guest'),
        gacha_id,
        char_id,
        rarity,
        time: Date.now()
    };
    gachaLogList.push(entry);
    // ‡πÄ‡∏Å‡πá‡∏ö log ‡πÅ‡∏Ñ‡πà 200 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ï‡πà‡∏≠ user
    gachaLogList = gachaLogList.slice(-200);
    saveGachaLog();
};

// ‡∏î‡∏π log ‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á (‡∏Ç‡∏≠‡∏á user ‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
window.queryMyGachaLog = async function(limit = 50) {
    await loadGachaLog();
    const user_id = localStorage.getItem('user_id') || 'guest';
    return gachaLogList.filter(l => l.user_id === user_id).slice(-limit).reverse();
};

// ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö admin: ‡∏î‡∏π log ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô (require isAdmin)
window.queryAllGachaLog = async function(limit = 1000) {
    await loadGachaLog();
    if (!window.isAdmin || !window.isAdmin()) {
        alert("‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏à‡∏∂‡∏á‡∏à‡∏∞‡∏î‡∏π log ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏î‡πâ");
        return [];
    }
    return gachaLogList.slice(-limit).reverse();
};

// Render Popup ‡πÅ‡∏™‡∏î‡∏á log ‡∏Å‡∏≤‡∏ä‡∏≤ user
window.openMyGachaLogPopup = async function() {
    const log = await window.queryMyGachaLog(60);
    let html = `
        <div style="font-size:1.14em;font-weight:bold;margin-bottom:7px;">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏ä‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
        <div style="max-height:340px;overflow-y:auto;">
        <table style="background:#1a2637;width:99%;border-radius:13px;">
        <tr style="color:#7dd;"><th>#</th><th>‡∏ß‡∏±‡∏ô/‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏Å‡∏≤‡∏ä‡∏≤</th><th>‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£</th><th>‚òÖ</th></tr>
        ${
            log.length ? 
            log.map((l, i) => `<tr>
                <td>${i+1}</td>
                <td>${(new Date(l.time)).toLocaleString()}</td>
                <td>${l.gacha_id}</td>
                <td>${l.char_id}</td>
                <td style="color:${l.rarity>=5?'gold':'#bee'};">‚òÖ${l.rarity}</td>
            </tr>`).join("") 
            : `<tr><td colspan="5" style="color:#faa;text-align:center;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏ä‡∏≤</td></tr>`
        }
        </table>
        </div>
        <div style="text-align:right;margin-top:13px;">
            <button class="secondary-btn" onclick="closePopup()">‡∏õ‡∏¥‡∏î</button>
        </div>
    `;
    window.openPopup('gachaLog', html, 'large', "‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏ä‡∏≤");
};

// (Admin) Render Log ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î popup
window.openAdminAllGachaLogPopup = async function() {
    const log = await window.queryAllGachaLog(500);
    let html = `
        <div style="font-size:1.14em;font-weight:bold;margin-bottom:7px;">[ADMIN] ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏ä‡∏≤‡∏ó‡∏∏‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</div>
        <div style="max-height:370px;overflow-y:auto;">
        <table style="background:#19263a;width:99%;border-radius:8px;">
        <tr style="color:#7dd;"><th>#</th><th>‡∏ß‡∏±‡∏ô/‡πÄ‡∏ß‡∏•‡∏≤</th><th>User</th><th>‡∏Å‡∏≤‡∏ä‡∏≤</th><th>‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£</th><th>‚òÖ</th></tr>
        ${
            log.length ? 
            log.map((l, i) => `<tr>
                <td>${i+1}</td>
                <td>${(new Date(l.time)).toLocaleString()}</td>
                <td>${l.user_id}</td>
                <td>${l.gacha_id}</td>
                <td>${l.char_id}</td>
                <td style="color:${l.rarity>=5?'gold':'#bee'};">‚òÖ${l.rarity}</td>
            </tr>`).join("") 
            : `<tr><td colspan="6" style="color:#faa;">‡πÑ‡∏°‡πà‡∏°‡∏µ log</td></tr>`
        }
        </table>
        </div>
        <div style="text-align:right;margin-top:13px;">
            <button class="secondary-btn" onclick="closePopup()">‡∏õ‡∏¥‡∏î</button>
        </div>
    `;
    window.openPopup('allGachaLog', html, 'large', "Gacha Log (ADMIN)");
};

// Auto menu: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô admin panel ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏°‡∏ô‡∏π profile
document.addEventListener('DOMContentLoaded', ()=>{
    if (document.getElementById('btnGachaLog')) {
        document.getElementById('btnGachaLog').onclick = window.openMyGachaLogPopup;
    }
    // ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å popup ‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å gacha.js ‡∏´‡∏•‡∏±‡∏á‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à
});

// Export ‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°
window.gachaLogEngine = {
    add: window.addGachaLog,
    mylog: window.queryMyGachaLog,
    all: window.queryAllGachaLog,
    open: window.openMyGachaLogPopup
};

‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå data/gacha_log.json
{
  "logs": [
    {
      "user_id": "player1",
      "time": 1717228300000,
      "gacha_id": "premium_summon",
      "char_id": "astra",
      "rarity": 5
    },
    {
      "user_id": "player2",
      "time": 1717228400000,
      "gacha_id": "premium_summon",
      "char_id": "slime_basic",
      "rarity": 3
    }
    // ...‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏¢‡πÜ
  ]
}

‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå js/energy.js
// js/energy.js
//
// Epic Seven Card Battle - Energy (Stamina) System (Frontend only)
//
// ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö energy bar, ‡∏•‡∏î/‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏î‡∏±‡∏ô‡πÄ‡∏à‡∏µ‡πâ‡∏¢‡∏ô, ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï, ‡πÉ‡∏ä‡πâ item, ‡∏õ‡πá‡∏≠‡∏õ‡∏≠‡∏±‡∏õ ‡πÄ‡∏ï‡∏¥‡∏°/‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏°‡∏î, ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
// ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ sync ‡∏Å‡∏±‡∏ö LocalStorage ‡∏´‡∏£‡∏∑‡∏≠ API/JSON ‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡πÑ‡∏î‡πâ

const DEFAULT_MAX_ENERGY = 45;     // cap ‡∏Ñ‡πà‡∏≤ default
const REGEN_INTERVAL_MIN = 12;     // 1 energy ‡∏ï‡πà‡∏≠‡∏Å‡∏µ‡πà‡∏ô‡∏≤‡∏ó‡∏µ? (12 ‡∏ô‡∏≤‡∏ó‡∏µ = 5/‡∏ä‡∏°)
const REGEN_AMOUNT    = 1;
const REGEN_TICK_MS   = 60 * 1000; // 1 ‡∏ô‡∏≤‡∏ó‡∏µ/loop (‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô 10 ‡∏ß‡∏¥/DEV ‡πÑ‡∏î‡πâ)
const ENERGY_ITEM_IDS = ['heal_potion']; // ‡πÉ‡∏ä‡πâ heal_potion ‡πÄ‡∏ï‡∏¥‡∏° energy ‡πÑ‡∏î‡πâ
let energy_config = { max: DEFAULT_MAX_ENERGY, regen_min: REGEN_INTERVAL_MIN };

// ===== 1. STATE =====
function getEnergy() {
    let e = Number(localStorage.getItem('user_energy'));
    if (isNaN(e)) e = energy_config.max;
    return e;
}

function setEnergy(val) {
    localStorage.setItem('user_energy', val);
    renderEnergyBar();
}

function getEnergyMax() {
    return energy_config.max || DEFAULT_MAX_ENERGY;
}

// ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏à‡∏ô‡πÄ‡∏ï‡∏¥‡∏° 1 energy ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (timestamp)
function getNextRegenTs() {
    let ts = Number(localStorage.getItem('energy_next_ts'));
    if (!ts) {
        ts = Date.now() + energy_config.regen_min * 60 * 1000;
        localStorage.setItem('energy_next_ts', ts);
    }
    return ts;
}

function setNextRegenTs(ts) {
    localStorage.setItem('energy_next_ts', ts);
}

// ===== 2. REGEN AUTO PER TIME (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏≠‡∏≠‡∏ô/‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏Å‡∏°) =====
function energyRegenTick() {
    let eNow = getEnergy();
    let eMax = getEnergyMax();
    if (eNow >= eMax) {
        setNextRegenTs(Date.now() + energy_config.regen_min * 60 * 1000);
        return;
    }
    let ts = getNextRegenTs();
    let now = Date.now();
    if (now >= ts) {
        setEnergy(Math.min(eMax, eNow + REGEN_AMOUNT));
        setNextRegenTs(now + energy_config.regen_min * 60 * 1000);
        renderEnergyBar();
    }
}

// ===== 3. Energy UI BAR (Footer, Header, ‡∏´‡∏£‡∏∑‡∏≠ Popup) =====
function renderEnergyBar() {
    let bar = document.getElementById('energyBarUI');
    if (!bar) {
        bar = document.createElement('div');
        bar.id = 'energyBarUI';
        Object.assign(bar.style, {
            position: 'fixed',
            left: '18px',
            top: '82px',
            zIndex: '50',
            background: '#211d27e8',
            color: '#c8f8fd',
            borderRadius: '12px',
            padding: '7px 16px 5px 16px',
            fontFamily: 'inherit',
            fontWeight: 'bold',
            boxShadow: '0 3px 19px #14effa24',
            fontSize: '1.08em',
            minWidth: '110px',
            userSelect: 'none',
            cursor: 'pointer'
        });
        document.body.appendChild(bar);
        bar.onclick = openEnergyDetailPopup;
    }
    let energy = getEnergy();
    let eMax = getEnergyMax();
    let ts = getNextRegenTs();
    let minLeft = Math.max(0, Math.ceil((ts - Date.now()) / 60000));
    bar.innerHTML = `<span style="color:#71eaff;font-size:1.23em;">‚ö° ENERGY</span> <span style="color:#fafd85;">${energy}</span>/<b>${eMax}</b><span style="font-size:.93em;color:#8ee;"> ${energy < eMax ? `(+1 ‡πÉ‡∏ô ${minLeft}‡∏ô‡∏≤‡∏ó‡∏µ)` : ''}</span>`;
}

// Popup ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
function openEnergyDetailPopup() {
    let energy = getEnergy();
    let max = getEnergyMax();
    let minLeft = Math.ceil((getNextRegenTs() - Date.now()) / 60000);
    let html = `
      <div style="padding:6px 11px;text-align:center;">
        <div style="font-size:1.1em;margin-bottom:8px;">‚ö° <b>‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô</b> (${energy} / ${max})</div>
        <div style="color:#bdf;">${energy < max ? `‡∏à‡∏∞‡∏ü‡∏∑‡πâ‡∏ô +1 energy ‡πÉ‡∏ô‡∏≠‡∏µ‡∏Å <b>${minLeft}</b> ‡∏ô‡∏≤‡∏ó‡∏µ` : '‡πÄ‡∏ï‡πá‡∏°‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß'}</div>
        <hr style="margin:12px 0;" />
        <button class="primary-btn" style="margin-bottom:6px;" onclick="refillEnergyWithItem()">‡πÉ‡∏ä‡πâ Heal Potion ‡πÄ‡∏û‡∏¥‡πà‡∏° Energy</button>
        <div style="font-size:.95em;color:#7cf;">Heal Potion = +15 Energy</div>
        <hr style="margin:12px 0;" />
        <button class="secondary-btn" onclick="closePopup()">‡∏õ‡∏¥‡∏î</button>
      </div>
    `;
    window.openPopup('energyDetail', html, 'small', '‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô Energy');
}

window.refillEnergyWithItem = function() {
    // ‡πÉ‡∏ä‡πâ‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏° (heal_potion) ‡πÉ‡∏ô inventory
    let inventory = window.inventoryEngine?.list() || [];
    let owned = inventory.find(i => ENERGY_ITEM_IDS.includes(i.id) && i.qty >= 1);
    if (!owned) {
        alert("‡πÑ‡∏°‡πà‡∏°‡∏µ Heal Potion ‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á");
        return;
    }
    let val = 15;
    let energy = getEnergy();
    let max = getEnergyMax();
    let after = Math.min(max, energy + val);
    setEnergy(after);
    window.inventoryEngine.remove(owned.id, 1);
    closePopup('energyDetail');
    setTimeout(() => renderEnergyBar(), 222);
    alert(`Energy +${after - energy}`);
};

// ===== 4. Energy ‡∏•‡∏î/‡πÄ‡∏û‡∏¥‡πà‡∏° ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏î‡∏±‡∏ô‡πÄ‡∏à‡∏µ‡πâ‡∏¢‡∏ô/‡∏≠‡∏∑‡πà‡∏ô‡πÜ =====
window.addEnergy = function(val) {
    let e = Math.min(getEnergyMax(), getEnergy() + val);
    setEnergy(e);
    renderEnergyBar();
};
window.reduceEnergy = function(val) {
    let e = Math.max(0, getEnergy() - val);
    setEnergy(e);
    renderEnergyBar();
};

// ===== 5. INIT (DOMContentLoaded) =====
document.addEventListener('DOMContentLoaded', () => {
    // ‡πÇ‡∏´‡∏•‡∏î config
    fetch('data/energy.json').then(r => r.json()).then(cfg => {
        if (cfg?.max) energy_config.max = cfg.max;
        if (cfg?.regen_min) energy_config.regen_min = cfg.regen_min;
    }).catch(() => {});

    // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ energy ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏ï‡πá‡∏°
    if (!localStorage.getItem('user_energy')) setEnergy(energy_config.max);
    // ‡∏ï‡∏¥‡∏î energy bar UI
    setTimeout(() => renderEnergyBar(), 350);

    // Loop regen ‡∏ó‡∏∏‡∏Å REGEN_TICK_MS
    setInterval(energyRegenTick, REGEN_TICK_MS);

    // ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πà‡∏ô‡∏î‡∏±‡∏ô‡πÄ‡∏à‡∏µ‡πâ‡∏¢‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å
    window.renderEnergyBar = renderEnergyBar;
    window.openEnergyDetailPopup = openEnergyDetailPopup;
});

// ===== 6. Export API ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÉ‡∏ä‡πâ =====
window.energyEngine = {
    get: getEnergy,
    set: setEnergy,
    max: getEnergyMax,
    add: window.addEnergy,
    reduce: window.reduceEnergy,
    render: renderEnergyBar,
    openDetail: openEnergyDetailPopup,
    config: energy_config,
};

‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå data/energy.json
{
  "max": 45,         // Max Energy ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö user ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô admin/‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå)
  "regen_min": 12    // 1 energy ‡∏ü‡∏∑‡πâ‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏∏‡∏Å 12 ‡∏ô‡∏≤‡∏ó‡∏µ
}

‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå data/config.json
{
  "battle": {
    "spd_bar_max": 100,
    "spd_frame": 120,
    "max_team": 4,
    "max_monster": 4,
    "show_crit_popup": true,
    "ani_slide_duration": 350
  },
  "exp": {
    "base_win": 60,
    "base_lose": 18,
    "exp_up_event": 1.0
  },
  "drop": {
    "exp_potion_rate": 55,
    "rune_shard_rate": 22,
    "gold_rate": 80
  },
  "stat_curve": {
    "hero_hp": 1.085,
    "hero_atk": 1.08,
    "hero_def": 1.09
  },
  "energy": {
    "max": 45,
    "regen_min": 12
  },
  "cooldown": {
    "base_cd_reduce": 1,
    "cd_reset_by_item": true
  },
  "limit": {
    "max_inventory": 999,
    "max_char_collection": 50,
    "max_party": 4
  },
  "gacha": {
    "pity_enabled": true,
    "pity_count": 20,
    "gacha_log_limit": 150
  },
  "file_version": "1.0.0",
  "update": "2024-06-07"
}

‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå js/localization.js
// js/localization.js
/**
 * Localization System (Epic Seven Card Battle)
 * - Auto-detect, allow manual switch
 * - All string must use key, ex: t("menu.team")
 * - Work with all modular code, async/dynamic
 * (c) 2024
 */

let langData = {};       // Object of all text key:value
let langList = ['th', 'en']; // So far - more add as needed
let currentLang = 'th';  // Default: Thai

// Load language data from /data/lang/*.json
async function loadLang(lang) {
    if (!langList.includes(lang)) lang = 'en';
    currentLang = lang;
    langData = {};
    try {
        langData = await fetch(`data/lang/${lang}.json`).then(r => r.json());
        localStorage.setItem('user_lang', lang);
    } catch {
        langData = {};
    }
    applyLanguageToUI();
}

// Localizer function t(key) | lang(key)
function t(key, args = {}) {
    let keys = key.split('.');
    let val = langData;
    for (let k of keys) {
        val = (val || {})[k];
        if (!val) break;
    }
    if (!val) return key;
    // Replace {xxx} in text by args.xxx
    if (typeof val === 'string') {
        return val.replace(/{(\w+)}/g, (a, b) => args[b] || '');
    }
    return val;
}

// Apply language to all .trans-key UI (with data-trans="key")
function applyLanguageToUI() {
    document.querySelectorAll('[data-trans]').forEach(el => {
        el.innerHTML = t(el.getAttribute('data-trans'));
    });
}

// Add lang switcher menu/button in your UI
function renderLangMenu(containerId = "langMenu") {
    let html = `<select id="langSel" style="padding:.4em 1.4em;font-size:1em;">` +
        langList.map(code => `<option value="${code}" ${code === currentLang ? "selected" : ""}>${langName(code)}</option>`).join('') +
        `</select>`;
    (document.getElementById(containerId) || document.body).innerHTML = html;
    setTimeout(() => {
        document.getElementById('langSel').onchange = e => {
            loadLang(e.target.value);
            applyLanguageToUI();
        };
    }, 1);
}

function langName(code) {
    return {
        en: 'English',
        th: '‡πÑ‡∏ó‡∏¢',
        ja: 'Êó•Êú¨Ë™û'
    }[code] || code.toUpperCase();
}

// On startup: load language (from localStorage or browser)
document.addEventListener('DOMContentLoaded', () => {
    let userLang = localStorage.getItem('user_lang') || navigator.language.substr(0,2) || 'th';
    if (!langList.includes(userLang)) userLang = 'th';
    loadLang(userLang);
    // Optional: render switcher menu somewhere (ex: footer)
    if (document.getElementById('footerLangMenu')) renderLangMenu('footerLangMenu');
});

// Expose for modules
window.t = t;
window.lang = t;
window.selectLang = loadLang;
window.applyLanguageToUI = applyLanguageToUI;
window.renderLangMenu = renderLangMenu;

‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå data/lang/th.json
{
  "menu": {
    "team": "‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏°",
    "battle": "‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ",
    "inventory": "‡∏Ñ‡∏•‡∏±‡∏á‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°",
    "quest": "‡πÄ‡∏Ñ‡∏ß‡∏™‡∏ï‡πå",
    "shop": "‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤",
    "gacha": "‡∏Å‡∏≤‡∏ä‡∏≤",
    "character": "‡∏Ñ‡∏•‡∏±‡∏á‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£",
    "announcement": "‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®",
    "chat": "‡πÅ‡∏ä‡∏ó",
    "login": "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö",
    "logout": "‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö"
  },
  "popup": {
    "ok": "‡∏ï‡∏Å‡∏•‡∏á",
    "cancel": "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å",
    "close": "‡∏õ‡∏¥‡∏î",
    "confirm": "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô",
    "use_item": "‡πÉ‡∏ä‡πâ‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°",
    "upgrade": "‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î",
    "equip": "‡πÉ‡∏™‡πà‡∏£‡∏π‡∏ô",
    "result_win": "‡∏ä‡∏±‡∏¢‡∏ä‡∏ô‡∏∞!",
    "result_lose": "‡πÅ‡∏û‡πâ"
  },
  "battle": {
    "auto": "‡∏≠‡∏≠‡πÇ‡∏ï‡πâ",
    "start": "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ",
    "back": "‡∏Å‡∏•‡∏±‡∏ö",
    "hp": "HP",
    "atk": "‡πÇ‡∏à‡∏°‡∏ï‡∏µ",
    "def": "‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô",
    "spd": "‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß",
    "crit": "‡∏Ñ‡∏£‡∏¥",
    "exp_gain": "‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö EXP",
    "drop_items": "‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö"
  },
  "inventory": {
    "title": "‡∏Ñ‡∏•‡∏±‡∏á‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°",
    "use": "‡πÉ‡∏ä‡πâ",
    "no_item": "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°"
  },
  "character": {
    "title": "‡∏Ñ‡∏•‡∏±‡∏á‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£",
    "lock": "‡∏•‡πá‡∏≠‡∏Å",
    "unlock": "‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å",
    "upgrade": "‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î"
  },
  "gacha": {
    "draw1": "‡∏™‡∏∏‡πà‡∏° 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á",
    "draw10": "‡∏™‡∏∏‡πà‡∏° 10 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á",
    "result": "‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏ä‡∏≤"
  },
  "energy": {
    "energy": "‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô",
    "full": "‡πÄ‡∏ï‡πá‡∏°",
    "refill": "‡πÄ‡∏ï‡∏¥‡∏°‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô",
    "next": "‡∏≠‡∏µ‡∏Å {min} ‡∏ô‡∏≤‡∏ó‡∏µ"
  },
  "admin": {
    "panel": "Admin Panel",
    "user": "‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ",
    "item": "‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°",
    "quest": "‡πÄ‡∏Ñ‡∏ß‡∏™‡∏ï‡πå",
    "gacha": "‡∏Å‡∏≤‡∏ä‡∏≤",
    "shop": "‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤"
  }
}

‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå data/lang/en.json
{
  "menu": {
    "team": "Team Setup",
    "battle": "Battle",
    "inventory": "Inventory",
    "quest": "Quest",
    "shop": "Shop",
    "gacha": "Gacha",
    "character": "Characters",
    "announcement": "Announcement",
    "chat": "Chat",
    "login": "Login",
    "logout": "Logout"
  },
  "popup": {
    "ok": "OK",
    "cancel": "Cancel",
    "close": "Close",
    "confirm": "Confirm",
    "use_item": "Use Item",
    "upgrade": "Upgrade",
    "equip": "Equip",
    "result_win": "Victory!",
    "result_lose": "Defeat"
  },
  "battle": {
    "auto": "Auto",
    "start": "Start Battle",
    "back": "Back",
    "hp": "HP",
    "atk": "ATK",
    "def": "DEF",
    "spd": "SPD",
    "crit": "Crit",
    "exp_gain": "EXP gained",
    "drop_items": "Drop Items"
  },
  "inventory": {
    "title": "Inventory",
    "use": "Use",
    "no_item": "No items"
  },
  "character": {
    "title": "Character Box",
    "lock": "Lock",
    "unlock": "Unlock",
    "upgrade": "Upgrade"
  },
  "gacha": {
    "draw1": "Draw 1",
    "draw10": "Draw 10",
    "result": "Gacha Result"
  },
  "energy": {
    "energy": "Energy",
    "full": "Full",
    "refill": "Refill",
    "next": "in {min} min"
  },
  "admin": {
    "panel": "Admin Panel",
    "user": "User",
    "item": "Item",
    "quest": "Quest",
    "gacha": "Gacha",
    "shop": "Shop"
  }
}

‡∏ó‡∏∏‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏∏‡∏î‡∏ï‡πà‡∏≤‡∏á‡πÜ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏Å‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™‡∏Å‡∏±‡∏ô ‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡∏´‡∏≤‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ô‡∏±‡πâ‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏´‡∏ô‡∏ö‡πâ‡∏≤‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏ß‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏´‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏°‡∏≤ ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏ß‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Ñ console ‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏¥‡∏î error ‡∏°‡∏±‡πâ‡∏¢
‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏´‡πâ‡∏≤‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏±‡∏î‡∏Å‡∏±‡∏ö‡∏à‡∏∏‡∏î‡∏≠‡∏∑‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡πÑ‡∏°‡πà‡∏á‡∏±‡πâ‡∏ô‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏ö

‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏ü‡∏•‡πå
1.js/ui.js, popupManager.js (core popup & noti)
2.‡πÄ‡∏û‡∏¥‡πà‡∏° js/utils.js ‡πÅ‡∏•‡πâ‡∏ß import ‡πÉ‡∏ô‡∏ó‡∏∏‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
3.battle.js, team.js, effect.js, passive.js, animationEngine.js, result.js (loop, state, event, win/lose, popup call)
4.inventory.js, item.json, shop.js, reward, quest, stage, energy (‡∏Ç‡∏≠‡∏á, ‡∏î‡πà‡∏≤‡∏ô, exp, ‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô, ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• ‡πÄ‡∏ï‡∏¥‡∏°-‡∏•‡∏î‡πÑ‡∏î‡πâ)
5.characterCollection.js, upgrade.js, rune.js (‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£/‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î/‡∏£‡∏π‡∏ô)
6.gacha.js, gachaLog.js (‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏•‡∏±‡∏á‡∏™‡∏∏‡πà‡∏° add to collection ‡πÅ‡∏•‡πâ‡∏ß log)
7.chat.js, announcement.js, redeem.js (popup, noti, dot, admin)
8.admin.js (guard, panel UI, lazy load JSON ‡πÉ‡∏ô panel)
‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏∏‡∏î‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡∏∞‡∏•‡∏≥‡∏î‡∏±‡∏ö (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏ï‡πá‡∏° ‡πÑ‡∏°‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ã‡πâ‡∏≥)
1. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏£‡∏µ‡πÅ‡∏ü‡∏Å‡πÄ‡∏ï‡∏≠‡∏£‡πå UI/Popup Manager ‡πÉ‡∏´‡πâ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡∏ó‡∏∏‡∏Å module
2. ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô utils.js ‡πÅ‡∏•‡πâ‡∏ß update ‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÉ‡∏´‡πâ import ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏≤‡∏Å utils
3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö battle.js, effect.js, passive.js ‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô (trigger event, passive, buff/debuff, animation)
4. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö inventory ‡∏´‡∏•‡∏±‡∏á shop, quest, battle, redeem, gacha ‡πÄ‡∏û‡∏∑‡πà‡∏≠ sync ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
5. ‡πÉ‡∏´‡πâ quest/stage/unlock/exp/energy update ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô
6. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö language/i18n ‡πÉ‡∏´‡πâ .innerHTML ‡πÉ‡∏ô popup ‡∏ó‡∏∏‡∏Å‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏£‡∏±‡∏ö t(key) ‡πÑ‡∏°‡πà hardcode
7. ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á admin panel ‡∏ó‡∏∏‡∏Å‡πÄ‡∏°‡∏ô‡∏π json/‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏ö/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç

‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏ô‡∏µ‡πâ

‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï js/popupManager.js
// js/popupManager.js

let popupStack = [];  // Stack ‡πÄ‡∏Å‡πá‡∏ö popup layer ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î

/**
 * ‡πÄ‡∏õ‡∏¥‡∏î Popup ‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠ (‡πÄ‡∏û‡∏¥‡πà‡∏° Stack)
 * @param {Object} options
 * @property {String} id ‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
 * @property {String} title
 * @property {String} content HTML
 * @property {String} size 'normal'|'large'|'tall'|'small'
 * @property {Function} onClose callback
 * @property {Boolean} showCloseBtn
 * @property {String} autoFocus selector
 */
window.popupManager = {
    open: function (options = {}) {
        // ‡∏´‡∏≤‡∏Å‡∏ã‡πâ‡∏≥ id ‡πÉ‡∏ô stack ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏ã‡πâ‡∏≥
        if (popupStack.some(p => p.id === options.id)) return;
        const popupLayer = document.getElementById('popupLayer');
        if (!popupLayer) return;
        const { id, title, content, size, onClose, showCloseBtn, autoFocus } = options;
        const sz = size || 'normal';
        let html = `
      <div class="popup${sz==='large'?' large':sz==='tall'?' tall':sz==='small'?' small':''}" style="z-index:${100+popupStack.length*2};" popup-id="${id||''}">
          ${showCloseBtn===false?'':`<button class="close" onclick="popupManager.close('${id||''}')">&times;</button>`}
          <h2 style="margin-bottom:.39em;">${typeof t === 'function' ? t(title||id) : (title||'')}</h2>
          <div class="popup-content" style="margin-top:9px;">${content || ''}</div>
      </div>`;
        let wrap = document.createElement('div');
        wrap.className = 'popup-wrap-layer';
        wrap.style = `position:fixed; top:0; left:0; width:100vw;height:100vh;display:flex;
          align-items:center;justify-content:center;z-index:${99 + popupStack.length*2+1};`;
        wrap.innerHTML = html;
        popupStack.push({
            id,
            wrap,
            onClose: typeof onClose === "function"?onClose:null
        });
        popupLayer.appendChild(wrap);
        popupLayer.classList.add('active');
        if (autoFocus) {
            setTimeout(()=>{ const el = wrap.querySelector(autoFocus); if(el) el.focus(); }, 150)
        }
        // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö language/refresh
        if (typeof applyLanguageToUI === "function") setTimeout(applyLanguageToUI, 15);
    },

    /** ‡∏õ‡∏¥‡∏î Popup (‡∏ó‡∏µ‡∏•‡∏∞‡∏ä‡∏±‡πâ‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏∞‡∏ö‡∏∏ id) */
    close: function(id='') {
        const popupLayer = document.getElementById('popupLayer');
        if (!popupLayer) return;
        if (!popupStack.length) return;
        let pop;
        if(id) {
            let idx = popupStack.findIndex(p=>p.id===id);
            if(idx===-1) return;
            pop = popupStack.splice(idx,1)[0];
            if (pop && pop.wrap) pop.wrap.remove();
        } else {
            pop = popupStack.pop();
            if (pop && pop.wrap) pop.wrap.remove();
        }
        if (pop && pop.onClose) pop.onClose();
        if (!popupStack.length) popupLayer.classList.remove('active');
    },

    /** ‡∏õ‡∏¥‡∏î Popups ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (reset stack) */
    closeAll: function () {
        const popupLayer = document.getElementById('popupLayer');
        popupStack.forEach(p => {
            if (p.wrap) p.wrap.remove();
            if (typeof p.onClose==="function") p.onClose();
        });
        popupStack = [];
        if (popupLayer) popupLayer.classList.remove('active');
    },

    /** Render content ‡πÉ‡∏´‡∏°‡πà‡∏ö‡∏ô popup id ‡∏ô‡∏µ‡πâ (‡πÄ‡∏ä‡πà‡∏ô refresh) */
    update: function(id, content) {
        let pop = popupStack.find(p => p.id===id);
        if(pop && pop.wrap) {
            let inner = pop.wrap.querySelector('.popup-content');
            if(inner) inner.innerHTML = content;
        }
    },

    getStack: function () { return [...popupStack]; }
};

// Shortcuts
window.openPopup = function (id, content = '', size = 'normal', title = '', options = {}) {
    window.popupManager.open({id, title: title || id, content, size, ...options});
}
window.closePopup = function (id = '') { window.popupManager.close(id); }
window.closeAllPopup = function () { window.popupManager.closeAll(); }

// Escape key = close popup
document.addEventListener('keyup', ev => {
    if(ev.key === 'Escape') popupManager.close();
});
// Click shadow layer (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏¥‡∏î popup ‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï)
document.getElementById('popupLayer')?.addEventListener('mousedown', ev => {
    if(ev.target.classList.contains('popup-wrap-layer')) {
        if(!popupStack.length) return;
        let last = popupStack[popupStack.length-1];
        if(last && last.wrap && last.wrap.querySelector('.close')) {
            window.popupManager.close();
        }
    }
});

// Menu notification dots (ex. new announcement, quest, etc.)
window.setMenuNoti = function(btnId, show) {
    const btn = document.getElementById(btnId);
    if(btn) {
        if(show) btn.classList.add('noti');
        else btn.classList.remove('noti');
    }
};

‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏ü‡∏•‡πå js/ui.js
// js/ui.js

document.addEventListener('DOMContentLoaded', () => {
    // Menu button event mapping: [btnId, popupId or function]
    const menuActions = {
        btnTeam: () => openPopup('team', '', 'large', t("menu.team")),
        btnBattle: () => openPopup('Battle', '', 'large', t("menu.battle")),
        btnInventory: () => openPopup('inventory', '', 'large', t("menu.inventory")),
        btnQuest: () => openPopup('quest', '', 'large', t("menu.quest")),
        btnShop: () => openPopup('shop', '', 'large', t("menu.shop")),
        btnGacha: () => openPopup('gacha', '', 'large', t("menu.gacha")),
        btnCharacter: () => openPopup('characterCollection', '', 'large', t("menu.character")),
        btnAnnouncement: () => openPopup('announcement', '', 'large', t("menu.announcement")),
        btnChat: () => openPopup('chat', '', 'tall', t("menu.chat")),
        btnLogin: () => openPopup('login', '', 'small', t("menu.login")),
    };
    Object.entries(menuActions).forEach(([btnId, action]) => {
        const btn = document.getElementById(btnId);
        if (btn) btn.addEventListener('click', action);
    });

    // Profile name
    window.setPlayerName = function(name) {
        let el = document.getElementById('playerName');
        if(el) el.textContent = name || '';
    };

    // ESC key (‡∏ã‡πâ‡∏≥‡πÄ‡∏û‡∏∑‡πà‡∏≠ backup)
    document.addEventListener('keyup', (ev) => { if (ev.key === 'Escape') closePopup(); });

    // battlefield "Back" button: hide battlefield, show menu
    const btnBack = document.getElementById('btnBack');
    if (btnBack) btnBack.addEventListener('click', () => {
        document.getElementById('mainBattlefield').classList.add('hide');
    });

    // Default: dot & notification handler
    window.setMenuNoti = function(btnId, show) {
        const btn = document.getElementById(btnId);
        if(btn) {
            if(show) btn.classList.add('noti');
            else btn.classList.remove('noti');
        }
    };

    // Language menu auto for footer/demo
    if (typeof renderLangMenu === "function" && document.getElementById('footerLangMenu')) {
        renderLangMenu('footerLangMenu');
    }
});

‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå js/utils.js
// js/utils.js
// Utility & helper functions ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Epic Seven Card Auto Battle ‡∏ó‡∏∏‡∏Å‡πÇ‡∏°‡∏î‡∏π‡∏•‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ

/**
 * Deep clone object (recursively)
 * @param {Object} obj
 * @returns {Object}
 */
window.deepCopy = function(obj) {
    return JSON.parse(JSON.stringify(obj));
};

/**
 * Random int [min, max] (inclusive)
 */
window.randInt = function(min, max) {
    if (min === max) return min;
    return Math.floor(Math.random() * (max - min + 1)) + min;
};

/**
 * Find element by selector, throw if not found
 * @param {string} selector
 * @returns {HTMLElement}
 */
window.$ = function(selector) {
    let el = document.querySelector(selector);
    if (!el) throw new Error("Element not found: " + selector);
    return el;
};

/**
 * Pluralize text (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö en/th)
 * Example: plural('item', 2, 'en'), plural('‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°', 1, 'th')
 */
window.plural = function(word, n, lang = 'th') {
    if (lang === 'en') return n === 1 ? word : word + 's';
    return word;
};

/**
 * Capitalize first letter
 */
window.capFirst = function(str) {
    if (!str) return "";
    return str.charAt(0).toUpperCase() + str.slice(1);
};

/**
 * Format number with commas (1,234,567)
 */
window.numberWithCommas = function(num) {
    return (num||0).toLocaleString('en-US');
};

/**
 * Format timestamp to "DD/MM/YYYY HH:MM"
 */
window.formatTime = function(ts) {
    let d = new Date(ts); 
    return `${d.getDate().toString().padStart(2,"0")}/${(d.getMonth()+1).toString().padStart(2,"0")}/${d.getFullYear()} ${(d.getHours()||0).toString().padStart(2,"0")}:${(d.getMinutes()||0).toString().padStart(2,"0")}`;
};

/**
 * Sleep (await sleep(ms))
 */
window.sleep = function(ms) {
    return new Promise((r) => setTimeout(r, ms));
};

/**
 * Escape HTML special chars (for safe display in innerHTML)
 */
window.escapeHTML = function(str) {
    return (str||"").replace(/[<>&"']/g, c =>
        ({
            '<': '&lt;', '>': '&gt;', '&': '&amp;', '"': '&quot;', "'": '&#39;'
        }[c])
    );
};

/**
 * Remove HTML tags (keep just text)
 */
window.stripHTML = function(str) {
    return (str||"").replace(/<(.*?)>/g, "");
};

/**
 * Truncate text to length + ...
 */
window.truncate = function(str, len) {
    str = str || "";
    if(str.length <= len) return str;
    return str.substr(0, len-3) + "...";
};

‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏ü‡∏•‡πå data/item.json
[
  {
    "id": "gold",
    "name": "Gold",
    "type": "currency",
    "description": "‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏ó‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏ä‡∏≤",
    "img": "gold.png",
    "rarity": 1,
    "usable": false,
    "price": 0
  },
  {
    "id": "diamond",
    "name": "Crystal",
    "type": "currency",
    "description": "‡πÄ‡∏û‡∏ä‡∏£ ‡πÉ‡∏ä‡πâ‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏ä‡∏≤ ‡∏û‡∏¥‡πÄ‡∏®‡∏©",
    "img": "diamond.png",
    "rarity": 2,
    "usable": false,
    "price": 0
  },
  {
    "id": "exp_potion",
    "name": "EXP Potion",
    "type": "xp_item",
    "description": "‡πÄ‡∏û‡∏¥‡πà‡∏° EXP ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢",
    "img": "exp_potion.png",
    "rarity": 2,
    "usable": true,
    "effect": { "exp": 500 },
    "price": 200
  },
  {
    "id": "skill_book",
    "name": "Skill Book",
    "type": "upgrade",
    "description": "‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏™‡∏Å‡∏¥‡∏•‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ (‡∏™‡∏∏‡πà‡∏° 1 skill)",
    "img": "skill_book.png",
    "rarity": 3,
    "usable": true,
    "effect": { "skillup": 1 },
    "price": 900
  },
  {
    "id": "rune_shard",
    "name": "Rune Shard",
    "type": "rune_material",
    "description": "‡πÄ‡∏®‡∏©‡∏£‡∏π‡∏ô ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏ô",
    "img": "rune_shard.png",
    "rarity": 2,
    "usable": false,
    "price": 150
  },
  {
    "id": "heal_potion",
    "name": "Heal Potion",
    "type": "heal",
    "description": "‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°‡πÉ‡∏ä‡πâ‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π HP 50% ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡πÄ‡∏ï‡∏¥‡∏° Energy (+15)",
    "img": "heal_potion.png",
    "rarity": 2,
    "usable": true,
    "effect": { "hp_pct": 50, "energy": 15 },
    "price": 120
  }
]

‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏ü‡∏•‡πå js/inventory.js
// js/inventory.js

let itemData = [];
let inventory = [];

/** ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°‡∏à‡∏≤‡∏Å data/item.json */
async function loadItemData() {
  if (itemData.length) return;
  itemData = await fetch('data/item.json').then(r => r.json());
}

/** ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô (‡∏à‡∏≤‡∏Å localStorage) */
function loadInventory() {
  let raw = localStorage.getItem('user_inventory');
  inventory = raw ? JSON.parse(raw) : [];
}

/** ‡πÄ‡∏ã‡∏ü inventory */
function saveInventory() {
  localStorage.setItem('user_inventory', JSON.stringify(inventory));
}

/** ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°‡πÉ‡∏ô data/item.json */
function findItemById(id) {
  return itemData.find(i => i.id === id);
}

/** render UI ‡∏Ñ‡∏•‡∏±‡∏á‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏° */
function renderInventoryUI() {
  let html = `
    <div style="display:flex;flex-direction:column;gap:7px;max-height:420px;overflow-y:auto;">
      ${inventory.length === 0 ? '<div style="color:#bbb;text-align:center;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°</div>' :
        inventory.map(item => {
          let info = findItemById(item.id) || {};
          return `
          <div style="display:flex;align-items:center;background:#272b38;padding:10px 16px;border-radius:10px;gap:19px;">
            <div style="width:36px;height:36px;border-radius:8px;background:#201624;display:flex;justify-content:center;align-items:center;">
              ${info.img ? `<img src="img/item/${info.img}" alt="${info.name}" style="width:32px;">` : "üéí"}
            </div>
            <div style="flex-grow:1;">
              <b>${info.name || item.id}</b>
              <div style="font-size:.91em;color:#84ccff;margin-top:2px;">${info.description || ''}</div>
            </div>
            <div style="color:#aaffbe;font-weight:bold;font-size:1.07em;">x${item.qty}</div>
            ${info.usable ? `<button class="primary-btn" style="padding:5px 1em 5px 1em;font-size:.96em;" onclick="useItemPrompt('${item.id}')">‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏¢</button>` : ""}
          </div>`;
        }).join('')}
    </div>
  `;
  document.getElementById('inventoryArea').innerHTML = html;
}

/** ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô popup ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏° */
window.useItemPrompt = function(itemId) {
  let info = findItemById(itemId);
  window.openPopup('useItem', `
    <div style="text-align:center;">
      <img src="img/item/${info.img}" style="width:52px;margin-bottom:8px;">
      <div style="font-size:1.09em;">${info.name}</div>
      <div style="margin:.6em 0 1.1em 0;font-size:.97em;color:#7cf;">${info.description}</div>
      <button class="primary-btn" style="margin:.8em .3em 0 .3em;padding:.5em 2.1em;" onclick="useItemNow('${itemId}')">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÉ‡∏ä‡πâ‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°</button>
      <button class="secondary-btn" style="margin:.8em .3em 0 .3em;" onclick="closePopup()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
  `, 'small', `‡πÉ‡∏ä‡πâ ${info.name}`);
}

/** ‡πÉ‡∏ä‡πâ‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡∏•‡∏î qty, ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å effect, update ui) */
window.useItemNow = function(itemId) {
  let idx = inventory.findIndex(i => i.id === itemId);
  let info = findItemById(itemId);
  if (idx === -1 || !info) return;
  if (inventory[idx].qty <= 0) return;
  // Effect (mock: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï character / heal / exp ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)
  if (info.effect && info.effect.exp) {
    // ‡πÄ‡∏û‡∏¥‡πà‡∏° exp ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡πÅ‡∏£‡∏Å‡πÉ‡∏ô team
    let t = JSON.parse(localStorage.getItem('userTeam') || "[]");
    if (t.length) {
      let cid = t[0];
      let cdata = JSON.parse(localStorage.getItem("char_" + cid) || '{}');
      if (cdata) {
        cdata.exp = (cdata.exp || 0) + info.effect.exp;
        localStorage.setItem("char_" + cid, JSON.stringify(cdata));
        alert(`‡πÄ‡∏û‡∏¥‡πà‡∏° EXP ‡πÉ‡∏´‡πâ ${cdata.name} +${info.effect.exp}`);
      }
    }
  }
  // Heal to selected: (Opt: implement in character select popup)
  // ‡πÄ‡∏û‡∏¥‡πà‡∏° energy bar (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Heal Potion) 
  if (info.effect && info.effect.energy) {
    let energy = Number(localStorage.getItem("user_energy") || 0);
    let maxEnergy = 45; // default, ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏¢‡∏á config/energy.js ‡πÑ‡∏î‡πâ
    let after = Math.min(maxEnergy, energy + info.effect.energy);
    localStorage.setItem("user_energy", after);
    alert(`‡πÄ‡∏ï‡∏¥‡∏° Energy +${after - energy}`);
    if (typeof renderEnergyBar === "function") renderEnergyBar();
  }
  inventory[idx].qty--;
  if (inventory[idx].qty === 0) inventory.splice(idx, 1);
  saveInventory();
  window.closePopup();
  renderInventoryUI();
}

/** ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°‡πÄ‡∏Ç‡πâ‡∏≤ inventory */
window.addToInventory = function(itemId, qty) {
  if (!itemId || !qty) return;
  let idx = inventory.findIndex(i => i.id === itemId);
  if (idx >= 0) inventory[idx].qty += qty;
  else inventory.push({ id: itemId, qty });
  saveInventory();
}

/** ‡∏•‡∏ö‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏° (admin, debug) */
window.removeFromInventory = function(itemId, qty) {
  let idx = inventory.findIndex(i => i.id === itemId);
  if (idx >= 0) {
    inventory[idx].qty -= qty;
    if (inventory[idx].qty <= 0) inventory.splice(idx, 1);
    saveInventory();
  }
}

// DOM integration, auto popup on menu
document.addEventListener('DOMContentLoaded', async () => {
  await loadItemData();
  loadInventory();
  // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° hook popup
  const showInvPopup = () => {
    window.openPopup('inventory', `
      <div id="inventoryArea"></div>
      <div style="text-align:right;"><button class="secondary-btn" onclick="closePopup()">‡∏õ‡∏¥‡∏î</button></div>
    `, 'large', "‡∏Ñ‡∏•‡∏±‡∏á‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°");
    renderInventoryUI();
  };
  let btn = document.getElementById('btnInventory');
  if (btn) btn.onclick = showInvPopup;

  window.renderInventoryUI = renderInventoryUI;
});

/** ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API ‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ */
window.inventoryEngine = {
  load: loadInventory,
  save: saveInventory,
  add: window.addToInventory,
  remove: window.removeFromInventory,
  list: () => inventory,
  findItemById,
  reloadAll: async () => { await loadItemData(); loadInventory(); },
}

‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏ü‡∏•‡πå js/shop.js
// js/shop.js - Epic Seven Clone Frontend Shop System

let shopData = [];
let purchaseHistory = {}; // Log per user/day: { shopId_itemId: numBought }

async function loadShopData() {
    if (shopData.length) return;
    let res = await fetch('data/shop.json').then(r => r.json());
    shopData = res.shops;
}

function loadShopHistory() {
    try {
        purchaseHistory = JSON.parse(localStorage.getItem('shop_purchase_history') || '{}');
    } catch { purchaseHistory = {}; }
}

function saveShopHistory() {
    localStorage.setItem('shop_purchase_history', JSON.stringify(purchaseHistory));
}

// ---------- Render UI ----------
async function openShopPopup(shopId = "main") {
    await loadShopData(); loadShopHistory();
    let shop = shopData.find(s => s.id === shopId && s.enabled);
    if (!shop) {
        window.openPopup('shop', `<div>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà</div><button class="secondary-btn" onclick="closePopup()">‡∏õ‡∏¥‡∏î</button>`, 'large', '‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤');
        return;
    }

    let html = `
      <div style="font-size:1.14em;color:#dac1ff;margin-bottom:6px;">${shop.desc || ''}</div>
      <div style="display:flex;gap:17px;flex-wrap:wrap;align-items:stretch;">
        ${shop.items.filter(i => i.enabled).map(item => renderShopItem(shop, item)).join('')}
      </div>
      <div style="text-align:right;margin-top:23px;">
        <button class="secondary-btn" onclick="closePopup()">‡∏õ‡∏¥‡∏î</button>
      </div>
    `;

    window.openPopup('shop', html, 'large', shop.name);
    renderShopLiveUI(shop.id);
}

// Helper ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ 1 ‡∏≠‡∏±‡∏ô
function renderShopItem(shop, item) {
    let inv = window.inventoryEngine?.list() || [];
    let priceOwned = inv.find(i => i.id === item.price_item)?.qty || 0;
    let itemData = window.inventoryEngine.findItemById(item.item_id) || {};
    // ‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
    let key = `${shop.id}_${item.id}_${getTodayStr()}`;
    let bought = purchaseHistory[key] || 0;
    let canBuy = item.can_buy && bought < item.can_buy;
    let canBuyToday = item.daily_limit ? bought < item.daily_limit : true;
    let disabled = !canBuy || !canBuyToday || priceOwned < item.price_amount;

    return `
      <div style="background:#223246;border:2px solid #53a0fa5c;border-radius:13px;min-width:162px;flex:1 0 174px;padding:14px 12px 18px 12px;margin-bottom:.8em;display:flex;flex-direction:column;align-items:center;justify-content:space-between;">
        <img src="img/item/${itemData.img||'noimg.png'}" alt="${itemData.name||item.item_id}" style="width:38px;margin-bottom:7px;" />
        <div style="font-size:1.1em;font-weight:bold;">${itemData.name||item.item_id} x${item.amount}</div>
        <div style="color:#ffbe77;font-size:.98em;">${item.desc || (itemData && itemData.description)||''}</div>
        <div style="margin:.8em 0;font-size:.95em;">
          <b>‡∏£‡∏≤‡∏Ñ‡∏≤:</b> <span style="color: gold;font-weight:bold;">${item.price_amount}</span> <img src="img/item/${item.price_item}.png" style="width:18px;vertical-align:middle" /> 
          <br/>
          <span style="font-size:.97em;color:#cdf;">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${priceOwned}</span>
        </div>
        ${item.daily_limit ? `<div style="color:#9eecff;font-size:.92em;margin:.4em 0;">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡πâ‡∏ß: ${bought} / ${item.daily_limit}</div>` : ''}
        <button class="primary-btn" style="padding:6px 1.4em;font-size:.97em;" onclick="buyShopItem('${shop.id}','${item.id}')" ${disabled?"disabled":""}>${disabled?'‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ':'‡∏ã‡∏∑‡πâ‡∏≠'}</button>
      </div>
    `;
}

// ---------- Buy flow ----------
window.buyShopItem = function(shopId, itemId) {
    let shop = shopData.find(s => s.id === shopId);
    if (!shop) return;
    let item = shop.items.find(i => i.id === itemId);
    if (!item) return;
    let key = `${shopId}_${itemId}_${getTodayStr()}`;
    let bought = purchaseHistory[key] || 0;
    if (item.can_buy && bought >= item.can_buy) return alert("‡∏ñ‡∏∂‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≠‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß");
    if (item.daily_limit && bought >= item.daily_limit) return alert("‡∏ñ‡∏∂‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß");
    let inv = window.inventoryEngine?.list() || [];
    let owned = inv.find(i => i.id === item.price_item)?.qty || 0;
    if (owned < item.price_amount) return alert("‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠");
    // confirm popup
    let itemInfo = window.inventoryEngine.findItemById(item.item_id) || {};
    window.openPopup('confirmBuy', `
      <div style="text-align:center;">
        <img src="img/item/${itemInfo.img||'noimg.png'}" style="width:49px;margin-bottom:8px;">
        <div style="font-size:1.14em;font-weight:bold;margin-bottom:7px;">${itemInfo.name || item.item_id}</div>
        <div style="margin-bottom:8px;">${item.desc || ''} <br> <b>x${item.amount}</b></div>
        <div style="color:gold;font-size:.98em;">‡∏£‡∏≤‡∏Ñ‡∏≤ ${item.price_amount} <img src="img/item/${item.price_item}.png" style="width:17px;vertical-align:middle" /> </div>
        <button onclick="confirmShopBuy('${shopId}','${item.id}')" class="primary-btn" style="margin:.7em 1em 0 1em;">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ã‡∏∑‡πâ‡∏≠</button>
        <button onclick="closePopup()" class="secondary-btn" style="margin:.7em 0 0 0;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      </div>
    `, 'small', '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠');
}

// ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏à‡∏£‡∏¥‡∏á
window.confirmShopBuy = function(shopId, itemId) {
    let shop = shopData.find(s => s.id === shopId);
    if (!shop) return;
    let item = shop.items.find(i => i.id === itemId);
    let key = `${shopId}_${itemId}_${getTodayStr()}`;
    let bought = purchaseHistory[key] || 0;
    if (item.can_buy && bought >= item.can_buy) return alert("‡∏ñ‡∏∂‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß");
    if (item.daily_limit && bought >= item.daily_limit) return alert("‡∏ñ‡∏∂‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß");
    let inv = window.inventoryEngine?.list() || [];
    let own = inv.find(i => i.id === item.price_item);
    if (!own || own.qty < item.price_amount) return alert("‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡πÑ‡∏°‡πà‡∏û‡∏≠");

    window.inventoryEngine.remove(item.price_item, item.price_amount);
    window.inventoryEngine.add(item.item_id, item.amount);
    purchaseHistory[key] = (bought || 0) + 1;
    saveShopHistory();
    closePopup('confirmBuy');
    // popup ‡∏™‡∏£‡∏∏‡∏õ
    window.openPopup('shopResult', `
      <div style="text-align:center;color:#53fdc2;">
        <div style="font-size:1.15em;margin:11px 0;"><b>‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à        !</b></div>
        <img src="img/item/${item.item_id}.png" style="width:47px;" />
        <div>‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö <b>${window.inventoryEngine.findItemById(item.item_id)?.name || item.item_id} x${item.amount}</b></div>
        <div style="margin-top:13px;"><button class="primary-btn" onclick="closePopup();openShopPopup('${shopId}')">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</button></div>
      </div>
    `, 'small', '‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
}

// Helper: date string ‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô
function getTodayStr() {
    let d = new Date();
    return d.getFullYear().toString() + (d.getMonth()+1).toString().padStart(2,"0") + d.getDate().toString().padStart(2,"0");
}

// Render shop item area live
function renderShopLiveUI(shopId) {
    // ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ refresh ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡πÄ‡∏á‡∏¥‡∏ô, ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≠‡∏ö‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏•‡∏±‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
}

// Auto menu bind
document.addEventListener('DOMContentLoaded', () => {
    let btn = document.getElementById('btnShop');
    if (btn) btn.onclick = () => openShopPopup('main');
});

// Expose global
window.shopEngine = {
    open: openShopPopup,
    reload: loadShopData
};

‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå js/reward.js
// js/reward.js

/**
 * RewardHandler ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏à‡∏Å‡∏Ç‡∏≠‡∏á (drop, quest, redeem, stage)
 * ‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö inventory.js, characterCollection.js
 */

window.rewardEngine = {
  /**
   * ‡πÉ‡∏´‡πâ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á item/character/exp/gold ‡∏î‡∏π‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á rewardObj:
   * rewardObj = [{type: "item"/"character"/"exp"/"gold", id: "item_id", qty: n}]
   */
  give: function (rewardObj = []) {
    if (!Array.isArray(rewardObj)) return;

    let htmlList = [];

    rewardObj.forEach(r => {
      if (r.type === "item") {
        window.addToInventory?.(r.id, r.qty || 1);
        htmlList.push(`<div>üéÅ ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö <b>${window.inventoryEngine?.findItemById(r.id)?.name || r.id} x${r.qty}</b></div>`);
      } else if (r.type === "character") {
        window.collectCharacter?.(r.id);
        htmlList.push(`<div>üé¥ ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ <b style="color:#99d5ff">${r.id}</b> ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏•‡∏±‡∏á</div>`);
      } else if (r.type === "exp") {
        // +exp ‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å‡πÉ‡∏ô team
        let t = JSON.parse(localStorage.getItem('userTeam') || "[]");
        if (t.length) {
          let cid = t[0];
          let cdata = JSON.parse(localStorage.getItem("char_" + cid) || '{}');
          cdata.exp = (cdata.exp || 0) + (r.qty || 1);
          localStorage.setItem("char_" + cid, JSON.stringify(cdata));
          htmlList.push(`<div>‚≠ê EXP +${r.qty} ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å‡πÉ‡∏ô‡∏ó‡∏µ‡∏°</div>`);
        }
      } else if (r.type === "gold") {
        window.addToInventory?.('gold', r.qty || 1);
        htmlList.push(`<div>üí∞ Gold +${r.qty}</div>`);
      }
    });

    // Immediate show popup (optional)
    if (htmlList.length) {
      window.openPopup('rewardResult',
        `<div style="text-align:center;color:#74fec9">${htmlList.join('')}
          <button class="primary-btn" style="margin-top:16px" onclick="closePopup()">‡∏ï‡∏Å‡∏•‡∏á</button>
        </div>`, 'small', '‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•!'
      );
    }
  }
};

‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå js/quest.js
// js/quest.js

/**
 * ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Ñ‡∏ß‡∏™‡∏ï‡πå‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô / ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå / event, UI popup, ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° inventory/reward
 * ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà data/quest/<xxx>.json
 */

let questData = [];
let questProgress = {}; // ‡∏ï‡πà‡∏≠ user

async function loadQuests() {
  questData = [];
  // ‡∏™‡∏°‡∏°‡∏∏‡∏ï‡∏¥‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô/‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡πà‡∏≠‡∏ô
  let daily = await fetch('data/quest/daily.json').then(r => r.json()).catch(() => []);
  let weekly = await fetch('data/quest/weekly.json').then(r => r.json()).catch(() => []);
  questData = [...(daily.quests || []), ...(weekly.quests || [])];
  loadQuestProgress();
}
function loadQuestProgress() {
  try {
    questProgress = JSON.parse(localStorage.getItem('quest_progress') || '{}');
  } catch { questProgress = {}; }
}
function saveQuestProgress() {
  localStorage.setItem('quest_progress', JSON.stringify(questProgress));
}

async function openQuestPopup() {
  await loadQuests();
  loadQuestProgress();
  let html = questData.length
    ? questData.map(q => renderQuestCard(q)).join('')
    : `<div style="text-align:center;color:#ddd">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏Ñ‡∏ß‡∏™‡∏ï‡πå‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</div>`;
  window.openPopup('quest', `<div>${html}</div>
    <div style="margin-top:16px;text-align:right;"><button class="secondary-btn" onclick="closePopup()">‡∏õ‡∏¥‡∏î</button></div>`, 'large', '‡πÄ‡∏Ñ‡∏ß‡∏™‡∏ï‡πå');
}
function renderQuestCard(q) {
  let prog = questProgress[q.id] || { cur: 0, claimed: false };
  let done = prog.cur >= (q.target || 1);
  return `<div style="background:#1f302a;border-radius:11px;margin:8px 0;padding:12px 13px;color:${done ? '#adeb98' : '#fff'}">
    <b>${q.name}</b><br>
    <div style="color:#bde8ff">${q.desc || ''}</div>
    <div style="margin:7px 0">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤: <b>${prog.cur || 0} / ${q.target || 1}</b> ${done ? '‚úÖ' : ''}</div>
    <div>‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•: ${q.reward.map(r => `<span>${r.type === "item" ? "üéÅ" : r.type === "character" ? "üé¥" : "‚≠ê"} ${window.inventoryEngine?.findItemById(r.id)?.name || r.id} x${r.qty}</span>`).join(' ')}</div>
    <button class="primary-btn" style="margin-top:8px" onclick="claimQuest('${q.id}')" ${!done || prog.claimed ? 'disabled' : ''}>‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•${prog.claimed ? '‡πÅ‡∏•‡πâ‡∏ß' : ''}</button>
  </div>`;
}
window.claimQuest = function (questId) {
  let q = questData.find(x => x.id === questId);
  if (!q) return;
  loadQuestProgress();
  let prog = questProgress[questId] || { cur: 0, claimed: false };
  if ((prog.cur || 0) >= q.target && !prog.claimed) {
    window.rewardEngine.give(q.reward);
    prog.claimed = true;
    questProgress[questId] = prog;
    saveQuestProgress();
    openQuestPopup();
  } else {
    alert("‡∏¢‡∏±‡∏á‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏ß‡∏™‡∏ï‡πå‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö");
  }
}
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤: ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏Å trigger
window.increaseQuestProgress = function (questId, amt = 1) {
  loadQuestProgress();
  let prog = questProgress[questId] || { cur: 0, claimed: false };
  prog.cur += amt;
  questProgress[questId] = prog;
  saveQuestProgress();
}

// Auto bind menu
document.addEventListener('DOMContentLoaded', () => {
  let btn = document.getElementById('btnQuest');
  if (btn) btn.onclick = openQuestPopup;
});
// export
window.questEngine = {
  open: openQuestPopup,
  reload: loadQuests,
  progress: questProgress,
  increment: window.increaseQuestProgress,
};

‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏ü‡∏•‡πå js/stage.js
// (‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å js/stage.js ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô)
// ...
window.startStageBattle = async function (chapterId,zoneId,stageId) {
    // ‡πÇ‡∏´‡∏•‡∏î stage data
    let chapter = chapterData.find(ch => ch.id === chapterId);
    if(!chapter) return;
    let zone = chapter.zones.find(z => z.id === zoneId);
    if(!zone) return;
    let stage = zone.stages.find(s => s.id === stageId);
    if(!stage) return;

    // Check energy
    let energy = Number(localStorage.getItem("user_energy") || 0);
    if(energy < stage.require_energy){
        alert("Energy ‡πÑ‡∏°‡πà‡∏û‡∏≠!");
        return;
    }

    // ‡∏•‡∏î energy ‡πÅ‡∏•‡∏∞ update UI energy
    energy -= stage.require_energy;
    localStorage.setItem("user_energy",energy);
    if (typeof renderEnergyBar === "function") renderEnergyBar();

    // Set up battle - simulate 1 wave (extendible)
    window.prepareBattleFromStage(stage);

    // Store currentStage state (‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö battle/result)
    localStorage.setItem('current_stage_id', stage.id);
    localStorage.setItem('current_stage_zone', zone.id);
    localStorage.setItem('current_stage_chapter', chapter.id);

    closePopup();
    document.getElementById('mainBattlefield').classList.remove('hide');
    setTimeout(() => {
        if (window.battleEngine && window.battleEngine.startBattle) {
            window.battleEngine.startBattle();
        }
    }, 777);
};

// (‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç) ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏ö‡∏î‡πà‡∏≤‡∏ô ‡πÉ‡∏´‡πâ update unlock stage & reward
window.hookStageBattleEnd = function(state) {
    // Call after battle win/lose popup
    // ‡∏£‡∏±‡∏ö state == "win"|"lose"
    let curStageId = localStorage.getItem('current_stage_id');
    if (state === 'win' && curStageId) {
        window.updateStageProgress(curStageId);
        // ‡πÄ‡∏û‡∏¥‡πà‡∏° exp/item/gold ‡∏ï‡∏≤‡∏° stage
        // (‡∏î‡∏∂‡∏á stage ‡∏à‡∏≤‡∏Å chapterData)
        let chapterId = localStorage.getItem('current_stage_chapter');
        let zoneId = localStorage.getItem('current_stage_zone');
        let chapter = chapterData.find(c=>c.id===chapterId);
        let zone = chapter && chapter.zones.find(z=>z.id===zoneId);
        let stage = zone && zone.stages.find(s=>s.id===curStageId);
        if (stage && stage.drops && stage.drops.length) {
            // ‡πÅ‡∏à‡∏Å drop
            let dropList = [];
            stage.drops.forEach(d => {
                if (Math.random()*100 < d.rate) {
                    let n = randInt(d.min,d.max);
                    dropList.push({type:'item',id:d.id,qty:n});
                }
            });
            window.rewardEngine?.give(dropList);
        }
        // ‡πÅ‡∏à‡∏Å exp
        if(stage && stage.exp_reward) window.rewardEngine?.give([{type:'exp',qty:stage.exp_reward}]);
    }
    // unlock
    setTimeout(()=>{ openStageMapPopup(); }, 1000);
};

// (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ô result.js ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï progress)
window.updateStageProgress = function(stageId) {
    loadStageProgress();
    stageProgress[stageId] = true;
    saveStageProgress();
};

// export (‡∏ï‡πà‡∏≠)
window.stageEngine = Object.assign(window.stageEngine||{},{
  end: window.hookStageBattleEnd,
});

‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï js/characterCollection.js
// js/characterCollection.js

/**
 * Epic Seven - Character Collection System (Frontend Only)
 * - Card grid, search, sort, filter, responsive, upgrade, rune
 * - Data driven by: localStorage char_collection & data/char/*.json
 * - Connect: upgrade.js, rune.js, team.js, popupManager.js
 * (c) 2024
 */

let charCollection = [];  // Owned character IDs
let charMeta = [];        // All char meta loaded
let filters = { text: '', star: 0, element: 'all', class: 'all' };

// ------------ 1. Load user collection from localStorage ------------
function loadCharCollection() {
    let arr = JSON.parse(localStorage.getItem('char_collection') || "[]");
    charCollection = arr.filter((id, idx) => arr.indexOf(id) === idx); // unique
}

// ------------ 2. Load meta data for all owned characters ------------
async function loadCharMeta() {
    await loadCharCollection();
    charMeta = await Promise.all(charCollection.map(async id => {
        try {
            let res = await fetch(`data/char/${id}.json`);
            return await res.json();
        } catch (e) { return null; }
    }));
    charMeta = charMeta.filter(c => !!c);
}

// ------------ 3. Render main UI grid ------------
function renderCharGrid() {
    let area = document.getElementById('characterArea');
    if (!area) return;
    let cs = charMeta.slice();
    if (filters.star > 0) cs = cs.filter(c => (c.star || 0) === Number(filters.star));
    if (filters.element !== 'all') cs = cs.filter(c => (c.element || "") === filters.element);
    if (filters.class !== 'all') cs = cs.filter(c => (c.class || "") === filters.class);
    if (filters.text.length) cs = cs.filter(c => c.name.toLowerCase().includes(filters.text.toLowerCase()));
    cs.sort((a, b) => (b.star || 0) - (a.star || 0) || (a.name.localeCompare(b.name)));
    let isMobile = window.innerWidth < 650;
    let html = `<div style="display:grid;grid-template-columns:repeat(${isMobile ? 3 : 6},1fr);gap:16px;">` +
        (cs.length ? cs.map(c => charCardBox(c)).join('') : '<div style="color:#fff;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£</div>') +
        `</div>`;
    area.innerHTML = `
      <div style="display:flex;gap:10px;margin-bottom:10px;">
        <input id="charSearchBox" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠..." style="flex:1;max-width:180px;" value="${filters.text || ''}"/>
        <select id="starFilter"><option value="0">‚òÖ ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option><option value="3">‚òÖ3</option><option value="4">‚òÖ4</option><option value="5">‚òÖ5</option></select>
        <select id="eleFilter"><option value="all">‡∏ó‡∏∏‡∏Å‡∏ò‡∏≤‡∏ï‡∏∏</option><option value="fire">üî• ‡πÑ‡∏ü</option><option value="water">üíß ‡∏ô‡πâ‡∏≥</option><option value="earth">üå± ‡∏î‡∏¥‡∏ô</option><option value="dark">üåë ‡∏°‡∏∑‡∏î</option><option value="light">üåü ‡πÅ‡∏™‡∏á</option></select>
        <select id="classFilter"><option value="all">‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏•‡∏≤‡∏™</option><option value="knight">‡∏≠‡∏±‡∏®‡∏ß‡∏¥‡∏ô</option><option value="warrior">‡∏ô‡∏±‡∏Å‡∏£‡∏ö</option><option value="mage">‡∏à‡∏≠‡∏°‡πÄ‡∏ß‡∏ó‡∏¢‡πå</option><option value="ranger">‡πÄ‡∏£‡∏ô‡πÄ‡∏à‡∏≠‡∏£‡πå</option><option value="assassin">‡πÅ‡∏≠‡∏™‡∏ã‡∏≤‡∏ã‡∏¥‡∏ô</option><option value="monster">‡∏°‡∏≠‡∏ô‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡πå</option></select>
      </div>
      ${html}
    `;
    document.getElementById('starFilter').value = filters.star;
    document.getElementById('eleFilter').value = filters.element;
    document.getElementById('classFilter').value = filters.class;
    document.getElementById('charSearchBox').oninput = ev => { filters.text = ev.target.value.trim(); renderCharGrid(); };
    document.getElementById('starFilter').onchange = ev => { filters.star = ev.target.value; renderCharGrid(); };
    document.getElementById('eleFilter').onchange = ev => { filters.element = ev.target.value; renderCharGrid(); };
    document.getElementById('classFilter').onchange = ev => { filters.class = ev.target.value; renderCharGrid(); };
}

// ------------ 4. Card box HTML ------------
function charCardBox(c) {
    let lock = isCharLocked(c.id);
    return `
      <div class="card" data-chrid="${c.id}" style="position:relative;">
        <img src="img/char/${c.img}" class="hero-img" alt="${c.name}" />
        <div class="name">${c.name}</div>
        <div style="font-size:.93em;color:#d9d;line-height:1.2em;">Lv. ${c.level || '-'} ‚òÖ${c.star || '-'}</div>
        <div style="font-size:.89em;color:#cff;">‡∏ò‡∏≤‡∏ï‡∏∏: ${elIcon(c.element)} | ${classIcon(c.class)}</div>
        <div style="margin:6px 0;">
            <button class="primary-btn" style="padding:3px 1.1em;font-size:.97em;" onclick="showCharDetailPopup('${c.id}')">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
            <button class="secondary-btn" style="padding:3px 1.1em;font-size:.97em;" onclick="upgradeCharPopup('${c.id}')">‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î</button>
            <button class="primary-btn" style="padding:3px 1em;font-size:.93em;" onclick="runeEngine.openEquipPopup('${c.id}')">‡πÉ‡∏™‡πà‡∏£‡∏π‡∏ô</button>
        </div>
        <button style="position:absolute;top:7px;right:14px;opacity:.8;background:none;border:0;color:#fa8;font-size:1.5em;outline:none;z-index:7"
            onclick="toggleCharLock('${c.id}');event.stopPropagation()" title="${lock ? '‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å' : '‡∏•‡πá‡∏≠‡∏Å'}">
            ${lock ? 'üîí' : 'üîì'}
        </button>
      </div>`;
}
function elIcon(el) {
    return { fire: 'üî•', water: 'üíß', earth: 'üå±', dark: 'üåë', light: 'üåü' }[el] || '‚ùî';
}
function classIcon(cls) {
    return { knight: 'üõ°Ô∏è', warrior: '‚öîÔ∏è', mage: 'ü¶â', ranger: 'üèπ', assassin: 'üó°Ô∏è', monster: 'üëæ' }[cls] || 'üëΩ';
}

// ------------ 5. Lock/Unlock ------------
function isCharLocked(chid) {
    let ll = JSON.parse(localStorage.getItem('char_lock') || "[]");
    return ll.includes(chid);
}
function toggleCharLock(chid) {
    let ll = JSON.parse(localStorage.getItem('char_lock') || "[]");
    let idx = ll.indexOf(chid);
    if (idx >= 0) ll.splice(idx, 1); else ll.push(chid);
    localStorage.setItem('char_lock', JSON.stringify(ll));
    renderCharGrid();
}

// ------------ 6. Popup: Char Detail ------------
window.showCharDetailPopup = async function (charId) {
    let c = charMeta.find(c => c.id === charId);
    if (!c) return;
    let html = `
        <div style="display:flex;flex-direction:column;align-items:center;gap:7px;">
            <img src="img/char/${c.img}" class="hero-img" style="width:82px;margin:0 auto 9px auto;" />
            <div style="font-size:1.22em;font-weight:600">${c.name}</div>
            <div style="color:#b6deff;">Lv.${c.level || '-'} / ‚òÖ${c.star||'-'} | ${elIcon(c.element)} ${classIcon(c.class)}</div>
            <hr style="width:86%;border:1px solid #234;" />
            <div>HP <b>${c.hp}</b> | ATK <b>${c.atk}</b> | DEF <b>${c.def}</b> | SPD <b>${c.spd}</b></div>
            <div>CRIT <b>${c.crit_rate}%</b> | CRIT DMG <b>${c.crit_dmg}%</b> | EFF <b>${c.effectiveness}%</b></div>
            <div>Skills: <ul>${(c.skills || []).map(s => `<li><b>${s.name}</b>: ${s.desc || ''}</li>`).join('')}</ul></div>
            <div style="margin-top:7px;">
                <button class="primary-btn" onclick="upgradeCharPopup('${c.id}')">‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î</button>
                <button class="primary-btn" onclick="runeEngine.openEquipPopup('${c.id}')">‡πÉ‡∏™‡πà‡∏£‡∏π‡∏ô</button>
                <button class="secondary-btn" onclick="closePopup()" style="margin-left:11px;">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>`;
    window.openPopup('charDetail', html, 'large', c.name);
}

// ------------ 7. INIT [DOM Ready, bind menu] ------------
document.addEventListener('DOMContentLoaded', async () => {
    let btn = document.getElementById('btnCharacter');
    if (btn)
        btn.onclick = async () => {
            await loadCharMeta();
            renderCharGrid();
            window.openPopup('characterCollection', `<div id="characterArea"></div>`, 'large', '‡∏Ñ‡∏•‡∏±‡∏á‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£');
            renderCharGrid();
        };
});

// ‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ (upgrade, rune)
window.characterEngine = {
    load: loadCharMeta,
    render: renderCharGrid
};

‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏ü‡∏•‡πå js/upgrade.js
// js/upgrade.js - Epic Seven Auto Battle - Upgrade System

let upgradeConfig = {};
let charUpgradeTarget = null;
let inventory = [];

/** Load upgrade config from /data/upgrade.json */
async function loadUpgradeConfig() {
  if (Object.keys(upgradeConfig).length) return;
  upgradeConfig = await fetch('data/upgrade.json').then(r => r.json());
}

/** Render Upgrade popup for a character */
async function openUpgradePopup(characterId) {
  await loadUpgradeConfig();
  await window.inventoryEngine.reloadAll();
  let char = JSON.parse(localStorage.getItem('char_' + characterId)
               || localStorage.getItem('char_' + characterId.replace('_', ''))
               || '{}');
  if (!char || !char.id) { alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏ô‡∏µ‡πâ"); return; }
  charUpgradeTarget = char;
  let html = `
    <div style="display:flex;flex-direction:column;align-items:center;gap:10px;">
      <img src="img/char/${char.img}" style="width:72px;border-radius:15px;box-shadow:0 0 22px #1defeb66;">
      <div style="font-size:1.18em;font-weight:bold;">${char.name}</div>
      <div>Lv. <b>${char.level}</b> <span style="color:#ffe480;">‚òÖ${char.star}</span>
          / <b>EXP</b> ${char.exp}/${char.exp_max || '?'}
      </div>
      <div style="color:#87c7ff;">HP <b>${char.hp}</b> | ATK <b>${char.atk}</b> | DEF <b>${char.def}</b> | SPD <b>${char.spd}</b></div>
      <hr style="width:88%; border:1px solid #234">
      <div style="display:flex;gap:12px;">
        <button class="primary-btn" onclick="doLevelUpChar('${char.id}')">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏•‡πÄ‡∏ß‡∏•</button>
        <button class="primary-btn" onclick="doSkillUpChar('${char.id}')">‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏™‡∏Å‡∏¥‡∏•</button>
        <button class="primary-btn" onclick="doPromoteChar('${char.id}')">‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡∏±‡πâ‡∏ô/‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏î‡∏≤‡∏ß</button>
      </div>
      <button class="secondary-btn" onclick="closePopup()">‡∏õ‡∏¥‡∏î</button>
    </div>
  `;
  window.openPopup('upgradePopup', html, 'large', '‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£');
}

/** Level Up (use exp_potion) */
window.doLevelUpChar = function (charId) {
  let char = JSON.parse(localStorage.getItem('char_' + charId));
  if (!char) return;
  let expItem = upgradeConfig.levelup.exp_item;
  let inv = window.inventoryEngine.list();
  let owned = inv.find(i => i.id === expItem);
  if (!owned || owned.qty <= 0) { alert("‡πÑ‡∏°‡πà‡∏°‡∏µ EXP Potion ‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á"); return; }
  let expAdd = 500;
  char.exp = (char.exp || 0) + expAdd;
  let lvled = false;
  while (char.exp >= (char.exp_max || 99999)) {
    char.exp -= char.exp_max;
    char.level = (char.level || 1) + 1;
    lvled = true;
  }
  if (lvled) alert("Level UP!");
  char.hp = Math.round(char.hp * 1.085);
  char.atk = Math.round(char.atk * 1.08);
  char.def = Math.round(char.def * 1.09);
  localStorage.setItem('char_' + char.id, JSON.stringify(char));
  window.inventoryEngine.remove(expItem, 1);
  openUpgradePopup(char.id);
};

/** Skill Up (use skill_book) */
window.doSkillUpChar = function (charId) {
  let char = JSON.parse(localStorage.getItem('char_' + charId));
  if (!char) return;
  let inv = window.inventoryEngine.list();
  let skillBookItem = upgradeConfig.skillup.item;
  let owned = inv.find(i => i.id === skillBookItem);
  if (!owned || owned.qty <= 0) { alert("‡πÑ‡∏°‡πà‡∏°‡∏µ Skill Book ‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á"); return; }
  let skills = char.skills || [];
  if (!skills.length) { alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏Å‡∏¥‡∏•‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î"); return; }
  let idx = Math.floor(Math.random() * skills.length);
  let sk = skills[idx];
  if (sk.multiplier) sk.multiplier = +(sk.multiplier + upgradeConfig.skillup.increase_percent/100).toFixed(2);
  if (sk.cooldown && sk.cooldown > 1) sk.cooldown = Math.max(1, sk.cooldown - 1);
  char.skills[idx] = sk;
  localStorage.setItem('char_' + char.id, JSON.stringify(char));
  window.inventoryEngine.remove(skillBookItem, 1);
  alert(`‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î Skill "${sk.name}" ‡πÉ‡∏´‡πâ‡πÅ‡∏£‡∏á‡∏Ç‡∏∂‡πâ‡∏ô!`);
  openUpgradePopup(char.id);
};

/** Promote: Increase Stars (use gold + material) */
window.doPromoteChar = function (charId) {
  let char = JSON.parse(localStorage.getItem('char_' + charId));
  if (!char) return;
  let starNext = (char.star || 1) + 1;
  let prom = upgradeConfig.promotion.requirements.find(r => r.star === char.star);
  if (!prom) { alert("‡∏î‡∏≤‡∏ß‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß"); return; }
  let inv = window.inventoryEngine.list();
  let gold = inv.find(i => i.id === 'gold');
  if (!gold || gold.qty < prom.cost_gold) { alert("Gold ‡πÑ‡∏°‡πà‡∏û‡∏≠"); return; }
  let enough = prom.materials.every(mat =>
    inv.find(i => i.id === mat.id && i.qty >= mat.qty));
  if (!enough) { alert("‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÑ‡∏°‡πà‡∏û‡∏≠"); return; }
  window.inventoryEngine.remove('gold', prom.cost_gold);
  prom.materials.forEach(mat => window.inventoryEngine.remove(mat.id, mat.qty));
  char.star = starNext;
  char.hp = Math.floor(char.hp * 1.20);
  char.atk = Math.floor(char.atk * 1.15);
  char.def = Math.floor(char.def * 1.12);
  localStorage.setItem('char_' + char.id, JSON.stringify(char));
  alert("‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏î‡∏≤‡∏ß‡πÉ‡∏´‡∏°‡πà: " + char.star);
  openUpgradePopup(char.id);
};

// ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Å‡∏±‡∏ö characterCollection
document.addEventListener('DOMContentLoaded', () => {
  window.upgradeCharPopup = openUpgradePopup;
  let area = document.getElementById('characterArea');
  if (area) area.addEventListener('click', e => {
    let target = e.target.closest('[data-upgrade]');
    if (target) openUpgradePopup(target.dataset.upgrade);
  });
});

// Expose
window.upgradeEngine = {
  open: openUpgradePopup,
  reloadConfig: loadUpgradeConfig
};

‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏ü‡∏•‡πå js/rune.js
// js/rune.js

let runeData = [];
let runeSetBonuses = {};
let userRunes = [];    // ‡∏ó‡∏∏‡∏Å‡∏£‡∏π‡∏ô‡∏Ç‡∏≠‡∏á user (id, unlock, slot)
let equippedRunes = {}; // { char_id: [slot1, slot2, slot3, slot4] }
let currentCharEquip = null;

// ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏π‡∏ô‡∏à‡∏≤‡∏Å data/rune.json
async function loadRuneData() {
  if (runeData.length) return;
  let arr = await fetch('data/rune.json').then(r => r.json());
  runeData = arr.filter(x => !x.set_bonuses);
  runeSetBonuses = arr.find(x => x.set_bonuses)?.set_bonuses || {};
}

// ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏ô‡∏Ç‡∏≠‡∏á user (‡∏à‡∏≤‡∏Å localStorage)
function loadUserRunes() {
  userRunes = JSON.parse(localStorage.getItem('user_runes') || "[]");
  equippedRunes = JSON.parse(localStorage.getItem('equipped_runes') || "{}");
}

// ‡πÄ‡∏ã‡∏ü‡∏£‡∏π‡∏ô‡∏Å‡∏•‡∏±‡∏ö localStorage
function saveUserRunes() {
  localStorage.setItem('user_runes', JSON.stringify(userRunes));
  localStorage.setItem('equipped_runes', JSON.stringify(equippedRunes));
}

// UI - render pop-up ‡∏™‡∏ß‡∏°‡πÉ‡∏™‡πà‡∏£‡∏π‡∏ô
async function openRuneEquipPopup(char_id) {
  await loadRuneData(); loadUserRunes();
  currentCharEquip = char_id;
  let charRunes = equippedRunes[char_id] || [null, null, null, null];
  let runeSlotHtml = '';
  for (let slot = 1; slot <= 4; slot++) {
    let runeId = charRunes[slot - 1];
    let ru = runeData.find(r => r.id === runeId);
    runeSlotHtml += `<div style="border:1px solid #348ac9;border-radius:10px;padding:8px 7px;min-width:96px;min-height:65px;margin:3px 0;">
      <b>‡∏ä‡πà‡∏≠‡∏á ${slot}:</b> ${ru ?
        `<span title="${ru.name}" style="font-size:1.2em;vertical-align:middle;">${ru.icon ?? 'üî∏'}</span> 
        <span style="color:#7df;font-weight:600;">${ru.name}</span>
        <button class="secondary-btn" style="font-size:.96em;padding:.1em .8em;margin-left:4px;" onclick="unequipRune(${slot})">‡∏ñ‡∏≠‡∏ô</button>
        <div style="font-size:0.88em;color:#acfc94;margin-top:4px;">${mainStatText(ru.main_stat)} ${ru.sub_stats.map(mainStatText).join(', ')}</div>`
        : `<span style="color:#888;">‡∏ß‡πà‡∏≤‡∏á</span>
          <button class="primary-btn" style="font-size:.9em;" onclick="showSelectRune(${slot})">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏ô</button>`
      }
      </div>`;
  }
  const setBuffHtml = renderSetBonus(charRunes);
  const html = `
    <div style="display:flex;flex-direction:column;gap:7px;">
      <h3>‡∏£‡∏π‡∏ô‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏ô‡∏µ‡πâ</h3>
      ${runeSlotHtml}
      ${setBuffHtml}
      <button class="secondary-btn" onclick="closePopup()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î</button>
    </div>`;
  window.openPopup('runeEquip', html, 'large', '‡∏™‡∏ß‡∏°‡πÉ‡∏™‡πà‡∏£‡∏π‡∏ô');
}

// Render set buff ‡∏£‡∏ß‡∏° (‡∏ñ‡πâ‡∏≤‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡∏£‡∏ö)
function renderSetBonus(runeIdArr) {
  let sets = {}, slots = {};
  runeIdArr.forEach(id => {
    let r = runeData.find(a => a.id === id);
    if (r) {
      sets[r.set] = (sets[r.set] || 0) + 1;
      slots[r.slot] = 1;
    }
  });
  let buffHtml = '';
  Object.keys(sets).forEach(set => {
    const cfg = runeSetBonuses[set];
    if (cfg && sets[set] >= cfg.slot_required) {
      buffHtml += `<div style="background:#22442b;margin:13px 0;padding:7px 9px;border-radius:7px;">
          <span style="font-size:1.16em;">${cfg.desc}</span> <b style="color:#66e0ca;">(‡∏Ñ‡∏£‡∏ö‡πÄ‡∏ã‡πá‡∏ï!)</b>
        </div>`;
    }
  });
  return buffHtml ? `<div style="margin-top:14px;">${buffHtml}</div>` : '';
}

// ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏ô
window.showSelectRune = function(slot) {
  let avai = userRunes.filter(r =>
    !Object.values(equippedRunes).flat().includes(r.rune_id) && runeData.find(x => x.id === r.rune_id)?.slot === slot);
  let html = avai.length
      ? avai.map(r => {
          let d = runeData.find(x => x.id === r.rune_id);
          return `<div style="display:flex;align-items:center;gap:9px;">
            <span style="font-size:1.3em;">${d.icon ?? 'üî∏'}</span>
            <b>${d.name}</b> <span style="font-size:0.93em;color:#d2ffee;">${mainStatText(d.main_stat)}</span>
            <button class="primary-btn" onclick="equipRuneSlot('${r.rune_id}',${slot})">‡πÉ‡∏™‡πà</button>
          </div>`;
        }).join('<hr style="margin:2px 0;">')
      : `<div style="color:#fda;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ</div>`;
  window.openPopup('selectRune', html, 'small', `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏ô ‡∏ä‡πà‡∏≠‡∏á ${slot}`);
};

// ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á stat
function mainStatText(stat) {
  if (!stat) return "";
  const lib = { spd: 'SPD', atk_pct: 'ATK%', def: 'DEF', def_pct: 'DEF%', crit_pct: 'CRIT%', effectiveness: 'EFF' };
  return (lib[stat.type] || stat.type) + " +" + stat.val;
}

// ‡πÉ‡∏™‡πà‡∏£‡∏π‡∏ô‡∏•‡∏á slot
window.equipRuneSlot = function(rune_id, slot) {
  let charRunes = equippedRunes[currentCharEquip] || [null,null,null,null];
  charRunes[slot - 1] = rune_id;
  equippedRunes[currentCharEquip] = charRunes;
  saveUserRunes();
  closePopup('selectRune');
  openRuneEquipPopup(currentCharEquip);
};

// ‡∏ñ‡∏≠‡∏ô‡∏£‡∏π‡∏ô
window.unequipRune = function(slot) {
  let charRunes = equippedRunes[currentCharEquip] || [null,null,null,null];
  charRunes[slot - 1] = null;
  equippedRunes[currentCharEquip] = charRunes;
  saveUserRunes();
  openRuneEquipPopup(currentCharEquip);
};

// ‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏£‡∏π‡∏ô (mock)
window.upgradeRune = function(rune_id) {
  alert("= Demo = ‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏±‡∏õ‡πÄ‡∏•‡πÄ‡∏ß‡∏•‡∏£‡∏π‡∏ô " + rune_id + " ‡πÅ‡∏•‡πâ‡∏ß (mock)");
};

window.runeEngine = {
  openEquipPopup: openRuneEquipPopup,
  getEquipped: function(char_id) { loadUserRunes(); return equippedRunes[char_id] || [null,null,null,null]; },
  getUserRunes: function() { loadUserRunes(); return userRunes; },
  addRune: function(rune_id) { userRunes.push({ rune_id }); saveUserRunes(); },
  removeRune: function(rune_id) { userRunes = userRunes.filter(r => r.rune_id !== rune_id); saveUserRunes(); }
};

// Hook DOM ‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ (‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° "‡πÉ‡∏™‡πà‡∏£‡∏π‡∏ô" ‡πÑ‡∏î‡πâ)
document.addEventListener('DOMContentLoaded', async () => {
  await loadRuneData(); loadUserRunes();
  if (document.getElementById('characterArea')) {
    document.getElementById('characterArea').addEventListener('click', e => {
      const btn = e.target.closest('[data-equiprune]');
      if (btn) openRuneEquipPopup(btn.getAttribute('data-equiprune'));
    });
  }
});

‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏ü‡∏•‡πå js/gacha.js
// js/gacha.js - ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏ä‡∏≤ Epic Seven Clone Frontend

let gachaList = [];
let gachaUserLog = [];
let gachaPity = {}; // { gachaId: pityCount }

async function loadGachaData() {
    if (gachaList.length) return;
    const res = await fetch('data/gacha.json').then(r => r.json());
    gachaList = res.gachas;
}

function loadGachaUserLog() {
    gachaUserLog = JSON.parse(localStorage.getItem('gacha_user_log') || '[]');
    gachaPity = JSON.parse(localStorage.getItem('gacha_pity') || '{}');
}

function saveGachaLog() {
    localStorage.setItem('gacha_user_log', JSON.stringify(gachaUserLog));
    localStorage.setItem('gacha_pity', JSON.stringify(gachaPity));
}

async function openGachaPopup() {
    await loadGachaData(); loadGachaUserLog();
    let avai = gachaList.filter(g => g.enabled);
    if (!avai.length) {
        window.openPopup('gacha', `<div>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏≤‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div><button class="secondary-btn" onclick="closePopup()">‡∏õ‡∏¥‡∏î</button>`, 'large', '‡∏Å‡∏≤‡∏ä‡∏≤');
        return;
    }
    let html = avai.map(g => `
        <div style="background:#1b232e;padding:24px 1.5em;border-radius:18px;margin-bottom:24px;text-align:center;box-shadow:0 2px 18px #278ddf18;">
            <img src="img/gacha/${g.banner_img || 'noimg.png'}" style="width:100%;min-width:210px;max-width:330px;border-radius:9px;margin-bottom:7px;box-shadow:0 1px 40px #35cfff23;">
            <div style="font-size:1.14em;color:#7ffbfb;font-weight:600;margin-bottom:4px;">${g.name}</div>
            <div style="color:#aef;margin-bottom:1em;">${g.desc || ''}</div>
            <div style="font-size:.95em;margin-bottom:1em;"><b>‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢: </b>
                <span style="color:goldenrod;font-weight:bold;">${g.cost.amount}</span> 
                <img src="img/item/${g.cost.item}.png" style="width:19px;vertical-align:middle" />
            </div>
            <div>
                <button class="primary-btn" onclick="gachaSummon('${g.id}',1)">‡∏™‡∏∏‡πà‡∏° 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
                <button class="primary-btn" onclick="gachaSummon('${g.id}',10)">‡∏™‡∏∏‡πà‡∏° 10 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
            </div>
            <div style="margin-top:18px;font-size:.9em;">
                <a href="#" onclick="openGachaLogPopup('${g.id}');return false;" style="color:#85deff;text-decoration:underline;">‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡πà‡∏°</a>
                ${g.pity?.enabled ? `<span style="margin-left:2em;color:#ffa;">Pity: ${gachaPity[g.id]||0}/${g.pity.max}</span>` : ''}
            </div>
        </div>
    `).join('');
    window.openPopup('gacha', html, 'large', '‡∏Å‡∏≤‡∏ä‡∏≤');
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏∏‡πà‡∏° gacha
window.gachaSummon = async function(gachaId, times = 1) {
    await loadGachaData(); loadGachaUserLog();
    let g = gachaList.find(x => x.id === gachaId); if (!g) return;

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£
    let inv = window.inventoryEngine?.list() || [];
    let currency = inv?.find(i => i.id === g.cost.item);
    if (!currency || currency.qty < g.cost.amount * times) {
        alert(`‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ ${g.cost.item} ‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠`);
        return;
    }

    // ‡πÅ‡∏õ‡∏•‡∏á pool ‡πÉ‡∏´‡πâ‡∏™‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡∏≠‡∏±‡∏ï‡∏£‡∏≤
    let poolFlat = [];
    g.pool.forEach(entry => {
        for (let i = 0; i < entry.rate; i++) poolFlat.push(entry.char_id);
    });

    let got = [], pityFlag = false;
    for (let t = 0; t < times; t++) {
        let pity = (g.pity?.enabled ? gachaPity[g.id] || 0 : 0);
        let pick;
        // pity trigger
        if (g.pity?.enabled && g.pity.max && pity+1 >= g.pity.max) {
            pick = g.pool.find(c => c.rarity === g.pity.guarantee_rarity)?.char_id || poolFlat[0];
            gachaPity[g.id] = 0;
            pityFlag = true;
        } else {
            pick = poolFlat[Math.floor(Math.random() * poolFlat.length)];
            let card = g.pool.find(c => c.char_id === pick);
            if (g.pity?.enabled) {
                if(card && card.rarity === g.pity.guarantee_rarity) gachaPity[g.id] = 0;
                else gachaPity[g.id] = (gachaPity[g.id] || 0) + 1;
            }
        }
        got.push(pick);
        window.collectCharacter?.(pick);
        window.addGachaLog?.({
            gacha_id: g.id,
            char_id: pick,
            rarity: g.pool.find(c => c.char_id === pick)?.rarity || 3
        });
    }
    window.inventoryEngine.remove(g.cost.item, g.cost.amount * times);
    saveGachaLog();
    openGachaResult(g, got, pityFlag);
};

// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤ collection (‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ)
window.collectCharacter = function(charId) {
    let chars = JSON.parse(localStorage.getItem('char_collection') || '[]');
    if(!chars.includes(charId)) chars.push(charId);
    localStorage.setItem('char_collection', JSON.stringify(chars));
}

// ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏ä‡∏≤
function openGachaResult(gacha, resultArr, pityFlag) {
    let html = `<div style="text-align:center;">
        <div style="font-size:1.7em;margin-bottom:6px;">üé¥ Gacha Result</div>
        <div style="color:#fcc;${pityFlag ? 'font-weight:bold;' : ''}">${pityFlag ? 'Pity Triggered! ‡∏Å‡∏≤‡∏£‡∏±‡∏ô‡∏ï‡∏µ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î!' : ''}</div>
        <div style="display:flex;justify-content:center;gap:13px;flex-wrap:wrap;margin-top:1em;">` +
        resultArr.map(cid => {
            let imgSrc = `img/char/${cid}.png`;
            return `<div style="background:#223352;border:2px solid #35aaffb7;border-radius:13px;padding:8px 12px;display:flex;flex-direction:column;align-items:center;min-width:93px;">
                <img src="${imgSrc}" style="width:58px;margin-bottom:8px;border-radius:10px;box-shadow:0 0 17px #27508080;" />
                <b style="color:#aef;">${cid}</b>
            </div>`;
        }).join('') +
        `</div>
        <div style="margin-top:18px;">
            <button class="primary-btn" onclick="closePopup();openGachaPopup();">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏ä‡∏≤</button>
        </div>
    </div>`;
    window.openPopup('gachaResult', html, 'large', '‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏ä‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
}

// ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏ä‡∏≤
window.openGachaLogPopup = function(gachaId) {
    loadGachaUserLog();
    let logs = gachaUserLog.filter(x => x.gacha_id === gachaId).slice(-30).reverse();
    let html = logs.length ? `<div style="max-height:300px;overflow-y:auto;"><table style="width:100%;">
        <tr style="color:#aae;"><th>#</th><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏ú‡∏•‡∏™‡∏∏‡πà‡∏°</th><th>Rarity</th></tr>
        ${logs.map((l,i) => `<tr>
            <td>${i+1}</td>
            <td>${(new Date(l.time)).toLocaleString()}</td>
            <td>${l.char}</td>
            <td><span style="color:${l.rarity>=5?'gold':'#fff'};">‚òÖ${l.rarity}</span></td>
        </tr>`).join('')}
        </table></div>` : `<div style="text-align:center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏ä‡∏≤</div>`;
    window.openPopup('gachaLog'+gachaId, html, 'large', "‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏ä‡∏≤");
}

// auto bind ‡∏õ‡∏∏‡πà‡∏°
document.addEventListener('DOMContentLoaded', () => {
    let btn = document.getElementById('btnGacha');
    if(btn) btn.onclick = openGachaPopup;
});

// ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö/‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
window.gachaEngine = {
    open: openGachaPopup,
    log: openGachaLogPopup,
    summon: window.gachaSummon
};

‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏ü‡∏•‡πå js/gachaLog.js
// js/gachaLog.js - Epic Seven Card System: Gacha Log ‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏ä‡∏≤

// Log: { user_id, time, gacha_id, char_id, rarity }
let gachaLogList = [];
let gachaLogLoaded = false;

// ‡πÇ‡∏´‡∏•‡∏î log ‡∏Å‡∏≤‡∏ä‡∏≤ (‡∏à‡∏≤‡∏Å localStorage ‡∏´‡∏£‡∏∑‡∏≠ data/gacha_log.json ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö admin)
async function loadGachaLog() {
    if (gachaLogLoaded) return;
    try {
        gachaLogList = JSON.parse(localStorage.getItem('gacha_log') || '[]');
    } catch { gachaLogList = []; }

    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô admin ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏∏‡∏Å log ‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå (read-only)
    if (window.isAdmin && window.isAdmin()) {
        try {
            let allLog = await fetch('data/gacha_log.json').then(r => r.json());
            gachaLogList = allLog.logs || [];
        } catch { /* skip if unavailable */ }
    }
    gachaLogLoaded = true;
}

// ‡πÄ‡∏ã‡∏ü log ‡∏•‡∏á localStorage ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (‡πÄ‡∏Å‡πá‡∏ö 200 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)
function saveGachaLog() {
    localStorage.setItem('gacha_log', JSON.stringify(gachaLogList));
}

// ‡πÄ‡∏û‡∏¥‡πà‡∏° log ‡πÉ‡∏´‡∏°‡πà (‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏™‡∏∏‡πà‡∏°)
window.addGachaLog = function({ user_id, gacha_id, char_id, rarity }) {
    const entry = {
        user_id: user_id || (localStorage.getItem('user_id') || 'guest'),
        gacha_id,
        char_id,
        rarity,
        time: Date.now()
    };
    gachaLogList.push(entry);
    gachaLogList = gachaLogList.slice(-200);
    saveGachaLog();
};

// ‡∏î‡∏π log ‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡∏≠‡∏á user ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
window.queryMyGachaLog = async function(limit = 50) {
    await loadGachaLog();
    const user_id = localStorage.getItem('user_id') || 'guest';
    return gachaLogList.filter(l => l.user_id === user_id).slice(-limit).reverse();
};

// (Admin) ‡∏î‡∏π log ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô
window.queryAllGachaLog = async function(limit = 1000) {
    await loadGachaLog();
    if (!window.isAdmin || !window.isAdmin()) {
        alert("‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏à‡∏∂‡∏á‡∏à‡∏∞‡∏î‡∏π log ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏î‡πâ");
        return [];
    }
    return gachaLogList.slice(-limit).reverse();
};

// Render Popup ‡πÅ‡∏™‡∏î‡∏á log ‡∏Å‡∏≤‡∏ä‡∏≤ user
window.openMyGachaLogPopup = async function() {
    const log = await window.queryMyGachaLog(60);
    let html = `
        <div style="font-size:1.14em;font-weight:bold;margin-bottom:7px;">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏ä‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
        <div style="max-height:340px;overflow-y:auto;">
        <table style="background:#1a2637;width:99%;border-radius:13px;">
        <tr style="color:#7dd;"><th>#</th><th>‡∏ß‡∏±‡∏ô/‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏Å‡∏≤‡∏ä‡∏≤</th><th>‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£</th><th>‚òÖ</th></tr>
        ${
            log.length ? 
            log.map((l, i) => `<tr>
                <td>${i+1}</td>
                <td>${(new Date(l.time)).toLocaleString()}</td>
                <td>${l.gacha_id}</td>
                <td>${l.char_id}</td>
                <td style="color:${l.rarity>=5?'gold':'#bee'};">‚òÖ${l.rarity}</td>
            </tr>`).join("") 
            : `<tr><td colspan="5" style="color:#faa;text-align:center;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏ä‡∏≤</td></tr>`
        }
        </table>
        </div>
        <div style="text-align:right;margin-top:13px;">
            <button class="secondary-btn" onclick="closePopup()">‡∏õ‡∏¥‡∏î</button>
        </div>
    `;
    window.openPopup('gachaLog', html, 'large', "‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏ä‡∏≤");
};

// (Admin) Render Log ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î popup
window.openAdminAllGachaLogPopup = async function() {
    const log = await window.queryAllGachaLog(500);
    let html = `
        <div style="font-size:1.14em;font-weight:bold;margin-bottom:7px;">[ADMIN] ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏ä‡∏≤‡∏ó‡∏∏‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</div>
        <div style="max-height:370px;overflow-y:auto;">
        <table style="background:#19263a;width:99%;border-radius:8px;">
        <tr style="color:#7dd;"><th>#</th><th>‡∏ß‡∏±‡∏ô/‡πÄ‡∏ß‡∏•‡∏≤</th><th>User</th><th>‡∏Å‡∏≤‡∏ä‡∏≤</th><th>‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£</th><th>‚òÖ</th></tr>
        ${
            log.length ? 
            log.map((l, i) => `<tr>
                <td>${i+1}</td>
                <td>${(new Date(l.time)).toLocaleString()}</td>
                <td>${l.user_id}</td>
                <td>${l.gacha_id}</td>
                <td>${l.char_id}</td>
                <td style="color:${l.rarity>=5?'gold':'#bee'};">‚òÖ${l.rarity}</td>
            </tr>`).join("") 
            : `<tr><td colspan="6" style="color:#faa;">‡πÑ‡∏°‡πà‡∏°‡∏µ log</td></tr>`
        }
        </table>
        </div>
        <div style="text-align:right;margin-top:13px;">
            <button class="secondary-btn" onclick="closePopup()">‡∏õ‡∏¥‡∏î</button>
        </div>
    `;
    window.openPopup('allGachaLog', html, 'large', "Gacha Log (ADMIN)");
};

// Auto menu: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô admin panel ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏°‡∏ô‡∏π profile
document.addEventListener('DOMContentLoaded', ()=>{
    if (document.getElementById('btnGachaLog')) {
        document.getElementById('btnGachaLog').onclick = window.openMyGachaLogPopup;
    }
});

// Export ‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°
window.gachaLogEngine = {
    add: window.addGachaLog,
    mylog: window.queryMyGachaLog,
    all: window.queryAllGachaLog,
    open: window.openMyGachaLogPopup
};

‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏ü‡∏•‡πå js/chat.js
// js/chat.js
/*
  Epic Seven Card Auto Battle - Chat System
  - GM / Global / System / Player Chat
  - ‡πÄ‡∏Å‡πá‡∏ö chat.json + banned_words.json
  - Responsive, security filter, limited send rate
  - ‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö popup UI
*/
let chatList = [];
let bannedWords = [];
let chatLastTime = 0;
const CHAT_LOG_MAX = 50;

// ‡πÇ‡∏´‡∏•‡∏î chat log (localStorage)
async function loadChat() {
  if (!chatList.length) {
    try {
      let arr = JSON.parse(localStorage.getItem('chat_log') || "[]");
      chatList = arr;
    } catch { chatList = []; }
  }
}
function saveChat() {
  let arr = chatList.slice(-CHAT_LOG_MAX);
  localStorage.setItem('chat_log', JSON.stringify(arr));
}

// ‡πÇ‡∏´‡∏•‡∏î banned words
async function loadBannedWords() {
  if (!bannedWords.length) {
    try {
      let arr = await fetch('data/banned_words.json').then(r=>r.json());
      bannedWords = arr;
    } catch { bannedWords = []; }
  }
}

// Render chat pop-up UI
async function openChatPopup() {
  await loadChat(); await loadBannedWords();
  renderChatListUI();
  let username = localStorage.getItem('user_name') || '';
  let html = `
    <div style="max-height:300px;overflow-y:auto;" id="chatAreaList"></div>
    <div style="margin-top:1.0em;display:flex;gap:7px;">
      <input id="chatInputBox" maxlength="90" placeholder="${username ? "‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..." : "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö"}" style="flex:1;" ${username ? '' : 'disabled'}/>
      <button class="primary-btn" onclick="${username ? 'sendChatMsg()' : ''}" ${username ? '' : 'disabled'}>‡∏™‡πà‡∏á</button>
    </div>
    <div style="font-size:.86em;color:#cae;margin-top:.3em;">‡∏à‡∏≥‡∏Å‡∏±‡∏î 1 ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°/3 ‡∏ß‡∏¥ ¬∑ ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 90 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£</div>
    <button class="secondary-btn" style="margin-top:9px;" onclick="closePopup()">‡∏õ‡∏¥‡∏î</button>
  `;
  window.openPopup('chat', html, 'tall', '‡πÅ‡∏ä‡∏ó Global');
  setTimeout(() => { let el=document.getElementById('chatInputBox'); if(el) el.focus(); }, 410);
  setInterval(renderChatListUI, 4000);
}

// Render ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡πÅ‡∏ä‡∏ó
function renderChatListUI() {
  let el = document.getElementById('chatAreaList'); if (!el) return;
  let arr = chatList.slice(-CHAT_LOG_MAX);
  el.innerHTML = arr.map(c =>
    `<div style="display:flex;align-items:center;gap:7px;margin-bottom:2px;">
      <span style="color:#77f;font-weight:600;font-size:.98em;">[${formatChatTime(c.time)}] ${escapeHTML(c.user)}:</span>
      <span style="font-size:.97em;">${escapeHTML(c.text)}</span>
      ${c.system ? ` <span style="color:#ef7;font-size:.89em;">[System]</span>` : ""}
    </div>`
  ).join('');
  el.scrollTop = el.scrollHeight;
}
function formatChatTime(ts) {
  let d = new Date(ts);
  return d.getHours().toString().padStart(2,"0")+":"+d.getMinutes().toString().padStart(2,"0");
}

// ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
window.sendChatMsg = function() {
  let box = document.getElementById('chatInputBox'); if (!box) return;
  let txt = (box.value || "").trim();
  if (!txt) return;
  if (txt.length>90) return alert('‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô 90 ‡∏ï‡∏±‡∏ß');
  let now = Date.now();
  // anti-spam
  if (now - chatLastTime < 3000) { alert("‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠ 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ/‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°"); return; }
  chatLastTime = now;
  let username = localStorage.getItem('user_name') || 'Guest';
  let test = txt.toLowerCase();
  if (bannedWords.some(w => test.includes(w))) { alert("‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°!"); return; }
  if (txt.match(/[<>]/)) { alert("‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï HTML"); return; }
  chatList.push({ user: username, text: txt, time: now, system: false });
  chatList = chatList.slice(-CHAT_LOG_MAX);
  saveChat();
  box.value = "";
  renderChatListUI();
  // Optional: Push noti dot (setMenuNoti)
  setMenuNoti && setMenuNoti('btnChat', true);
};
// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° System
window.addSystemChat = function(msg) {
  let now = Date.now();
  chatList.push({ user: "System", text: msg, time: now, system: true });
  chatList = chatList.slice(-CHAT_LOG_MAX);
  saveChat();
  renderChatListUI();
  setMenuNoti && setMenuNoti('btnChat', true);
};
// Escape HTML
function escapeHTML(str) {
  return (str||"").replace(/[<>&"']/g, c =>
    ({'<':'&lt;','>':'&gt;','&':'&amp;','"':'&quot;',"'":'&#39;'}[c]));
}
// Auto mount ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏ä‡∏ó‡πÉ‡∏ô‡πÄ‡∏°‡∏ô‡∏π
document.addEventListener('DOMContentLoaded', () => {
  let btn = document.getElementById('btnChat');
  if (btn) btn.onclick = openChatPopup;
});
// Export chatEngine
window.chatEngine = {
  open: openChatPopup,
  addSystem: window.addSystemChat,
  reloadWords: async()=>{bannedWords=[];await loadBannedWords();}
};

‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏ü‡∏•‡πå js/announcement.js
// js/announcement.js
let announcementList = [];
/** ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ announcement */
async function loadAnnouncements() {
  if (announcementList.length) return;
  let raw = await fetch('data/announcement.json').then(r => r.json());
  announcementList = raw.announcements || [];
}
/** Render popup ‡∏£‡∏ß‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏ï‡πà‡∏≤‡∏á‡πÜ (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö noti dot) */
async function openAnnouncementPopup() {
  await loadAnnouncements();
  let readIds = JSON.parse(localStorage.getItem('read_announcement_ids') || "[]");
  // ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î/‡∏Å‡∏•‡∏∏‡πà‡∏°
  let pin = announcementList.filter(a => a.pin && isAnnouncementAvailable(a));
  let normal = announcementList.filter(a => !a.pin && isAnnouncementAvailable(a));
  function groupBy(arr, key) { return arr.reduce((r, x) => ((r[x[key]]=r[x[key]]||[]).push(x),r),{});}
  let normalGrp = groupBy(normal, 'type');
  let tabTypes = ['all', ...Object.keys(normalGrp)];
  let activeType = 'all';
  let htmlTabs = tabTypes.map(type => 
    `<button class="primary-btn" style="margin-right:8px;font-weight:${type===activeType?'bold':'400'};" onclick="changeAnnouncementTab('${type}')">${type==='all'?'‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î':typeTitle(type)}</button>`
  ).join('');
  let htmlPin = pin.length ? `<div style="margin-bottom:16px;">${pin.map(renderAnnounceCard).join('')}</div>` : '';
  let htmlList = normal.map(renderAnnounceCard).join('');
  let html = `
    <div>
      <div style="margin-bottom:13px;">${htmlTabs}</div>
      ${htmlPin}
      <div id="announceMainList">${htmlList}</div>
    </div>
    <div style="text-align:right;"><button class="secondary-btn" onclick="closePopup()">‡∏õ‡∏¥‡∏î</button></div>
  `;
  window.openPopup('announcement', html, 'large', '‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®');
  setMenuNoti('btnAnnouncement', hasUnreadAnnouncement());
}
function renderAnnounceCard(a, idx = 0) {
  let readIds = JSON.parse(localStorage.getItem('read_announcement_ids') || "[]");
  let unread = !readIds.includes(a.id);
  let badge = a.type === 'patch' ? 'üõ†Ô∏è ' : a.type === 'event' ? 'üéâ ' : a.type === 'reward' ? 'üéÅ ' :
              a.type === 'shop' ? 'üõí ' : a.type === 'system' ? '‚ö†Ô∏è ' : '';
  let pin = a.pin ? '<span style="color:#fdec60;font-size:1.1em;">üìå</span>' : '';
  let statusDot = unread ? '<span style="display:inline-block;width:9px;height:9px;border-radius:7px;background:#ff6565;margin-left:6px;margin-bottom:1px;"></span>' : '';
  return `
    <div class="announce-card" style="background:#222d3d;border-radius:9px;margin-bottom:11px;padding:7px 13px 7px 13px;box-shadow:0 1px 16px #1470ad21;border:2px solid #174e8b42;cursor:pointer;transition:.14s;" onclick="viewAnnouncement('${a.id}')">
      <div style="font-size:1.02em;margin-bottom:1px;font-weight:bold;">
        ${pin} ${badge} <span>${a.title || '-'}</span> ${statusDot}
      </div>
      <div style="color:#9ad;font-size:.95em;">${a.show_time?formatTime(a.show_time):""} ${typeTitle(a.type)}</div>
      <div style="font-size:.93em;">
          ${a.short ? escapeHTML(a.short || '') : truncate(stripTags(a.content || ''), 71)}
      </div>
    </div>
  `;
}
/** ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÄ‡∏ï‡πá‡∏° */
window.viewAnnouncement = function (id) {
  let ann = announcementList.find(a => a.id === id);
  if (!ann) return;
  // Mark as read
  let readIds = JSON.parse(localStorage.getItem('read_announcement_ids') || '[]');
  if (!readIds.includes(ann.id)) {
    readIds.push(ann.id);
    localStorage.setItem('read_announcement_ids', JSON.stringify(readIds));
  }
  // action ‡∏û‡∏¥‡πÄ‡∏®‡∏© (force_popup, shop link, ... ‡∏≠‡∏∑‡πà‡∏ô‡πÜ)
  if (ann.force_popup) setTimeout(() => {}, 1);
  // Render detail
  let badge = ann.type === 'patch' ? 'üõ†Ô∏è ' : ann.type === 'event' ? 'üéâ ' : ann.type === 'reward' ? 'üéÅ ' :
              ann.type === 'shop' ? 'üõí ' : ann.type === 'system' ? '‚ö†Ô∏è ' : '';
  let html = `
      <div style="font-size:1.19em;margin-bottom:.6em;">
          ${badge}<b>${escapeHTML(ann.title || '')}</b>
          ${ann.pin?'<span style="font-size:1.1em;color:#fdc900;">üìå</span>':''}
      </div>
      <div style="color:#bce1ff;font-size:.97em;margin-bottom:4px;">
          ‡∏´‡∏°‡∏ß‡∏î: ${typeTitle(ann.type)} &nbsp; ${ann.show_time?formatTime(ann.show_time):""}
      </div>
      <div style="margin:9px 0 18px 0;white-space:pre-line;">${richText(ann.content||'')}</div>
      ${ann.link_url ? `<div><a href="${ann.link_url}" target="_blank" style="color:#3fa8ff;text-decoration:underline;">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</a></div>` : ''}
      <div style="text-align:right;margin-top:1.1em;">
        <button class="secondary-btn" onclick="closePopup();openAnnouncementPopup();">‡∏Å‡∏•‡∏±‡∏ö</button>
      </div>
  `;
  window.openPopup('announceDetail', html, 'large', ann.title ? `${badge}${ann.title}` : "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®");
  setMenuNoti('btnAnnouncement', hasUnreadAnnouncement());
};
// UI helpers
function typeTitle(type) {
  return {
    'patch': 'Patch Note','event': '‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°',
    'reward': '‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•','shop': '‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤/‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô',
    'system': '‡πÅ‡∏à‡πâ‡∏á‡∏£‡∏∞‡∏ö‡∏ö','general': '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ','inbox': '‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞'
  }[type] || type;
}
function stripTags(html) { return html.replace(/(<([^>]+)>)/gi, ""); }
function truncate(str, len) { return str.length<=len?str:str.substring(0, len-2)+"..."; }
function formatTime(ts) { if(!ts) return ""; let d=new Date(ts); return `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()}`; }
function escapeHTML(str) { return str.replace(/[<>"&]/g, c=>({'<':'&lt;','>':'&gt;','&':'&amp;','"':'&quot;'}[c])); }
function richText(str) { return escapeHTML(str).replace(/\n/g, '<br>').replace(/\*(.*?)\*/g, '<b>$1</b>'); }
/** ‡∏Ñ‡∏ß‡∏£‡πÅ‡∏™‡∏î‡∏á? (‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤, flag) */
function isAnnouncementAvailable(a) {
  const now = Date.now();
  if ((a.start_time && now < a.start_time) || (a.end_time && now > a.end_time)) return false;
  return a.enabled !== false;
}
/** ‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÉ‡∏´‡∏°‡πà unread? */
function hasUnreadAnnouncement() {
  let readIds = JSON.parse(localStorage.getItem('read_announcement_ids') || "[]");
  return announcementList.some(a => isAnnouncementAvailable(a) && !readIds.includes(a.id));
}
/** Tab switch */
window.changeAnnouncementTab = function (type) {
  let list = announcementList.filter(a => isAnnouncementAvailable(a)
      && (type === 'all' || a.type === type));
  let htmlPin = list.filter(a=>a.pin).map(renderAnnounceCard).join('');
  let htmlList = list.filter(a=>!a.pin).map(renderAnnounceCard).join('');
  document.getElementById('announceMainList').innerHTML = htmlPin + htmlList;
};
// Auto bind main menu
document.addEventListener('DOMContentLoaded', () => {
  let btn = document.getElementById('btnAnnouncement');
  if (btn) btn.onclick = openAnnouncementPopup;
  if (hasUnreadAnnouncement()) setMenuNoti('btnAnnouncement', true);
});
// export
window.announcementEngine = {
  open: openAnnouncementPopup,
  getAll: () => announcementList,
  reload: async () => { announcementList = []; await loadAnnouncements(); }
};

‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏ü‡∏•‡πå js/redeem.js
// js/redeem.js
let redeemCodeList = [];
let userUsedRedeem = []; // [{code_id:..., redeemed_time:...}]
async function loadRedeemCodeList() {
  if (redeemCodeList.length) return;
  try {
    redeemCodeList = (await fetch('data/redeem.json').then(r=>r.json()))?.codes || [];
  } catch { redeemCodeList = []; }
  loadUserRedeemUsed();
}
function loadUserRedeemUsed() {
  userUsedRedeem = JSON.parse(localStorage.getItem('user_used_redeem') || '[]');
}
function saveUserRedeemUsed() {
  localStorage.setItem('user_used_redeem', JSON.stringify(userUsedRedeem));
}
// ‡∏õ‡πä‡∏≠‡∏õ‡∏≠‡∏±‡∏õ "‡∏Å‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•"
window.openRedeemPopup = function () {
  const html = `
    <div style="text-align:center;">
      <div style="font-size:1.16em;font-weight:600;margin-bottom:.88em;">üéÅ ‡∏Å‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</div>
      <input id="redeemInputBox" placeholder="‡πÉ‡∏™‡πà‡πÇ‡∏Ñ‡πâ‡∏î (A-Z, 0-9)" style="width: 90%;" maxlength="32"/>
      <div style="margin:1.3em 0;"><button class="primary-btn" onclick="checkRedeemCode()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</button></div>
      <div id="redeemResultHint" style="color:#ffc29a;font-size:.94em;margin-top:1em;"></div>
      <div style="color:#aee;margin-top:1.7em;font-size:.89em;">
        *‡πÇ‡∏Ñ‡πâ‡∏î 1 ‡∏Ñ‡∏ô‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á, ‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏, ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
      </div>
      <button class="secondary-btn" style="margin-top:2.2em;" onclick="closePopup()">‡∏õ‡∏¥‡∏î</button>
    </div>
  `;
  window.openPopup('redeem', html, 'small', '‡∏Å‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î');
  setTimeout(() => document.getElementById('redeemInputBox')?.focus(), 100);
};
// validate and ‡πÉ‡∏´‡πâ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•
window.checkRedeemCode = async function () {
  await loadRedeemCodeList();
  const box = document.getElementById('redeemInputBox');
  if (!box) return;
  let code = box.value.trim().toUpperCase();
  let hintEl = document.getElementById('redeemResultHint');
  hintEl.innerText = "";
  if (!code.match(/^[A-Z0-9\-\_]+$/)) return hintEl.innerText = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (A-Z, 0-9)";
  let redeem = redeemCodeList.find(c => c.id === code && c.enabled !== false);
  const now = Date.now();
  if (!redeem)
    return hintEl.innerText = "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏Ñ‡πâ‡∏î‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î/‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß";
  if (redeem.start_time && now < redeem.start_time)
    return hintEl.innerText = "‚ùå ‡πÇ‡∏Ñ‡πâ‡∏î‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ";
  if (redeem.end_time && now > redeem.end_time)
    return hintEl.innerText = "‚ùå ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß";
  if (redeem.max_usage && redeem.used_count >= redeem.max_usage)
        return hintEl.innerText = "‚ùå ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡πâ‡∏ß";
  // per user
  loadUserRedeemUsed();
  if (userUsedRedeem.some(u => u.code_id === code)) {
    return hintEl.innerText = "‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á";
  }
  // ‡∏ï‡∏£‡∏ß‡∏à‡πÑ‡∏≠‡∏î‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô (‡∏Ñ‡∏ß‡∏£‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô, ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡πá‡∏à‡∏≥‡∏•‡∏≠‡∏á)
  let curUserId = localStorage.getItem('user_id') || 'guest';
  // ‡πÉ‡∏´‡πâ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤ inventory/character)
  const rewardHtml = [];
  if (redeem.reward && Array.isArray(redeem.reward)) {
    for (let r of redeem.reward) {
      if (r.type === 'item') {
        window.addToInventory?.(r.id, r.qty || 1);
        rewardHtml.push(`<div>üéÅ ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö <b>${window.inventoryEngine?.findItemById(r.id)?.name || r.id} x${r.qty}</b></div>`);
      } else if (r.type === 'character') {
        window.collectCharacter?.(r.id);
        rewardHtml.push(`<div>üé¥ ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ <b style="color:#84bcff;">${r.id}</b></div>`);
      }
    }
  }
  // ‡πÄ‡∏ã‡∏ü userUsedRedeem
  userUsedRedeem.push({ code_id: code, time: now, user: curUserId });
  saveUserRedeemUsed();
  // (‡∏ù‡∏±‡πà‡∏á admin/‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏° used_count ‡πÄ‡∏≠‡∏á‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå json)
  // ‡πÅ‡∏™‡∏î‡∏á popup ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
  window.openPopup('redeemSuccess', `
    <div style="text-align:center;">
      <div style="font-size:1.15em;font-weight:700;color:#56f7ca;margin-bottom:9px;">‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</div>
      ${rewardHtml.join('')}
      <button class="primary-btn" style="margin-top:1.2em;" onclick="closePopup();">‡πÇ‡∏≠‡πÄ‡∏Ñ</button>
    </div>
  `, 'small', '‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•');
};

// Auto bind ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π (ID: btnRedeem)
document.addEventListener('DOMContentLoaded', () => {
  let btn = document.getElementById('btnRedeem');
  if (btn) btn.onclick = window.openRedeemPopup;
});

// Expose export
window.redeemEngine = {
  open: window.openRedeemPopup,
  check: window.checkRedeemCode,
  reload: async () => { redeemCodeList = []; await loadRedeemCodeList(); }
};

‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏ü‡∏•‡πå js/admin.js
// js/admin.js (‡∏â‡∏ö‡∏±‡∏ö‡πÄ‡∏ï‡πá‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö admin panel)

document.addEventListener('DOMContentLoaded', () => {
  // Guard: ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
  const isAdmin = localStorage.getItem("user_is_admin") === "1";
  const adminName = localStorage.getItem("user_name");
  if (!isAdmin) {
    alert("‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô");
    window.location.href = "index.html";
    return;
  }
  document.getElementById('adminName').innerText = `üë§ ${adminName}`;
  document.getElementById("btnLogout").onclick = function () {
    localStorage.removeItem("user_id");
    localStorage.removeItem("user_name");
    localStorage.removeItem("user_is_admin");
    window.location.href = "index.html";
  };

  // Menu event mapping
  {
    let mapping = {
      btnUserMgr:   renderUserMgr,
      btnCharMgr:   renderCharMgr,
      btnItemMgr:   renderItemMgr,
      btnRuneMgr:   renderRuneMgr,
      btnQuestMgr:  renderQuestMgr,
      btnGachaMgr:  renderGachaMgr,
      btnStageMgr:  renderStageMgr,
      btnShopMgr:   renderShopMgr,
      btnAnnounceMgr: renderAnnounceMgr,
      btnRedeemMgr: renderRedeemMgr,
      btnChatMod:   renderChatMgr
    };
    Object.entries(mapping).forEach(([btn, fn])=>{
      let el = document.getElementById(btn);
      if (el) el.onclick = fn;
    });
  }
  // Default
  renderUserMgr();
});

function setAdminMain(html) {
  document.getElementById("adminMainArea").innerHTML = html;
}

/* ==== 1) USER MANAGEMENT ==== */
async function renderUserMgr() {
  let res = await fetch('data/user.json').then(r=>r.json());
  let html = `<h2>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h2>
    <table style="width:100%;background:#223247;border-radius:12px;">
      <tr style="color:#bfa;font-size:1.13em;"><th>ID</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>Role</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°</th></tr>
      ${res.map(u=>
        `<tr>
          <td>${u.id}</td>
          <td>${u.name}</td>
          <td>${u.role}</td>
          <td><span style="color:${u.enabled?'#7fe':'#fad'};">${u.enabled?'‚úîÔ∏è ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô':'‚ùå ‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î'}</span></td>
          <td>
            <button onclick="editUserPopup('${u.id}')" class="primary-btn" style="font-size:.95em;">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            <button onclick="banUser('${u.id}')" class="secondary-btn" style="font-size:.93em;">‡πÅ‡∏ö‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
          </td>
        </tr>`).join('')}
    </table>
    <div style="margin:16px 0 0 0;text-align:right;">
      <button class="primary-btn" onclick="addUserPopup()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
    </div>`;
  setAdminMain(html);
}
window.renderUserMgr = renderUserMgr;
window.editUserPopup = function (uid) { alert("‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤"); }
window.addUserPopup = function () { alert("‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤"); }
window.banUser = function (uid) { alert(`‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ö‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ "${uid}" ‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤ (‡πÉ‡∏ô‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô local ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÉ‡∏ô data/user.json ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ backend)`); };

/* ==== 2) CHAR MANAGEMENT ==== */
async function renderCharMgr() {
  // ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏à‡∏£‡∏¥‡∏á‡∏Ñ‡∏ß‡∏£ query file .json ‡∏´‡∏£‡∏∑‡∏≠ list id ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
  let charIds = ['astra','slime_basic'];
  let all = await Promise.all(charIds.map(id=>fetch(`data/char/${id}.json`).then(r=>r.json())));
  let html = `<h2>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ (meta-json)</h2>
    <table style="width:100%;background:#2a3247;border-radius:12px;">
      <tr><th>‡∏£‡∏π‡∏õ</th><th>ID</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‚òÖ</th><th>‡∏ò‡∏≤‡∏ï‡∏∏</th><th>class</th><th>‡∏™‡∏Å‡∏¥‡∏•</th><th>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th></tr>
      ${all.map(c=>
        `<tr>
         <td><img src="img/char/${c.img}" style="width:36px;border-radius:9px;" /></td>
         <td>${c.id}</td>
         <td>${c.name}</td>
         <td>${c.star}</td>
         <td>${c.element}</td>
         <td>${c.class}</td>
         <td>${(c.skills||[]).length}</td>
         <td><button onclick="editCharPopup('${c.id}')" class="primary-btn" style="font-size:.93em;">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button></td>
        </tr>`).join('')}
    </table>
    <div style="margin:14px 0 0 0;text-align:right;">
      <button class="primary-btn" onclick="addCharPopup()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£</button>
    </div>
    <div style="color:#aaa;padding:13px 0;">*‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏∞ Reflect ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå .json ‡∏à‡∏£‡∏¥‡∏á (auto reload)</div>`;
  setAdminMain(html);
}
window.renderCharMgr = renderCharMgr;
window.editCharPopup = function (cid) { window.openPopup('editChar',`<div>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö (‡πÇ‡∏õ‡∏£‡∏î‡πÅ‡∏Å‡πâ json ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á)</div>`,'small','‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£'); }
window.addCharPopup = function () { window.openPopup('addChar',`<div>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö (‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô .json ‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô data/char/)</div>`,'small','‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£'); }

/* ==== 3) ITEM MANAGEMENT ==== */
async function renderItemMgr() {
  let items = await fetch('data/item.json').then(r=>r.json());
  let html = `<h2>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°</h2>
    <table style="width:100%;background:#273257;border-radius:12px;">
      <tr><th>‡∏£‡∏π‡∏õ</th><th>ID</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>type</th><th>desc</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤</th></tr>
      ${items.map(it=>
        `<tr>
           <td><img src="img/item/${it.img||'noimg.png'}" style="width:32px" /></td>
           <td>${it.id}</td><td>${it.name}</td>
           <td>${it.type||'-'}</td><td>${it.description||'-'}</td>
           <td>${it.price}</td>
        </tr>`
      ).join('')}
    </table>
    <div style="margin:14px 0 0 0;text-align:right;">
      <button class="primary-btn" onclick="alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°: ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà data/item.json')">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°</button>
    </div>`;
  setAdminMain(html);
}
window.renderItemMgr = renderItemMgr;

/* ==== 4) RUNE ==== */
async function renderRuneMgr() {
  let runes = await fetch('data/rune.json').then(r=>r.json());
  let html = `<h2>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏ô (rune.json)</h2>
    <table style="width:100%;background:#223549;border-radius:12px;">
      <tr><th>ICON</th><th>id</th><th>name</th><th>slot</th><th>main stat</th><th>set</th><th>sub</th></tr>
      ${runes.filter(r=>r.id).map(r=>
        `<tr>
         <td>${r.icon||'üî∏'}</td>
         <td>${r.id}</td>
         <td>${r.name}</td>
         <td>${r.slot}</td>
         <td>${r.main_stat ? `${r.main_stat.type}+${r.main_stat.val}` : '-'}</td>
         <td>${r.set}</td>
         <td>${(r.sub_stats||[]).map(s=>`${s.type}+${s.val}`).join(', ')}</td>
        </tr>`).join('')}
    </table>
    <div style="text-align:right;margin-top:13px;">
      <button class="primary-btn" onclick="alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏ô: ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô data/rune.json')">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏ô</button>
    </div>`;
  setAdminMain(html);
}
window.renderRuneMgr = renderRuneMgr;

/* ==== 5) QUEST ==== */
async function renderQuestMgr() {
  setAdminMain(`<h2>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏ß‡∏™‡∏ï‡πå (‡πÇ‡∏õ‡∏£‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà data/quest/*.json)</h2>
    <div>‡πÄ‡∏Ñ‡∏ß‡∏™‡∏ï‡πå/‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡πâ‡∏ß reload ‡πÄ‡∏Å‡∏°</div>
    <div style="margin:16px 0;"><button class="primary-btn" onclick="alert('‡∏£‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ñ‡∏ß‡∏™‡∏ï‡πå')">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</button></div>`);
}

/* ==== 6) GACHA ==== */
async function renderGachaMgr() {
  let gacha = await fetch('data/gacha.json').then(r=>r.json());
  let html = `<h2>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏ä‡∏≤ (gacha.json)</h2>
      <table style="width:100%;background:#243168;border-radius:12px;">
      <tr><th>id</th><th>name</th><th>‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</th><th>type</th><th>cost</th><th>pool</th><th>‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°</th></tr>
      ${gacha.gachas.map(g=>
        `<tr>
         <td>${g.id}</td>
         <td>${g.name}</td>
         <td>${g.enabled ? "‚úî" : "‚ùå"}</td>
         <td>${g.type}</td>
         <td>${g.cost.amount} ${g.cost.item}</td>
         <td>${g.pool.map(p=>`${p.char_id}(‚òÖ${p.rarity})`).join(', ')}</td>
         <td><button onclick="alert('edit gacha: ‡πÇ‡∏õ‡∏£‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà data/gacha.json')" class="primary-btn">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button></td>
        </tr>`).join('')}
      </table>
      <div style="margin-top:11px;text-align:right;">
        <button onclick="alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏ä‡∏≤: ‡πÇ‡∏õ‡∏£‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç data/gacha.json')" class="primary-btn">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏ä‡∏≤</button>
      </div>`;
  setAdminMain(html);
}
window.renderGachaMgr = renderGachaMgr;

/* ==== 7) STAGE/DUNGEON ==== */
async function renderStageMgr() {
  setAdminMain(`<h2>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Stage/Dungeon</h2>
  <div>‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà, Zone, Stage ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î config ‡πÉ‡∏ô data/stage/*.json</div>`);
}

/* ==== 8) SHOP ==== */
async function renderShopMgr() {
  let shop = await fetch('data/shop.json').then(r=>r.json());
  let html = `<h2>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
      <table style="width:100%;background:#223249;border-radius:12px;">
      <tr><th>id</th><th>name</th><th>type</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th></tr>
      ${shop.shops.map(s=>
        `<tr>
         <td>${s.id}</td>
         <td>${s.name}</td>
         <td>${s.type}</td>
         <td>${s.enabled ? "‚úî" : "‚ùå"}</td>
         <td>${(s.items||[]).length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td>
        </tr>`).join('')}
      </table>
      <div style="margin-top:10px;text-align:right;">
        <button onclick="alert('update shop: ‡πÇ‡∏õ‡∏£‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç data/shop.json')" class="primary-btn">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
      </div>`;
  setAdminMain(html);
}
window.renderShopMgr = renderShopMgr;

/* ==== 9) ANNOUNCEMENT ==== */
async function renderAnnounceMgr() {
  let ann = await fetch('data/announcement.json').then(r=>r.json());
  let html = `<h2>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</h2>
    <table style="width:100%;background:#142449;border-radius:10px;">
    <tr><th>id</th><th>title</th><th>pin</th><th>type</th><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th></tr>
    ${ann.announcements.map(a=>
      `<tr>
        <td>${a.id}</td><td>${a.title}</td>
        <td>${a.pin?'‚úî':'‚ùå'}</td>
        <td>${a.type}</td>
        <td>${a.show_time ? new Date(a.show_time).toLocaleString() : '-'}</td>
        <td><button onclick="alert('Announce: ‡πÇ‡∏õ‡∏£‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà data/announcement.json')" class="primary-btn" style="font-size:.96em;">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button></td>
      </tr>`
    ).join('')}
    </table>
    <div style="margin-top:10px;text-align:right">
     <button class="primary-btn" onclick="alert('‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®: ‡πÇ‡∏õ‡∏£‡∏î‡πÅ‡∏Å‡πâ‡∏ó‡∏µ‡πà announcement.json')">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</button>
    </div>
    <div style="color:#ead;padding:13px;">*‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÉ‡∏´‡∏°‡πà/‡∏•‡∏ö ‡∏ï‡πâ‡∏≠‡∏á reload ‡πÑ‡∏ü‡∏•‡πå announcement.json ‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÄ‡∏Å‡∏°</div>`;
  setAdminMain(html);
}
window.renderAnnounceMgr = renderAnnounceMgr;

/* ==== 10) REDEEM CODE ==== */
async function renderRedeemMgr() {
  let rc = await fetch('data/redeem.json').then(r=>r.json());
  let html = `<h2>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏Ñ‡πâ‡∏î (redeem)</h2>
    <table style="width:100%;background:#212d41;border-radius:12px;">
      <tr><th>id</th><th>desc</th><th>active</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ</th><th>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th></tr>
      ${rc.codes.map(c=>
        `<tr>
         <td>${c.id}</td>
         <td>${c.desc}</td>
         <td>${c.enabled?'‚úî':'‚ùå'}</td>
         <td>${c.used_count||0}/${c.max_usage||'-'}</td>
         <td><button onclick="alert('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏Ñ‡πâ‡∏î: ‡πÇ‡∏õ‡∏£‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏ô data/redeem.json')" class="primary-btn">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button></td>
        </tr>`
      ).join('')}
    </table>
    <div style="margin-top:11px;text-align:right;">
      <button onclick="alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î: ‡πÇ‡∏õ‡∏£‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç data/redeem.json ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á')" class="primary-btn">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î</button>
    </div>`;
  setAdminMain(html);
}
window.renderRedeemMgr = renderRedeemMgr;

/* ==== 11) CHAT MOD/PANEL ==== */
async function renderChatMgr() {
  // Load chat log, banned words
  let chat = [];
  try { chat = await fetch('data/chat.json').then(r=>r.json()); } catch { chat = []; }
  let banned = [];
  try { banned = await fetch('data/banned_words.json').then(r=>r.json()); } catch {banned = [];}
  let html = `<h2>‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÅ‡∏ä‡∏ó/‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</h2>
    <h3>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (${chat.length})</h3>
    <div style="max-height:210px;overflow-y:auto;">
      <table style="width:100%;background:#23236c;border-radius:11px;">
        <tr><th style="width:120px;">‡πÄ‡∏ß‡∏•‡∏≤</th><th style="width:180px;">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</th><th>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</th><th>‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°</th></tr>
        ${chat.slice(-50).reverse().map(c=>
          `<tr>
            <td>${c.time ? (new Date(c.time)).toLocaleTimeString() : '-'}</td>
            <td>${c.user}</td>
            <td>${escapeHTML(c.text)}</td>
            <td>
              <button class="secondary-btn" style="padding:.2em 1.2em;" onclick="alert('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ: ‡πÅ‡∏Å‡πâ chat.json')">‡∏•‡∏ö</button>
            </td>
          </tr>`
        ).join('')}
      </table>
    </div>
    <h3>‡∏Ñ‡∏≥‡∏ï‡πâ‡∏≠‡∏á‡∏´‡πâ‡∏≤‡∏° (${banned.length})</h3>
    <div>
      <ul>
      ${banned.map(word=>`<li>${escapeHTML(word)} <button class="secondary-btn" onclick="alert('‡∏•‡∏ö‡∏Ñ‡∏≥‡∏ï‡πâ‡∏≠‡∏á‡∏´‡πâ‡∏≤‡∏°: ‡πÇ‡∏õ‡∏£‡∏î‡πÅ‡∏Å‡πâ banned_words.json ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á')">‡∏•‡∏ö</button></li>`).join('')}
      </ul>
      <button class="primary-btn" onclick="alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ï‡πâ‡∏≠‡∏á‡∏´‡πâ‡∏≤‡∏°: ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô banned_words.json')">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ï‡πâ‡∏≠‡∏á‡∏´‡πâ‡∏≤‡∏°</button>
    </div>
    <div style="color:#98ffe7;margin:11px 0 0 0;">* ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏ü‡∏•‡πå JSON ‡πÅ‡∏•‡∏∞‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏à‡∏∂‡∏á‡∏à‡∏∞‡∏°‡∏µ‡∏ú‡∏•</div>`;
  setAdminMain(html);
}
window.renderChatMgr = renderChatMgr;

// Utility for safe display in table
function escapeHTML(str) {
  return (str || "").replace(/[<>&"]/g, c=>
    ({'<':'&lt;','>':'&gt;','&':'&amp;','"':'&quot;'}[c]));
}


‡πÄ‡∏ä‡πá‡∏Ñ‡πÉ‡∏´‡πâ‡∏ó‡∏µ‡∏ß‡πà‡∏≤ ‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‡∏°‡∏µ‡∏õ‡πä‡∏≠‡∏õ‡∏≠‡∏±‡∏û‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• ‡∏õ‡∏∏‡πà‡∏ô ‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å ‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏´‡∏ô ‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ