‡πÑ‡∏ü‡∏•‡πå index.html
<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Epic Seven Card Auto Battle</title>
    <link rel="stylesheet" href="css/style.css" />
    <link rel="icon" href="favicon.ico" />

    <style>
      #mainBattlefield.hide { display:none; }
    </style>
</head>

<body class="dark-bg">

    <!-- NAVBAR -->
    <header>
        <nav class="navbar">
            <div class="logo">EPIC Seven - Card Battle</div>
            <ul class="menu">
                <li>
                    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏° -->
                    <button id="btnTeam" onclick="window.location.href='team.html'">‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏°</button>
                </li>
                <!-- ‡∏ï‡∏±‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ (battle) ‡∏≠‡∏≠‡∏Å -->
                <li>
                    <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡πà‡∏≤‡∏ô/‡∏ú‡∏à‡∏ç‡∏†‡∏±‡∏¢ -->
                    <button id="btnStage" onclick="openStageMapPopup()">‡∏ú‡∏à‡∏ç‡∏†‡∏±‡∏¢</button>
                </li>
                <li>
                    <button id="btnInventory" onclick="openPopup('inventory')">‡∏Ñ‡∏•‡∏±‡∏á‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°</button>
                </li>
                <li>
                    <button id="btnQuest" onclick="openPopup('quest')">‡πÄ‡∏Ñ‡∏ß‡∏™‡∏ï‡πå</button>
                </li>
                <li>
                    <button id="btnShop" onclick="openPopup('shop')">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</button>
                </li>
                <li>
                    <button id="btnGacha" onclick="openPopup('gacha')">‡∏Å‡∏≤‡∏ä‡∏≤</button>
                </li>
                <li>
                    <button id="btnCharacter" onclick="openPopup('characterCollection')">‡∏Ñ‡∏•‡∏±‡∏á‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£</button>
                </li>
                <li>
                    <button id="btnAnnouncement" onclick="openPopup('announcement')">‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</button>
                </li>
                <li>
                    <button id="btnChat" onclick="openPopup('chat')">‡πÅ‡∏ä‡∏ó</button>
                </li>
                <li>
                    <button id="btnLogin" onclick="openPopup('login')">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                </li>
            </ul>
            <div class="profile">
                <span id="playerName"></span>
                <button id="btnLogin" onclick="openPopup('login')">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
        </nav>
    </header>

    <!-- POPUP LAYER -->
    <div id="popupLayer"></div>

    <!-- MAIN BATTLE FIELD (‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏î‡∏¢ js/stage.js ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô) -->
    <main id="mainBattlefield" class="hide">
        <section class="battlefield">
            <div class="card-row user">
                <!-- card generation by JS -->
            </div>
            <div class="card-row monster">
                <!-- card generation by JS -->
            </div>
            <div class="spd-bar-container">
                <!-- generated by JS -->
            </div>
        </section>
        <section class="battle-controls">
            <button id="btnStartAuto" class="primary-btn">Auto Battle</button>
            <button id="btnBack" class="secondary-btn">‡∏Å‡∏•‡∏±‡∏ö</button>
        </section>
    </main>

    <!-- FOOTER -->
    <footer>
        <small style="color: #aaa;">¬© 2024 - Epic Seven Fan Project Demo Frontend</small>
        <div id="footerLangMenu" style="margin-top:8px; text-align:center;"></div>
    </footer>

    <!-- JS -->
    <!-- (popupManager.js ‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå) -->
    <script src="js/popupManager.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/reward.js"></script>
    <script src="js/team.js"></script>
    <script src="js/battle.js"></script>
    <script src="js/ai.js"></script>
    <script src="js/animationEngine.js"></script>
    <script src="js/effect.js"></script>
    <script src="js/result.js"></script>
    <script src="js/inventory.js"></script>
    <script src="js/upgrade.js"></script>
    <script src="js/rune.js"></script>
    <script src="js/gacha.js"></script>
    <script src="js/quest.js"></script>
    <script src="js/stage.js"></script>
    <script src="js/shop.js"></script>
    <script src="js/announcement.js"></script>
    <script src="js/redeem.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/characterCollection.js"></script>
    <script src="js/passive.js"></script>
    <script src="js/chat.js"></script>
    <script src="js/gachaLog.js"></script>
    <script src="js/energy.js"></script>
    <script src="js/localization.js"></script>

    <!-- Menu MAP Popups -->
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        // set playerName, noti, ... ‡∏ï‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°
        window.setPlayerName = function (name) {
          var el = document.getElementById('playerName');
          if (el) el.textContent = name || '';
        };
        window.setMenuNoti = function (btnId, show) {
          var btn = document.getElementById(btnId);
          if (btn) {
            if (show) btn.classList.add('noti');
            else btn.classList.remove('noti');
          }
        };

        // Map popup menu (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô btnTeam, btnStage)
        var menu = [
          ['btnInventory', 'inventory'],
          ['btnQuest', 'quest'],
          ['btnShop', 'shop'],
          ['btnGacha', 'gacha'],
          ['btnCharacter', 'characterCollection'],
          ['btnAnnouncement', 'announcement'],
          ['btnChat', 'chat'],
          ['btnLogin', 'login']
        ];
        menu.forEach(function (pair) {
          var btn = document.getElementById(pair[0]);
          if (btn && !btn.onclick) btn.onclick = function () { openPopup(pair[1]); };
        });

        // ‡∏õ‡∏∏‡πà‡∏° Stage Map ‡πÄ‡∏õ‡∏¥‡∏î Map Popup
        var btnStage = document.getElementById('btnStage');
        if (btnStage) {
          btnStage.onclick = function () {
            if (window.openStageMapPopup) window.openStageMapPopup();
          }
        }

        // ‡∏õ‡∏∏‡πà‡∏° Auto Battle ‡πÉ‡∏ô mainBattlefield (‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠ stage.js ‡∏î‡∏∂‡∏á wave ‡πÅ‡∏•‡πâ‡∏ß)
        var btnAuto = document.getElementById('btnStartAuto');
        if(btnAuto){
          btnAuto.onclick = function(){
            if(window.battleEngine && battleEngine.startBattle){
              battleEngine.startBattle();
            }
          };
        }

        // ‡∏õ‡∏∏‡πà‡∏° "‡∏Å‡∏•‡∏±‡∏ö" = ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡∏ô‡∏≤‡∏°‡∏£‡∏ö
        var btnBack = document.getElementById('btnBack');
        if(btnBack){
          btnBack.onclick = function(){
            document.getElementById('mainBattlefield').classList.add('hide');
          };
        }
      });
    </script>
</body>
</html>

‡πÑ‡∏ü‡∏•‡πå css/style.css
/* Main color theme */
:root {
  --dark-bg: #191c21;
  --panel-bg: #23242a;
  --pop-bg: #1d2230;
  --accent: #3fa8ff;
  --accent2: #ff6565;
  --secondary: #e6f1ff;
  --border: #33364a;
  --card-bg: #25293c;
  --font-main: 'Prompt', 'Sarabun', Arial, sans-serif;
}

body,
html {
  margin: 0;
  padding: 0;
  background: var(--dark-bg);
  color: var(--secondary);
  font-family: var(--font-main);
  font-size: 17px;
  transition: background 0.2s;
  height: 100%;
  min-height: 100vh;
}
.dark-bg {
  background: var(--dark-bg)!important;
}

header, nav {
  width: 100vw;
  background: var(--panel-bg);
  position: sticky; top: 0;
  z-index: 40;
}

.navbar {
  display: flex; justify-content: space-between;
  align-items: center; padding: 0.3em 3vw;
}
.logo {
  font-weight: bold;
  font-size: 1.2em;
  letter-spacing: 1px;
  color: var(--accent);
}
.menu {
  list-style: none; display: flex; align-items: center; gap: .6em;
  margin: 0; padding: 0;
}
.menu li button {
  background: transparent; border: none; color: var(--secondary);
  font-size: 1em; padding: .45em 1em;
  border-radius: 30px; cursor: pointer;
  transition: background .14s;
  position: relative;
}
.menu li button.noti::after {
  content: "";
  background: var(--accent2);
  width: 10px; height: 10px;
  border-radius:100%; position: absolute;
  top: .3em; right: .7em;
  box-shadow: 0 0 6px 3px #ffabab77;
}

.menu li button:hover,
.menu li button:focus {
  background: #2c2e39;
  color: var(--accent);
}
.profile { display: flex; align-items: center; gap: 1em; }
#playerName { font-weight: 600; }
.hide { display: none!important; }


/* ========== MAIN BATTLEFIELD ========== */
main#mainBattlefield {
  max-width: 1180px;
  margin: 1.3em auto 0 auto;
  background: var(--panel-bg);
  border-radius: 15px;
  box-shadow: 0 2px 50px #0004;
  padding: 1.2em .5em 1.5em .5em;
  min-height: 430px;
  display: block;
  transition: all .18s;
}
.battlefield {
  position: relative;
  width: 100%;
  min-height: 320px;
  background: linear-gradient(0deg, #202639 80%, #1a222e 100%);
  border-radius: 16px;
  margin: 0 auto 10px auto; 
  box-shadow: 0 0 35px 10px #04071c30 inset;
  overflow: hidden;
  padding: 1em 0;
}
.card-row {
  display: flex;
  justify-content: space-evenly;
  align-items: flex-end;
  margin: 0.4em auto;
  gap: 13px;
  min-height: 130px;
  z-index: 2;
  position: relative;
}

/* User's team on top, monsters below */
.card-row.user { margin-bottom: 46px; }
.card-row.monster { margin-bottom: 18px; }

.spd-bar-container {
  position: absolute; width: 100%;
  left: 0; top: 48%;
  transform: translateY(-50%);
  display: flex; justify-content: center;
  gap: 24px; pointer-events: none;
  z-index: 3;
}
.spd-bar {
  width: 90px; height: 8px;
  background: #303742;
  border-radius: 6px;
  margin-bottom: 3px;
  overflow: hidden;
  box-shadow: 0 2px 8px #0006 inset;
}
.spd-bar-fill {
  background: linear-gradient(90deg, var(--accent), #9be7ff 70%);
  height: 100%; border-radius: 6px;
  transition: width 0.23s;
}

.battle-controls {
  display: flex; justify-content: center;
  gap: 30px; padding: 1.2em 0;
}
.primary-btn, .secondary-btn {
  background: var(--accent);
  border: none;
  color: #fff;
  font-size: 1.04em;
  font-weight: bold;
  padding: .65em 2.2em;
  border-radius: 35px;
  cursor: pointer;
  letter-spacing: .05em;
  box-shadow: 0 2px 8px #41a5f68e;
  margin-bottom: .4em;
  transition: all .14s;
}
.primary-btn:hover { background: #135488;}
.secondary-btn {
  background: #373958; color: #ccd9ef; box-shadow: none;
}
.secondary-btn:hover { background: #29304b; color: #fff; }

/* CARD STYLE - for hero & monster */
.card {
  background: var(--card-bg);
  border-radius: 15px;
  box-shadow: 0 0 8px 1px #23294a78, 0 1px 0 #3fa8ff2a;
  width: 116px; min-height: 136px;
  position: relative;
  display: flex; flex-direction: column;
  align-items: center; justify-content: flex-end;
  transition: transform .16s;
  overflow: visible;
  border: 2px solid #1d2238;
}
.card .hero-img, .card .mon-img {
  width: 75px; height: 75px;
  border-radius: 50%;
  margin-top: 17px;
  background: #13131c;
  object-fit: cover; object-position: center;
  outline: 3px solid var(--accent);
  box-shadow: 0 0 12px #3fa8ff33;
}
.card .statbar {
  width: 85%; height: 8px;
  border-radius: 5px;
  margin: 5px auto 5px auto;
  background: #171c2d;
  box-shadow: 0 1px 8px #0006 inset;
  overflow: hidden;
}
.card .hp-fill {
  background: linear-gradient(90deg, #55dcab, #4e93f1 80%);
  height: 100%; border-radius: 3px;
  transition: width 0.27s;
}
.card .name {
  font-size: .98em; font-weight: bold; margin-top: 7px;
  text-shadow: 0 2px 9px #0008;
  color: #fff;
  letter-spacing: .03em;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 95px;
  text-align: center;
}
.card .damage-popup {
  position: absolute;
  left: 60%; top: 23%;
  font-size: 1.15em;
  color: var(--accent2);
  font-weight: bold;
  transform: translate(-50%, -60%) scale(1.05);
  opacity: 0;
  pointer-events: none;
  animation: damageJump .7s cubic-bezier(.5,-1, .2, 1.8) 1;
}

@keyframes damageJump {
  0%   { opacity: 0; transform: translate(-50%, -80%) scale(0.7);}
  21%  { opacity: 1; transform: translate(-50%, -120%) scale(1.2);}
  69%  { opacity: 1; transform: translate(-50%, -115%) scale(1.0);}
  100% { opacity: 0; transform: translate(-50%,-70%) scale(.60);}
}

/* Buff & debuff icon overlay on card */
.card .stat-icons {
  display: flex; flex-wrap: wrap;
  gap: 1px; margin-bottom: 4px; justify-content: center;
}
.card .stat-icon {
  width: 18px; height: 18px; border-radius: 50%;
  background: #232c48; border: 2px solid #6ad2ff77;
  display: flex; align-items: center; justify-content: center;
  font-size: 1em; margin-left: 1px;
  box-shadow: 0 0 5px #0088ffc9;
  position: relative;
  cursor: pointer;
}
.card .stat-icon.buff { border-color: #15ef92; }
.card .stat-icon.debuff { border-color: #eb5454; }

/* Tooltip */
.tooltip {
  position: absolute;
  left: 50%; bottom: 120%; z-index: 24;
  background: #22253c;
  color: #daf5ff;
  padding: 4px 12px;
  border-radius: 8px;
  font-size: .90em; min-width: 87px; max-width: 200px;
  box-shadow: 0 8px 25px #0079ff41;
  pointer-events: none; opacity: 0; transition: all .12s;
}
.stat-icon:hover .tooltip { opacity: 1; }

/* ========== POPUPS ========== */
#popupLayer {
  position: fixed;
  top:0; left:0; z-index: 99;
  width:100vw; height:100vh;
  display:flex; align-items:center; justify-content:center;
  background: #050925d8;
  pointer-events: none;
  opacity: 0;
  transition: opacity .18s;
}
#popupLayer.active {
  pointer-events: all; opacity: 1;
}
.popup {
  background: var(--pop-bg);
  border-radius: 18px;
  padding: 2em 1.5em 1.5em 1.5em;
  box-shadow: 0 0 80px #3138aa51, 0 1px 13px #49d9ff1b;
  min-width: 340px;
  min-height: 120px;
  max-width: 99vw;
  max-height: 90vh;
  overflow-y: auto;
  color: #fff;
  position: relative;
  animation: popupOpen .25s cubic-bezier(.7,0, .09,1.55);
}
@keyframes popupOpen {
 0% { transform: scale(.82) translateY(50px) rotate(-7deg);}
 100%{ transform: scale(1) translateY(0);}
}
.popup.large { min-width: 700px; max-width: 99vw; min-height: 340px;}
.popup.tall { min-height: 390px; max-width: 550px;}
.popup.small { min-width: 260px;max-width:327px;}

.popup .close {
  position:absolute;
  top:10px; right: 10px;
  background: #293e69;
  color: #dff6fc;
  border:none; font-size:1.45em;
  width:30px; height:30px;
  border-radius:100%; cursor:pointer;
  opacity: .85;
  z-index: 5;
  transition: background .15s;
}
.popup .close:hover { background: var(--accent2); color: #fff; }

/* Pop-up area blocks (for slot areas) */
#teamEditArea, #questArea, #gachaArea, #characterArea, #announcementArea,
#chatArea, #shopArea, #inventoryArea { margin: 16px 0 0 0;}

/* Input Buttons/Fields */
input, select, textarea {
  background: #1e2532;
  border: 2px solid #314a6a;
  color: #eee;
  padding: 9px 14px;
  border-radius: 9px;
  font-size: 1em; outline: none;
  margin: 5px 0;
  box-shadow: 0 2px 8px #0067ad20;
  transition: border .13s;
}
input:focus { border:2px solid var(--accent);}
input[type="password"] { letter-spacing: .2em; }

button:focus { outline: 2px solid var(--accent);}
button:active { filter: brightness(.93);}
::-webkit-scrollbar { width: 9px; background: #233;}
::-webkit-scrollbar-thumb { background: #303860; border-radius: 7px; box-shadow: 0 2px 12px #152a;}

/* Footer */
footer {
  margin: 0;
  background: #141520;
  color: #c9d1e6bb;
  text-align: center;
  font-size: .96em;
  padding: 16px 0 11px 0;
}

/* ========== RESPONSIVE DESIGN ========== */
@media (max-width: 750px) {
  .battlefield { min-height: 240px; }
  .card { width: 81px; min-height: 82px; }
  .card .hero-img, .card .mon-img { width: 52px; height: 52px;}
  .popup.large { min-width: 97vw;}
  .popup.tall { min-width: 97vw;}
  main#mainBattlefield { padding: .51em 0; border-radius: 6px;}
  .navbar { flex-direction:column; gap:.5em;}
  .menu { flex-wrap: wrap; gap: .19em 1em; margin-bottom:.3em;}
}

@media (max-width: 540px) {
  .card { width: 66px; }
  .popup { padding:1em .65em .8em .65em; }
}

‡πÑ‡∏ü‡∏•‡πå data/char/astra.json
{
  "id": "astra",
  "type": "hero",
  "name": "Astra",
  "element": "water",
  "class": "knight",
  "rarity": 5,
  "star": 5,
  "level": 1,
  "level_max": 50,
  "exp": 0,
  "exp_max": 600,
  "hp": 150064,
  "atk": 1016,
  "def": 59,
  "spd": 1000,
  "crit_rate": 15,
  "crit_dmg": 150,
  "effectiveness": 0,
  "resistance": 20,
  "skills": [
    {
      "id": "astra_s1",
      "name": "Sword Slash",
      "type": "attack",
      "desc": "‡πÇ‡∏à‡∏°‡∏ï‡∏µ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ 1 ‡∏ï‡∏±‡∏ß ‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏ï‡∏¥‡∏î [def break] 1 ‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô",
      "multiplier": 1.02,
      "effect": {
        "debuff": [
          { "type": "def_break", "turn": 1, "chance": 35 }
        ]
      },
      "cooldown": 0
    },
    {
      "id": "astra_s2",
      "name": "Guardian Blessing",
      "type": "buff",
      "desc": "‡πÄ‡∏û‡∏¥‡πà‡∏° DEF‡πÉ‡∏´‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏ó‡∏µ‡∏° 2 ‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô",
      "multiplier": 0,
      "effect": {
        "buff": [
          { "type": "def_up", "turn": 1 }
        ]
      },
      "cooldown": 5
    },
    {
      "id": "astra_s3",
      "name": "Aegis Pierce",
      "type": "attack",
      "desc": "‡πÇ‡∏à‡∏°‡∏ï‡∏µ‡∏´‡∏°‡∏π‡πà ‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏ï‡∏¥‡∏î stunned 1 ‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô",
      "multiplier": 1.7,
      "effect": {
        "debuff": [
          { "type": "stun", "turn": 3, "chance": 50 }
        ]
      },
      "cooldown": 3
    }
  ],
  "passive": "astra_passive",
  "img": "astra.png"
}

‡πÑ‡∏ü‡∏•‡πå team.html
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Epic Seven - ‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏°</title>
    <link rel="stylesheet" href="css/style.css" />
</head>
<body class="dark-bg">

<header>
    <nav class="navbar">
        <div class="logo">EPIC Seven - Card Battle</div>
        <ul class="menu">
            <li><button onclick="window.location.href='index.html'">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button></li>
            <li><button onclick="window.location.href='team.html'" class="noti">‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏°</button></li>
            <li><button id="btnBack">‡∏Å‡∏•‡∏±‡∏ö</button></li>
        </ul>
        <div class="profile">
            <span id="playerName"></span>
            <button id="btnLogin">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </nav>
</header>

<main id="mainTeamSetup" style="max-width: 1000px; margin:20px auto;background:var(--panel-bg);border-radius:12px;box-shadow:0 1px 20px #0006;padding:26px 8px;">
    <h2 style="margin-bottom:0.8em;">‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ</h2>
    <div class="team-section">
        <h3>‡∏ó‡∏µ‡∏°‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 4 ‡∏ï‡∏±‡∏ß)</h3>
        <div id="teamSlotBar" class="card-row user"></div>
        <button class="primary-btn" id="btnSaveTeam" style="margin-top:18px;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏µ‡∏°</button>
    </div>
    <hr style="margin: 32px 0 18px 0; border:1px solid var(--border);">
    <h4>‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ (‡∏•‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏ö‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏°)</h4>
    <div id="charCollection" class="card-row" style="flex-wrap:wrap; gap:15px 8px; justify-content:flex-start;"></div>
</main>

<div id="popupLayer"></div>

<footer>
    <small style="color: #aaa;">&copy; 2024 - Epic Seven Fan Project Demo Frontend</small>
</footer>

<script src="js/utils.js"></script>
<script src="js/team.js"></script>
</body>
</html>

‡πÑ‡∏ü‡∏•‡πå js/team.js
// js/team.js

const maxTeam = 4;
const baseCharIds = ['astra', 'slime_earth', 'slime_fire', 'slime_water'];

let allChars = []; // All user-owned char (metadata, not just id)
let team = [];     // Current team (ids, max length 4)

/**
 * Ensure user has at least 4 base characters in their collection.
 * If there's no char_collection, or empty, will add defaults.
 */
function ensureBaseCollection() {
    let stored = localStorage.getItem('char_collection');
    let arr = [];
    if (stored && stored.startsWith('[')) {
        try { arr = JSON.parse(stored); } catch { arr = []; }
    }
    let changed = false;
    if (!Array.isArray(arr)) arr = [];
    baseCharIds.forEach(id => { if (!arr.includes(id)) { arr.push(id); changed = true; } });
    if (!stored || changed) localStorage.setItem('char_collection', JSON.stringify(arr));
    return arr;
}

/**
 * Load character meta from user collection (char_collection)
 */
async function loadCharacters() {
    let charIds = ensureBaseCollection();
    const metas = await Promise.all(
        charIds.map(id => fetch(`data/char/${id}.json`).then(r => r.json()).catch(() => null))
    );
    allChars = metas.filter(Boolean); // only those found in meta
}

/**
 * Load team from LocalStorage
 */
function loadTeam() {
    let t = localStorage.getItem('userTeam');
    if (!t) team = [];
    else team = JSON.parse(t);
    // Remove team member if not in current owned char
    let userCharIds = allChars.map(c => c.id);
    team = team.filter(id => userCharIds.includes(id));
}

/**
 * Save team to LocalStorage (max 4, only ids in collection)
 */
function saveTeam() {
    team = team.filter(id => id && allChars.some(c => c.id === id));
    localStorage.setItem('userTeam', JSON.stringify(team));
    alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏µ‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
}

/**
 * Render team slot bar
 */
function renderTeamBar() {
    const el = document.getElementById('teamSlotBar');
    if (!el) return;
    el.innerHTML = '';
    for (let i = 0; i < maxTeam; i++) {
        let char = allChars.find(c => c.id === team[i]);
        let slot = document.createElement('div');
        slot.className = 'card';
        slot.style.minHeight = "140px";
        slot.dataset.idx = i;
        if (char) {
            slot.innerHTML = `
                <img src="img/char/${char.img}" class="hero-img" alt="${char.name}">
                <div class="name">${char.name}</div>
                <button class="primary-btn" style="margin:7px 0 4px 0;font-size:.93em;" onclick="removeFromTeam(${i})">‡∏ô‡∏≥‡∏≠‡∏≠‡∏Å</button>
            `;
        } else {
            slot.innerHTML = `<div style="opacity:.44;margin-top:30px;text-align:center;">‡∏ß‡πà‡∏≤‡∏á</div>`;
            slot.style.background = '#262a39b2';
        }
        el.appendChild(slot);
    }
}

/**
 * Render character collection below the team area, drag-to-add
 */
function renderCharCollection() {
    const el = document.getElementById('charCollection');
    if (!el) return;
    el.innerHTML = '';
    allChars.forEach(c => {
        let inTeam = team.includes(c.id);
        let div = document.createElement('div');
        div.className = 'card';
        div.draggable = !inTeam;
        div.style.opacity = inTeam ? '.34' : '1.0';
        div.style.cursor = inTeam ? "not-allowed" : "grab";
        div.innerHTML = `
            <img src="img/char/${c.img}" class="hero-img" alt="${c.name}" >
            <div class="name">${c.name}</div>
            <div style="font-size:.92em;margin-bottom:3px;">Lv.${c.level} &nbsp; <small class="stat-bar">${c.hp} HP</small></div>
        `;
        // Show popup info on click
        div.addEventListener('click', e => { openCharInfoPopup(c); });

        // Drag: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏™‡πà‡∏ó‡∏µ‡∏°
        div.addEventListener('dragstart', ev => {
            ev.dataTransfer.setData("text/plain", c.id);
        });

        el.appendChild(div);
    });

    // Team slot: drag over/drop
    const teamSlots = document.querySelectorAll('#teamSlotBar .card');
    teamSlots.forEach(slot => {
        slot.ondragover = e => { e.preventDefault(); slot.style.borderColor = '#49cfffa8'; };
        slot.ondragleave = e => { slot.style.borderColor = ''; };
        slot.ondrop = function(e) {
            e.preventDefault();
            let dragId = e.dataTransfer.getData("text/plain");
            let idx = Number(slot.dataset.idx);
            // only if not in team and exists in collection
            if (!team.includes(dragId) && allChars.some(ch => ch.id === dragId)) {
                team[idx] = dragId;
                saveTeam();
                renderTeamBar();
                renderCharCollection();
            }
        }
    });
}

/**
 * Remove character from team by slot index
 */
window.removeFromTeam = function(idx) {
    team[idx] = undefined;
    renderTeamBar();
    renderCharCollection();
}

/**
 * Popup: Character info
 */
function openCharInfoPopup(char) {
    closePopup();
    window.openPopup('charInfo', {
        char
    });
}

// Patch: Add charInfo popup template for UI
(function () {
    const origRenderPopup = window.renderPopup;
    window.renderPopup = function (type, data) {
        if (type === "charInfo" && data && data.char) {
            const c = data.char;
            return `<div class="popup" style="min-width:285px;">
                <button class="close" onclick="closePopup()">√ó</button>
                <img src="img/char/${c.img}" class="hero-img" style="margin:auto;display:block;" />
                <div class="name" style="text-align:center;">${c.name}</div>
                <div style="margin-top:8px;font-size:.97em;color:#87cdff;">Lv.${c.level} ‚òÖ${c.star} <span> (${c.class})</span></div>
                <hr style="margin:8px 0 8px 0;border-color:#234;">
                <div><b>HP</b> ${c.hp} &nbsp; <b>ATK</b> ${c.atk} &nbsp; <b>DEF</b> ${c.def}</div>
                <div><b>SPD</b> ${c.spd} &nbsp; <b>CRIT%:</b> ${c.crit_rate}</div>
                <div><b>Skills</b>:</div>
                <ul>${c.skills.map(s => `<li><b>${s.name}</b>: ${s.desc}</li>`).join('')}</ul>
            </div>`;
        }
        return origRenderPopup(type, data);
    }
})();

/**
 * Save team button
 */
document.addEventListener('DOMContentLoaded', () => {
    const btnSaveTeam = document.getElementById('btnSaveTeam');
    if (btnSaveTeam) btnSaveTeam.onclick = saveTeam;
});

/**
 * Back button - return to homepage
 */
const btnBack = document.getElementById('btnBack');
if (btnBack) btnBack.onclick = () => { window.location.href = 'index.html'; }

/**
 * Initialize: load all step
 */
(async () => {
    await loadCharacters();
    loadTeam(); // after allChars loaded
    renderTeamBar();
    renderCharCollection();
})();

‡πÑ‡∏ü‡∏•‡πå js/battle.js
// js/battle.js - Epic Seven Card Battle NEW (2024/06 Rewrite By GPT-4)
// ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ‡πÅ‡∏ö‡∏ö SPD BAR, AI Auto, Popup ‡∏î‡∏≤‡πÄ‡∏°‡∏à/‡∏Æ‡∏µ‡∏•, Event ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°, ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÇ‡∏°‡∏î‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà (effect, passive, animation)

const CONFIG = { SPD_MAX: 100, SPD_FRAME: 120, MAX_HERO: 4, MAX_MON: 4 };
let Battle = {
    heroes: [],
    monsters: [],
    spdBar: [],
    auto: false,
    running: false,
};

// ----------------- LOAD TEAM & ENEMY -----------------
async function loadBattleTeams() {
    // Load user team
    let ids = JSON.parse(localStorage.getItem('userTeam') || "[]");
    Battle.heroes = [];
    for (let id of ids) {
        if (!id) continue;
        let c = await fetch(`data/char/${id}.json`).then(r => r.json());
        let meta = { ...c, currHp: c.hp, alive: true, buffs: [], debuffs: [], cooldowns: new Array((c.skills||[]).length).fill(0) };
        if (window.passiveEngine?.apply) await window.passiveEngine.apply(meta);
        Battle.heroes.push(meta);
    }
    // Load monsters ("monster_list" ‡∏´‡∏£‡∏∑‡∏≠ fallback)
    let mlist = [];
    try {
        mlist = JSON.parse(localStorage.getItem("monster_list") || '["slime_basic"]');
    } catch { mlist = ["slime_basic"]; }
    Battle.monsters = [];
    for (let i = 0; i < CONFIG.MAX_MON; i++) {
        let id = mlist[i % mlist.length];
        let c = null;
        try { c = await fetch(`data/monster/${id}.json`).then(r => r.json()); }
        catch { c = { id: "slime_basic", name: "Slime", hp: 300, atk: 18, def: 7, spd: 85, img: "slime_basic.png", skills: [] }; }
        let meta = { ...c, id: c.id + '_' + (i+1), currHp: c.hp, alive: true, buffs: [], debuffs: [], cooldowns: new Array((c.skills||[]).length).fill(0) };
        if (window.passiveEngine?.apply) await window.passiveEngine.apply(meta);
        Battle.monsters.push(meta);
    }
}

// ----------------- SPD BAR INIT -----------------
function initSpdBar() {
    Battle.spdBar = [];
    Battle.heroes.forEach((h,i) => Battle.spdBar.push(spdObject(h,i,"hero")));
    Battle.monsters.forEach((m,i) => Battle.spdBar.push(spdObject(m,i,"mon")));
}
function spdObject(c, idx, side) {
    return { id: `${side}${idx}`, idx, side, name:c.name, spd:c.spd, charge:0, dead:false, cooldowns:c.cooldowns, buffs:c.buffs, debuffs:c.debuffs };
}

// ----------------- RENDER FIELD + CARD -----------------
function renderBattlefield() {
    let heroRow = document.querySelector('.card-row.user');
    let monRow  = document.querySelector('.card-row.monster');
    if (heroRow) heroRow.innerHTML = '';
    if (monRow) monRow.innerHTML   = '';
    Battle.heroes.forEach((c, i) => heroRow?.appendChild(renderCardNew(c,i,"hero")));
    Battle.monsters.forEach((c, i) => monRow?.appendChild(renderCardNew(c,i,"mon")));
    // SPD Bars
    let bar = document.querySelector('.spd-bar-container');
    if (bar) bar.innerHTML = '';
    Battle.spdBar.forEach(obj=>{
        let wrap = document.createElement('div');
        wrap.className = 'spd-bar';
        wrap.title = `[${obj.side=="hero"?"Hero":"Monster"}] ${obj.name} SPD:${obj.spd}`;
        let fill = document.createElement('div');
        fill.className = 'spd-bar-fill';
        fill.style.width = Math.floor(Math.min(CONFIG.SPD_MAX, obj.charge)/CONFIG.SPD_MAX*100) + "%";
        wrap.appendChild(fill); bar?.appendChild(wrap);
    });
}
function renderCardNew(c, idx, side) {
    let d = document.createElement('div');
    d.className = 'card';
    d.id = `${side}${idx}`;
    d.setAttribute('data-idx', idx);
    d.setAttribute('data-side', side);
    let img = document.createElement('img');
    img.className = (side=="hero"?"hero-img":"mon-img");
    img.src = `img/char/${c.img}`;
    img.alt = c.name;
    d.appendChild(img);
    d.appendChild(divCls('name', c.name));
    // HP BAR
    let statbar = document.createElement('div');
    statbar.className = 'statbar';
    let hpfill = document.createElement('div');
    hpfill.className = 'hp-fill';
    let hpPer = Math.max(0, Math.min(1, c.currHp / c.hp));
    hpfill.style.width = (hpPer * 100) + "%";
    statbar.appendChild(hpfill);
    d.appendChild(statbar);
    // buffer and debuff icons
    let statIcons = document.createElement('div');
    statIcons.className = 'stat-icons';
    (c.buffs||[]).forEach(b => statIcons.appendChild(iconForStatus(b,"buff")));
    (c.debuffs||[]).forEach(b => statIcons.appendChild(iconForStatus(b,"debuff")));
    d.appendChild(statIcons);
    d.appendChild(divCls('', `HP ${Math.floor(c.currHp)}/${c.hp} SPD:${c.spd}`, {fontSize:".82em"}));
    return d;
}
function divCls(cls, txt, styleObj) {
    let d = document.createElement('div');
    if (cls) d.className = cls;
    d.innerText = txt;
    if (styleObj) Object.assign(d.style, styleObj);
    return d;
}
function iconForStatus(stat, type) {
    let e = document.createElement('div');
    e.className = 'stat-icon '+type;
    e.innerHTML = getStatEmoji(stat.type);
    e.title = (stat.type||"").toUpperCase()+(stat.turn?(" ("+stat.turn+"T)"):"");
    if (stat.turn && stat.turn > 0) {
        let lbl = document.createElement('small');
        lbl.style = "position:absolute;font-size:.79em;font-weight:bold;right:2px;bottom:1px;color:"+ (type=="buff"?"#42fcc1":"#ffc3a3");
        lbl.innerText = stat.turn;
        e.appendChild(lbl);
    }
    let tt = document.createElement('span');
    tt.className = 'tooltip';
    tt.innerText = statDesc(stat.type,type,stat);
    e.appendChild(tt);
    return e;
}
function statDesc(type, side, details) {
    // Short desc
    const lib = {def_break: 'DEF‚Üì',def_up:'DEF‚Üë',stun:'Stun',poison:'Poison',burn:'Burn',heal_ot:'HoT',spd_up:'SPD‚Üë',spd_down:'SPD‚Üì',immune:'Immune',silence:'Silence'};
    return (lib[type]||type) + (details.turn?(" ("+details.turn+" turn)"):"");
}
function getStatEmoji(t) {
    return {def_break:"üõ†Ô∏è",def_up:"üõ°Ô∏è",stun:"üí´",heal_ot:"üíö",poison:"‚ò†Ô∏è",burn:"üî•",spd_up:"üí®",spd_down:"üê¢",immune:"üîí",silence:"üîá"}[t] || "‚ú®";
}

// ----------------- SHOW DAMAGE / HEAL popups -----------------
window.showDamage = function(idx, side, value, color='#ff5656') {
    let dom = document.getElementById(`${side}${idx}`);
    if (!dom) return;
    let pop = document.createElement('span');
    pop.className = 'damage-popup';
    pop.innerText = (value < 0 ? "+" : "-") + Math.abs(value);
    pop.style.color = color;
    dom.appendChild(pop);
    setTimeout(()=>pop.remove(), 900);
};

// ----------------- AUTO SPD BAR LOOP & TURNS -----------------
async function startBattle() {
    if (Battle.running) return; Battle.running = true; Battle.auto = true;
    async function loop() {
        while (Battle.running) {
            for (let i=0;i<Battle.spdBar.length;i++) {
                let bar = Battle.spdBar[i];
                if (bar.dead) continue;
                let charArr = (bar.side=="hero"?Battle.heroes:Battle.monsters);
                let char = charArr[bar.idx];
                // Process buffs/debuffs/HoT, before charge
                if (window.effectEngine?.processStatusTurn) window.effectEngine.processStatusTurn(char);
                if (char.currHp <= 0) { char.alive = false; bar.dead = true; continue; }
                if (window.effectEngine?.isStunnedOrSkipped?.(char)) {
                    bar.cooldowns.forEach((v, i, arr) => {if(arr[i]>0) arr[i]--;});
                    continue;
                }
                // Increase SPD
                bar.charge += spdChargeCurrent(bar);
                if (bar.charge >= CONFIG.SPD_MAX) {
                    bar.charge = 0;
                    await runTurn(bar);
                    renderBattlefield();
                    break; // pause, rerun
                }
            }
            checkBattleResult();
            renderBattlefield();
            await (window.animationEngine?.sleep ? window.animationEngine.sleep(CONFIG.SPD_FRAME) : new Promise(r=>setTimeout(r,CONFIG.SPD_FRAME)));
        }
    }
    loop();
}
function spdChargeCurrent(bar) {
    let spd = bar.spd, up=1.0;
    if (bar.buffs?.some(b => b.type=="spd_up")) up+=.3;
    if (bar.debuffs?.some(b => b.type=="spd_down")) up-=.3;
    return spd/10*up;
}
async function runTurn(bar) {
    let team = (bar.side=="hero"?Battle.heroes:Battle.monsters);
    let enemy = (bar.side=="hero"?Battle.monsters:Battle.heroes);
    let char = team[bar.idx];
    if (window.effectEngine?.processStatusTurn) window.effectEngine.processStatusTurn(char);
    if (window.effectEngine?.isStunnedOrSkipped?.(char)) {
        bar.cooldowns.forEach((v,i,arr)=>{if(arr[i]>0) arr[i]--;});
        return;
    }
    if (!char.alive) return;
    // AI pick skill+target
    let skill = window.aiPickSkill ? window.aiPickSkill(char, bar.cooldowns, team, enemy) : pickSkillFallback(char,bar);
    let targets = [];
    if (skill.type==="attack" && (skill.multiplier > 1.2 || skill.type==='aoe')) targets = enemy.filter(e=>e.alive);
    else if (skill.type==="attack") targets = [pickTargetFallback(enemy, skill)];
    else if (skill.type==="buff") targets = team.filter(c=>c.alive);
    else if (skill.type==="heal") targets = [pickTargetFallback(team, skill)];
    targets = (targets||[]).filter(Boolean);
    // Animation
    if (window.animationEngine) {
        if (skill.type==="attack" && targets[0]) {
            let ti = enemy.indexOf(targets[0]);
            await window.animationEngine.animateAttackCard(bar.idx, ti, bar.side, bar.side=="hero"?"mon":"hero");
        }
        if ((skill.type==="attack" && skill.multiplier>1.2 && targets.length>1) || skill.type==="aoe") {
            let tiarr = targets.map(t=>enemy.indexOf(t));
            await window.animationEngine.animateAoEAttack(bar.idx, bar.side, bar.side=="hero"?"mon":"hero", tiarr);
        }
        if (skill.type==="heal") await window.animationEngine.animateHeal(bar.idx, bar.side);
        if (skill.type==="buff") await window.animationEngine.animateBuffDebuff(bar.idx, bar.side, "buff");
    }
    // Apply skill
    await doSkillNew(char, skill, targets, bar.side);
    // Cooldown
    if (skill.cooldown) bar.cooldowns[char.skills.findIndex(s=>s.id==skill.id)] = skill.cooldown+1;
    bar.cooldowns.forEach((v,i,arr)=>{if(arr[i]>0) arr[i]--;});
}
function pickSkillFallback(char,bar) {
    let order = [2,1,0];
    for (let i of order) if (char.skills?.[i] && bar.cooldowns[i]<=0) return char.skills[i];
    return char.skills?.[0];
}
function pickTargetFallback(arr,skill) {
    arr = arr.filter(c=>c.alive);
    if (skill?.type==="heal") return arr.sort((a,b)=>a.currHp/a.hp-b.currHp/b.hp)[0];
    return arr.sort((a,b)=>a.currHp-b.currHp)[0];
}

// ----------------- APPLY SKILL -----------------
async function doSkillNew(user, skill, targets, side) {
    if (!targets) return;
    for (let t of targets) {
        if (!t.alive) continue;
        // Heal
        if (skill.type=="heal") {
            let val = Math.floor(user.atk*0.7 + user.level*1.5);
            t.currHp = Math.min(t.hp, t.currHp + val);
            window.showDamage?.(t.index, t.side, -val, "#59f495"); // heal popup
            t.alive = t.currHp > 0;
            continue;
        }
        // Buff
        if (skill.type=="buff" && skill.effect?.buff)
        {
            window.effectEngine?.addEffect?.(t, skill.effect.buff, "buff");
            continue;
        }
        // Attack/AoE
        let dmg = Math.floor(user.atk * (skill.multiplier||1) * (1 + (user.crit_rate||0)/100));
        let defReduce = t.debuffs?.some(d=>d.type=="def_break") ? 1.4 : 1;
        let defVal = t.def*defReduce;
        dmg = Math.max(Math.floor(dmg - defVal/3), 1);
        if (Math.random()*100 < (user.crit_rate||0)) dmg = Math.floor(dmg * ((user.crit_dmg||150)/100));
        t.currHp = Math.max(0, t.currHp - dmg);
        t.alive = t.currHp > 0;
        window.showDamage?.(t.index, t.side, dmg, "#ff5656");
        // Debuff
        if (skill.effect?.debuff) {
            window.effectEngine?.addEffect?.(t, skill.effect.debuff, "debuff");
        }
        // Passive: onDamaged
        if (window.passiveEngine?.trigger) window.passiveEngine.trigger("onDamaged", t, {attacker:user,skill});
    }
}

// ----------------- RESULT CHECK ----------------
function checkBattleResult() {
    let aliveH = Battle.heroes.some(c=>c.alive);
    let aliveM = Battle.monsters.some(c=>c.alive);
    if (!aliveH || !aliveM) {
        Battle.running = false;
        showBattleResultPop(aliveH ? "win" : "lose");
    }
}
function showBattleResultPop(state) {
    if (window.renderBattleResult)
        window.renderBattleResult({ state });
    else setTimeout(()=>{
        openPopup('battleResult', {
            state
        });
    },800);
}

// ----------- DOM STARTUP: START/RENDER -----------
document.addEventListener('DOMContentLoaded', ()=>{
    let btn = document.getElementById('btnStartAuto');
    if (btn) btn.onclick = async()=>{
        Battle.auto = true;
        await loadBattleTeams();
        initSpdBar();
        renderBattlefield();
        startBattle();
    };
    if(document.getElementById('mainBattlefield') && !document.getElementById('mainBattlefield').classList.contains('hide')) {
        loadBattleTeams().then(()=>{
            initSpdBar();
            renderBattlefield();
        });
    }
});

// ----------- HELPER: deepcopy for char/monster -----------
function deepCopy(obj) { return JSON.parse(JSON.stringify(obj)); }

// ----------- EXPORT Global API -----------
window.battleEngine = {
    loadBattleTeams, initSpdBar, renderBattlefield, startBattle,
    get heroes() { return Battle.heroes; },
    get monsters() { return Battle.monsters; },
    get speedBars() { return Battle.spdBar; }
};

‡πÑ‡∏ü‡∏•‡πå js/ai.js
// js/ai.js
/**
 * Epic Seven - AI Auto Battle Engine (‡πÅ‡∏¢‡∏Å Module)
 * ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å skill ‡πÅ‡∏•‡∏∞ target ‡πÉ‡∏ô battle.js
 */

/**
 * Pick skill ‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏î‡∏¢ AI) - ‡πÅ‡∏ö‡∏ö modular
 * @param {Object} char - (obj) ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£
 * @param {Array<number>} cooldowns - cooldown ‡πÅ‡∏ï‡πà‡∏•‡∏∞ skill [s1, s2, s3...]
 * @param {Array<Object>} allies - ‡∏ù‡∏±‡πà‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô (obj)
 * @param {Array<Object>} enemies - ‡∏ù‡∏±‡πà‡∏á‡∏ï‡∏£‡∏á‡∏Ç‡πâ‡∏≤‡∏° (obj)
 * @return {Object} skill ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏ä‡πâ
 */
function aiPickSkill(char, cooldowns, allies, enemies) {
    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ö‡∏±‡∏ü, heal, ‡πÉ‡∏ä‡πâ skill aoe ‡∏Å‡πà‡∏≠‡∏ô (‡∏•‡∏≥‡∏î‡∏±‡∏ö: AoE > Heal/Buff > Single)
    // ‡πÉ‡∏ä‡πâ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç HP ‡∏ï‡πà‡∏≥, ‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏°‡∏≤‡∏Å/‡∏ô‡πâ‡∏≠‡∏¢, ‡∏´‡∏£‡∏∑‡∏≠ CD climate
    let skills = char.skills || [];
    let usable = skills.map((s, i) => ({...s, cd: cooldowns[i] || 0, idx: i }))
        .filter(s => s.cd === 0);

    // (1) Heal/Buff - ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÉ‡∏ô usable skill
    for (let s of usable) {
        if (s.type === 'heal' && needHeal(allies)) return s;
        if (s.type === 'buff' && needBuff(allies, s)) return s;
    }

    // (2) AoE - ‡∏ñ‡πâ‡∏≤ AoE ‡πÅ‡∏•‡∏∞‡∏ù‡∏±‡πà‡∏á‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏°‡∏µ 2 ‡∏ï‡∏±‡∏ß+ (‡∏´‡∏£‡∏∑‡∏≠ priority)
    for (let s of usable) {
        if ((s.type === 'attack' || s.type === 'aoe') && s.multiplier > 1.5 && (living(enemies) > 1)) {
            return s;
        }
    }

    // (3) Debuff - ‡∏ï‡∏µ‡πÄ‡∏õ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ü‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏Å‡∏£‡πà‡∏á (def break/stun)
    for (let s of usable) {
        if (s.effect && s.effect.debuff) return s;
    }

    // (4) Single Attack - ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å default
    if (usable.length > 0) return usable[0];
    // fallback: skill 1
    return skills[0];
}

/**
 * Pick target ‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡πÇ‡∏à‡∏°‡∏ï‡∏µ (AI)
 * @param {Array<Object>} arr - ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (obj)
 * @param {Object} skill - skill ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏ä‡πâ
 * @return {Object}
 */
function aiPickTarget(arr, skill = null) {
    // ‡∏ï‡∏µ‡∏ï‡∏±‡∏ß HP ‡∏ô‡πâ‡∏≠‡∏¢‡∏™‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô ‡πÄ‡∏ß‡πâ‡∏ô‡∏ñ‡πâ‡∏≤ skill ‡πÄ‡∏õ‡πá‡∏ô heal/buff
    arr = arr.filter(c => c.alive);
    // Heal: ‡∏´‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏Ñ‡∏∑‡∏≠‡∏ù‡∏±‡πà‡∏á‡πÄ‡∏£‡∏≤ (lowest HP)
    if (skill && skill.type === 'heal') {
        return arr.sort((a, b) => a.currHp / a.hp - b.currHp / b.hp)[0];
    }
    // Buff: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡∏ù‡∏±‡πà‡∏á‡πÄ‡∏£‡∏≤ alive
    if (skill && skill.type === 'buff') {
        // ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡πà logic   --> ‡πÉ‡∏™‡πà‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å index 0
        return arr[0];
    }
    // AoE: ‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏¢
    if (skill && (skill.type === 'aoe' || (skill.type === 'attack' && skill.multiplier > 1.5))) {
        return arr; // ‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ñ‡∏ß enemy
    }
    // Debuff: ‡∏ï‡∏µ tank ‡∏Å‡πà‡∏≠‡∏ô (defense/high HP), ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏ô‡πâ‡∏ô ‡∏´‡∏≤ HP ‡∏ô‡πâ‡∏≠‡∏¢‡∏™‡∏∏‡∏î
    let sorted = arr.sort((a, b) => a.currHp - b.currHp);
    return sorted[0];
}

/**
 * ‡πÉ‡∏Ñ‡∏£‡πÉ‡∏ô‡∏ó‡∏µ‡∏° HP ‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 60% ‡πÉ‡∏´‡πâ heal
 * @param {Array<Object>} team
 */
function needHeal(team) {
    for (let c of team) {
        if (c.alive && c.currHp / c.hp < 0.6) return true;
    }
    return false;
}

/**
 * ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ö‡∏±‡∏ü‡∏ó‡∏µ‡πà skill ‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ó‡∏µ‡∏°‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÅ‡∏•‡πâ‡∏ß‡∏Ç‡πâ‡∏≤‡∏°)
 * @param {Array<Object>} team
 * @param {Object} skill
 */
function needBuff(team, skill) {
    let buffs = (skill && skill.effect && skill.effect.buff) || [];
    for (let btype of buffs.map(b => b.type)) {
        // ‡∏ñ‡πâ‡∏≤ buff ‡∏ô‡∏µ‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏ó‡∏µ‡∏°‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏°‡∏î ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ
        let count = team.filter(c => c.alive && c.buffs && c.buffs.some(bf => bf.type === btype)).length;
        if (count < team.length) return true; // ‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏Ñ‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ buff ‡∏ô‡∏µ‡πâ
    }
    return false;
}

/**
 * ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏≤‡∏¢
 */
function living(arr) {
    return arr ? arr.filter(c => c.alive).length : 0;
}

// ---- ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡∏±‡∏ö battle.js ----
// Expose ‡πÄ‡∏õ‡πá‡∏ô global ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ
window.aiPickSkill = aiPickSkill;
window.aiPickTarget = aiPickTarget;

‡πÑ‡∏ü‡∏•‡πå js/animationEngine.js
/* Epic Seven Card Auto Battle - Animation Engine */
/* ‡∏ß‡∏≤‡∏á‡πÉ‡∏ô /js/animationEngine.js */

window.animationEngine = (function () {
    /** Card slide animation to attack */
    async function animateAttackCard(fromIdx, toIdx, fromSide, toSide, type = 'single') {
        const fromCard = document.getElementById(`${fromSide}${fromIdx}`);
        const toCard = document.getElementById(`${toSide}${toIdx}`);
        if (!fromCard || !toCard) return;
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á overlay
        const rectFrom = fromCard.getBoundingClientRect();
        const rectTo = toCard.getBoundingClientRect();
        // Absolute overlay clone
        const clone = fromCard.cloneNode(true);
        clone.style.position = "fixed";
        clone.style.left = rectFrom.left + 'px';
        clone.style.top = rectFrom.top + 'px';
        clone.style.width = rectFrom.width + 'px';
        clone.style.zIndex = "2000";
        clone.style.transition = 'all 0.35s cubic-bezier(.6,0,.2,1.4)';
        // Hide original
        fromCard.style.opacity = "0.4";
        document.body.appendChild(clone);
        await sleep(30);

        // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÑ‡∏õ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢
        clone.style.left = rectTo.left + 'px';
        clone.style.top = rectTo.top + 'px';
        clone.style.boxShadow = "0 0 32px #e7ff79c8, 0 0 80px #e3e37044";
        clone.style.transform = "scale(1.10) rotate(-3deg)";
        await sleep(330);

        // Flash/Shake ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢
        shakeCard(toCard);
        // Remove overlay
        setTimeout(() => {
            clone.remove();
            fromCard.style.opacity = "1";
        }, 110);

        await sleep(180);
    }

    /** AoE Animation (wave blast) */
    async function animateAoEAttack(fromIdx, fromSide, toSide, targets) {
        const fromCard = document.getElementById(`${fromSide}${fromIdx}`);
        if (!fromCard) return;
        // Pulse the card
        pulseCard(fromCard, "#f2d13e");
        // Wave line to center
        targets.forEach((t) => {
            const tgt = document.getElementById(`${toSide}${t}`);
            if (tgt) {
                flashCard(tgt, "#ffd058");
                shakeCard(tgt);
            }
        });
        await sleep(340);
    }

    /** Heal effect (green glow, upward effect) */
    async function animateHeal(toIdx, toSide) {
        const tgt = document.getElementById(`${toSide}${toIdx}`);
        if (!tgt) return;
        glowCard(tgt, "#68eccc");
        // Heal "plus" popup up
        let plus = document.createElement('span');
        plus.textContent = "+HP";
        plus.style = "color:#68fdd8;font-weight:bold;font-size:1.18em;position:absolute;left:42%;top:17%;opacity:0;transition:top .4s,opacity .2s;";
        tgt.appendChild(plus);
        setTimeout(() => {
            plus.style.top = "-6%";
            plus.style.opacity = "1";
        }, 20);
        setTimeout(() => plus.remove(), 650);
        await sleep(390);
    }

    /** Buff/Debuff effect on card */
    async function animateBuffDebuff(toIdx, toSide, type = "buff") {
        const tgt = document.getElementById(`${toSide}${toIdx}`);
        if (!tgt) return;
        glowCard(tgt, type === "buff" ? "#98deff" : "#ff7b7b");
        await sleep(260);
    }

    // --- Utilities (Shake, Glow, Flash, Pulse) ---
    function shakeCard(card) {
        if (!card) return;
        card.animate([
            { transform: "translateX(0)" },
            { transform: "translateX(-12px)" },
            { transform: "translateX(13px)" },
            { transform: "translateX(-7px)" },
            { transform: "translateX(0)" }
        ], { duration: 320, easing: "ease-in" });
    }
    function glowCard(card, color) {
        if (!card) return;
        card.style.boxShadow = `0 0 15px 6px ${color}66`;
        setTimeout(() => (card.style.boxShadow = ""), 380);
    }
    function flashCard(card, color = "#fff") {
        if (!card) return;
        card.style.background = color;
        setTimeout(() => (card.style.background = ""), 170);
    }
    function pulseCard(card, color) {
        if (!card) return;
        card.animate([
            { boxShadow: `0 0 0px 0px ${color}40` },
            { boxShadow: `0 0 15px 8px ${color}bb` },
            { boxShadow: `0 0 0px 0px ${color}00` }
        ], { duration: 410 });
    }
    function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

    // --- Expose ---

    return {
        animateAttackCard,
        animateAoEAttack,
        animateHeal,
        animateBuffDebuff,
        shakeCard,
        glowCard,
        flashCard,
        pulseCard,
        sleep
    };
})();

‡πÑ‡∏ü‡∏•‡πå js/effect.js
// effect.js - Rewrite ver (by GPT-4, 2024)
// Epic Seven Card Battle: Effect System (Buff/Debuff/Heal/Process Turn/Stack)
// ‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏° (‡∏Ñ‡∏•‡∏µ‡∏ô‡πÅ‡∏•‡∏∞‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°)
// ‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö: battle.js, ai.js, animationEngine.js

/**
 * ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (Buff ‡∏´‡∏£‡∏∑‡∏≠ Debuff) ‡πÉ‡∏´‡πâ character
 * @param {Object} target - ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢
 * @param {Array|Object} effects - [{type, turn, chance}]
 * @param {String} effectType - 'buff' ‡∏´‡∏£‡∏∑‡∏≠ 'debuff'
 */
function addEffectV2(target, effects, effectType) {
  if (!target || !effects) return;
  if (!Array.isArray(effects)) effects = [effects];

  // Ensure buffs/debuffs field
  if (!target.buffs) target.buffs = [];
  if (!target.debuffs) target.debuffs = [];

  for (const effect of effects) {
    if (!effect || !effect.type) continue;

    // Immunity (debuff only)
    if (
      effectType === "debuff" &&
      Array.isArray(target.buffs) &&
      target.buffs.some(b => b.type === "immune" && b.turn && b.turn > 0)
    ) {
      // ‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô stun/burn/poison ‡∏¢‡∏±‡∏á‡∏ï‡∏¥‡∏î
      if (!["stun", "burn", "poison"].includes(effect.type)) continue;
    }

    // Non-stack (default), Stackable (burn/poison)
    let canStack = ["burn", "poison"].includes(effect.type);
    let existing =
      effectType === "buff"
        ? target.buffs.find(b => b.type === effect.type)
        : target.debuffs.find(d => d.type === effect.type);

    if (!canStack && existing) continue;

    // Chance
    if (typeof effect.chance === "number") {
      if (Math.random() * 100 > effect.chance) continue; // Failed to proc
    }

    let effObj = { ...effect };
    // (clone, so each has separate turn etc)
    if (effectType === "buff") target.buffs.push(effObj);
    else target.debuffs.push(effObj);
  }
}

/**
 * ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏° turn ‡πÉ‡∏´‡∏°‡πà ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î turn & trigger effect
 * @param {Object} char
 */
function processStatusEachTurn(char) {
  if (!char) return;
  ["buffs", "debuffs"].forEach(group => {
    if (!Array.isArray(char[group])) return;
    // countdown
    for (let i = char[group].length - 1; i >= 0; i--) {
      let st = char[group][i];
      if (typeof st.turn === "number" && st.turn > 0) st.turn--;
      // Remove if expired
      if (st.turn === 0) char[group].splice(i, 1);
    }
  });

  // === ACTIVE EFFECTS ===
  // Debuff: Poison/Burn
  if (Array.isArray(char.debuffs)) {
    char.debuffs.forEach(d => {
      if (d.type === "poison") {
        let val = Math.max(1, Math.round(char.hp * 0.05));
        char.currHp = Math.max(0, char.currHp - val);
        showStatusPopup(char, -val, "#ffea80"); // yellow
      }
      if (d.type === "burn") {
        let val = Math.max(1, Math.round(char.hp * 0.12));
        char.currHp = Math.max(0, char.currHp - val);
        showStatusPopup(char, -val, "#ff6100");
      }
    });
  }
  // Buff: Heal Over Time
  if (Array.isArray(char.buffs)) {
    char.buffs.forEach(b => {
      if (b.type === "heal_ot") {
        let val = Math.max(1, Math.round(char.hp * 0.06));
        char.currHp = Math.min(char.hp, char.currHp + val);
        showStatusPopup(char, val, "#2ae5a4");
      }
    });
  }
}

/**
 * ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏ô‡∏µ‡πâ‡πÇ‡∏î‡∏ô stun ‡∏´‡∏£‡∏∑‡∏≠ skip turn (‡πÄ‡∏ä‡πà‡∏ô stun, sleep, freeze, silence ‡∏Ø‡∏•‡∏Ø)
 * @param {Object} char
 * @returns {Boolean}
 */
function isTurnSkipStatus(char) {
  if (!char || !char.debuffs) return false;
  const effectNames = ["stun", "sleep", "freeze", "silence"];
  return char.debuffs.some(b => effectNames.includes(b.type));
}

/**
 * ‡∏•‡∏ö buff ‡∏´‡∏£‡∏∑‡∏≠ debuff ‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
 * @param {Object} char
 * @param {String} [type="all"] - 'buff'|'debuff'|'all'
 */
function clearStatus(char, type = "all") {
  if (!char) return;
  if (type === "all" || type === "buff") char.buffs = [];
  if (type === "all" || type === "debuff") char.debuffs = [];
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏î‡∏≤‡πÄ‡∏°‡∏à/‡∏Æ‡∏µ‡∏• ‡πÄ‡∏õ‡πá‡∏ô popup (‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Å‡∏±‡∏ö window.showDamage)
 */
function showStatusPopup(char, value, color = "#ff7777") {
  // value > 0 : heal, <0 : dmg
  // Find side, index for rendering (if available)
  let side = char.side || "hero",
    idx = typeof char.index === "number" ? char.index : 0;
  if (window.showDamage) window.showDamage(idx, side, value, color);
}

// -- EXPORT: API Global --
window.effectEngine = {
  addEffect: addEffectV2,
  processStatusTurn: processStatusEachTurn,
  isStunnedOrSkipped: isTurnSkipStatus,
  removeStatus: clearStatus
};

‡πÑ‡∏ü‡∏•‡πå js/result.js
// result.js (‡∏£‡∏µ‡πÑ‡∏£‡∏ó‡πå‡πÉ‡∏´‡∏°‡πà‡∏´‡∏°‡∏î 2024/06, ‡πÇ‡∏Ñ‡πâ‡∏î‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡πÄ‡∏î‡∏¥‡∏°)
// Epic Seven Card Battle - Modular Result + Reward System

/*
  Design Objectives:
    - Single responsibility: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏´‡∏•‡∏±‡∏á‡∏à‡∏ö‡∏î‡πà‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
    - ‡∏á‡πà‡∏≤‡∏¢‡∏ï‡πà‡∏≠ test, ‡∏õ‡∏£‡∏±‡∏ö theme, ‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö reward/inventory/character
    - ‡πÑ‡∏°‡πà‡∏ä‡∏ô‡∏Å‡∏±‡∏ö UI ‡∏ö‡∏≤‡∏ó, ‡∏ó‡∏∏‡∏Å event/‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå ‡∏ï‡πâ‡∏≠‡∏á popup ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß, ‡πÑ‡∏°‡πà‡πÅ‡∏à‡∏° slide ‡∏î‡∏≤‡πÄ‡∏°‡∏à
    - ‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö core ‡∏ú‡πà‡∏≤‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô API ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° (window.renderBattleResult, rewardEngine.give ‡∏Ø‡∏•‡∏Ø)
    - Customizable hook ‡∏û‡∏£‡πâ‡∏≠‡∏° afterClose/callback ‡πÅ‡∏ö‡∏ö Promise
*/

// =================[ STATE + CONST ]=================

const RESULT_POPUP_ID = "battleResultV2";

// =================[ MAIN CONTROLLER ]=================

/**
 * ‡∏£‡∏±‡∏ö‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ ‡∏´‡∏•‡∏±‡∏á battle/stage ‡∏à‡∏ö ‡πÄ‡∏û‡∏∑‡πà‡∏≠ popup exp, ‡∏î‡∏£‡∏≠‡∏õ, level up, ‡∏Ø‡∏•‡∏Ø
 * @param {Object} params - { state, heroes, monsters, drops, exp, afterClose }
 */
window.renderBattleResult = async function (params = {}) {
  // Basic fields
  const result = Object.assign(
    { state: "lose", exp: null, drops: [], heroes: null },
    params
  );
  // 1. ‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏µ‡∏° user ‡∏Ç‡πâ‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à meta+exp sync
  const teamIds = loadUserTeam();
  const heroList = await getCharList(teamIds);
  // 2. Calculate EXP
  const exp = Number.isFinite(result.exp)
    ? result.exp
    : (result.state === "win"
        ? getCfg("exp.base_win", 60)
        : getCfg("exp.base_lose", 18));
  const dropItems = Array.isArray(result.drops) ? mergeRewards(result.drops) : [];
  // 3. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏ß‡∏™‡∏ï‡πå/mission ‡πÄ‡∏û‡∏¥‡πà‡∏° tracking ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡∏ú‡πà‡∏≤‡∏ô hook:
  if (typeof window.increaseQuestProgress === "function" && result.state === "win") {
    window.increaseQuestProgress("daily_login");
  }
  // 4. ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï EXP/‡πÄ‡∏•‡πÄ‡∏ß‡∏• ‡∏û‡∏£‡πâ‡∏≠‡∏° list ‡∏ó‡∏µ‡πà up
  const levelUpNames = processLevel(heroList, exp);
  // 5. ‡πÉ‡∏´‡πâ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• (item, char ‡∏•‡∏á inventory)
  giveReward(dropItems);
  // 6. Render popup
  const html = genResultHTML(result, heroList, exp, dropItems, levelUpNames);
  window.openPopup(
    RESULT_POPUP_ID,
    html,
    "large",
    result.state === "win" ? t("popup.result_win") : t("popup.result_lose"),
    {
      onClose: typeof result.afterClose === "function"
        ? result.afterClose
        : undefined,
    }
  );
  // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° stageEngine
  if (typeof window.stageEngine?.end === "function" && result.stage) {
    window.stageEngine.end(result.state);
  }
};

// =================[ CORE LOGIC + REWARDS ]=================

function processLevel(heroList, expUp) {
  let list = [];
  for (let i = 0; i < heroList.length; ++i) {
    const c = heroList[i];
    if (!c) continue;
    let baseLv = c.level || 1,
      baseExp = c.exp || 0,
      maxExp = c.exp_max || 99999;
    c.exp = baseExp + expUp;
    let up = false;
    while (c.exp >= maxExp) {
      c.exp -= maxExp;
      c.level = (c.level || 1) + 1;
      up = true;
    }
    if (up) list.push(c.name);
    // sync
    localStorage.setItem("char_" + c.id, JSON.stringify(c));
  }
  return list;
}

function giveReward(arr) {
  if (!arr || !arr.length) return;
  arr.forEach(rw => {
    if (rw.type === "item") window.addToInventory?.(rw.id, rw.qty);
    if (rw.type === "character") window.collectCharacter?.(rw.id);
  });
}

function mergeRewards(rew) {
  let byId = {};
  (rew || []).forEach(r => {
    if (!r || !r.id) return;
    let k = r.type + ":" + r.id;
    if (!byId[k]) byId[k] = { ...r, qty: r.qty || 1 };
    else byId[k].qty += r.qty || 1;
  });
  return Object.values(byId);
}

// =================[ HTML RENDER ]=================

function genResultHTML(result, heroList, exp, dropItems, levedNames) {
  let html = '';
  // Header/State
  html += `<div style="text-align:center;font-size:2em;margin:2px 0 14px 0;">
    ${result.state === "win"
      ? "üèÜ <b style='color:#4ffcbb'>" + t("popup.result_win") + "</b>"
      : "‚ùå <b style='color:#fb6'>" + t("popup.result_lose") + "</b>"}
    </div>
    <div style="font-size:1.13em;text-align:center;color:#aef;margin-bottom:7px;">
      ${t('battle.exp_gain')} +${exp}
    </div>
    <hr style="margin:11px 0 17px 0;border-color:#1888b088;">
  `;
  // Team heroes
  html += `<table style="width:98%;margin:0 auto 1em auto;"><tr>`;
  html += heroList
    .map(
      h =>
        `<td style="text-align:center;">
         <img src="img/char/${h.img || "noimg.png"}" alt="${h.name}" style="width:34px;border-radius:50%;box-shadow:0 0 9px #5affb7ee;"><br>
         <b>${h.name || "-"}</b><br>
         Lv.${h.level || "-"} ${
           levedNames.includes(h.name)
             ? '<span style="color:#59ff32;"> ‚ÜëUP!</span>'
             : ""
         }
        </td>`
    )
    .join("");
  html += `</tr></table>`;

  // Rewards
  if (dropItems.length) {
    html += `<div style="margin:9px 0;font-size:1.08em;color:#fffdbe;">
      ${t('battle.drop_items')} :
    </div>`;
    html += `<div style="display:flex;flex-wrap:wrap;gap:13px 16px;margin-bottom:1em;">`;
    dropItems.forEach(rw => {
      if (rw.type === "item") {
        const meta = window.inventoryEngine?.findItemById(rw.id) || {};
        html += `<div style="background:#26293d;border-radius:9px;padding:9px 11px;">
          <img src="img/item/${meta.img || "noimg.png"}" style="width:25px;border-radius:7px;"><br>
          ${meta.name || rw.id} <br>
          <span style="color:#aff;font-weight:700;">x${rw.qty}</span>
        </div>`;
      } else if (rw.type === "character") {
        html += `<div style="background:#413d23bb;border-radius:9px;padding:8px 10px;">
          <img src="img/char/${rw.id}.png" style="width:27px;border-radius:7px;"><br>
          <span style="color:#acf;font-weight:bold;">${rw.id}</span> üé¥
        </div>`;
      }
    });
    html += `</div>`;
  } else {
    html += `<div style="color:#9df;text-align:center;margin-top:.6em;">${t('inventory.no_item')}</div>`;
  }

  // Button
  html += `<div style="margin:2em 0 0 0;text-align:center;">
      <button class="primary-btn" onclick="closeResultAndReturn()" style="padding:.73em 2.7em;font-size:1.1em;">${t("popup.ok")}</button>
    </div>`;
  return html;
}

// =================[ API: ‡∏õ‡∏¥‡∏î popup, ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä ]=================

window.closeResultAndReturn = function () {
  window.closePopup?.(RESULT_POPUP_ID);
  // Reload or return, depends on page/context
  if (
    window.location.pathname.endsWith("index.html") &&
    typeof window.renderBattlefield === "function"
  ) {
    window.renderBattlefield();
  }
  if (typeof window.openStageMapPopup === "function") {
    setTimeout(() => window.openStageMapPopup(), 900);
  }
};

// =================[ UTIL ]=================

function getCfg(key, fallback) {
  try {
    let data =
      window._game_config_cache ||
      JSON.parse(localStorage.getItem("game_config_cache") || "{}");
    let parts = (key || "").split(".");
    for (let k of parts) data = data[k];
    return typeof data !== "undefined" ? data : fallback;
  } catch {
    return fallback;
  }
}

function loadUserTeam() {
  try {
    const t = localStorage.getItem("userTeam");
    return t ? JSON.parse(t) : [];
  } catch {
    return [];
  }
}

async function getCharList(ids) {
  if (!Array.isArray(ids)) return [];
  const all = await Promise.all(
    ids.map(async id => {
      if (!id) return null;
      let cache = null;
      try {
        cache = localStorage.getItem("char_" + id);
      } catch {}
      if (cache) return JSON.parse(cache);
      try {
        const res = await fetch(`data/char/${id}.json`);
        return await res.json();
      } catch {
        return null;
      }
    })
  );
  return all.filter(Boolean);
}

// ===============[ Reward Engine: re-expose ]====================
// ‡πÉ‡∏´‡πâ‡πÇ‡∏°‡∏î‡∏π‡∏•‡∏≠‡∏∑‡πà‡∏ô ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å rewardEngine.give() (for popup summarization)
window.rewardEngine = {
  give(arr) {
    let items = Array.isArray(arr) ? arr : [arr];
    let merged = mergeRewards(items);
    giveReward(merged);
    // show summary popup
    const summary = `<div style="text-align:center;">
      <div style="font-size:1.18em;color:#39ffc2;margin-bottom:6px;">‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</div>
      ${merged
        .map(
          rw =>
            rw.type === "item"
              ? `<div style="color:#d4f;font-size:.99em;padding:3px;"><b>${window.inventoryEngine?.findItemById(rw.id)?.name || rw.id}</b> x${rw.qty}</div>`
              : `<div style="color:#7bd;font-size:.99em;padding:3px;"><b>${rw.id}</b> üé¥</div>`
        )
        .join("")}
      <button class="primary-btn" style="margin-top:1.1em;" onclick="closePopup();">${
        t("popup.ok") || "OK"
      }</button>
    </div>`;
    window.openPopup?.("rewardSummary", summary, "small", "‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•");
  },
};
 
 ‡πÑ‡∏ü‡∏•‡πå js/popupManager.js
 // /js/popupManager.js

/**
 * popupManager.js
 * Epic Seven Auto Battle - Popup System (v1.0)
 * ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î-‡∏õ‡∏¥‡∏î Pop-up ‡∏Å‡∏•‡∏≤‡∏á / popover ‡∏ã‡πâ‡∏≠‡∏ô
 * ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö HTML Content, Callback, Responsive
 * ‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö index.html, ui.js, ‡∏ó‡∏∏‡∏Å module
 * Author: (‡∏Ñ‡∏∏‡∏ì)
 */

// ‡πÄ‡∏Å‡πá‡∏ö Stack ‡∏Ç‡∏≠‡∏á popup ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏¥‡∏î‡∏ã‡πâ‡∏≠‡∏ô
let popupStack = [];

/**
 * ‡πÄ‡∏õ‡∏¥‡∏î Popup ‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠
 * @param {Object} options { 
 *    id: string, // ‡∏ä‡∏∑‡πà‡∏≠ feature, ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô key menu, ex: 'quest', 'inventory'
 *    title: string, // ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠
 *    content: HTML string, // ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ HTML (innerHTML)
 *    size: "normal" | "large" | "tall" | "small",
 *    onClose: function, // callback ‡πÄ‡∏°‡∏∑‡πà‡∏≠ popup ‡∏ô‡∏µ‡πâ‡∏õ‡∏¥‡∏î
 *    showCloseBtn: boolean, // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏¥‡∏î (default: true)
 *    autoFocus: CSS selector (optional, ‡πÇ‡∏ü‡∏Å‡∏±‡∏™ input)
 * }
 */
window.popupManager = {
    open: function (options = {}) {
        // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô popup ‡∏ã‡πâ‡∏≠‡∏ô‡∏ã‡πâ‡∏≥‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏¥‡∏°
        if (popupStack.some(p => p.id === options.id)) {
            return; // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏ã‡πâ‡∏≥
        }
        const popupLayer = document.getElementById('popupLayer');
        if (!popupLayer) return;

        const { id, title, content, size, onClose, showCloseBtn, autoFocus } = options;
        const sz = size || 'normal';
        let html = `
      <div class="popup${sz === 'large' ? ' large' : sz === 'tall' ? ' tall' : sz === 'small' ? ' small' : ''}" 
        style="z-index: ${100 + popupStack.length * 2};" popup-id="${id || ''}">
          ${showCloseBtn === false ? '' : `<button class="close" onclick="popupManager.close('${id || ''}')">√ó</button>`}
          <h2 style="margin-bottom:.39em;">${title || ''}</h2>
          <div class="popup-content" style="margin-top:9px;">${content || ''}</div>
      </div>`;

        let wrap = document.createElement('div');
        wrap.className = 'popup-wrap-layer';
        wrap.style = `position:fixed; top:0; left:0; width:100vw;height:100vh;display:flex;
          align-items:center;justify-content:center;z-index:${99 + popupStack.length * 2 + 1};`;
        wrap.innerHTML = html;

        // Store info to Stack
        popupStack.push({
            id,
            wrap,
            onClose: typeof onClose === "function" ? onClose : null
        });

        popupLayer.appendChild(wrap);
        popupLayer.classList.add('active');

        // Auto focus
        if (autoFocus) {
            setTimeout(() => {
                const el = wrap.querySelector(autoFocus);
                if (el) el.focus();
            }, 150);
        }
    },

    /**
     * ‡∏õ‡∏¥‡∏î Popup (‡∏õ‡∏¥‡∏î‡∏ö‡∏ô‡∏™‡∏∏‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏≤‡∏° id)
     * @param {string} id
     */
    close: function (id = '') {
        const popupLayer = document.getElementById('popupLayer');
        if (!popupLayer) return;
        if (popupStack.length === 0) return;
        let pop;
        if (id) {
            let idx = popupStack.findIndex(p => p.id === id);
            if (idx === -1) return;
            pop = popupStack.splice(idx, 1)[0];
            if (pop && pop.wrap) {
                pop.wrap.remove();
            }
        } else {
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡πà‡∏á id ‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î‡∏ï‡∏±‡∏ß‡∏ö‡∏ô‡∏™‡∏∏‡∏î
            pop = popupStack.pop();
            if (pop && pop.wrap) {
                pop.wrap.remove();
            }
        }
        // onClose callback
        if (pop && pop.onClose) pop.onClose();

        // ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ popup ‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î layer
        if (popupStack.length === 0) {
            popupLayer.classList.remove('active');
        }
    },

    /**
     * ‡∏õ‡∏¥‡∏î Popups ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (reset stack)
     */
    closeAll: function () {
        const popupLayer = document.getElementById('popupLayer');
        popupStack.forEach(p => {
            if (p.wrap) p.wrap.remove();
            if (typeof p.onClose === "function") p.onClose();
        });
        popupStack = [];
        if (popupLayer) popupLayer.classList.remove('active');
    },

    /**
     * Render content ‡πÉ‡∏´‡∏°‡πà‡∏ö‡∏ô popup id ‡∏ô‡∏µ‡πâ (‡πÄ‡∏ä‡πà‡∏ô refetch/refresh)
     * @param {string} id
     * @param {string} content HTML
     */
    update: function (id, content) {
        let pop = popupStack.find(p => p.id === id);
        if (pop && pop.wrap) {
            let inner = pop.wrap.querySelector('.popup-content');
            if (inner) inner.innerHTML = content;
        }
    },

    /**
     * ‡∏î‡∏∂‡∏á Stack popups
     */
    getStack: function () { return [...popupStack]; }
};

// [Global shortcut]
window.openPopup = function (id, content = '', size = 'normal', title = '', options = {}) {
    // For backward compat: openPopup(type, html, size, title, { ... })
    window.popupManager.open({
        id, title: title || id, content, size, ...options
    });
}
window.closePopup = function (id = '') { window.popupManager.close(id); }
window.closeAllPopup = function () { window.popupManager.closeAll(); }

// Escape = close popup ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
document.addEventListener('keyup', ev => {
    if (ev.key === 'Escape') popupManager.close();
});

// Click shadow layer (‡∏õ‡∏¥‡∏î popup ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ popup ‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï)
document.getElementById('popupLayer')?.addEventListener('mousedown', ev => {
    if (ev.target.classList.contains('popup-wrap-layer')) {
        // ‡∏´‡∏≤‡∏Å popup ‡∏ö‡∏ô‡∏™‡∏∏‡∏î‡∏°‡∏µ showCloseBtn = false => ‡πÑ‡∏°‡πà‡∏õ‡∏¥‡∏î ‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏•‡∏¥‡∏Å
        if (popupStack.length === 0) return;
        let last = popupStack[popupStack.length - 1];
        if (last && last.wrap && last.wrap.querySelector('.close')) {
            window.popupManager.close();
        }
    }
});

‡πÑ‡∏ü‡∏•‡πå data/item.json
[
  {
    "id": "gold",
    "name": "Gold",
    "type": "currency",
    "description": "‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏ó‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏ä‡∏≤",
    "img": "gold.png",
    "rarity": 1,
    "usable": false,
    "price": 0
  },
  {
    "id": "diamond",
    "name": "Crystal",
    "type": "currency",
    "description": "‡πÄ‡∏û‡∏ä‡∏£ ‡πÉ‡∏ä‡πâ‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏ä‡∏≤ ‡∏û‡∏¥‡πÄ‡∏®‡∏©",
    "img": "diamond.png",
    "rarity": 2,
    "usable": false,
    "price": 0
  },
  {
    "id": "exp_potion",
    "name": "EXP Potion",
    "type": "xp_item",
    "description": "‡πÄ‡∏û‡∏¥‡πà‡∏° EXP ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢",
    "img": "exp_potion.png",
    "rarity": 2,
    "usable": true,
    "effect": { "exp": 500 },
    "price": 200
  },
  {
    "id": "skill_book",
    "name": "Skill Book",
    "type": "upgrade",
    "description": "‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏™‡∏Å‡∏¥‡∏•‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ (‡∏™‡∏∏‡πà‡∏° 1 skill)",
    "img": "skill_book.png",
    "rarity": 3,
    "usable": true,
    "effect": { "skillup": 1 },
    "price": 900
  },
  {
    "id": "rune_shard",
    "name": "Rune Shard",
    "type": "rune_material",
    "description": "‡πÄ‡∏®‡∏©‡∏£‡∏π‡∏ô ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏ô",
    "img": "rune_shard.png",
    "rarity": 2,
    "usable": false,
    "price": 150
  },
  {
    "id": "heal_potion",
    "name": "Heal Potion",
    "type": "heal",
    "description": "‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°‡πÉ‡∏ä‡πâ‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π HP 50% ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡πÄ‡∏ï‡∏¥‡∏° Energy (+15)",
    "img": "heal_potion.png",
    "rarity": 2,
    "usable": true,
    "effect": { "hp_pct": 50, "energy": 15 },
    "price": 120
  }
]

‡πÑ‡∏ü‡∏•‡πå js/inventory.js
// js/inventory.js

let itemData = [];
let inventory = [];

/** ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°‡∏à‡∏≤‡∏Å data/item.json */
async function loadItemData() {
  if (itemData.length) return;
  itemData = await fetch('data/item.json').then(r => r.json());
}

/** ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô (‡∏à‡∏≤‡∏Å localStorage) */
function loadInventory() {
  let raw = localStorage.getItem('user_inventory');
  inventory = raw ? JSON.parse(raw) : [];
}

/** ‡πÄ‡∏ã‡∏ü inventory */
function saveInventory() {
  localStorage.setItem('user_inventory', JSON.stringify(inventory));
}

/** ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°‡πÉ‡∏ô data/item.json */
function findItemById(id) {
  return itemData.find(i => i.id === id);
}

/** render UI ‡∏Ñ‡∏•‡∏±‡∏á‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏° */
function renderInventoryUI() {
  let html = `
    <div style="display:flex;flex-direction:column;gap:7px;max-height:420px;overflow-y:auto;">
      ${inventory.length === 0 ? '<div style="color:#bbb;text-align:center;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°</div>' :
        inventory.map(item => {
          let info = findItemById(item.id) || {};
          return `
          <div style="display:flex;align-items:center;background:#272b38;padding:10px 16px;border-radius:10px;gap:19px;">
            <div style="width:36px;height:36px;border-radius:8px;background:#201624;display:flex;justify-content:center;align-items:center;">
              ${info.img ? `<img src="img/item/${info.img}" alt="${info.name}" style="width:32px;">` : "üéí"}
            </div>
            <div style="flex-grow:1;">
              <b>${info.name || item.id}</b>
              <div style="font-size:.91em;color:#84ccff;margin-top:2px;">${info.description || ''}</div>
            </div>
            <div style="color:#aaffbe;font-weight:bold;font-size:1.07em;">x${item.qty}</div>
            ${info.usable ? `<button class="primary-btn" style="padding:5px 1em 5px 1em;font-size:.96em;" onclick="useItemPrompt('${item.id}')">‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏¢</button>` : ""}
          </div>`;
        }).join('')}
    </div>
  `;
  document.getElementById('inventoryArea').innerHTML = html;
}

/** ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô popup ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏° */
window.useItemPrompt = function(itemId) {
  let info = findItemById(itemId);
  window.openPopup('useItem', `
    <div style="text-align:center;">
      <img src="img/item/${info.img}" style="width:52px;margin-bottom:8px;">
      <div style="font-size:1.09em;">${info.name}</div>
      <div style="margin:.6em 0 1.1em 0;font-size:.97em;color:#7cf;">${info.description}</div>
      <button class="primary-btn" style="margin:.8em .3em 0 .3em;padding:.5em 2.1em;" onclick="useItemNow('${itemId}')">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÉ‡∏ä‡πâ‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°</button>
      <button class="secondary-btn" style="margin:.8em .3em 0 .3em;" onclick="closePopup()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
  `, 'small', `‡πÉ‡∏ä‡πâ ${info.name}`);
}

/** ‡πÉ‡∏ä‡πâ‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡∏•‡∏î qty, ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å effect, update ui) */
window.useItemNow = function(itemId) {
  let idx = inventory.findIndex(i => i.id === itemId);
  let info = findItemById(itemId);
  if (idx === -1 || !info) return;
  if (inventory[idx].qty <= 0) return;
  // Effect (mock: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï character / heal / exp ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)
  if (info.effect && info.effect.exp) {
    // ‡πÄ‡∏û‡∏¥‡πà‡∏° exp ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡πÅ‡∏£‡∏Å‡πÉ‡∏ô team
    let t = JSON.parse(localStorage.getItem('userTeam') || "[]");
    if (t.length) {
      let cid = t[0];
      let cdata = JSON.parse(localStorage.getItem("char_" + cid) || '{}');
      if (cdata) {
        cdata.exp = (cdata.exp || 0) + info.effect.exp;
        localStorage.setItem("char_" + cid, JSON.stringify(cdata));
        alert(`‡πÄ‡∏û‡∏¥‡πà‡∏° EXP ‡πÉ‡∏´‡πâ ${cdata.name} +${info.effect.exp}`);
      }
    }
  }
  // Heal to selected: (Opt: implement in character select popup)
  // ‡πÄ‡∏û‡∏¥‡πà‡∏° energy bar (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Heal Potion) 
  if (info.effect && info.effect.energy) {
    let energy = Number(localStorage.getItem("user_energy") || 0);
    let maxEnergy = 45; // default, ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏¢‡∏á config/energy.js ‡πÑ‡∏î‡πâ
    let after = Math.min(maxEnergy, energy + info.effect.energy);
    localStorage.setItem("user_energy", after);
    alert(`‡πÄ‡∏ï‡∏¥‡∏° Energy +${after - energy}`);
    if (typeof renderEnergyBar === "function") renderEnergyBar();
  }
  inventory[idx].qty--;
  if (inventory[idx].qty === 0) inventory.splice(idx, 1);
  saveInventory();
  window.closePopup();
  renderInventoryUI();
}

/** ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°‡πÄ‡∏Ç‡πâ‡∏≤ inventory */
window.addToInventory = function(itemId, qty) {
  if (!itemId || !qty) return;
  let idx = inventory.findIndex(i => i.id === itemId);
  if (idx >= 0) inventory[idx].qty += qty;
  else inventory.push({ id: itemId, qty });
  saveInventory();
}

/** ‡∏•‡∏ö‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏° (admin, debug) */
window.removeFromInventory = function(itemId, qty) {
  let idx = inventory.findIndex(i => i.id === itemId);
  if (idx >= 0) {
    inventory[idx].qty -= qty;
    if (inventory[idx].qty <= 0) inventory.splice(idx, 1);
    saveInventory();
  }
}

// DOM integration, auto popup on menu
document.addEventListener('DOMContentLoaded', async () => {
  await loadItemData();
  loadInventory();
  // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° hook popup
  const showInvPopup = () => {
    window.openPopup('inventory', `
      <div id="inventoryArea"></div>
      <div style="text-align:right;"><button class="secondary-btn" onclick="closePopup()">‡∏õ‡∏¥‡∏î</button></div>
    `, 'large', "‡∏Ñ‡∏•‡∏±‡∏á‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°");
    renderInventoryUI();
  };
  let btn = document.getElementById('btnInventory');
  if (btn) btn.onclick = showInvPopup;

  window.renderInventoryUI = renderInventoryUI;
});

/** ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API ‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ */
window.inventoryEngine = {
  load: loadInventory,
  save: saveInventory,
  add: window.addToInventory,
  remove: window.removeFromInventory,
  list: () => inventory,
  findItemById,
  reloadAll: async () => { await loadItemData(); loadInventory(); },
}

‡πÑ‡∏ü‡∏•‡πå js/upgrade.js
// js/upgrade.js - Epic Seven Auto Battle - Upgrade System

let upgradeConfig = {};
let charUpgradeTarget = null;

function example() {
    let inventory = window.inventoryEngine.list();
}

/** Load upgrade config from /data/upgrade.json */
async function loadUpgradeConfig() {
  if (Object.keys(upgradeConfig).length) return;
  upgradeConfig = await fetch('data/upgrade.json').then(r => r.json());
}

/** Render Upgrade popup for a character */
async function openUpgradePopup(characterId) {
  await loadUpgradeConfig();
  await window.inventoryEngine.reloadAll();
  let char = JSON.parse(localStorage.getItem('char_' + characterId)
               || localStorage.getItem('char_' + characterId.replace('_', ''))
               || '{}');
  if (!char || !char.id) { alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏ô‡∏µ‡πâ"); return; }
  charUpgradeTarget = char;
  let html = `
    <div style="display:flex;flex-direction:column;align-items:center;gap:10px;">
      <img src="img/char/${char.img}" style="width:72px;border-radius:15px;box-shadow:0 0 22px #1defeb66;">
      <div style="font-size:1.18em;font-weight:bold;">${char.name}</div>
      <div>Lv. <b>${char.level}</b> <span style="color:#ffe480;">‚òÖ${char.star}</span>
          / <b>EXP</b> ${char.exp}/${char.exp_max || '?'}
      </div>
      <div style="color:#87c7ff;">HP <b>${char.hp}</b> | ATK <b>${char.atk}</b> | DEF <b>${char.def}</b> | SPD <b>${char.spd}</b></div>
      <hr style="width:88%; border:1px solid #234">
      <div style="display:flex;gap:12px;">
        <button class="primary-btn" onclick="doLevelUpChar('${char.id}')">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏•‡πÄ‡∏ß‡∏•</button>
        <button class="primary-btn" onclick="doSkillUpChar('${char.id}')">‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏™‡∏Å‡∏¥‡∏•</button>
        <button class="primary-btn" onclick="doPromoteChar('${char.id}')">‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡∏±‡πâ‡∏ô/‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏î‡∏≤‡∏ß</button>
      </div>
      <button class="secondary-btn" onclick="closePopup()">‡∏õ‡∏¥‡∏î</button>
    </div>
  `;
  window.openPopup('upgradePopup', html, 'large', '‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£');
}

/** Level Up (use exp_potion) */
window.doLevelUpChar = function (charId) {
  let char = JSON.parse(localStorage.getItem('char_' + charId));
  if (!char) return;
  let expItem = upgradeConfig.levelup.exp_item;
  let inv = window.inventoryEngine.list();
  let owned = inv.find(i => i.id === expItem);
  if (!owned || owned.qty <= 0) { alert("‡πÑ‡∏°‡πà‡∏°‡∏µ EXP Potion ‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á"); return; }
  let expAdd = 500;
  char.exp = (char.exp || 0) + expAdd;
  let lvled = false;
  while (char.exp >= (char.exp_max || 99999)) {
    char.exp -= char.exp_max;
    char.level = (char.level || 1) + 1;
    lvled = true;
  }
  if (lvled) alert("Level UP!");
  char.hp = Math.round(char.hp * 1.085);
  char.atk = Math.round(char.atk * 1.08);
  char.def = Math.round(char.def * 1.09);
  localStorage.setItem('char_' + char.id, JSON.stringify(char));
  window.inventoryEngine.remove(expItem, 1);
  openUpgradePopup(char.id);
};

/** Skill Up (use skill_book) */
window.doSkillUpChar = function (charId) {
  let char = JSON.parse(localStorage.getItem('char_' + charId));
  if (!char) return;
  let inv = window.inventoryEngine.list();
  let skillBookItem = upgradeConfig.skillup.item;
  let owned = inv.find(i => i.id === skillBookItem);
  if (!owned || owned.qty <= 0) { alert("‡πÑ‡∏°‡πà‡∏°‡∏µ Skill Book ‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á"); return; }
  let skills = char.skills || [];
  if (!skills.length) { alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏Å‡∏¥‡∏•‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î"); return; }
  let idx = Math.floor(Math.random() * skills.length);
  let sk = skills[idx];
  if (sk.multiplier) sk.multiplier = +(sk.multiplier + upgradeConfig.skillup.increase_percent/100).toFixed(2);
  if (sk.cooldown && sk.cooldown > 1) sk.cooldown = Math.max(1, sk.cooldown - 1);
  char.skills[idx] = sk;
  localStorage.setItem('char_' + char.id, JSON.stringify(char));
  window.inventoryEngine.remove(skillBookItem, 1);
  alert(`‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î Skill "${sk.name}" ‡πÉ‡∏´‡πâ‡πÅ‡∏£‡∏á‡∏Ç‡∏∂‡πâ‡∏ô!`);
  openUpgradePopup(char.id);
};

/** Promote: Increase Stars (use gold + material) */
window.doPromoteChar = function (charId) {
  let char = JSON.parse(localStorage.getItem('char_' + charId));
  if (!char) return;
  let starNext = (char.star || 1) + 1;
  let prom = upgradeConfig.promotion.requirements.find(r => r.star === char.star);
  if (!prom) { alert("‡∏î‡∏≤‡∏ß‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß"); return; }
  let inv = window.inventoryEngine.list();
  let gold = inv.find(i => i.id === 'gold');
  if (!gold || gold.qty < prom.cost_gold) { alert("Gold ‡πÑ‡∏°‡πà‡∏û‡∏≠"); return; }
  let enough = prom.materials.every(mat =>
    inv.find(i => i.id === mat.id && i.qty >= mat.qty));
  if (!enough) { alert("‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÑ‡∏°‡πà‡∏û‡∏≠"); return; }
  window.inventoryEngine.remove('gold', prom.cost_gold);
  prom.materials.forEach(mat => window.inventoryEngine.remove(mat.id, mat.qty));
  char.star = starNext;
  char.hp = Math.floor(char.hp * 1.20);
  char.atk = Math.floor(char.atk * 1.15);
  char.def = Math.floor(char.def * 1.12);
  localStorage.setItem('char_' + char.id, JSON.stringify(char));
  alert("‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏î‡∏≤‡∏ß‡πÉ‡∏´‡∏°‡πà: " + char.star);
  openUpgradePopup(char.id);
};

// ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Å‡∏±‡∏ö characterCollection
document.addEventListener('DOMContentLoaded', () => {
  window.upgradeCharPopup = openUpgradePopup;
  let area = document.getElementById('characterArea');
  if (area) area.addEventListener('click', e => {
    let target = e.target.closest('[data-upgrade]');
    if (target) openUpgradePopup(target.dataset.upgrade);
  });
});

// Expose
window.upgradeEngine = {
  open: openUpgradePopup,
  reloadConfig: loadUpgradeConfig
};

‡πÑ‡∏ü‡∏•‡πå data/upgrade.json
{
  "levelup": {
    "exp_required_base": 600,
    "exp_curve": 1.2,
    "exp_item": "exp_potion"
  },
  "promotion": {
    "star_max": 6,
    "requirements": [
      { "star": 3, "cost_gold": 1000, "materials": [ { "id": "rune_shard", "qty": 4 } ] },
      { "star": 4, "cost_gold": 4000, "materials": [ { "id": "rune_shard", "qty": 9 } ] },
      { "star": 5, "cost_gold": 9000, "materials": [ { "id": "rune_shard", "qty": 15 }, { "id": "heal_potion", "qty": 2 } ] }
    ]
  },
  "skillup": {
    "item": "skill_book",
    "increase_percent": 11,
    "max_lv": 6,
    "cost_gold": 700
  },
  "awaken": {
    "enabled": true,
    "require_materials": [
      { "star": 4, "materials": [ { "id": "rune_shard", "qty": 8 }, { "id": "heal_potion", "qty": 1 } ] },
      { "star": 5, "materials": [ { "id": "rune_shard", "qty": 14 }, { "id": "heal_potion", "qty": 2 } ] }
    ]
  }
}

‡πÑ‡∏ü‡∏•‡πå js/rune.js
// js/rune.js

let runeData = [];
let runeSetBonuses = {};
let userRunes = [];    // ‡∏ó‡∏∏‡∏Å‡∏£‡∏π‡∏ô‡∏Ç‡∏≠‡∏á user (id, unlock, slot)
let equippedRunes = {}; // { char_id: [slot1, slot2, slot3, slot4] }
let currentCharEquip = null;

// ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏π‡∏ô‡∏à‡∏≤‡∏Å data/rune.json
async function loadRuneData() {
  if (runeData.length) return;
  let arr = await fetch('data/rune.json').then(r => r.json());
  runeData = arr.filter(x => !x.set_bonuses);
  runeSetBonuses = arr.find(x => x.set_bonuses)?.set_bonuses || {};
}

// ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏ô‡∏Ç‡∏≠‡∏á user (‡∏à‡∏≤‡∏Å localStorage)
function loadUserRunes() {
  userRunes = JSON.parse(localStorage.getItem('user_runes') || "[]");
  equippedRunes = JSON.parse(localStorage.getItem('equipped_runes') || "{}");
}

// ‡πÄ‡∏ã‡∏ü‡∏£‡∏π‡∏ô‡∏Å‡∏•‡∏±‡∏ö localStorage
function saveUserRunes() {
  localStorage.setItem('user_runes', JSON.stringify(userRunes));
  localStorage.setItem('equipped_runes', JSON.stringify(equippedRunes));
}

// UI - render pop-up ‡∏™‡∏ß‡∏°‡πÉ‡∏™‡πà‡∏£‡∏π‡∏ô
async function openRuneEquipPopup(char_id) {
  await loadRuneData(); loadUserRunes();
  currentCharEquip = char_id;
  let charRunes = equippedRunes[char_id] || [null, null, null, null];
  let runeSlotHtml = '';
  for (let slot = 1; slot <= 4; slot++) {
    let runeId = charRunes[slot - 1];
    let ru = runeData.find(r => r.id === runeId);
    runeSlotHtml += `<div style="border:1px solid #348ac9;border-radius:10px;padding:8px 7px;min-width:96px;min-height:65px;margin:3px 0;">
      <b>‡∏ä‡πà‡∏≠‡∏á ${slot}:</b> ${ru ?
        `<span title="${ru.name}" style="font-size:1.2em;vertical-align:middle;">${ru.icon ?? 'üî∏'}</span> 
        <span style="color:#7df;font-weight:600;">${ru.name}</span>
        <button class="secondary-btn" style="font-size:.96em;padding:.1em .8em;margin-left:4px;" onclick="unequipRune(${slot})">‡∏ñ‡∏≠‡∏ô</button>
        <div style="font-size:0.88em;color:#acfc94;margin-top:4px;">${mainStatText(ru.main_stat)} ${ru.sub_stats.map(mainStatText).join(', ')}</div>`
        : `<span style="color:#888;">‡∏ß‡πà‡∏≤‡∏á</span>
          <button class="primary-btn" style="font-size:.9em;" onclick="showSelectRune(${slot})">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏ô</button>`
      }
      </div>`;
  }
  const setBuffHtml = renderSetBonus(charRunes);
  const html = `
    <div style="display:flex;flex-direction:column;gap:7px;">
      <h3>‡∏£‡∏π‡∏ô‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏ô‡∏µ‡πâ</h3>
      ${runeSlotHtml}
      ${setBuffHtml}
      <button class="secondary-btn" onclick="closePopup()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î</button>
    </div>`;
  window.openPopup('runeEquip', html, 'large', '‡∏™‡∏ß‡∏°‡πÉ‡∏™‡πà‡∏£‡∏π‡∏ô');
}

// Render set buff ‡∏£‡∏ß‡∏° (‡∏ñ‡πâ‡∏≤‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡∏£‡∏ö)
function renderSetBonus(runeIdArr) {
  let sets = {}, slots = {};
  runeIdArr.forEach(id => {
    let r = runeData.find(a => a.id === id);
    if (r) {
      sets[r.set] = (sets[r.set] || 0) + 1;
      slots[r.slot] = 1;
    }
  });
  let buffHtml = '';
  Object.keys(sets).forEach(set => {
    const cfg = runeSetBonuses[set];
    if (cfg && sets[set] >= cfg.slot_required) {
      buffHtml += `<div style="background:#22442b;margin:13px 0;padding:7px 9px;border-radius:7px;">
          <span style="font-size:1.16em;">${cfg.desc}</span> <b style="color:#66e0ca;">(‡∏Ñ‡∏£‡∏ö‡πÄ‡∏ã‡πá‡∏ï!)</b>
        </div>`;
    }
  });
  return buffHtml ? `<div style="margin-top:14px;">${buffHtml}</div>` : '';
}

// ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏ô
window.showSelectRune = function(slot) {
  let avai = userRunes.filter(r =>
    !Object.values(equippedRunes).flat().includes(r.rune_id) && runeData.find(x => x.id === r.rune_id)?.slot === slot);
  let html = avai.length
      ? avai.map(r => {
          let d = runeData.find(x => x.id === r.rune_id);
          return `<div style="display:flex;align-items:center;gap:9px;">
            <span style="font-size:1.3em;">${d.icon ?? 'üî∏'}</span>
            <b>${d.name}</b> <span style="font-size:0.93em;color:#d2ffee;">${mainStatText(d.main_stat)}</span>
            <button class="primary-btn" onclick="equipRuneSlot('${r.rune_id}',${slot})">‡πÉ‡∏™‡πà</button>
          </div>`;
        }).join('<hr style="margin:2px 0;">')
      : `<div style="color:#fda;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ</div>`;
  window.openPopup('selectRune', html, 'small', `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏ô ‡∏ä‡πà‡∏≠‡∏á ${slot}`);
};

// ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á stat
function mainStatText(stat) {
  if (!stat) return "";
  const lib = { spd: 'SPD', atk_pct: 'ATK%', def: 'DEF', def_pct: 'DEF%', crit_pct: 'CRIT%', effectiveness: 'EFF' };
  return (lib[stat.type] || stat.type) + " +" + stat.val;
}

// ‡πÉ‡∏™‡πà‡∏£‡∏π‡∏ô‡∏•‡∏á slot
window.equipRuneSlot = function(rune_id, slot) {
  let charRunes = equippedRunes[currentCharEquip] || [null,null,null,null];
  charRunes[slot - 1] = rune_id;
  equippedRunes[currentCharEquip] = charRunes;
  saveUserRunes();
  closePopup('selectRune');
  openRuneEquipPopup(currentCharEquip);
};

// ‡∏ñ‡∏≠‡∏ô‡∏£‡∏π‡∏ô
window.unequipRune = function(slot) {
  let charRunes = equippedRunes[currentCharEquip] || [null,null,null,null];
  charRunes[slot - 1] = null;
  equippedRunes[currentCharEquip] = charRunes;
  saveUserRunes();
  openRuneEquipPopup(currentCharEquip);
};

// ‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î‡∏£‡∏π‡∏ô (mock)
window.upgradeRune = function(rune_id) {
  alert("= Demo = ‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏±‡∏õ‡πÄ‡∏•‡πÄ‡∏ß‡∏•‡∏£‡∏π‡∏ô " + rune_id + " ‡πÅ‡∏•‡πâ‡∏ß (mock)");
};

window.runeEngine = {
  openEquipPopup: openRuneEquipPopup,
  getEquipped: function(char_id) { loadUserRunes(); return equippedRunes[char_id] || [null,null,null,null]; },
  getUserRunes: function() { loadUserRunes(); return userRunes; },
  addRune: function(rune_id) { userRunes.push({ rune_id }); saveUserRunes(); },
  removeRune: function(rune_id) { userRunes = userRunes.filter(r => r.rune_id !== rune_id); saveUserRunes(); }
};

// Hook DOM ‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ (‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏° "‡πÉ‡∏™‡πà‡∏£‡∏π‡∏ô" ‡πÑ‡∏î‡πâ)
document.addEventListener('DOMContentLoaded', async () => {
  await loadRuneData(); loadUserRunes();
  if (document.getElementById('characterArea')) {
    document.getElementById('characterArea').addEventListener('click', e => {
      const btn = e.target.closest('[data-equiprune]');
      if (btn) openRuneEquipPopup(btn.getAttribute('data-equiprune'));
    });
  }
});

‡πÑ‡∏ü‡∏•‡πå data/rune.json
[
  {
    "id": "spd_rare",
    "name": "Speed Rune",
    "slot": 2,
    "main_stat": { "type": "spd", "val": 25 },
    "sub_stats": [
      { "type": "atk_pct", "val": 7 },
      { "type": "def", "val": 16 }
    ],
    "set": "speed",
    "rarity": 4,
    "icon": "üí®"
  },
  {
    "id": "atk_pure",
    "name": "Attack Rune",
    "slot": 1,
    "main_stat": { "type": "atk_pct", "val": 15 },
    "sub_stats": [
      { "type": "spd", "val": 5 }
    ],
    "set": "rage",
    "rarity": 3,
    "icon": "‚öîÔ∏è"
  },
  {
    "id": "crit_big",
    "name": "Critical Rune",
    "slot": 4,
    "main_stat": { "type": "crit_pct", "val": 12 },
    "sub_stats": [
      { "type": "atk_pct", "val": 6 },
      { "type": "spd", "val": 7 },
      { "type": "effectiveness", "val": 4 }
    ],
    "set": "critical",
    "rarity": 5,
    "icon": "üéØ"
  },
  {
    "id": "def_basic",
    "name": "Defense Rune",
    "slot": 3,
    "main_stat": { "type": "def_pct", "val": 10 },
    "sub_stats": [],
    "set": "defend",
    "rarity": 2,
    "icon": "üõ°Ô∏è"
  },
  {
    "set_bonuses": {
      "speed":    { "slot_required": 2, "bonus": { "spd": 25 },        "desc": "Speed +25%"  },
      "rage":     { "slot_required": 4, "bonus": { "atk_pct": 35 },     "desc": "ATK +35%"    },
      "critical": { "slot_required": 2, "bonus": { "crit_pct": 12 },    "desc": "Crit +12%"   },
      "defend":   { "slot_required": 2, "bonus": { "def_pct": 15 },     "desc": "DEF +15%"    }
    }
  }
]

‡πÑ‡∏ü‡∏•‡πå js/gacha.js
// js/gacha.js - ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏ä‡∏≤ Epic Seven Clone Frontend

let gachaList = [];
let gachaUserLog = [];
let gachaPity = {}; // { gachaId: pityCount }

async function loadGachaData() {
    if (gachaList.length) return;
    const res = await fetch('data/gacha.json').then(r => r.json());
    gachaList = res.gachas;
}

function loadGachaUserLog() {
    gachaUserLog = JSON.parse(localStorage.getItem('gacha_user_log') || '[]');
    gachaPity = JSON.parse(localStorage.getItem('gacha_pity') || '{}');
}

function saveGachaLog() {
    localStorage.setItem('gacha_user_log', JSON.stringify(gachaUserLog));
    localStorage.setItem('gacha_pity', JSON.stringify(gachaPity));
}

async function openGachaPopup() {
    await loadGachaData(); loadGachaUserLog();
    let avai = gachaList.filter(g => g.enabled);
    if (!avai.length) {
        window.openPopup('gacha', `<div>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏≤‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div><button class="secondary-btn" onclick="closePopup()">‡∏õ‡∏¥‡∏î</button>`, 'large', '‡∏Å‡∏≤‡∏ä‡∏≤');
        return;
    }
    let html = avai.map(g => `
        <div style="background:#1b232e;padding:24px 1.5em;border-radius:18px;margin-bottom:24px;text-align:center;box-shadow:0 2px 18px #278ddf18;">
            <img src="img/gacha/${g.banner_img || 'noimg.png'}" style="width:100%;min-width:210px;max-width:330px;border-radius:9px;margin-bottom:7px;box-shadow:0 1px 40px #35cfff23;">
            <div style="font-size:1.14em;color:#7ffbfb;font-weight:600;margin-bottom:4px;">${g.name}</div>
            <div style="color:#aef;margin-bottom:1em;">${g.desc || ''}</div>
            <div style="font-size:.95em;margin-bottom:1em;"><b>‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢: </b>
                <span style="color:goldenrod;font-weight:bold;">${g.cost.amount}</span> 
                <img src="img/item/${g.cost.item}.png" style="width:19px;vertical-align:middle" />
            </div>
            <div>
                <button class="primary-btn" onclick="gachaSummon('${g.id}',1)">‡∏™‡∏∏‡πà‡∏° 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
                <button class="primary-btn" onclick="gachaSummon('${g.id}',10)">‡∏™‡∏∏‡πà‡∏° 10 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
            </div>
            <div style="margin-top:18px;font-size:.9em;">
                <a href="#" onclick="openGachaLogPopup('${g.id}');return false;" style="color:#85deff;text-decoration:underline;">‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡πà‡∏°</a>
                ${g.pity?.enabled ? `<span style="margin-left:2em;color:#ffa;">Pity: ${gachaPity[g.id]||0}/${g.pity.max}</span>` : ''}
            </div>
        </div>
    `).join('');
    window.openPopup('gacha', html, 'large', '‡∏Å‡∏≤‡∏ä‡∏≤');
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏∏‡πà‡∏° gacha
window.gachaSummon = async function(gachaId, times = 1) {
    await loadGachaData(); loadGachaUserLog();
    let g = gachaList.find(x => x.id === gachaId); if (!g) return;

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£
    let inv = window.inventoryEngine?.list() || [];
    let currency = inv?.find(i => i.id === g.cost.item);
    if (!currency || currency.qty < g.cost.amount * times) {
        alert(`‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ ${g.cost.item} ‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠`);
        return;
    }

    // ‡πÅ‡∏õ‡∏•‡∏á pool ‡πÉ‡∏´‡πâ‡∏™‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏°‡∏≠‡∏±‡∏ï‡∏£‡∏≤
    let poolFlat = [];
    g.pool.forEach(entry => {
        for (let i = 0; i < entry.rate; i++) poolFlat.push(entry.char_id);
    });

    let got = [], pityFlag = false;
    for (let t = 0; t < times; t++) {
        let pity = (g.pity?.enabled ? gachaPity[g.id] || 0 : 0);
        let pick;
        // pity trigger
        if (g.pity?.enabled && g.pity.max && pity+1 >= g.pity.max) {
            pick = g.pool.find(c => c.rarity === g.pity.guarantee_rarity)?.char_id || poolFlat[0];
            gachaPity[g.id] = 0;
            pityFlag = true;
        } else {
            pick = poolFlat[Math.floor(Math.random() * poolFlat.length)];
            let card = g.pool.find(c => c.char_id === pick);
            if (g.pity?.enabled) {
                if(card && card.rarity === g.pity.guarantee_rarity) gachaPity[g.id] = 0;
                else gachaPity[g.id] = (gachaPity[g.id] || 0) + 1;
            }
        }
        got.push(pick);
        window.collectCharacter?.(pick);
        window.addGachaLog?.({
            gacha_id: g.id,
            char_id: pick,
            rarity: g.pool.find(c => c.char_id === pick)?.rarity || 3
        });
    }
    window.inventoryEngine.remove(g.cost.item, g.cost.amount * times);
    saveGachaLog();
    openGachaResult(g, got, pityFlag);
};

// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤ collection (‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ)
window.collectCharacter = function(charId) {
    let chars = JSON.parse(localStorage.getItem('char_collection') || '[]');
    if(!chars.includes(charId)) chars.push(charId);
    localStorage.setItem('char_collection', JSON.stringify(chars));
}

// ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏ä‡∏≤
function openGachaResult(gacha, resultArr, pityFlag) {
    let html = `<div style="text-align:center;">
        <div style="font-size:1.7em;margin-bottom:6px;">üé¥ Gacha Result</div>
        <div style="color:#fcc;${pityFlag ? 'font-weight:bold;' : ''}">${pityFlag ? 'Pity Triggered! ‡∏Å‡∏≤‡∏£‡∏±‡∏ô‡∏ï‡∏µ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î!' : ''}</div>
        <div style="display:flex;justify-content:center;gap:13px;flex-wrap:wrap;margin-top:1em;">` +
        resultArr.map(cid => {
            let imgSrc = `img/char/${cid}.png`;
            return `<div style="background:#223352;border:2px solid #35aaffb7;border-radius:13px;padding:8px 12px;display:flex;flex-direction:column;align-items:center;min-width:93px;">
                <img src="${imgSrc}" style="width:58px;margin-bottom:8px;border-radius:10px;box-shadow:0 0 17px #27508080;" />
                <b style="color:#aef;">${cid}</b>
            </div>`;
        }).join('') +
        `</div>
        <div style="margin-top:18px;">
            <button class="primary-btn" onclick="closePopup();openGachaPopup();">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏ä‡∏≤</button>
        </div>
    </div>`;
    window.openPopup('gachaResult', html, 'large', '‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏ä‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
}

// ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏ä‡∏≤
window.openGachaLogPopup = function(gachaId) {
    loadGachaUserLog();
    let logs = gachaUserLog.filter(x => x.gacha_id === gachaId).slice(-30).reverse();
    let html = logs.length ? `<div style="max-height:300px;overflow-y:auto;"><table style="width:100%;">
        <tr style="color:#aae;"><th>#</th><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏ú‡∏•‡∏™‡∏∏‡πà‡∏°</th><th>Rarity</th></tr>
        ${logs.map((l,i) => `<tr>
            <td>${i+1}</td>
            <td>${(new Date(l.time)).toLocaleString()}</td>
            <td>${l.char}</td>
            <td><span style="color:${l.rarity>=5?'gold':'#fff'};">‚òÖ${l.rarity}</span></td>
        </tr>`).join('')}
        </table></div>` : `<div style="text-align:center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏ä‡∏≤</div>`;
    window.openPopup('gachaLog'+gachaId, html, 'large', "‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏ä‡∏≤");
}

// auto bind ‡∏õ‡∏∏‡πà‡∏°
document.addEventListener('DOMContentLoaded', () => {
    let btn = document.getElementById('btnGacha');
    if(btn) btn.onclick = openGachaPopup;
});

// ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö/‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
window.gachaEngine = {
    open: openGachaPopup,
    log: openGachaLogPopup,
    summon: window.gachaSummon
};

‡πÑ‡∏ü‡∏•‡πå data/gacha.json
{
    "gachas": [
        {
            "id": "premium_summon",
            "name": "Premium Gacha",
            "type": "normal",
            "enabled": true,
            "cost": {
                "item": "diamond",
                "amount": 50
            },
            "pool": [
                {
                    "char_id": "astra",
                    "rarity": 5,
                    "rate": 5
                },
                {
                    "char_id": "slime_basic",
                    "rarity": 3,
                    "rate": 95
                }
            ],
            "pity": {
                "enabled": true,
                "max": 20,
                "guarantee_rarity": 5
            },
            "banner_img": "gacha_premium.png",
            "desc": "‡∏™‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡∏π‡∏á\n‡∏¢‡∏¥‡πà‡∏á‡∏´‡∏°‡∏∏‡∏ô‡πÄ‡∏¢‡∏≠‡∏∞‡∏¢‡∏¥‡πà‡∏á‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÑ‡∏î‡πâ ‚òÖ5!"
        },
        {
            "id": "event_summon_may2024",
            "name": "May 2024 Event",
            "type": "event",
            "enabled": false,
            "cost": {
                "item": "ticket_event",
                "amount": 1
            },
            "pool": [
                {
                    "char_id": "astra",
                    "rarity": 5,
                    "rate": 10
                },
                {
                    "char_id": "slime_basic",
                    "rarity": 3,
                    "rate": 90
                }
            ],
            "pity": {
                "enabled": false
            },
            "banner_img": "gacha_event_may2024.png",
            "desc": "‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏¥‡∏à - ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡πã‡∏ß Event ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô"
        }
    ]
}

‡πÑ‡∏ü‡∏•‡πå js/quest.js
// js/quest.js

/**
 * ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Ñ‡∏ß‡∏™‡∏ï‡πå‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô / ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå / event, UI popup, ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° inventory/reward
 * ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà data/quest/<xxx>.json
 */

let questData = [];
let questProgress = {}; // ‡∏ï‡πà‡∏≠ user

async function loadQuests() {
  questData = [];
  // ‡∏™‡∏°‡∏°‡∏∏‡∏ï‡∏¥‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô/‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Å‡πà‡∏≠‡∏ô
  let daily = await fetch('data/quest/daily.json').then(r => r.json()).catch(() => []);
  let weekly = await fetch('data/quest/weekly.json').then(r => r.json()).catch(() => []);
  questData = [...(daily.quests || []), ...(weekly.quests || [])];
  loadQuestProgress();
}
function loadQuestProgress() {
  try {
    questProgress = JSON.parse(localStorage.getItem('quest_progress') || '{}');
  } catch { questProgress = {}; }
}
function saveQuestProgress() {
  localStorage.setItem('quest_progress', JSON.stringify(questProgress));
}

async function openQuestPopup() {
  await loadQuests();
  loadQuestProgress();
  let html = questData.length
    ? questData.map(q => renderQuestCard(q)).join('')
    : `<div style="text-align:center;color:#ddd">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏Ñ‡∏ß‡∏™‡∏ï‡πå‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</div>`;
  window.openPopup('quest', `<div>${html}</div>
    <div style="margin-top:16px;text-align:right;"><button class="secondary-btn" onclick="closePopup()">‡∏õ‡∏¥‡∏î</button></div>`, 'large', '‡πÄ‡∏Ñ‡∏ß‡∏™‡∏ï‡πå');
}
function renderQuestCard(q) {
  let prog = questProgress[q.id] || { cur: 0, claimed: false };
  let done = prog.cur >= (q.target || 1);
  return `<div style="background:#1f302a;border-radius:11px;margin:8px 0;padding:12px 13px;color:${done ? '#adeb98' : '#fff'}">
    <b>${q.name}</b><br>
    <div style="color:#bde8ff">${q.desc || ''}</div>
    <div style="margin:7px 0">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤: <b>${prog.cur || 0} / ${q.target || 1}</b> ${done ? '‚úÖ' : ''}</div>
    <div>‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•: ${q.reward.map(r => `<span>${r.type === "item" ? "üéÅ" : r.type === "character" ? "üé¥" : "‚≠ê"} ${window.inventoryEngine?.findItemById(r.id)?.name || r.id} x${r.qty}</span>`).join(' ')}</div>
    <button class="primary-btn" style="margin-top:8px" onclick="claimQuest('${q.id}')" ${!done || prog.claimed ? 'disabled' : ''}>‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•${prog.claimed ? '‡πÅ‡∏•‡πâ‡∏ß' : ''}</button>
  </div>`;
}
window.claimQuest = function (questId) {
  let q = questData.find(x => x.id === questId);
  if (!q) return;
  loadQuestProgress();
  let prog = questProgress[questId] || { cur: 0, claimed: false };
  if ((prog.cur || 0) >= q.target && !prog.claimed) {
    window.rewardEngine.give(q.reward);
    prog.claimed = true;
    questProgress[questId] = prog;
    saveQuestProgress();
    openQuestPopup();
  } else {
    alert("‡∏¢‡∏±‡∏á‡∏ó‡∏≥‡πÄ‡∏Ñ‡∏ß‡∏™‡∏ï‡πå‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö");
  }
}
// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤: ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏Å trigger
window.increaseQuestProgress = function (questId, amt = 1) {
  loadQuestProgress();
  let prog = questProgress[questId] || { cur: 0, claimed: false };
  prog.cur += amt;
  questProgress[questId] = prog;
  saveQuestProgress();
}

// Auto bind menu
document.addEventListener('DOMContentLoaded', () => {
  let btn = document.getElementById('btnQuest');
  if (btn) btn.onclick = openQuestPopup;
});
// export
window.questEngine = {
  open: openQuestPopup,
  reload: loadQuests,
  progress: questProgress,
  increment: window.increaseQuestProgress,
};

‡πÑ‡∏ü‡∏•‡πå data/quest/daily.json
{
  "quests": [
    {
      "id": "daily_login",
      "name": "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ",
      "desc": "‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏° 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á",
      "target": 1,
      "reward": [
        {"type": "item", "id": "exp_potion", "qty": 1}
      ]
    }
  ]
}

‡πÑ‡∏ü‡∏•‡πå data/quest/weekly.json
{
  "quests": [
    {
      "id": "weekly_gacha",
      "name": "‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏ä‡∏≤ 5 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á",
      "desc": "‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏ä‡∏≤‡∏Ñ‡∏£‡∏ö 5 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ",
      "target": 5,
      "reward": [
        {"type": "item", "id": "gold", "qty": 1000}
      ]
    }
  ]
}

‡πÑ‡∏ü‡∏•‡πå js/stage.js
// js/stage.js - EpicSeven Advance Stage System (Linear Unlock v2.1 / GPT-4 Enhanced)

// ---------------------------- CONFIG & STATE ----------------------------
let chapterData = [];
let stageProgress = {}; // { [stageId]: true }
let chapterFiles = [
    'data/stage/chapter1.json',
    'data/stage/chapter2.json',
    'data/stage/chapter3.json'
];

// ‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏∏‡∏Å Chapter ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö multi chapter)
async function loadChapters() {
    if (chapterData.length) return;
    chapterData = [];
    for (let fn of chapterFiles) {
        try {
            const ch = await fetch(fn).then(r => r.json());
            chapterData.push(ch);
        } catch (e) { /* ‡∏ñ‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ ‡∏à‡∏∞‡∏Ç‡πâ‡∏≤‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ */ }
    }
}

function loadStageProgress() {
    try {
        stageProgress = JSON.parse(localStorage.getItem('stage_progress') || '{}');
    } catch { stageProgress = {}; }
}

function saveStageProgress() {
    localStorage.setItem('stage_progress', JSON.stringify(stageProgress));
}

// --------------------- UNLOCK LOGIC WITH CROSS-ZONE + ‡∏ó‡∏µ‡∏°‡πÄ‡∏•‡πÄ‡∏ß‡∏• ------------------
function isStageUnlocked(chapterIdx, zoneIdx, stageIdx) {
    return true;
}

function isStageCleared(stageId) {
    return !!stageProgress[stageId];
}

// --------------------- STAGE MAP POPUP + ADVANCED RENDER ------------------
window.openStageMapPopup = async function () {
    await loadChapters();
    loadStageProgress();
    let html = '';
    chapterData.forEach((ch, chapterIdx) => {
        html += `<div style="margin-bottom:14px;">
            <h2 style="color:#6cfffa">${ch.name}</h2>
            <div style="color:#c8eee9">${ch.desc || ''}</div>
            ${ch.zones.map((zone, zoneIdx) => `
                <div style="margin:17px 0 7px 18px;">
                    <h3 style="color:#aff">${zone.name}</h3>
                    <div class="stage-list">
                    ${
                        zone.stages.map((stage, stageIdx) => {
                            let teamLvLocked = false;
                            if (stage.require_team_level) {
                                let team = [];
                                try { team = JSON.parse(localStorage.getItem('userTeam') || '[]'); } catch {}
                                let ok = team.some(cid => {
                                    try {
                                        let c = JSON.parse(localStorage.getItem('char_' + cid) || 'null');
                                        return c && c.level && c.level >= stage.require_team_level;
                                    } catch { return false; }
                                });
                                if (!ok) teamLvLocked = true;
                            }
                            let unlocked = isStageUnlocked(chapterIdx, zoneIdx, stageIdx);
                            let cleared = isStageCleared(stage.id);
                            return `<div style="margin:4px 0 7px 27px;
                                                padding:7px 13px;border-radius:11px;
                                                background:${cleared ? '#242c4a' : '#141d28ba'};
                                                display:flex;align-items:center;justify-content:space-between;">
                                    <div>
                                        <b>${stage.name}</b> <span style="color:#cde;">LV.${stage.recommended_level}</span>
                                        <div style="font-size:.96em;color:#afe;">${stage.desc || ''}</div>
                                        ${
                                            stage.require_team_level
                                            ? `<div style="font-size:.95em;color:#62f6e6;">üîì ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡πÉ‡∏ô‡∏ó‡∏µ‡∏° Lv.${stage.require_team_level} ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏•‡πà‡∏ô</div>`
                                            : ''
                                        }
                                    </div>
                                    <div>
                                    ${
                                        teamLvLocked
                                        ? `<span style="color:#fa8;font-size:.98em;">üîí ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÉ‡∏ô‡∏ó‡∏µ‡∏° Lv.${stage.require_team_level}+</span>`
                                        : (unlocked
                                            ? `<button class="primary-btn" style="padding:.5em 1.7em;" onclick="startStageBattle('${ch.id}','${zone.id}','${stage.id}')" ${cleared ? '' : ''}>
                                                    ${cleared ? '‡πÄ‡∏•‡πà‡∏ô‡∏ã‡πâ‡∏≥' : '‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏•‡πà‡∏ô'}
                                                </button>`
                                            : `<span style="color:#fa8;font-size:.98em;">üîí ‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ô‡∏î‡πà‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</span>`)
                                    }
                                    </div>
                                    ${cleared ? '<span style="color:#93d;font-size:.96em;margin-left:13px;">‚úî ‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>' : ''}
                                </div>`;
                        }).join('')
                    }
                    </div>
                </div>
            `).join('')}
        </div>`;
    });
    html += `<div style="text-align:right;margin-top:14px;">
        <button class="secondary-btn" onclick="closePopup()">‡∏õ‡∏¥‡∏î</button>
    </div>`;
    window.openPopup('stageMap', html, 'large', '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡πà‡∏≤‡∏ô');
};

// ------------------- START/END STAGE BATTLE HOOKS ----------------------
window.startStageBattle = async function (chapterId, zoneId, stageId) {
    await loadChapters();

    let chapter = chapterData.find(ch => ch.id === chapterId);
    if (!chapter) return;
    let zone = chapter.zones.find(z => z.id === zoneId);
    if (!zone) return;
    let stage = zone.stages.find(s => s.id === stageId);
    if (!stage) return;

    // Check energy
    let energy = Number(localStorage.getItem("user_energy") || 0);
    if (energy < stage.require_energy) {
        alert("Energy ‡πÑ‡∏°‡πà‡∏û‡∏≠!");
        return;
    }
    localStorage.setItem("user_energy", energy - stage.require_energy);
    if (typeof renderEnergyBar === "function") renderEnergyBar();

    // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° wave (‡πÅ‡∏Ñ‡πà wave[0] ‡πÄ‡∏™‡∏°‡∏≠‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö simple ‡∏ô‡∏µ‡πâ)
    let enemies = (stage.waves[0] && Array.isArray(stage.waves[0].enemies))
        ? stage.waves[0].enemies
        : [];

    // Save current stage context
    localStorage.setItem('current_stage_id', stage.id);
    localStorage.setItem('current_stage_zone', zone.id);
    localStorage.setItem('current_stage_chapter', chapter.id);
    closePopup();

    setTimeout(async () => {
        // Team user
        if (window.battleEngine && battleEngine.loadBattleTeams)
            await battleEngine.loadBattleTeams();

        // Monsters
        if (window.battleEngine && typeof battleEngine.monsters !== "undefined") {
            try {
                let arr = [];
                for (const enemy of enemies) {
                    let c = null;
                    // New: Try load meta from data/monster/{id}.json first
                    try {
                        c = await fetch(`data/monster/${enemy.id}.json`).then(r => r.json());
                    } catch {
                        // Fallback: support special boss or player-like monsters
                        try {
                            c = await fetch(`data/char/${enemy.id}.json`).then(r => r.json());
                        } catch (e) { c = null; }
                    }
                    if (!c) continue;
                    arr.push({
                        ...c,
                        id: enemy.id + "_" + ((Math.random() * 10000) | 0),
                        level: enemy.level || c.level || 1,
                        currHp: c.hp,
                        alive: true,
                        buffs: [],
                        debuffs: [],
                        cooldowns: Array((c.skills || []).length).fill(0),
                    });
                }
                battleEngine.monsters = arr;
            } catch {}
        }
        battleEngine?.initSpdBar?.();
        battleEngine?.renderBattlefield?.();
        document.getElementById('mainBattlefield')?.classList.remove('hide');
    }, 400);
};

// ------- ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏ö‡∏î‡πà‡∏≤‡∏ô (win) - ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏î‡πà‡∏≤‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡∏ó‡∏µ‡∏•‡∏∞‡∏î‡πà‡∏≤‡∏ô (linear) -----
window.hookStageBattleEnd = function(state) {
    let curStageId = localStorage.getItem('current_stage_id');
    if (state === 'win' && curStageId) {
        loadStageProgress();
        stageProgress[curStageId] = true;
        saveStageProgress();
    }
    setTimeout(() => { openStageMapPopup(); }, 900);
};

window.updateStageProgress = function(stageId) {
    loadStageProgress();
    stageProgress[stageId] = true;
    saveStageProgress();
};

// (Exports)
window.stageEngine = Object.assign(window.stageEngine || {}, {
    end: window.hookStageBattleEnd,
    update: window.updateStageProgress,
    reload: loadChapters,
});

‡πÑ‡∏ü‡∏•‡πå js/shop.js
// js/shop.js - UI Rewrite V2 (2024) - Epic Seven Clone Frontend Shop

let shopDataV2 = [];
let purchaseLog = {};
let shopFilter = { text: "", type: "all" };

// ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
async function loadShopDataV2() {
  if (shopDataV2.length) return;
  try {
    const raw = await fetch('data/shop.json').then(r => r.json());
    shopDataV2 = Array.isArray(raw.shops) ? raw.shops : [];
  } catch { shopDataV2 = []; }
}

// ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠
function loadShopLog() {
  try {
    purchaseLog = JSON.parse(localStorage.getItem('shop_purchase_log') || '{}');
  } catch { purchaseLog = {}; }
}

// ‡πÄ‡∏ã‡∏ü‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠
function saveShopLog() {
  localStorage.setItem('shop_purchase_log', JSON.stringify(purchaseLog));
}

// =================== UI SHOP MAIN POPUP ====================

async function openShopCenter(shopId = "main") {
  await loadShopDataV2();
  loadShopLog();
  await window.inventoryEngine?.reloadAll?.();

  let shop = shopDataV2.find(s => s.id === shopId && s.enabled);
  if (!shop) {
    window.openPopup('shop', `<div>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà</div><button class="secondary-btn" onclick="closePopup()">‡∏õ‡∏¥‡∏î</button>`, 'large', '‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤');
    return;
  }

  // Filter, search
  const types = Array.from(new Set(shop.items.map(i => i.type || ""))).filter(x=>!!x);
  let typeSel = `<option value="all">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>` +
      types.map(tp=>`<option value="${tp}">${tp}</option>`).join('');
  let filterHtml = `
    <div style="display:flex;gap:10px 21px;flex-wrap:wrap;margin-bottom:14px;">
      <input type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°..." style="flex:2;min-width:170px" id="shopSearchBox" value="${shopFilter.text||""}"/>
      <select id="shopTypeFilter" style="flex:1;min-width:120px">${typeSel}</select>
      <button class="secondary-btn" onclick="resetShopFilter()" style="min-width:62px">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
    </div>
  `;

  // Filter items
  let items = shop.items.filter(x=>x.enabled);
  if (shopFilter.text) {
    items = items.filter(i=>{
      let info = window.inventoryEngine.findItemById(i.item_id) || {};
      return (info.name||i.item_id||"").toLowerCase().includes(shopFilter.text.toLowerCase());
    });
  }
  if (shopFilter.type && shopFilter.type !== "all") {
    items = items.filter(i => (i.type||"") === shopFilter.type);
  }
  // Sort by: rare first, price, name
  items = items.slice().sort((a, b)=>{
    let ait = window.inventoryEngine.findItemById(a.item_id) || {};
    let bit = window.inventoryEngine.findItemById(b.item_id) || {};
    return (bit.rarity||0)-(ait.rarity||0) || (a.price_amount||0)-(b.price_amount||0) || ((ait.name||a.item_id||"")+(bit.name||b.item_id||""));
  });

  let itemHtml = items.length
    ? items.map(item => renderShopCard(shop, item)).join("")
    : `<div style="color:#eee;text-align:center;padding:1.7em 0">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</div>`;
  
  let mainHtml = `
    ${filterHtml}
    <div style="display: grid;grid-template-columns: repeat(auto-fit,minmax(210px,1fr));gap:18px;" id="shopGridArea">
    ${itemHtml}
    </div>
    <div style="margin-top:17px;text-align:right">
      <button class="secondary-btn" onclick="closePopup()">‡∏õ‡∏¥‡∏î</button>
    </div>
  `;
  window.openPopup('shop', mainHtml, 'large', shop.name);

  setTimeout(()=>{
    document.getElementById('shopSearchBox').oninput = ev=>{
      shopFilter.text = ev.target.value; openShopCenter(shopId);
    };
    document.getElementById('shopTypeFilter').value = shopFilter.type||"all";
    document.getElementById('shopTypeFilter').onchange = ev=>{
      shopFilter.type = ev.target.value; openShopCenter(shopId);
    };
  }, 100);
}
window.openShopCenter = openShopCenter;

// Shop Card - 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
function renderShopCard(shop, item) {
  let invList = window.inventoryEngine?.list() || [];
  let itemMeta = window.inventoryEngine.findItemById(item.item_id) || {};
  let haveQty = invList.find(i=>i.id===item.item_id)?.qty || 0;
  let priceQty = invList.find(i=>i.id===item.price_item)?.qty || 0;

  let buyKey = `${shop.id}_${item.id}_${todayKey()}`;
  let bought = purchaseLog[buyKey] || 0;
  // ‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î?
  let leftDaily  = item.daily_limit ? (item.daily_limit-bought) : "‚àû";
  let maxBuyOK = ((!item.daily_limit)||bought<item.daily_limit) && ((!item.can_buy)||bought<item.can_buy);
  let enoughtCash = priceQty >= (item.price_amount||0);
  let canBuy = maxBuyOK && enoughtCash;

  let badge = "";
  if(itemMeta.rarity>=4) badge = `<div style="position:absolute;top:8px;right:13px;color:gold;padding:.1em .8em;background:#3334">‚òÖ${itemMeta.rarity}</div>`;
  if(haveQty>0) badge += `<div style="position:absolute;bottom:9px;left:13px;background:#71fa9c;color:#202;padding:.09em .7em;font-size:.92em">‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà: ${haveQty}</div>`;

  let outStock = !canBuy;
  let img = itemMeta.img || "noimg.png";

  return `
    <div class="shop-card" style="position:relative;border:2px solid #286af677;border-radius:15px;background:#20253799;padding:14px 11px;margin-bottom:6px;min-height:181px;box-shadow:${outStock ? "0 2px 19px #f2242320":"0 2px 13px #1acf8327"};overflow:hidden;">
      ${badge}
      <div style="text-align:center;"><img src="img/item/${img}" style="width:38px;height:38px" alt="${itemMeta.name||item.item_id}"/></div>
      <div style="font-weight:700;font-size:1.1em;text-align:center;margin:.5em 0 .13em 0;">${itemMeta.name||item.item_id}</div>
      <div style="color:#ade;font-size:.94em;margin-bottom:2px;text-align:center;">${item.desc||itemMeta.description||''}</div>
      <div style="text-align:center;color:#ffd25c;font-size:.95em">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: <b>${item.amount}</b></div>
      <div style="text-align:center;margin-top:.3em;">
        <span style="color:gold;font-size:1.13em;font-weight:bold;">${item.price_amount}</span>
        <img src="img/item/${item.price_item}.png" style="width:16px;vertical-align:middle" />
        <span style="color:#aef;font-size:.97em;">(‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${priceQty})</span>
      </div>
      <div style="margin:.37em 0 .17em 0;text-align:center;">
        ${item.daily_limit ? `<span style="color:#b4f6b3;font-size:.95em;">‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: ${leftDaily}</span>` : ""}
      </div>
      <button class="primary-btn" style="width:100%;padding:.55em 0;font-size:1em;" onclick="promptBuyShopItem('${shop.id}','${item.id}')" ${!canBuy?"disabled":""}>${canBuy?"‡∏ã‡∏∑‡πâ‡∏≠":"‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ"}</button>
    </div>
  `;
}

// Buy: ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
window.promptBuyShopItem = function(shopId, itemId) {
  let shop = shopDataV2.find(s=>s.id==shopId);
  let item = shop?.items.find(i=>i.id==itemId);
  if(!shop||!item) return;
  let itemMeta = window.inventoryEngine.findItemById(item.item_id) || {};

  let invList = window.inventoryEngine?.list() || [];
  let priceQty = invList.find(i=>i.id===item.price_item)?.qty || 0;
  let haveQty = invList.find(i=>i.id===item.item_id)?.qty || 0;

  let buyKey = `${shop.id}_${item.id}_${todayKey()}`;
  let bought = purchaseLog[buyKey] || 0;
  let canBuy = ((item.daily_limit ? bought<item.daily_limit:true) && (item.can_buy?bought<item.can_buy:true) && priceQty >= (item.price_amount||0));
  if(!canBuy) return alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ");

  window.openPopup("shopConfirm", `
    <div style="text-align:center;">
      <img src="img/item/${itemMeta.img||'noimg.png'}" style="width:47px;margin-bottom:8px;" /><br>
      <div style="font-size:1.11em;font-weight:700">${itemMeta.name||item.item_id}</div>
      <div style="margin-bottom:6px;color:#fcf090">${item.desc||itemMeta.description||""}</div>
      <div>‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ <b style="color:gold">${item.price_amount}</b> <img src="img/item/${item.price_item}.png" style="width:16px;vertical-align:middle"/> ‡∏ã‡∏∑‡πâ‡∏≠ <b>${itemMeta.name} x${item.amount}</b> ?</div>
      <hr style="margin:11px 0;">
      <button class="primary-btn" onclick="doBuyShopAction('${shop.id}','${item.id}')" style="padding:.5em 2.1em;">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ã‡∏∑‡πâ‡∏≠</button>
      <button class="secondary-btn" style="margin-left:1.1em;" onclick="closePopup()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
  `, 'small', '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠');
}

// Buy Action
window.doBuyShopAction = function(shopId,itemId) {
  let shop = shopDataV2.find(s=>s.id==shopId);
  let item = shop?.items.find(i=>i.id==itemId);
  if(!shop||!item) return;
  let buyKey = `${shop.id}_${item.id}_${todayKey()}`;
  let bought = purchaseLog[buyKey]||0;

  let invList = window.inventoryEngine?.list() || [];
  let priceQty = invList.find(i=>i.id===item.price_item)?.qty || 0;
  // Double check
  if(item.daily_limit && bought>=item.daily_limit) return alert("‡∏Ñ‡∏£‡∏ö‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß");
  if(item.can_buy && bought>=item.can_buy) return alert("‡∏Ñ‡∏£‡∏ö‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡πâ‡∏ß");
  if(priceQty<item.price_amount) return alert("‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡πÑ‡∏°‡πà‡∏û‡∏≠");

  // ‡∏•‡∏ö‡πÄ‡∏á‡∏¥‡∏ô, ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏≠‡∏á
  window.inventoryEngine.remove(item.price_item, item.price_amount);
  window.inventoryEngine.add(item.item_id, item.amount);
  purchaseLog[buyKey] = bought+1;
  saveShopLog();
  closePopup('shopConfirm');

  window.openPopup("shopResult", `
    <div style="color:#19e6b4;font-weight:bold;text-align:center;font-size:1.1em">
      ‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!<br>
      ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö ${window.inventoryEngine.findItemById(item.item_id)?.name||item.item_id} x${item.amount}
    </div>
    <div style="margin:1.5em auto 0 auto;text-align:center;">
      <button class="primary-btn" onclick="closePopup();openShopCenter('${shopId}')">‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</button>
    </div>
  `, "small", "‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
}

function resetShopFilter() {
  shopFilter = { text:"", type:"all" }; openShopCenter();
}

function todayKey() {
  let d = new Date();
  return d.getFullYear()+("0"+(d.getMonth()+1)).slice(-2)+("0"+d.getDate()).slice(-2);
}

// =========== MENU BIND ===============
document.addEventListener('DOMContentLoaded', () => {
  let btn = document.getElementById('btnShop');
  if(btn) btn.onclick = ()=>openShopCenter();
});

// Export API
window.shopEngine = {
  open: openShopCenter,
  reload: loadShopDataV2
};

‡πÑ‡∏ü‡∏•‡πå data/shop.json
{
  "shops": [
    {
      "id": "main",
      "name": "‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å",
      "type": "main",
      "enabled": true,
      "desc": "‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°, ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö, ‡πÅ‡∏•‡∏∞‡∏Ç‡∏≠‡∏á‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô",
      "refresh_type": "none",    
      "refresh_cycle_minutes": 0,
      "items": [
        {
          "id": "gold_5000",
          "item_id": "gold",
          "amount": 5000,
          "price_item": "diamond",
          "price_amount": 10,
          "desc": "‡∏£‡∏±‡∏ö 5,000 Gold ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ",
          "can_buy": 999,
          "daily_limit": 3,
          "enabled": true
        },
        {
          "id": "exp_potion_1",
          "item_id": "exp_potion",
          "amount": 1,
          "price_item": "gold",
          "price_amount": 110,
          "desc": "EXP Potion x1 ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏•‡πÄ‡∏ß‡∏•‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£",
          "can_buy": 99,
          "daily_limit": 5,
          "enabled": true
        },
        {
          "id": "rune_shard_1",
          "item_id": "rune_shard",
          "amount": 1,
          "price_item": "gold",
          "price_amount": 200,
          "desc": "Rune Shard ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏ô",
          "can_buy": 50,
          "daily_limit": 0,
          "enabled": true
        }
      ]
    },
    {
      "id": "event",
      "name": "Event Shop",
      "type": "event",
      "enabled": false,
      "desc": "‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ä‡πà‡∏ß‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°",
      "refresh_type": "none",
      "items": []
    },
    {
      "id": "secret",
      "name": "Secret Shop",
      "type": "secret",
      "enabled": false,
      "desc": "‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å 30 ‡∏ô‡∏≤‡∏ó‡∏µ",
      "refresh_type": "time",
      "refresh_cycle_minutes": 30,
      "items": []
    }
  ]
}

‡πÑ‡∏ü‡∏•‡πå js/announcement.js
/* Epic Seven Card Auto Battle - Animation Engine */
/* ‡∏ß‡∏≤‡∏á‡πÉ‡∏ô /js/animationEngine.js */

window.animationEngine = (function () {
    /** Card slide animation to attack */
    async function animateAttackCard(fromIdx, toIdx, fromSide, toSide, type = 'single') {
        const fromCard = document.getElementById(`${fromSide}${fromIdx}`);
        const toCard = document.getElementById(`${toSide}${toIdx}`);
        if (!fromCard || !toCard) return;
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á overlay
        const rectFrom = fromCard.getBoundingClientRect();
        const rectTo = toCard.getBoundingClientRect();
        // Absolute overlay clone
        const clone = fromCard.cloneNode(true);
        clone.style.position = "fixed";
        clone.style.left = rectFrom.left + 'px';
        clone.style.top = rectFrom.top + 'px';
        clone.style.width = rectFrom.width + 'px';
        clone.style.zIndex = "2000";
        clone.style.transition = 'all 0.35s cubic-bezier(.6,0,.2,1.4)';
        // Hide original
        fromCard.style.opacity = "0.4";
        document.body.appendChild(clone);
        await sleep(30);

        // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÑ‡∏õ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢
        clone.style.left = rectTo.left + 'px';
        clone.style.top = rectTo.top + 'px';
        clone.style.boxShadow = "0 0 32px #e7ff79c8, 0 0 80px #e3e37044";
        clone.style.transform = "scale(1.10) rotate(-3deg)";
        await sleep(330);

        // Flash/Shake ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢
        shakeCard(toCard);
        // Remove overlay
        setTimeout(() => {
            clone.remove();
            fromCard.style.opacity = "1";
        }, 110);

        await sleep(180);
    }

    /** AoE Animation (wave blast) */
    async function animateAoEAttack(fromIdx, fromSide, toSide, targets) {
        const fromCard = document.getElementById(`${fromSide}${fromIdx}`);
        if (!fromCard) return;
        // Pulse the card
        pulseCard(fromCard, "#f2d13e");
        // Wave line to center
        targets.forEach((t) => {
            const tgt = document.getElementById(`${toSide}${t}`);
            if (tgt) {
                flashCard(tgt, "#ffd058");
                shakeCard(tgt);
            }
        });
        await sleep(340);
    }

    /** Heal effect (green glow, upward effect) */
    async function animateHeal(toIdx, toSide) {
        const tgt = document.getElementById(`${toSide}${toIdx}`);
        if (!tgt) return;
        glowCard(tgt, "#68eccc");
        // Heal "plus" popup up
        let plus = document.createElement('span');
        plus.textContent = "+HP";
        plus.style = "color:#68fdd8;font-weight:bold;font-size:1.18em;position:absolute;left:42%;top:17%;opacity:0;transition:top .4s,opacity .2s;";
        tgt.appendChild(plus);
        setTimeout(() => {
            plus.style.top = "-6%";
            plus.style.opacity = "1";
        }, 20);
        setTimeout(() => plus.remove(), 650);
        await sleep(390);
    }

    /** Buff/Debuff effect on card */
    async function animateBuffDebuff(toIdx, toSide, type = "buff") {
        const tgt = document.getElementById(`${toSide}${toIdx}`);
        if (!tgt) return;
        glowCard(tgt, type === "buff" ? "#98deff" : "#ff7b7b");
        await sleep(260);
    }

    // --- Utilities (Shake, Glow, Flash, Pulse) ---
    function shakeCard(card) {
        if (!card) return;
        card.animate([
            { transform: "translateX(0)" },
            { transform: "translateX(-12px)" },
            { transform: "translateX(13px)" },
            { transform: "translateX(-7px)" },
            { transform: "translateX(0)" }
        ], { duration: 320, easing: "ease-in" });
    }
    function glowCard(card, color) {
        if (!card) return;
        card.style.boxShadow = `0 0 15px 6px ${color}66`;
        setTimeout(() => (card.style.boxShadow = ""), 380);
    }
    function flashCard(card, color = "#fff") {
        if (!card) return;
        card.style.background = color;
        setTimeout(() => (card.style.background = ""), 170);
    }
    function pulseCard(card, color) {
        if (!card) return;
        card.animate([
            { boxShadow: `0 0 0px 0px ${color}40` },
            { boxShadow: `0 0 15px 8px ${color}bb` },
            { boxShadow: `0 0 0px 0px ${color}00` }
        ], { duration: 410 });
    }
    function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

    // --- Expose ---

    return {
        animateAttackCard,
        animateAoEAttack,
        animateHeal,
        animateBuffDebuff,
        shakeCard,
        glowCard,
        flashCard,
        pulseCard,
        sleep
    };
})();

‡πÑ‡∏ü‡∏•‡πå data/announcement.json
{
  "announcements": [
    {
      "id": "patch_20240601",
      "type": "patch",
      "title": "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô 1.0",
      "content": "*‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö auto battle* ‡πÇ‡∏´‡∏°‡∏î‡πÉ‡∏´‡∏°‡πà: SPD BAR\nAnimation Slide ‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÇ‡∏à‡∏°‡∏ï‡∏µ‡πÅ‡∏ö‡∏ö Yu-Gi-Oh!\n\n- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏±‡∏ö EXP\n- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏ä‡∏≤‡πÅ‡∏•‡∏∞‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤",
      "start_time": 1717200000000,
      "end_time": null,
      "show_time": 1717239842000,
      "pin": true,
      "force_popup": true,
      "enabled": true
    },
    {
      "id": "reward_june2024",
      "type": "reward",
      "title": "‡πÅ‡∏à‡∏Å‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°‡∏ü‡∏£‡∏µ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô",
      "content": "‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç‡πÄ‡∏û‡∏ä‡∏£ 500\n‡πÅ‡∏•‡∏∞ EXP Potion x2 ‡∏ü‡∏£‡∏µ‡πÑ‡∏õ‡πÄ‡∏•‡∏¢!\n\n*‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ 1-7 ‡∏°‡∏¥.‡∏¢. 2024*",
      "start_time": 1717214400000,
      "end_time": 1717791999000,
      "show_time": 1717214500000,
      "pin": false,
      "enabled": true
    },
    {
      "id": "event_runeweek",
      "type": "event",
      "title": "‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° Rune Week",
      "content": "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô ‡∏£‡∏±‡∏ö Rune Shard x2\n‡πÅ‡∏•‡∏∞‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏ä‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏° 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô!",
      "start_time": 1717300800000,
      "end_time": 1717895999000,
      "show_time": 1717387200000,
      "pin": false,
      "enabled": true
    },
    {
      "id": "shop_promotion",
      "type": "shop",
      "title": "‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô",
      "content": "‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°‡∏•‡∏î‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 30% ‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å\n*‡πÄ‡∏â‡∏û‡∏≤‡∏∞ 1-5 ‡∏°‡∏¥.‡∏¢. 2024*",
      "start_time": 1717214400000,
      "end_time": 1717559999000,
      "show_time": 1717214600000,
      "pin": false,
      "link_url": "",
      "enabled": true
    },
    {
      "id": "system_maintenance",
      "type": "system",
      "title": "‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå",
      "content": "‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 4 ‡∏°‡∏¥.‡∏¢. 2024 ‡πÄ‡∏ß‡∏•‡∏≤ 00:00-03:00 ‡∏ô.\n*‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ logout ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ*",
      "start_time": 1717430400000,
      "end_time": 1717441200000,
      "show_time": 1717430500000,
      "pin": false,
      "enabled": true
    }
  ]
}

‡πÑ‡∏ü‡∏•‡πå js/redeem.js
// js/redeem.js
let redeemCodeList = [];
let userUsedRedeem = []; // [{code_id:..., redeemed_time:...}]
async function loadRedeemCodeList() {
  if (redeemCodeList.length) return;
  try {
    redeemCodeList = (await fetch('data/redeem.json').then(r=>r.json()))?.codes || [];
  } catch { redeemCodeList = []; }
  loadUserRedeemUsed();
}
function loadUserRedeemUsed() {
  userUsedRedeem = JSON.parse(localStorage.getItem('user_used_redeem') || '[]');
}
function saveUserRedeemUsed() {
  localStorage.setItem('user_used_redeem', JSON.stringify(userUsedRedeem));
}
// ‡∏õ‡πä‡∏≠‡∏õ‡∏≠‡∏±‡∏õ "‡∏Å‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•"
window.openRedeemPopup = function () {
  const html = `
    <div style="text-align:center;">
      <div style="font-size:1.16em;font-weight:600;margin-bottom:.88em;">üéÅ ‡∏Å‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</div>
      <input id="redeemInputBox" placeholder="‡πÉ‡∏™‡πà‡πÇ‡∏Ñ‡πâ‡∏î (A-Z, 0-9)" style="width: 90%;" maxlength="32"/>
      <div style="margin:1.3em 0;"><button class="primary-btn" onclick="checkRedeemCode()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•</button></div>
      <div id="redeemResultHint" style="color:#ffc29a;font-size:.94em;margin-top:1em;"></div>
      <div style="color:#aee;margin-top:1.7em;font-size:.89em;">
        *‡πÇ‡∏Ñ‡πâ‡∏î 1 ‡∏Ñ‡∏ô‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á, ‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏, ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
      </div>
      <button class="secondary-btn" style="margin-top:2.2em;" onclick="closePopup()">‡∏õ‡∏¥‡∏î</button>
    </div>
  `;
  window.openPopup('redeem', html, 'small', '‡∏Å‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î');
  setTimeout(() => document.getElementById('redeemInputBox')?.focus(), 100);
};
// validate and ‡πÉ‡∏´‡πâ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•
window.checkRedeemCode = async function () {
  await loadRedeemCodeList();
  const box = document.getElementById('redeemInputBox');
  if (!box) return;
  let code = box.value.trim().toUpperCase();
  let hintEl = document.getElementById('redeemResultHint');
  hintEl.innerText = "";
  if (!code.match(/^[A-Z0-9\-\_]+$/)) return hintEl.innerText = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (A-Z, 0-9)";
  let redeem = redeemCodeList.find(c => c.id === code && c.enabled !== false);
  const now = Date.now();
  if (!redeem)
    return hintEl.innerText = "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏Ñ‡πâ‡∏î‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î/‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß";
  if (redeem.start_time && now < redeem.start_time)
    return hintEl.innerText = "‚ùå ‡πÇ‡∏Ñ‡πâ‡∏î‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ";
  if (redeem.end_time && now > redeem.end_time)
    return hintEl.innerText = "‚ùå ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß";
  if (redeem.max_usage && redeem.used_count >= redeem.max_usage)
        return hintEl.innerText = "‚ùå ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡πâ‡∏ß";
  // per user
  loadUserRedeemUsed();
  if (userUsedRedeem.some(u => u.code_id === code)) {
    return hintEl.innerText = "‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á";
  }
  // ‡∏ï‡∏£‡∏ß‡∏à‡πÑ‡∏≠‡∏î‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô (‡∏Ñ‡∏ß‡∏£‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô, ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡πá‡∏à‡∏≥‡∏•‡∏≠‡∏á)
  let curUserId = localStorage.getItem('user_id') || 'guest';
  // ‡πÉ‡∏´‡πâ‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤ inventory/character)
  const rewardHtml = [];
  if (redeem.reward && Array.isArray(redeem.reward)) {
    for (let r of redeem.reward) {
      if (r.type === 'item') {
        window.addToInventory?.(r.id, r.qty || 1);
        rewardHtml.push(`<div>üéÅ ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö <b>${window.inventoryEngine?.findItemById(r.id)?.name || r.id} x${r.qty}</b></div>`);
      } else if (r.type === 'character') {
        window.collectCharacter?.(r.id);
        rewardHtml.push(`<div>üé¥ ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ <b style="color:#84bcff;">${r.id}</b></div>`);
      }
    }
  }
  // ‡πÄ‡∏ã‡∏ü userUsedRedeem
  userUsedRedeem.push({ code_id: code, time: now, user: curUserId });
  saveUserRedeemUsed();
  // (‡∏ù‡∏±‡πà‡∏á admin/‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏° used_count ‡πÄ‡∏≠‡∏á‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå json)
  // ‡πÅ‡∏™‡∏î‡∏á popup ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
  window.openPopup('redeemSuccess', `
    <div style="text-align:center;">
      <div style="font-size:1.15em;font-weight:700;color:#56f7ca;margin-bottom:9px;">‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</div>
      ${rewardHtml.join('')}
      <button class="primary-btn" style="margin-top:1.2em;" onclick="closePopup();">‡πÇ‡∏≠‡πÄ‡∏Ñ</button>
    </div>
  `, 'small', '‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•');
};

// Auto bind ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π (ID: btnRedeem)
document.addEventListener('DOMContentLoaded', () => {
  let btn = document.getElementById('btnRedeem');
  if (btn) btn.onclick = window.openRedeemPopup;
});

// Expose export
window.redeemEngine = {
  open: window.openRedeemPopup,
  check: window.checkRedeemCode,
  reload: async () => { redeemCodeList = []; await loadRedeemCodeList(); }
};

‡πÑ‡∏ü‡∏•‡πå data/redeem.json
{
  "codes": [
    {
      "id": "WELCOME2024",           
      "reward": [                    
        { "type": "item", "id": "diamond", "qty": 500 },
        { "type": "item", "id": "exp_potion", "qty": 2 }
      ],
      "desc": "‡∏£‡∏±‡∏ö‡∏ü‡∏£‡∏µ‡πÄ‡∏û‡∏ä‡∏£ 500 + EXP Potion x2 (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà)",
      "start_time": 1717200000000,  
      "end_time": 1767167999000,    
      "max_usage": 10000,           
      "used_count": 0,              
      "per_user": 1,                
      "enabled": true
    },
    {
      "id": "JUNE_EVENT01",
      "reward": [
        { "type": "item", "id": "rune_shard", "qty": 6 }
      ],
      "desc": "‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° Rune June ‡∏£‡∏±‡∏ö Rune Shard x6",
      "start_time": 1717214400000,  
      "end_time": 1717791999000,    
      "max_usage": 500,
      "used_count": 49,
      "per_user": 1,
      "enabled": true
    },
    {
      "id": "INDIV_CODE_DEMO_123X",
      "reward": [
        { "type": "character", "id": "astra", "qty": 1 }
      ],
      "desc": "‡πÅ‡∏à‡∏Å Astra 5‚òÖ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° DEVS",
      "start_time": 1717200000000,
      "end_time": 1720000000000,
      "max_usage": 1,
      "used_count": 0,
      "per_user": 1,
      "enabled": true
    }
  ]
}

‡πÑ‡∏ü‡∏•‡πå js/auth.js
// auth.js (Rewrite 2024/06) - Epic Seven Card Battle - NEW LOGIN SYSTEM

// State
let Auth = {
    user: null,
    isLoggedIn: false,
    isAdmin: false
};

let userTable = [];

// ===== 1. ‡πÇ‡∏´‡∏•‡∏î user list ‡∏à‡∏≤‡∏Å data/user.json =====
async function fetchUserTable() {
    if (userTable.length) return userTable;
    try {
        const res = await fetch('data/user.json');
        userTable = await res.json();
    } catch {
        userTable = [];
    }
    return userTable;
}

// ===== 2. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å session (LocalStorage) =====
function saveSession(user) {
    localStorage.setItem('user_id', user.id);
    localStorage.setItem('user_name', user.name);
    localStorage.setItem('user_is_admin', user.role === "admin" ? "1" : "0");
}

function clearSession() {
    localStorage.removeItem('user_id');
    localStorage.removeItem('user_name');
    localStorage.removeItem('user_is_admin');
}

// ===== 3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö session ‡πÉ‡∏ô localStorage =====
function readSession() {
    let id = localStorage.getItem('user_id') || '';
    let name = localStorage.getItem('user_name') || '';
    let admin = localStorage.getItem('user_is_admin') === "1";
    if (id && name) {
        Auth = {
            user: { id, name, role: admin ? "admin" : "player" },
            isLoggedIn: true,
            isAdmin: admin
        };
    } else {
        Auth = { user: null, isLoggedIn: false, isAdmin: false };
    }
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏ô UI ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
    if (typeof setPlayerName === 'function') {
        setPlayerName(Auth.isLoggedIn && Auth.user ? Auth.user.name : '');
    }
}
readSession();

// ===== 4. Popup ‡∏ü‡∏≠‡∏£‡πå‡∏° Login =====
function renderLoginForm() {
    return `
        <div class="popup small" style="padding:1.3em 1.2em;">
          <button class="close" onclick="closePopup()">√ó</button>
          <h2 style="margin-bottom:.95em;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
          <div id="loginMsg" style="color:#f66;font-size:.93em;margin-bottom:4px;"></div>
          <input id="login_user" type="text" placeholder="User ID..." autocomplete="username" style="width:100%;margin-bottom:7px;">
          <input id="login_pass" type="password" placeholder="Password..." autocomplete="current-password" style="width:100%;margin-bottom:16px;">
          <button class="primary-btn" style="width:100%;margin-bottom:.6em;" onclick="doLogin()">
              ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô
          </button>
          <button class="secondary-btn" style="width:100%;" onclick="closePopup()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
    `;
}

window.openLoginPopup = async function () {
    await fetchUserTable();
    window.openPopup('login', renderLoginForm(), 'small', '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö');
    setTimeout(() => {
        let el = document.getElementById('login_user');
        if (el) el.focus();
    }, 120);
};

// ===== 5. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô + ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö =====
window.doLogin = async function () {
    await fetchUserTable();
    const inputId = document.getElementById('login_user').value.trim();
    const inputPw = document.getElementById('login_pass').value;
    const elMsg = document.getElementById('loginMsg');
    const found = userTable.find(u =>
        u.id === inputId && u.password === inputPw && u.enabled !== false
    );
    if (found) {
        saveSession(found);
        readSession();
        closePopup();
        location.reload();
    } else {
        if (elMsg) elMsg.innerText = '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ú‡∏¥‡∏î!';
    }
};

// ===== 6. Logout =====
window.doLogout = function () {
    clearSession();
    readSession();
    location.reload();
};

// ===== 7. Shortcut =====
window.getCurrentUser = function () {
    readSession();
    return Auth.user;
}
window.isAdmin = function () {
    readSession();
    return Auth.isAdmin;
}
window.isLoggedIn = function () {
    readSession();
    return Auth.isLoggedIn;
}

// ===== 8. On load: set event handler/login button =====
document.addEventListener('DOMContentLoaded', () => {
    readSession();
    let btn = document.getElementById('btnLogin');
    if (btn) {
        // Toggle text and func
        if (Auth.isLoggedIn) {
            btn.textContent = "‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö";
            btn.onclick = window.doLogout;
        } else {
            btn.textContent = "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö";
            btn.onclick = window.openLoginPopup;
        }
    }
    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏∑‡πà‡∏≠ user
    if (typeof setPlayerName === 'function') {
        setPlayerName(Auth.isLoggedIn && Auth.user ? Auth.user.name : '');
    }
});

// ===== 9. EXPORT (for legacy/compatibility) =====
window.authEngine = {
    user: () => getCurrentUser(),
    isAdmin,
    isLoggedIn,
    login: window.doLogin,
    logout: window.doLogout,
    open: window.openLoginPopup
};

‡πÑ‡∏ü‡∏•‡πå data/user.json
[
  {
    "id": "admin",
    "name": "Admin",
    "password": "adminpass123",
    "role": "admin",
    "enabled": true
  },
  {
    "id": "player1",
    "name": "Achiraya",
    "password": "p1demo!!",
    "role": "player",
    "enabled": true
  },
  {
    "id": "player2",
    "name": "Somchai",
    "password": "playerdemo2",
    "role": "player",
    "enabled": true
  }
]

‡πÑ‡∏ü‡∏•‡πå js/characterCollection.js
// js/characterCollection.js

/**
 * Epic Seven - Character Collection System (Frontend Only)
 * - Card grid, search, sort, filter, responsive, upgrade, rune
 * - Data driven by: localStorage char_collection & data/char/*.json
 * - Connect: upgrade.js, rune.js, team.js, popupManager.js
 * (c) 2024
 */

let charCollection = [];  // Owned character IDs
let charMeta = [];        // All char meta loaded
let filters = { text: '', star: 0, element: 'all', class: 'all' };

// ------------ 1. Load user collection from localStorage ------------
function loadCharCollection() {
    let arr = JSON.parse(localStorage.getItem('char_collection') || "[]");
    charCollection = arr.filter((id, idx) => arr.indexOf(id) === idx); // unique
}

// ------------ 2. Load meta data for all owned characters ------------
async function loadCharMeta() {
    await loadCharCollection();
    charMeta = await Promise.all(charCollection.map(async id => {
        try {
            let res = await fetch(`data/char/${id}.json`);
            return await res.json();
        } catch (e) { return null; }
    }));
    charMeta = charMeta.filter(c => !!c);
}

// ------------ 3. Render main UI grid ------------
function renderCharGrid() {
    let area = document.getElementById('characterArea');
    if (!area) return;
    let cs = charMeta.slice();
    if (filters.star > 0) cs = cs.filter(c => (c.star || 0) === Number(filters.star));
    if (filters.element !== 'all') cs = cs.filter(c => (c.element || "") === filters.element);
    if (filters.class !== 'all') cs = cs.filter(c => (c.class || "") === filters.class);
    if (filters.text.length) cs = cs.filter(c => c.name.toLowerCase().includes(filters.text.toLowerCase()));
    cs.sort((a, b) => (b.star || 0) - (a.star || 0) || (a.name.localeCompare(b.name)));
    let isMobile = window.innerWidth < 650;
    let html = `<div style="display:grid;grid-template-columns:repeat(${isMobile ? 3 : 6},1fr);gap:16px;">` +
        (cs.length ? cs.map(c => charCardBox(c)).join('') : '<div style="color:#fff;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£</div>') +
        `</div>`;
    area.innerHTML = `
      <div style="display:flex;gap:10px;margin-bottom:10px;">
        <input id="charSearchBox" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠..." style="flex:1;max-width:180px;" value="${filters.text || ''}"/>
        <select id="starFilter"><option value="0">‚òÖ ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option><option value="3">‚òÖ3</option><option value="4">‚òÖ4</option><option value="5">‚òÖ5</option></select>
        <select id="eleFilter"><option value="all">‡∏ó‡∏∏‡∏Å‡∏ò‡∏≤‡∏ï‡∏∏</option><option value="fire">üî• ‡πÑ‡∏ü</option><option value="water">üíß ‡∏ô‡πâ‡∏≥</option><option value="earth">üå± ‡∏î‡∏¥‡∏ô</option><option value="dark">üåë ‡∏°‡∏∑‡∏î</option><option value="light">üåü ‡πÅ‡∏™‡∏á</option></select>
        <select id="classFilter"><option value="all">‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏•‡∏≤‡∏™</option><option value="knight">‡∏≠‡∏±‡∏®‡∏ß‡∏¥‡∏ô</option><option value="warrior">‡∏ô‡∏±‡∏Å‡∏£‡∏ö</option><option value="mage">‡∏à‡∏≠‡∏°‡πÄ‡∏ß‡∏ó‡∏¢‡πå</option><option value="ranger">‡πÄ‡∏£‡∏ô‡πÄ‡∏à‡∏≠‡∏£‡πå</option><option value="assassin">‡πÅ‡∏≠‡∏™‡∏ã‡∏≤‡∏ã‡∏¥‡∏ô</option><option value="monster">‡∏°‡∏≠‡∏ô‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡πå</option></select>
      </div>
      ${html}
    `;
    document.getElementById('starFilter').value = filters.star;
    document.getElementById('eleFilter').value = filters.element;
    document.getElementById('classFilter').value = filters.class;
    document.getElementById('charSearchBox').oninput = ev => { filters.text = ev.target.value.trim(); renderCharGrid(); };
    document.getElementById('starFilter').onchange = ev => { filters.star = ev.target.value; renderCharGrid(); };
    document.getElementById('eleFilter').onchange = ev => { filters.element = ev.target.value; renderCharGrid(); };
    document.getElementById('classFilter').onchange = ev => { filters.class = ev.target.value; renderCharGrid(); };
}

// ------------ 4. Card box HTML ------------
function charCardBox(c) {
    let lock = isCharLocked(c.id);
    return `
      <div class="card" data-chrid="${c.id}" style="position:relative;">
        <img src="img/char/${c.img}" class="hero-img" alt="${c.name}" />
        <div class="name">${c.name}</div>
        <div style="font-size:.93em;color:#d9d;line-height:1.2em;">Lv. ${c.level || '-'} ‚òÖ${c.star || '-'}</div>
        <div style="font-size:.89em;color:#cff;">‡∏ò‡∏≤‡∏ï‡∏∏: ${elIcon(c.element)} | ${classIcon(c.class)}</div>
        <div style="margin:6px 0;">
            <button class="primary-btn" style="padding:3px 1.1em;font-size:.97em;" onclick="showCharDetailPopup('${c.id}')">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
            <button class="secondary-btn" style="padding:3px 1.1em;font-size:.97em;" onclick="upgradeCharPopup('${c.id}')">‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î</button>
            <button class="primary-btn" style="padding:3px 1em;font-size:.93em;" onclick="runeEngine.openEquipPopup('${c.id}')">‡πÉ‡∏™‡πà‡∏£‡∏π‡∏ô</button>
        </div>
        <button style="position:absolute;top:7px;right:14px;opacity:.8;background:none;border:0;color:#fa8;font-size:1.5em;outline:none;z-index:7"
            onclick="toggleCharLock('${c.id}');event.stopPropagation()" title="${lock ? '‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å' : '‡∏•‡πá‡∏≠‡∏Å'}">
            ${lock ? 'üîí' : 'üîì'}
        </button>
      </div>`;
}
function elIcon(el) {
    return { fire: 'üî•', water: 'üíß', earth: 'üå±', dark: 'üåë', light: 'üåü' }[el] || '‚ùî';
}
function classIcon(cls) {
    return { knight: 'üõ°Ô∏è', warrior: '‚öîÔ∏è', mage: 'ü¶â', ranger: 'üèπ', assassin: 'üó°Ô∏è', monster: 'üëæ' }[cls] || 'üëΩ';
}

// ------------ 5. Lock/Unlock ------------
function isCharLocked(chid) {
    let ll = JSON.parse(localStorage.getItem('char_lock') || "[]");
    return ll.includes(chid);
}
function toggleCharLock(chid) {
    let ll = JSON.parse(localStorage.getItem('char_lock') || "[]");
    let idx = ll.indexOf(chid);
    if (idx >= 0) ll.splice(idx, 1); else ll.push(chid);
    localStorage.setItem('char_lock', JSON.stringify(ll));
    renderCharGrid();
}

// ------------ 6. Popup: Char Detail ------------
window.showCharDetailPopup = async function (charId) {
    let c = charMeta.find(c => c.id === charId);
    if (!c) return;
    let html = `
        <div style="display:flex;flex-direction:column;align-items:center;gap:7px;">
            <img src="img/char/${c.img}" class="hero-img" style="width:82px;margin:0 auto 9px auto;" />
            <div style="font-size:1.22em;font-weight:600">${c.name}</div>
            <div style="color:#b6deff;">Lv.${c.level || '-'} / ‚òÖ${c.star||'-'} | ${elIcon(c.element)} ${classIcon(c.class)}</div>
            <hr style="width:86%;border:1px solid #234;" />
            <div>HP <b>${c.hp}</b> | ATK <b>${c.atk}</b> | DEF <b>${c.def}</b> | SPD <b>${c.spd}</b></div>
            <div>CRIT <b>${c.crit_rate}%</b> | CRIT DMG <b>${c.crit_dmg}%</b> | EFF <b>${c.effectiveness}%</b></div>
            <div>Skills: <ul>${(c.skills || []).map(s => `<li><b>${s.name}</b>: ${s.desc || ''}</li>`).join('')}</ul></div>
            <div style="margin-top:7px;">
                <button class="primary-btn" onclick="upgradeCharPopup('${c.id}')">‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î</button>
                <button class="primary-btn" onclick="runeEngine.openEquipPopup('${c.id}')">‡πÉ‡∏™‡πà‡∏£‡∏π‡∏ô</button>
                <button class="secondary-btn" onclick="closePopup()" style="margin-left:11px;">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>`;
    window.openPopup('charDetail', html, 'large', c.name);
}

// ------------ 7. INIT [DOM Ready, bind menu] ------------
document.addEventListener('DOMContentLoaded', async () => {
    let btn = document.getElementById('btnCharacter');
    if (btn)
        btn.onclick = async () => {
            await loadCharMeta();
            renderCharGrid();
            window.openPopup('characterCollection', `<div id="characterArea"></div>`, 'large', '‡∏Ñ‡∏•‡∏±‡∏á‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£');
            renderCharGrid();
        };
});

// ‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ (upgrade, rune)
window.characterEngine = {
    load: loadCharMeta,
    render: renderCharGrid
};

‡πÑ‡∏ü‡∏•‡πå js/passive.js
// js/passive.js
//
// Epic Seven Card Battle - Passive Engine (Rewrite 2024/06/Full Modular By GPT)
//
// Features: 
// - Aura/Always/Trigger/Custom support
// - Centralized EventManager
// - Extendable PassiveEvent definition
// - Robust UI popup bind (showDamage, popupPassive)
//

(function () {
  // 1. State: passive list + ready flag
  let passiveMeta = [];
  let fetched = false;

  // 2. Load all passive config from /data/passive.json
  async function loadPassiveMeta() {
    if (fetched && passiveMeta.length) return;
    try {
      passiveMeta = await fetch('data/passive.json').then(r => r.json());
      fetched = true;
    } catch {
      passiveMeta = [];
    }
  }

  // 3. Interface: Passive object logic
  //    Use: passiveManager.applyAllOnInit(character)
  //         passiveManager.trigger('onDamaged', ...)
  class PassiveManager {
    constructor() {
      this._registeredEvents = {};
    }

    // Register all passive effects on char (eg. when start battle)
    async applyAllOnInit(char, context = {}) {
      await loadPassiveMeta();
      if (!char.passive) return;
      let assigned = Array.isArray(char.passive) ? char.passive : [char.passive];

      assigned.forEach(pid => {
        let meta = passiveMeta.find(p => p.id === pid);
        if (!meta) return;

        // 1. Aura/passive stat buff
        if (meta.type === "aura" && meta.effect) {
          Object.entries(meta.effect).forEach(([stat, val]) => {
            char[stat] = (char[stat] || 0) + val;
          });
          // Add passive tag for UI
          char._auraNotes = char._auraNotes || [];
          char._auraNotes.push({ icon: meta.icon, name: meta.name });
        }
        // 2. Apply always type flag (e.g. immunity)
        if (meta.type === "always" && meta.effect) {
          char._alwaysFlags = Object.assign({}, char._alwaysFlags || {}, meta.effect);
        }
        // 3. Register event-driven passive
        if (meta.type === "trigger") {
          char._passiveTriggers = char._passiveTriggers || [];
          char._passiveTriggers.push(meta);
        }
      });
    }

    // Centralized trigger for passive event ("onDamaged", "onHit", etc.)
    trigger(event, char, payload = {}) {
      if (!char?._passiveTriggers) return;
      char._passiveTriggers.forEach(pas => {
        // Matched event (eg. onDamaged), Chance roll
        if (pas.event === event && Math.random() * 100 < (pas.chance ?? 100)) {
          // Effect logic
          if (pas.effect) {
            Object.entries(pas.effect).forEach(([k, v]) => {
              // [Stat] instant gain (if exist)
              if (["hp", "atk", "def", "spd"].includes(k)) {
                char[k] = (char[k] || 0) + v;
                showPassivePopup(char, pas, `+${k.toUpperCase()} ${v}`);
              }
              // Heal
              else if (k === "heal") {
                let amount = typeof v === "number" ? Math.floor(char.hp * v) : 0;
                char.currHp = Math.min(char.hp, char.currHp + amount);
                showPassivePopup(char, pas, `Heal ${amount}`);
                if (window.showDamage) window.showDamage(char.index || 0, char.side || 'hero', -amount, "#5dfcb3");
              }
              // Buff/Debuff
              else if (k === "buff" && window.effectEngine) {
                window.effectEngine.addEffect(char, Array.isArray(v) ? v : [v], "buff");
                showPassivePopup(char, pas, t("popup.equip") + (pas.name ? ": " + pas.name : ''));
              }
              else if (k === "debuff" && window.effectEngine) {
                window.effectEngine.addEffect(char, Array.isArray(v) ? v : [v], "debuff");
                showPassivePopup(char, pas, "DEBUFF");
              }
            });
          }
          // Option: add more handling per game logic
          if (pas.showText) showPassivePopup(char, pas, pas.showText);
        }
      });
    }

    // Register global event hooks (optional for expansion)
    on(event, handler) {
      if (!this._registeredEvents[event]) this._registeredEvents[event] = [];
      this._registeredEvents[event].push(handler);
    }
    emit(event, ...args) {
      (this._registeredEvents[event] || []).forEach(fn => fn(...args));
    }

    // Utility: global filter, eg. check immunity
    static hasImmunity(char) {
      return !!(char?._alwaysFlags?.immune_all || (char.buffs || []).some(b => b.type === "immune"));
    }
  }

  // 4. Passive popup show logic for UI (dmg/heal/other)
  function showPassivePopup(char, pas, txt) {
    // Use UI function, fallback to alert
    let dom = document.getElementById(`${char.side || "hero"}${char.index || 0}`);
    if (dom) {
      let pop = document.createElement('span');
      pop.className = "damage-popup";
      pop.style.color = pas?.color || '#31ebdb';
      pop.innerHTML = `${pas?.icon ? pas.icon + " " : ""}<b>PASSIVE</b>: ${txt || pas?.name || ""}`;
      dom.appendChild(pop);
      setTimeout(() => pop.remove(), 1300);
    } else {
      // fallback for debug/dev
      // alert(`[Passive] ${char.name}: ${txt}`);
    }
  }

  // 5. Export public API
  const passiveEngine = {
    load:   loadPassiveMeta,
    apply:  (char, context) => (new PassiveManager()).applyAllOnInit(char, context),
    trigger: (event, char, payload) => (new PassiveManager()).trigger(event, char, payload),
    // Optional utilities for future
    hasImmunity: PassiveManager.hasImmunity
  };

  // Expose window.passiveEngine for global use
  window.passiveEngine = passiveEngine;

  // (Option) For all system auto-load
  window.addEventListener && window.addEventListener("DOMContentLoaded", () => loadPassiveMeta());

})();

/*
USAGE (like old version‚Äîcompatible):
- await passiveEngine.apply(char, char.passive);      // at battle start
- passiveEngine.trigger('onDamaged', char, payload);  // eg. in doSkill/onHit
- (UI) showPassivePopup(char, passive, message)       // for display popup

Passive event types: onDamaged, onEndTurn, onHit, onHeal, onBattleInit, etc.
*/

‡πÑ‡∏ü‡∏•‡πå data/passive.json
[
  {
    "id": "counter_attack",
    "name": "Counter Strike",
    "icon": "‚Ü©Ô∏è",
    "desc": "‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™ 25% ‡πÇ‡∏ï‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ñ‡∏π‡∏Å‡πÇ‡∏à‡∏°‡∏ï‡∏µ",
    "type": "trigger",
    "event": "onDamaged",
    "chance": 25,
    "effect": {"buff":[{"type":"counter_ready","turn":1}]},
    "showText": "‡πÇ‡∏ï‡πâ‡∏Å‡∏•‡∏±‡∏ö!"
  },
  {
    "id": "team_aura_def",
    "name": "Commander Aura",
    "icon": "üõ°Ô∏è",
    "desc": "‡∏ó‡∏µ‡∏°‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö DEF+12 ‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏Ç‡∏ì‡∏∞‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ",
    "type": "aura",
    "effect": { "def": 12 }
  },
  {
    "id": "self_heal",
    "name": "Regeneration",
    "icon": "üíö",
    "desc": "‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π HP 10% ‡∏Ç‡∏≠‡∏á Max HP ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏ö‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á",
    "type": "trigger",
    "event": "onEndTurn",
    "chance": 100,
    "effect": { "heal": 0.10 },
    "showText": "Regenerate"
  },
  {
    "id": "immunity_permanent",
    "name": "Immunity Master",
    "icon": "üîí",
    "desc": "‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î debuff ‡πÄ‡∏•‡∏¢",
    "type": "always",
    "effect": { "immune_all": true }
  },
  {
    "id": "relentless_aura_spd",
    "name": "Relentless Aura",
    "icon": "üí®",
    "desc": "‡∏ó‡∏µ‡∏°‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö SPD+8",
    "type": "aura",
    "effect": { "spd": 8 }
  },
  {
    "id": "burn_on_hit",
    "name": "Inferno Retaliate",
    "icon": "üî•",
    "desc": "‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™ 30% ‡∏ï‡∏¥‡∏î burn ‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏ï‡∏µ‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ",
    "type": "trigger",
    "event": "onDamaged",
    "chance": 30,
    "effect": { "debuff": [{"type":"burn", "turn":2}] },
    "showText": "Burned!"
  }
]

‡πÑ‡∏ü‡∏•‡πå admin.html
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Admin Panel - Epic Seven Card Auto Battle</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body class="dark-bg">
<header>
  <nav class="navbar">
    <div class="logo">ADMIN - Epic Seven Card Battle</div>
    <ul class="menu">
      <li><button onclick="window.location.href='index.html'">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏Å‡∏°</button></li>
      <li><button id="btnUserMgr">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</button></li>
      <li><button id="btnCharMgr">‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£/Skills</button></li>
      <li><button id="btnItemMgr">‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°</button></li>
      <li><button id="btnRuneMgr">‡∏£‡∏π‡∏ô</button></li>
      <li><button id="btnQuestMgr">‡πÄ‡∏Ñ‡∏ß‡∏™‡∏ï‡πå</button></li>
      <li><button id="btnGachaMgr">‡∏Å‡∏≤‡∏ä‡∏≤</button></li>
      <li><button id="btnStageMgr">‡∏î‡∏±‡∏ô‡πÄ‡∏à‡∏µ‡πâ‡∏¢‡∏ô</button></li>
      <li><button id="btnShopMgr">‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</button></li>
      <li><button id="btnAnnounceMgr">‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</button></li>
      <li><button id="btnRedeemMgr">‡πÇ‡∏Ñ‡πâ‡∏î</button></li>
      <li><button id="btnChatMod">‡πÅ‡∏ä‡∏ó</button></li>
    </ul>
    <div class="profile">
      <span id="adminName"></span>
      <button id="btnLogout">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>
  </nav>
</header>

<main style="max-width: 1120px;margin: 1.5em auto;background:#262a38bb;border-radius:18px;box-shadow:0 2px 26px #0b0a10a6;padding:26px 24px;min-height:440px;">
  <div id="adminMainArea"></div>
</main>

<div id="popupLayer"></div>
<footer>
  <small style="color: #aaa;">&copy; 2024 - Admin Panel (For Epic Seven Fan Project)</small>
</footer>

<script src="js/utils.js"></script>
<script src="js/admin.js"></script>
</body>
</html>

‡πÑ‡∏ü‡∏•‡πå js/admin.js
// js/admin.js (‡∏â‡∏ö‡∏±‡∏ö‡πÄ‡∏ï‡πá‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö admin panel)

/* ==== 1) LOGIN ADMIN GUARD ==== */
document.addEventListener('DOMContentLoaded', () => {
  // Check admin session
  const isAdmin = localStorage.getItem("user_is_admin") === "1";
  const adminName = localStorage.getItem("user_name");

  if (!isAdmin) {
    alert("‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô");
    window.location.href = "index.html";
    return;
  }
  document.getElementById('adminName').innerText = `üë§ ${adminName}`;
  document.getElementById("btnLogout").onclick = function () {
    localStorage.removeItem("user_id");
    localStorage.removeItem("user_name");
    localStorage.removeItem("user_is_admin");
    window.location.href = "index.html";
  };

  // Menu event mapping
  {
    let mapping = {
      btnUserMgr:   renderUserMgr,
      btnCharMgr:   renderCharMgr,
      btnItemMgr:   renderItemMgr,
      btnRuneMgr:   renderRuneMgr,
      btnQuestMgr:  renderQuestMgr,
      btnGachaMgr:  renderGachaMgr,
      btnStageMgr:  renderStageMgr,
      btnShopMgr:   renderShopMgr,
      btnAnnounceMgr: renderAnnounceMgr,
      btnRedeemMgr: renderRedeemMgr,
      btnChatMod:   renderChatMgr
    };
    Object.entries(mapping).forEach(([btn, fn])=>{
      let el = document.getElementById(btn);
      if (el) el.onclick = fn;
    });
  }

  // Default: open user mgr
  renderUserMgr();
});

// Helper: set main admin area content
function setAdminMain(html) {
  document.getElementById("adminMainArea").innerHTML = html;
}

/* ==== 2) USER MANAGEMENT ==== */
async function renderUserMgr() {
  let res = await fetch('data/user.json').then(r=>r.json());
  let html = `<h2>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h2>
    <table style="width:100%;background:#223247;border-radius:12px;">
      <tr style="color:#bfa;font-size:1.13em;"><th>ID</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>Role</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°</th></tr>
      ${res.map(u=>
        `<tr>
          <td>${u.id}</td>
          <td>${u.name}</td>
          <td>${u.role}</td>
          <td><span style="color:${u.enabled?'#7fe':'#fad'};">${u.enabled?'‚úîÔ∏è ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô':'‚ùå ‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î'}</span></td>
          <td>
            <button onclick="editUserPopup('${u.id}')" class="primary-btn" style="font-size:.95em;">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            <button onclick="banUser('${u.id}')" class="secondary-btn" style="font-size:.93em;">‡πÅ‡∏ö‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
          </td>
        </tr>`).join('')}
    </table>
    <div style="margin:16px 0 0 0;text-align:right;">
      <button class="primary-btn" onclick="addUserPopup()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
    </div>`;
  setAdminMain(html);
}
window.renderUserMgr = renderUserMgr;

window.editUserPopup = function (uid) {
  alert("‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤");
}
window.addUserPopup = function () {
  alert("‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤");
}
window.banUser = function (uid) {
  alert(`‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ö‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ "${uid}" ‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤ (‡πÉ‡∏ô‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô local ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÉ‡∏ô data/user.json ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ backend)`);
};

/* ==== 3) CHAR MANAGEMENT ==== */
async function renderCharMgr() {
  let charIds = ['astra','slime_basic'];
  let all = await Promise.all(charIds.map(id=>fetch(`data/char/${id}.json`).then(r=>r.json())));
  let html = `<h2>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ (meta-json)</h2>
    <table style="width:100%;background:#2a3247;border-radius:12px;">
      <tr><th>‡∏£‡∏π‡∏õ</th><th>ID</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‚òÖ</th><th>‡∏ò‡∏≤‡∏ï‡∏∏</th><th>class</th><th>‡∏™‡∏Å‡∏¥‡∏•</th><th>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th></tr>
      ${all.map(c=>`
        <tr>
         <td><img src="img/char/${c.img}" style="width:36px;border-radius:9px;" /></td>
         <td>${c.id}</td>
         <td>${c.name}</td>
         <td>${c.star}</td>
         <td>${c.element}</td>
         <td>${c.class}</td>
         <td>${(c.skills||[]).length}</td>
         <td><button onclick="editCharPopup('${c.id}')" class="primary-btn" style="font-size:.93em;">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button></td>
        </tr>`).join('')}
    </table>
    <div style="margin:14px 0 0 0;text-align:right;">
      <button class="primary-btn" onclick="addCharPopup()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£</button>
    </div>
    <div style="color:#aaa;padding:13px 0;">*‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏∞ Reflect ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå .json ‡∏à‡∏£‡∏¥‡∏á (auto reload)</div>`;
  setAdminMain(html);
}
window.renderCharMgr = renderCharMgr;
window.editCharPopup = function (cid) { window.openPopup('editChar',`<div>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö (‡πÇ‡∏õ‡∏£‡∏î‡πÅ‡∏Å‡πâ json ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á)</div>`,'small','‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£'); }
window.addCharPopup = function () { window.openPopup('addChar',`<div>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö (‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô .json ‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô data/char/)</div>`,'small','‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£'); }

/* ==== 4) ITEM MANAGEMENT ==== */
async function renderItemMgr() {
  let items = await fetch('data/item.json').then(r=>r.json());
  let html = `<h2>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°</h2>
    <table style="width:100%;background:#273257;border-radius:12px;">
      <tr><th>‡∏£‡∏π‡∏õ</th><th>ID</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>type</th><th>desc</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤</th></tr>
      ${items.map(it=>
        `<tr>
           <td><img src="img/item/${it.img||'noimg.png'}" style="width:32px" /></td>
           <td>${it.id}</td><td>${it.name}</td>
           <td>${it.type||'-'}</td><td>${it.description||'-'}</td>
           <td>${it.price}</td>
        </tr>`
      ).join('')}
    </table>
    <div style="margin:14px 0 0 0;text-align:right;">
      <button class="primary-btn" onclick="alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°: ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà data/item.json')">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°</button>
    </div>`;
  setAdminMain(html);
}
window.renderItemMgr = renderItemMgr;

/* ==== 5) RUNE ==== */
async function renderRuneMgr() {
  let runes = await fetch('data/rune.json').then(r=>r.json());
  let html = `<h2>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏ô (rune.json)</h2>
    <table style="width:100%;background:#223549;border-radius:12px;">
      <tr><th>ICON</th><th>id</th><th>name</th><th>slot</th><th>main stat</th><th>set</th><th>sub</th></tr>
      ${runes.filter(r=>r.id).map(r=>
        `<tr>
         <td>${r.icon||'üî∏'}</td>
         <td>${r.id}</td>
         <td>${r.name}</td>
         <td>${r.slot}</td>
         <td>${r.main_stat ? `${r.main_stat.type}+${r.main_stat.val}` : '-'}</td>
         <td>${r.set}</td>
         <td>${(r.sub_stats||[]).map(s=>`${s.type}+${s.val}`).join(', ')}</td>
        </tr>`).join('')}
    </table>
    <div style="text-align:right;margin-top:13px;">
      <button class="primary-btn" onclick="alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏ô: ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô data/rune.json')">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏π‡∏ô</button>
    </div>`;
  setAdminMain(html);
}
window.renderRuneMgr = renderRuneMgr;

/* ==== 6) QUEST (JSON) ==== */
async function renderQuestMgr() {
  setAdminMain(`<h2>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏ß‡∏™‡∏ï‡πå (‡πÇ‡∏õ‡∏£‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà data/quest/*.json)</h2>
    <div>‡πÄ‡∏Ñ‡∏ß‡∏™‡∏ï‡πå/‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡πâ‡∏ß reload ‡πÄ‡∏Å‡∏°</div>
    <div style="margin:16px 0;"><button class="primary-btn" onclick="alert('‡∏£‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ñ‡∏ß‡∏™‡∏ï‡πå')">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</button></div>`);
}

/* ==== 7) GACHA ==== */
async function renderGachaMgr() {
  let gacha = await fetch('data/gacha.json').then(r=>r.json());
  let html = `<h2>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏ä‡∏≤ (gacha.json)</h2>
      <table style="width:100%;background:#243168;border-radius:12px;">
      <tr><th>id</th><th>name</th><th>‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</th><th>type</th><th>cost</th><th>pool</th><th>‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°</th></tr>
      ${gacha.gachas.map(g=>
        `<tr>
         <td>${g.id}</td>
         <td>${g.name}</td>
         <td>${g.enabled ? "‚úî" : "‚ùå"}</td>
         <td>${g.type}</td>
         <td>${g.cost.amount} ${g.cost.item}</td>
         <td>${g.pool.map(p=>`${p.char_id}(‚òÖ${p.rarity})`).join(', ')}</td>
         <td><button onclick="alert('edit gacha: ‡πÇ‡∏õ‡∏£‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà data/gacha.json')" class="primary-btn">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button></td>
        </tr>`).join('')}
      </table>
      <div style="margin-top:11px;text-align:right;">
        <button onclick="alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏ä‡∏≤: ‡πÇ‡∏õ‡∏£‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç data/gacha.json')" class="primary-btn">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏ä‡∏≤</button>
      </div>`;
  setAdminMain(html);
}
window.renderGachaMgr = renderGachaMgr;

/* ==== 8) STAGE/DUNGEON ==== */
async function renderStageMgr() {
  setAdminMain(`<h2>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Stage/Dungeon</h2>
  <div>‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà, Zone, Stage ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î config ‡πÉ‡∏ô data/stage/*.json</div>`);
}

/* ==== 9) SHOP ==== */
async function renderShopMgr() {
  let shop = await fetch('data/shop.json').then(r=>r.json());
  let html = `<h2>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
      <table style="width:100%;background:#223249;border-radius:12px;">
      <tr><th>id</th><th>name</th><th>type</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th></tr>
      ${shop.shops.map(s=>
        `<tr>
         <td>${s.id}</td>
         <td>${s.name}</td>
         <td>${s.type}</td>
         <td>${s.enabled ? "‚úî" : "‚ùå"}</td>
         <td>${(s.items||[]).length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td>
        </tr>`).join('')}
      </table>
      <div style="margin-top:10px;text-align:right;">
        <button onclick="alert('update shop: ‡πÇ‡∏õ‡∏£‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà data/shop.json')" class="primary-btn">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
      </div>`;
  setAdminMain(html);
}
window.renderShopMgr = renderShopMgr;

/* ==== 10) ANNOUNCEMENT ==== */
async function renderAnnounceMgr() {
  let ann = await fetch('data/announcement.json').then(r=>r.json());
  let html = `<h2>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</h2>
    <table style="width:100%;background:#142449;border-radius:10px;">
    <tr><th>id</th><th>title</th><th>pin</th><th>type</th><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th></tr>
    ${ann.announcements.map(a=>
      `<tr>
        <td>${a.id}</td><td>${a.title}</td>
        <td>${a.pin?'‚úî':'‚ùå'}</td>
        <td>${a.type}</td>
        <td>${a.show_time ? new Date(a.show_time).toLocaleString() : '-'}</td>
        <td><button onclick="alert('Announce: ‡πÇ‡∏õ‡∏£‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡πà data/announcement.json')" class="primary-btn" style="font-size:.96em;">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button></td>
      </tr>`
    ).join('')}
    </table>
    <div style="margin-top:10px;text-align:right">
     <button class="primary-btn" onclick="alert('‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®: ‡πÇ‡∏õ‡∏£‡∏î‡πÅ‡∏Å‡πâ‡∏ó‡∏µ‡πà announcement.json')">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</button>
    </div>
    <div style="color:#ead;padding:13px;">*‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÉ‡∏´‡∏°‡πà/‡∏•‡∏ö ‡∏ï‡πâ‡∏≠‡∏á reload ‡πÑ‡∏ü‡∏•‡πå announcement.json ‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡πÄ‡∏Å‡∏°</div>`;
  setAdminMain(html);
}
window.renderAnnounceMgr = renderAnnounceMgr;

/* ==== 11) REDEEM CODE ==== */
async function renderRedeemMgr() {
  let rc = await fetch('data/redeem.json').then(r=>r.json());
  let html = `<h2>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏Ñ‡πâ‡∏î (redeem)</h2>
    <table style="width:100%;background:#212d41;border-radius:12px;">
      <tr><th>id</th><th>desc</th><th>active</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ</th><th>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th></tr>
      ${rc.codes.map(c=>
        `<tr>
         <td>${c.id}</td>
         <td>${c.desc}</td>
         <td>${c.enabled?'‚úî':'‚ùå'}</td>
         <td>${c.used_count||0}/${c.max_usage||'-'}</td>
         <td><button onclick="alert('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏Ñ‡πâ‡∏î: ‡πÇ‡∏õ‡∏£‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏ô data/redeem.json')" class="primary-btn">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button></td>
        </tr>`
      ).join('')}
    </table>
    <div style="margin-top:11px;text-align:right;">
      <button onclick="alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î: ‡πÇ‡∏õ‡∏£‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç data/redeem.json ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á')" class="primary-btn">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î</button>
    </div>`;
  setAdminMain(html);
}
window.renderRedeemMgr = renderRedeemMgr;

/* ==== 12) CHAT MOD/PANEL ==== */
async function renderChatMgr() {
  // Load chat log, banned words
  let chat = [];
  try { chat = await fetch('data/chat.json').then(r=>r.json()); } catch { chat = []; }
  let banned = [];
  try { banned = await fetch('data/banned_words.json').then(r=>r.json()); } catch {banned = [];}
  let html = `<h2>‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÅ‡∏ä‡∏ó/‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</h2>
    <h3>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (${chat.length})</h3>
    <div style="max-height:210px;overflow-y:auto;">
      <table style="width:100%;background:#23236c;border-radius:11px;">
        <tr><th style="width:120px;">‡πÄ‡∏ß‡∏•‡∏≤</th><th style="width:180px;">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</th><th>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</th><th>‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°</th></tr>
        ${chat.slice(-50).reverse().map(c=>
          `<tr>
            <td>${c.time ? (new Date(c.time)).toLocaleTimeString() : '-'}</td>
            <td>${c.user}</td>
            <td>${escapeHTML(c.text)}</td>
            <td>
              <button class="secondary-btn" style="padding:.2em 1.2em;" onclick="alert('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ: ‡πÅ‡∏Å‡πâ chat.json')">‡∏•‡∏ö</button>
            </td>
          </tr>`
        ).join('')}
      </table>
    </div>
    <h3>‡∏Ñ‡∏≥‡∏ï‡πâ‡∏≠‡∏á‡∏´‡πâ‡∏≤‡∏° (${banned.length})</h3>
    <div>
      <ul>
      ${banned.map(word=>`<li>${escapeHTML(word)} <button class="secondary-btn" onclick="alert('‡∏•‡∏ö‡∏Ñ‡∏≥‡∏ï‡πâ‡∏≠‡∏á‡∏´‡πâ‡∏≤‡∏°: ‡πÇ‡∏õ‡∏£‡∏î‡πÅ‡∏Å‡πâ banned_words.json ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á')">‡∏•‡∏ö</button></li>`).join('')}
      </ul>
      <button class="primary-btn" onclick="alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ï‡πâ‡∏≠‡∏á‡∏´‡πâ‡∏≤‡∏°: ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô banned_words.json')">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ï‡πâ‡∏≠‡∏á‡∏´‡πâ‡∏≤‡∏°</button>
    </div>
    <div style="color:#98ffe7;margin:11px 0 0 0;">* ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏ü‡∏•‡πå JSON ‡πÅ‡∏•‡∏∞‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏à‡∏∂‡∏á‡∏à‡∏∞‡∏°‡∏µ‡∏ú‡∏•</div>`;
  setAdminMain(html);
}
window.renderChatMgr = renderChatMgr;

// Utility for safe display in table
function escapeHTML(str) {
  return (str || "").replace(/[<>&"]/g, c=>
    ({'<':'&lt;','>':'&gt;','&':'&amp;','"':'&quot;'}[c]));
}

‡πÑ‡∏ü‡∏•‡πå stage/chapter1.json
{
  "id": "chapter1",
  "name": "‡∏ö‡∏ó‡∏ó‡∏µ‡πà 1 : ‡∏õ‡πà‡∏≤‡πÅ‡∏´‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô",
  "desc": "‡∏≠‡∏≠‡∏Å‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏™‡∏π‡πà‡∏õ‡πà‡∏≤‡∏°‡∏∑‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ù‡∏∂‡∏Å‡∏ù‡∏ô‡πÅ‡∏•‡∏∞‡∏û‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà",
  "zones": [
    {
      "id": "zone1",
      "name": "‡∏õ‡πà‡∏≤‡∏•‡∏≥‡∏ò‡∏≤‡∏£‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å",
      "stages": [
        {
          "id": "c1z1s1",
          "name": "‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏õ‡πà‡∏≤ (‡∏á‡πà‡∏≤‡∏¢)",
          "desc": "‡∏ù‡∏∂‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Å‡∏±‡∏ö‡∏™‡πÑ‡∏•‡∏°‡πå‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡πá‡∏Å",
          "recommended_level": 1,
          "require_energy": 2,
          "waves": [
            {
              "enemies": [
                { "id": "slime_basic", "level": 1 }
              ]
            }
          ],
          "drops": [
            { "id": "gold", "min": 50, "max": 65, "rate": 80 }
          ],
          "exp_reward": 25
        },
        {
          "id": "c1z1s2",
          "name": "‡πÄ‡∏ô‡∏¥‡∏ô‡∏•‡∏≤‡∏î‡πÄ‡∏≠‡∏µ‡∏¢‡∏á",
          "desc": "‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏à‡∏≠‡∏°‡∏≠‡∏ô‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏™‡∏≠‡∏á‡∏ï‡∏±‡∏ß",
          "recommended_level": 2,
          "require_energy": 2,
          "waves": [
            {
              "enemies": [
                { "id": "slime_basic", "level": 2 },
                { "id": "slime_basic", "level": 2 }
              ]
            }
          ],
          "drops": [
            { "id": "gold", "min": 60, "max": 80, "rate": 85 }
          ],
          "exp_reward": 28
        },
        {
          "id": "c1z1s3",
          "name": "‡∏£‡πà‡∏≠‡∏á‡∏ô‡πâ‡∏≥‡∏ï‡∏Å‡πÅ‡∏´‡πâ‡∏á",
          "desc": "‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏à‡∏≠ Slime ‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ñ‡∏ß",
          "recommended_level": 3,
          "require_energy": 3,
          "waves": [
            {
              "enemies": [
                { "id": "slime_basic", "level": 3 },
                { "id": "slime_basic", "level": 2 },
                { "id": "slime_basic", "level": 2 }
              ]
            }
          ],
          "drops": [
            { "id": "exp_potion", "min": 1, "max": 1, "rate": 15 }
          ],
          "exp_reward": 32
        },
        {
          "id": "c1z2s1",
          "name": "‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ‡∏™‡∏π‡∏á‡πÄ‡∏ó‡∏µ‡∏¢‡∏°‡πÄ‡∏°‡∏Ü",
          "desc": "‡∏°‡∏≠‡∏ô‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏Å‡∏£‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô",
          "recommended_level": 4,
          "require_energy": 3,
          "waves": [
            {
              "enemies": [
                { "id": "slime_basic", "level": 4 },
                { "id": "slime_basic", "level": 4 }
              ]
            }
          ],
          "drops": [
            { "id": "rune_shard", "min": 1, "max": 2, "rate": 23 }
          ],
          "exp_reward": 35
        },
        {
          "id": "c1z2s2",
          "name": "‡∏Ñ‡∏π‡∏ô‡πâ‡∏≥‡∏•‡∏∂‡∏Å",
          "desc": "‡∏û‡∏ö‡∏Å‡∏±‡∏ö ‡∏ö‡∏≠‡∏™ Slime ‡πÉ‡∏´‡∏ç‡πà",
          "recommended_level": 6,
          "require_energy": 3,
          "waves": [
            {
              "enemies": [
                { "id": "slime_basic", "level": 5 },
                { "id": "slime_basic", "level": 6 }
              ]
            }
          ],
          "drops": [
            { "id": "gold", "min": 75, "max": 105, "rate": 88 }
          ],
          "exp_reward": 41
        },
        {
          "id": "c1z2s3",
          "name": "‡πÇ‡∏û‡∏£‡∏á‡πÑ‡∏ü",
          "desc": "‡πÄ‡∏à‡∏≠‡∏°‡∏≠‡∏ô‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡πå 3 ‡∏ï‡∏±‡∏ß ‡∏™‡∏µ‡∏ü‡πâ‡∏≤",
          "recommended_level": 7,
          "require_energy": 4,
          "waves": [
            {
              "enemies": [
                { "id": "slime_basic", "level": 6 },
                { "id": "slime_basic", "level": 6 },
                { "id": "slime_basic", "level": 5 }
              ]
            }
          ],
          "drops": [
            { "id": "exp_potion", "min": 1, "max": 2, "rate": 25 }
          ],
          "exp_reward": 46
        },
        {
          "id": "c1z3s1",
          "name": "‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏™‡∏£‡∏∞‡∏ô‡πâ‡∏≥",
          "desc": "‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡∏°‡∏™‡∏µ‡πà‡∏ï‡∏±‡∏ß",
          "recommended_level": 8,
          "require_energy": 5,
          "waves": [
            {
              "enemies": [
                { "id": "slime_basic", "level": 7 },
                { "id": "slime_basic", "level": 7 },
                { "id": "slime_basic", "level": 6 }
              ]
            }
          ],
          "drops": [
            { "id": "rune_shard", "min": 1, "max": 2, "rate": 28 }
          ],
          "exp_reward": 55
        },
        {
          "id": "c1z3s2",
          "name": "‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏ï‡πà‡∏≤‡∏ô‡∏≥‡πÇ‡∏ä‡∏Ñ",
          "desc": "‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ‡∏¢‡∏≤‡∏ß ‡∏™‡πÑ‡∏•‡∏°‡πå 4 ‡∏ï‡∏±‡∏ß",
          "recommended_level": 9,
          "require_energy": 5,
          "waves": [
            {
              "enemies": [
                { "id": "slime_basic", "level": 7 },
                { "id": "slime_basic", "level": 8 },
                { "id": "slime_basic", "level": 8 },
                { "id": "slime_basic", "level": 8 }
              ]
            }
          ],
          "drops": [
            { "id": "gold", "min": 90, "max": 125, "rate": 90 }
          ],
          "exp_reward": 59
        },
        {
          "id": "c1z3s3",
          "name": "‡πÄ‡∏ô‡∏¥‡∏ô‡πÄ‡∏Ç‡∏≤‡∏•‡∏±‡∏ö",
          "desc": "‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏Å‡∏£‡πà‡∏á, ‡∏™‡πÑ‡∏•‡∏°‡πå Lv.9",
          "recommended_level": 10,
          "require_energy": 6,
          "waves": [
            {
              "enemies": [
                { "id": "slime_basic", "level": 9 }
              ]
            }
          ],
          "drops": [
            { "id": "exp_potion", "min": 1, "max": 2, "rate": 33 }
          ],
          "exp_reward": 64
        },
        {
          "id": "c1z4s1",
          "name": "‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏≤‡∏á‡πÄ‡∏Ç‡πâ‡∏≤",
          "desc": "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡πâ‡∏≤‡∏ó‡∏≤‡∏¢‡∏ö‡∏≠‡∏™‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏±‡∏á",
          "recommended_level": 11,
          "require_energy": 7,
          "waves": [
            {
              "enemies": [
                { "id": "slime_basic", "level": 10 },
                { "id": "slime_basic", "level": 10 }
              ]
            }
          ],
          "drops": [
            { "id": "gold", "min": 120, "max": 160, "rate": 95 }
          ],
          "exp_reward": 69
        },
        {
          "id": "c1z4s2",
          "name": "‡∏ö‡πà‡∏≠‡πÄ‡∏ß‡∏ó‡∏¢‡πå‡∏°‡∏ô‡∏ï‡∏£‡πå",
          "desc": "‡∏ä‡∏∏‡∏î combo ‡∏®‡∏±‡∏ï‡∏£‡∏π Lv.11",
          "recommended_level": 12,
          "require_energy": 8,
          "waves": [
            {
              "enemies": [
                { "id": "slime_basic", "level": 11 },
                { "id": "slime_basic", "level": 11 },
                { "id": "slime_basic", "level": 10 }
              ]
            }
          ],
          "drops": [
            { "id": "exp_potion", "min": 1, "max": 3, "rate": 48 }
          ],
          "exp_reward": 74
        },
        {
          "id": "c1z4s3",
          "name": "‡∏™‡∏ô‡∏≤‡∏°‡∏ù‡∏∂‡∏Å‡∏¢‡∏±‡∏Å‡∏©‡πå",
          "desc": "‡∏î‡πà‡∏≤‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢ ‡∏ó‡πâ‡∏≤‡∏ó‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏ö‡∏ó‡∏ô‡∏µ‡πâ!",
          "recommended_level": 13,
          "require_energy": 10,
          "waves": [
            {
              "enemies": [
                { "id": "slime_basic", "level": 12 },
                { "id": "slime_basic", "level": 12 },
                { "id": "slime_basic", "level": 12 },
                { "id": "slime_basic", "level": 12 }
              ]
            }
          ],
          "drops": [
            { "id": "rune_shard", "min": 2, "max": 4, "rate": 40 }
          ],
          "exp_reward": 85
        }
      ]
    }
  ]
}

‡πÑ‡∏ü‡∏•‡πå js/chat.js
// js/chat.js

/*
  Epic Seven Card Auto Battle - Chat System
  - GM / Global / System / Player Chat
  - ‡πÄ‡∏Å‡πá‡∏ö chat.json + banned_words.json
  - Responsive, security filter, limited send rate
  - ‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö popup UI
  (C) 2024
*/

let chatList = [];     // [{user, text, time}, ...]
let bannedWords = [];  // ["badword1", ...]
let chatLastTime = 0;
const CHAT_LOG_MAX = 50;

// ‡πÇ‡∏´‡∏•‡∏î chat log (localStorage/data)
async function loadChat() {
  if (!chatList.length) {
    try {
      let arr = JSON.parse(localStorage.getItem('chat_log') || "[]");
      chatList = arr;
    } catch { chatList = []; }
  }
}
function saveChat() {
  let arr = chatList.slice(-CHAT_LOG_MAX); // keep recent
  localStorage.setItem('chat_log', JSON.stringify(arr));
}

// ‡πÇ‡∏´‡∏•‡∏î banned words
async function loadBannedWords() {
  if (!bannedWords.length) {
    try {
      let arr = await fetch('data/banned_words.json').then(r=>r.json());
      bannedWords = arr;
    } catch { bannedWords = []; }
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô render popup UI
async function openChatPopup() {
  await loadChat(); await loadBannedWords();
  renderChatListUI();

  let html = `
      <div style="max-height:300px;overflow-y:auto;" id="chatAreaList"></div>
      <div style="margin-top:1.0em;display:flex;gap:7px;">
        <input id="chatInputBox" maxlength="90" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..." style="flex:1;"/>
        <button class="primary-btn" onclick="sendChatMsg()">‡∏™‡πà‡∏á</button>
      </div>
      <div style="font-size:.86em;color:#cae;margin-top:.3em;">‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡∏∞ 1 ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πà‡∏≠ 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</div>
      <button class="secondary-btn" style="margin-top:9px;" onclick="closePopup()">‡∏õ‡∏¥‡∏î</button>
  `;
  window.openPopup('chat', html, 'tall', '‡πÅ‡∏ä‡∏ó Global');

  document.getElementById('chatInputBox').focus();
  setInterval(renderChatListUI, 4000); // refresh
}

// Render ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
function renderChatListUI() {
  let el = document.getElementById('chatAreaList');
  if (!el) return;
  let arr = chatList.slice(-CHAT_LOG_MAX);
  el.innerHTML = arr.map(c =>
   `<div style="display:flex;align-items:center;gap:7px;margin-bottom:2px;">
      <span style="color:#77f;font-weight:600;font-size:.98em;">[${formatChatTime(c.time)}] ${escapeHTML(c.user)}:</span>
      <span style="font-size:.97em;">${escapeHTML(c.text)}</span>
      ${c.system ? ` <span style="color:#ef7;font-size:.89em;">[System]</span>` : ""}
    </div>`).join('');
  el.scrollTop = el.scrollHeight;
}

// ‡∏ü‡∏≠‡∏£‡πå‡πÅ‡∏°‡∏ï‡πÄ‡∏ß‡∏•‡∏≤
function formatChatTime(ts) {
  let d = new Date(ts);
  return d.getHours().toString().padStart(2,"0")+":"+d.getMinutes().toString().padStart(2,"0");
}

// ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
window.sendChatMsg = function() {
  let box = document.getElementById('chatInputBox');
  if (!box) return;
  let txt = (box.value || "").trim();
  if (!txt) return;
  if (txt.length>90) return alert('‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô 90 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£');
  let now = Date.now();
  // Anti spam/rapid
  if (now - chatLastTime < 3000) { alert("‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠ 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°"); return; }
  chatLastTime = now;
  // ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠
  let username = localStorage.getItem('user_name') || 'Guest';
  // Filter banned
  let test = txt.toLowerCase();
  if (bannedWords.some(w => test.includes(w))) { alert("‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°!"); return; }
  // Safe HTML, not allow tags
  if (txt.match(/[<>]/)) { alert("‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï HTML"); return; }
  // Push log
  chatList.push({ user: username, text: txt, time: now, system: false });
  // ‡∏ï‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏Ñ‡πà 50 messages
  chatList = chatList.slice(-CHAT_LOG_MAX);
  saveChat();
  box.value = "";
  renderChatListUI();
}

// Add system message (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å battle/gacha)
window.addSystemChat = function(msg) {
  let now = Date.now();
  chatList.push({ user: "System", text: msg, time: now, system: true });
  chatList = chatList.slice(-CHAT_LOG_MAX);
  saveChat();
  renderChatListUI();
}

// Escape HTML
function escapeHTML(str) {
  return (str || "").replace(/[<>"']/g, c =>
    ({'<':'&lt;','>':'&gt;','&':'&amp;','"':'&quot;',"'":'&#39;'}[c]));
}

// Auto mount ‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏ä‡∏ó‡πÉ‡∏ô‡πÄ‡∏°‡∏ô‡∏π
document.addEventListener('DOMContentLoaded', () => {
  let btn = document.getElementById('btnChat');
  if (btn) btn.onclick = openChatPopup;
});

// Export
window.chatEngine = {
  open: openChatPopup,
  addSystem: window.addSystemChat,
  reloadWords: async()=>{bannedWords=[];await loadBannedWords();}
};

‡πÑ‡∏ü‡∏•‡πå data/chat.json
[
  {
    "user": "System",
    "text": "‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡πÅ‡∏ä‡∏ó Global!",
    "time": 1717214400000,
    "system": true
  }
]

‡πÑ‡∏ü‡∏•‡πå banned_words.json
[
  "‡πÄ‡∏´‡∏µ‡πâ‡∏¢","‡∏Ñ‡∏ß‡∏¢","‡∏™‡∏±‡∏™","fuck","shit","bitch","‡πÅ‡∏°‡πà‡∏á","‡∏™‡πâ‡∏ô‡∏ï‡∏µ‡∏ô"
]

‡πÑ‡∏ü‡∏•‡πå js/gachaLog.js
// js/gachaLog.js - Epic Seven Card System: Gacha Log ‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏ä‡∏≤

// Log: { user_id, time, gacha_id, char_id, rarity }
let gachaLogList = [];
let gachaLogLoaded = false;

// ‡πÇ‡∏´‡∏•‡∏î log ‡∏Å‡∏≤‡∏ä‡∏≤ (‡∏à‡∏≤‡∏Å localStorage ‡∏´‡∏£‡∏∑‡∏≠ data/gacha_log.json ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö admin)
async function loadGachaLog() {
    if (gachaLogLoaded) return;
    try {
        gachaLogList = JSON.parse(localStorage.getItem('gacha_log') || '[]');
    } catch { gachaLogList = []; }

    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô admin ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏∏‡∏Å log ‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå (read-only)
    if (window.isAdmin && window.isAdmin()) {
        try {
            let allLog = await fetch('data/gacha_log.json').then(r => r.json());
            gachaLogList = allLog.logs || [];
        } catch { /* skip if unavailable */ }
    }
    gachaLogLoaded = true;
}

// ‡πÄ‡∏ã‡∏ü log ‡∏•‡∏á localStorage ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (‡πÄ‡∏Å‡πá‡∏ö 200 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)
function saveGachaLog() {
    localStorage.setItem('gacha_log', JSON.stringify(gachaLogList));
}

// ‡πÄ‡∏û‡∏¥‡πà‡∏° log ‡πÉ‡∏´‡∏°‡πà (‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏™‡∏∏‡πà‡∏°)
window.addGachaLog = function({ user_id, gacha_id, char_id, rarity }) {
    const entry = {
        user_id: user_id || (localStorage.getItem('user_id') || 'guest'),
        gacha_id,
        char_id,
        rarity,
        time: Date.now()
    };
    gachaLogList.push(entry);
    gachaLogList = gachaLogList.slice(-200);
    saveGachaLog();
};

// ‡∏î‡∏π log ‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡∏≠‡∏á user ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
window.queryMyGachaLog = async function(limit = 50) {
    await loadGachaLog();
    const user_id = localStorage.getItem('user_id') || 'guest';
    return gachaLogList.filter(l => l.user_id === user_id).slice(-limit).reverse();
};

// (Admin) ‡∏î‡∏π log ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô
window.queryAllGachaLog = async function(limit = 1000) {
    await loadGachaLog();
    if (!window.isAdmin || !window.isAdmin()) {
        alert("‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏à‡∏∂‡∏á‡∏à‡∏∞‡∏î‡∏π log ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏î‡πâ");
        return [];
    }
    return gachaLogList.slice(-limit).reverse();
};

// Render Popup ‡πÅ‡∏™‡∏î‡∏á log ‡∏Å‡∏≤‡∏ä‡∏≤ user
window.openMyGachaLogPopup = async function() {
    const log = await window.queryMyGachaLog(60);
    let html = `
        <div style="font-size:1.14em;font-weight:bold;margin-bottom:7px;">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏ä‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
        <div style="max-height:340px;overflow-y:auto;">
        <table style="background:#1a2637;width:99%;border-radius:13px;">
        <tr style="color:#7dd;"><th>#</th><th>‡∏ß‡∏±‡∏ô/‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏Å‡∏≤‡∏ä‡∏≤</th><th>‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£</th><th>‚òÖ</th></tr>
        ${
            log.length ? 
            log.map((l, i) => `<tr>
                <td>${i+1}</td>
                <td>${(new Date(l.time)).toLocaleString()}</td>
                <td>${l.gacha_id}</td>
                <td>${l.char_id}</td>
                <td style="color:${l.rarity>=5?'gold':'#bee'};">‚òÖ${l.rarity}</td>
            </tr>`).join("") 
            : `<tr><td colspan="5" style="color:#faa;text-align:center;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏ä‡∏≤</td></tr>`
        }
        </table>
        </div>
        <div style="text-align:right;margin-top:13px;">
            <button class="secondary-btn" onclick="closePopup()">‡∏õ‡∏¥‡∏î</button>
        </div>
    `;
    window.openPopup('gachaLog', html, 'large', "‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏ä‡∏≤");
};

// (Admin) Render Log ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î popup
window.openAdminAllGachaLogPopup = async function() {
    const log = await window.queryAllGachaLog(500);
    let html = `
        <div style="font-size:1.14em;font-weight:bold;margin-bottom:7px;">[ADMIN] ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡πà‡∏°‡∏Å‡∏≤‡∏ä‡∏≤‡∏ó‡∏∏‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</div>
        <div style="max-height:370px;overflow-y:auto;">
        <table style="background:#19263a;width:99%;border-radius:8px;">
        <tr style="color:#7dd;"><th>#</th><th>‡∏ß‡∏±‡∏ô/‡πÄ‡∏ß‡∏•‡∏≤</th><th>User</th><th>‡∏Å‡∏≤‡∏ä‡∏≤</th><th>‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£</th><th>‚òÖ</th></tr>
        ${
            log.length ? 
            log.map((l, i) => `<tr>
                <td>${i+1}</td>
                <td>${(new Date(l.time)).toLocaleString()}</td>
                <td>${l.user_id}</td>
                <td>${l.gacha_id}</td>
                <td>${l.char_id}</td>
                <td style="color:${l.rarity>=5?'gold':'#bee'};">‚òÖ${l.rarity}</td>
            </tr>`).join("") 
            : `<tr><td colspan="6" style="color:#faa;">‡πÑ‡∏°‡πà‡∏°‡∏µ log</td></tr>`
        }
        </table>
        </div>
        <div style="text-align:right;margin-top:13px;">
            <button class="secondary-btn" onclick="closePopup()">‡∏õ‡∏¥‡∏î</button>
        </div>
    `;
    window.openPopup('allGachaLog', html, 'large', "Gacha Log (ADMIN)");
};

// Auto menu: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô admin panel ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏°‡∏ô‡∏π profile
document.addEventListener('DOMContentLoaded', ()=>{
    if (document.getElementById('btnGachaLog')) {
        document.getElementById('btnGachaLog').onclick = window.openMyGachaLogPopup;
    }
});

// Export ‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°
window.gachaLogEngine = {
    add: window.addGachaLog,
    mylog: window.queryMyGachaLog,
    all: window.queryAllGachaLog,
    open: window.openMyGachaLogPopup
};

‡πÑ‡∏ü‡∏•‡πå  data/gacha_log.json
{
  "logs": [
    {
      "user_id": "player1",
      "time": 1717228300000,
      "gacha_id": "premium_summon",
      "char_id": "astra",
      "rarity": 5
    },
    {
      "user_id": "player2",
      "time": 1717228400000,
      "gacha_id": "premium_summon",
      "char_id": "slime_basic",
      "rarity": 3
    }
  ]
}

‡πÑ‡∏ü‡∏•‡πå energy.js
// js/energy.js
//
// Epic Seven Card Battle - Energy (Stamina) System (Frontend only)
//
// ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö energy bar, ‡∏•‡∏î/‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏î‡∏±‡∏ô‡πÄ‡∏à‡∏µ‡πâ‡∏¢‡∏ô, ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï, ‡πÉ‡∏ä‡πâ item, ‡∏õ‡πá‡∏≠‡∏õ‡∏≠‡∏±‡∏õ ‡πÄ‡∏ï‡∏¥‡∏°/‡πÅ‡∏à‡πâ‡∏á‡∏´‡∏°‡∏î, ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
// ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ sync ‡∏Å‡∏±‡∏ö LocalStorage ‡∏´‡∏£‡∏∑‡∏≠ API/JSON ‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡πÑ‡∏î‡πâ

const DEFAULT_MAX_ENERGY = 45;     // cap ‡∏Ñ‡πà‡∏≤ default
const REGEN_INTERVAL_MIN = 12;     // 1 energy ‡∏ï‡πà‡∏≠‡∏Å‡∏µ‡πà‡∏ô‡∏≤‡∏ó‡∏µ? (12 ‡∏ô‡∏≤‡∏ó‡∏µ = 5/‡∏ä‡∏°)
const REGEN_AMOUNT    = 1;
const REGEN_TICK_MS   = 60 * 1000; // 1 ‡∏ô‡∏≤‡∏ó‡∏µ/loop (‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô 10 ‡∏ß‡∏¥/DEV ‡πÑ‡∏î‡πâ)
const ENERGY_ITEM_IDS = ['heal_potion']; // ‡πÉ‡∏ä‡πâ heal_potion ‡πÄ‡∏ï‡∏¥‡∏° energy ‡πÑ‡∏î‡πâ
let energy_config = { max: DEFAULT_MAX_ENERGY, regen_min: REGEN_INTERVAL_MIN };

// ===== 1. STATE =====
function getEnergy() {
    let e = Number(localStorage.getItem('user_energy'));
    if (isNaN(e)) e = energy_config.max;
    return e;
}

function setEnergy(val) {
    localStorage.setItem('user_energy', val);
    renderEnergyBar();
}

function getEnergyMax() {
    return energy_config.max || DEFAULT_MAX_ENERGY;
}

// ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏à‡∏ô‡πÄ‡∏ï‡∏¥‡∏° 1 energy ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (timestamp)
function getNextRegenTs() {
    let ts = Number(localStorage.getItem('energy_next_ts'));
    if (!ts) {
        ts = Date.now() + energy_config.regen_min * 60 * 1000;
        localStorage.setItem('energy_next_ts', ts);
    }
    return ts;
}

function setNextRegenTs(ts) {
    localStorage.setItem('energy_next_ts', ts);
}

// ===== 2. REGEN AUTO PER TIME (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏≠‡∏≠‡∏ô/‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏Å‡∏°) =====
function energyRegenTick() {
    let eNow = getEnergy();
    let eMax = getEnergyMax();
    if (eNow >= eMax) {
        setNextRegenTs(Date.now() + energy_config.regen_min * 60 * 1000);
        return;
    }
    let ts = getNextRegenTs();
    let now = Date.now();
    if (now >= ts) {
        setEnergy(Math.min(eMax, eNow + REGEN_AMOUNT));
        setNextRegenTs(now + energy_config.regen_min * 60 * 1000);
        renderEnergyBar();
    }
}

// ===== 3. Energy UI BAR (Footer, Header, ‡∏´‡∏£‡∏∑‡∏≠ Popup) =====
function renderEnergyBar() {
    let bar = document.getElementById('energyBarUI');
    if (!bar) {
        bar = document.createElement('div');
        bar.id = 'energyBarUI';
        Object.assign(bar.style, {
            position: 'fixed',
            left: '18px',
            top: '82px',
            zIndex: '50',
            background: '#211d27e8',
            color: '#c8f8fd',
            borderRadius: '12px',
            padding: '7px 16px 5px 16px',
            fontFamily: 'inherit',
            fontWeight: 'bold',
            boxShadow: '0 3px 19px #14effa24',
            fontSize: '1.08em',
            minWidth: '110px',
            userSelect: 'none',
            cursor: 'pointer'
        });
        document.body.appendChild(bar);
        bar.onclick = openEnergyDetailPopup;
    }
    let energy = getEnergy();
    let eMax = getEnergyMax();
    let ts = getNextRegenTs();
    let minLeft = Math.max(0, Math.ceil((ts - Date.now()) / 60000));
    bar.innerHTML = `<span style="color:#71eaff;font-size:1.23em;">‚ö° ENERGY</span> <span style="color:#fafd85;">${energy}</span>/<b>${eMax}</b><span style="font-size:.93em;color:#8ee;"> ${energy < eMax ? `(+1 ‡πÉ‡∏ô ${minLeft}‡∏ô‡∏≤‡∏ó‡∏µ)` : ''}</span>`;
}

// Popup ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
function openEnergyDetailPopup() {
    let energy = getEnergy();
    let max = getEnergyMax();
    let minLeft = Math.ceil((getNextRegenTs() - Date.now()) / 60000);
    let html = `
      <div style="padding:6px 11px;text-align:center;">
        <div style="font-size:1.1em;margin-bottom:8px;">‚ö° <b>‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô</b> (${energy} / ${max})</div>
        <div style="color:#bdf;">${energy < max ? `‡∏à‡∏∞‡∏ü‡∏∑‡πâ‡∏ô +1 energy ‡πÉ‡∏ô‡∏≠‡∏µ‡∏Å <b>${minLeft}</b> ‡∏ô‡∏≤‡∏ó‡∏µ` : '‡πÄ‡∏ï‡πá‡∏°‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß'}</div>
        <hr style="margin:12px 0;" />
        <button class="primary-btn" style="margin-bottom:6px;" onclick="refillEnergyWithItem()">‡πÉ‡∏ä‡πâ Heal Potion ‡πÄ‡∏û‡∏¥‡πà‡∏° Energy</button>
        <div style="font-size:.95em;color:#7cf;">Heal Potion = +15 Energy</div>
        <hr style="margin:12px 0;" />
        <button class="secondary-btn" onclick="closePopup()">‡∏õ‡∏¥‡∏î</button>
      </div>
    `;
    window.openPopup('energyDetail', html, 'small', '‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô Energy');
}

window.refillEnergyWithItem = function() {
    // ‡πÉ‡∏ä‡πâ‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏° (heal_potion) ‡πÉ‡∏ô inventory
    let inventory = window.inventoryEngine?.list() || [];
    let owned = inventory.find(i => ENERGY_ITEM_IDS.includes(i.id) && i.qty >= 1);
    if (!owned) {
        alert("‡πÑ‡∏°‡πà‡∏°‡∏µ Heal Potion ‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á");
        return;
    }
    let val = 15;
    let energy = getEnergy();
    let max = getEnergyMax();
    let after = Math.min(max, energy + val);
    setEnergy(after);
    window.inventoryEngine.remove(owned.id, 1);
    closePopup('energyDetail');
    setTimeout(() => renderEnergyBar(), 222);
    alert(`Energy +${after - energy}`);
};

// ===== 4. Energy ‡∏•‡∏î/‡πÄ‡∏û‡∏¥‡πà‡∏° ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏î‡∏±‡∏ô‡πÄ‡∏à‡∏µ‡πâ‡∏¢‡∏ô/‡∏≠‡∏∑‡πà‡∏ô‡πÜ =====
window.addEnergy = function(val) {
    let e = Math.min(getEnergyMax(), getEnergy() + val);
    setEnergy(e);
    renderEnergyBar();
};
window.reduceEnergy = function(val) {
    let e = Math.max(0, getEnergy() - val);
    setEnergy(e);
    renderEnergyBar();
};

// ===== 5. INIT (DOMContentLoaded) =====
document.addEventListener('DOMContentLoaded', () => {
    // ‡πÇ‡∏´‡∏•‡∏î config
    fetch('data/energy.json').then(r => r.json()).then(cfg => {
        if (cfg?.max) energy_config.max = cfg.max;
        if (cfg?.regen_min) energy_config.regen_min = cfg.regen_min;
    }).catch(() => {});

    // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ energy ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏ï‡πá‡∏°
    if (!localStorage.getItem('user_energy')) setEnergy(energy_config.max);
    // ‡∏ï‡∏¥‡∏î energy bar UI
    setTimeout(() => renderEnergyBar(), 350);

    // Loop regen ‡∏ó‡∏∏‡∏Å REGEN_TICK_MS
    setInterval(energyRegenTick, REGEN_TICK_MS);

    // ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πà‡∏ô‡∏î‡∏±‡∏ô‡πÄ‡∏à‡∏µ‡πâ‡∏¢‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å
    window.renderEnergyBar = renderEnergyBar;
    window.openEnergyDetailPopup = openEnergyDetailPopup;
});

// ===== 6. Export API ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏∑‡πà‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÉ‡∏ä‡πâ =====
window.energyEngine = {
    get: getEnergy,
    set: setEnergy,
    max: getEnergyMax,
    add: window.addEnergy,
    reduce: window.reduceEnergy,
    render: renderEnergyBar,
    openDetail: openEnergyDetailPopup,
    config: energy_config,
};

‡πÑ‡∏ü‡∏•‡πå data/energy.json
{
  "max": 45,
  "regen_min": 12 
}

‡πÑ‡∏ü‡∏•‡πå data/config.json
{
  "battle": {
    "spd_bar_max": 100,
    "spd_frame": 120,
    "max_team": 4,
    "max_monster": 4,
    "show_crit_popup": true,
    "ani_slide_duration": 350
  },
  "exp": {
    "base_win": 60,
    "base_lose": 18,
    "exp_up_event": 1.0
  },
  "drop": {
    "exp_potion_rate": 55,
    "rune_shard_rate": 22,
    "gold_rate": 80
  },
  "stat_curve": {
    "hero_hp": 1.085,
    "hero_atk": 1.08,
    "hero_def": 1.09
  },
  "energy": {
    "max": 45,
    "regen_min": 12
  },
  "cooldown": {
    "base_cd_reduce": 1,
    "cd_reset_by_item": true
  },
  "limit": {
    "max_inventory": 999,
    "max_char_collection": 50,
    "max_party": 4
  },
  "gacha": {
    "pity_enabled": true,
    "pity_count": 20,
    "gacha_log_limit": 150
  },
  "file_version": "1.0.0",
  "update": "2024-06-07"
}

‡πÑ‡∏ü‡∏•‡πå js/localization.js
// js/localization.js
/**
 * Localization System (Epic Seven Card Battle)
 * - Auto-detect, allow manual switch
 * - All string must use key, ex: t("menu.team")
 * - Work with all modular code, async/dynamic
 * (c) 2024
 */

let langData = {};       // Object of all text key:value
let langList = ['th', 'en']; // So far - more add as needed
let currentLang = 'th';  // Default: Thai

// Load language data from /data/lang/*.json
async function loadLang(lang) {
    if (!langList.includes(lang)) lang = 'en';
    currentLang = lang;
    langData = {};
    try {
        langData = await fetch(`data/lang/${lang}.json`).then(r => r.json());
        localStorage.setItem('user_lang', lang);
    } catch {
        langData = {};
    }
    applyLanguageToUI();
}

// Localizer function t(key) | lang(key)
function t(key, args = {}) {
    let keys = key.split('.');
    let val = langData;
    for (let k of keys) {
        val = (val || {})[k];
        if (!val) break;
    }
    if (!val) return key;
    // Replace {xxx} in text by args.xxx
    if (typeof val === 'string') {
        return val.replace(/{(\w+)}/g, (a, b) => args[b] || '');
    }
    return val;
}

// Apply language to all .trans-key UI (with data-trans="key")
function applyLanguageToUI() {
    document.querySelectorAll('[data-trans]').forEach(el => {
        el.innerHTML = t(el.getAttribute('data-trans'));
    });
}

// Add lang switcher menu/button in your UI
function renderLangMenu(containerId = "langMenu") {
    let html = `<select id="langSel" style="padding:.4em 1.4em;font-size:1em;">` +
        langList.map(code => `<option value="${code}" ${code === currentLang ? "selected" : ""}>${langName(code)}</option>`).join('') +
        `</select>`;
    (document.getElementById(containerId) || document.body).innerHTML = html;
    setTimeout(() => {
        document.getElementById('langSel').onchange = e => {
            loadLang(e.target.value);
            applyLanguageToUI();
        };
    }, 1);
}

function langName(code) {
    return {
        en: 'English',
        th: '‡πÑ‡∏ó‡∏¢',
        ja: 'Êó•Êú¨Ë™û'
    }[code] || code.toUpperCase();
}

// On startup: load language (from localStorage or browser)
document.addEventListener('DOMContentLoaded', () => {
    let userLang = localStorage.getItem('user_lang') || navigator.language.substr(0,2) || 'th';
    if (!langList.includes(userLang)) userLang = 'th';
    loadLang(userLang);
    // Optional: render switcher menu somewhere (ex: footer)
    if (document.getElementById('footerLangMenu')) renderLangMenu('footerLangMenu');
});

// Expose for modules
window.t = t;
window.lang = t;
window.selectLang = loadLang;
window.applyLanguageToUI = applyLanguageToUI;
window.renderLangMenu = renderLangMenu;

‡πÑ‡∏ü‡∏•‡πå data/lang/en.json
{
  "menu": {
    "team": "Team Setup",
    "battle": "Battle",
    "inventory": "Inventory",
    "quest": "Quest",
    "shop": "Shop",
    "gacha": "Gacha",
    "character": "Characters",
    "announcement": "Announcement",
    "chat": "Chat",
    "login": "Login",
    "logout": "Logout"
  },
  "popup": {
    "ok": "OK",
    "cancel": "Cancel",
    "close": "Close",
    "confirm": "Confirm",
    "use_item": "Use Item",
    "upgrade": "Upgrade",
    "equip": "Equip",
    "result_win": "Victory!",
    "result_lose": "Defeat"
  },
  "battle": {
    "auto": "Auto",
    "start": "Start Battle",
    "back": "Back",
    "hp": "HP",
    "atk": "ATK",
    "def": "DEF",
    "spd": "SPD",
    "crit": "Crit",
    "exp_gain": "EXP gained",
    "drop_items": "Drop Items"
  },
  "inventory": {
    "title": "Inventory",
    "use": "Use",
    "no_item": "No items"
  },
  "character": {
    "title": "Character Box",
    "lock": "Lock",
    "unlock": "Unlock",
    "upgrade": "Upgrade"
  },
  "gacha": {
    "draw1": "Draw 1",
    "draw10": "Draw 10",
    "result": "Gacha Result"
  },
  "energy": {
    "energy": "Energy",
    "full": "Full",
    "refill": "Refill",
    "next": "in {min} min"
  },
  "admin": {
    "panel": "Admin Panel",
    "user": "User",
    "item": "Item",
    "quest": "Quest",
    "gacha": "Gacha",
    "shop": "Shop"
  }
}

‡πÑ‡∏ü‡∏•‡πå data/lang/th.json
{
  "menu": {
    "team": "‡∏à‡∏±‡∏î‡∏ó‡∏µ‡∏°",
    "battle": "‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ",
    "inventory": "‡∏Ñ‡∏•‡∏±‡∏á‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°",
    "quest": "‡πÄ‡∏Ñ‡∏ß‡∏™‡∏ï‡πå",
    "shop": "‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤",
    "gacha": "‡∏Å‡∏≤‡∏ä‡∏≤",
    "character": "‡∏Ñ‡∏•‡∏±‡∏á‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£",
    "announcement": "‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®",
    "chat": "‡πÅ‡∏ä‡∏ó",
    "login": "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö",
    "logout": "‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö"
  },
  "popup": {
    "ok": "‡∏ï‡∏Å‡∏•‡∏á",
    "cancel": "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å",
    "close": "‡∏õ‡∏¥‡∏î",
    "confirm": "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô",
    "use_item": "‡πÉ‡∏ä‡πâ‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°",
    "upgrade": "‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î",
    "equip": "‡πÉ‡∏™‡πà‡∏£‡∏π‡∏ô",
    "result_win": "‡∏ä‡∏±‡∏¢‡∏ä‡∏ô‡∏∞!",
    "result_lose": "‡πÅ‡∏û‡πâ"
  },
  "battle": {
    "auto": "‡∏≠‡∏≠‡πÇ‡∏ï‡πâ",
    "start": "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏π‡πâ",
    "back": "‡∏Å‡∏•‡∏±‡∏ö",
    "hp": "HP",
    "atk": "‡πÇ‡∏à‡∏°‡∏ï‡∏µ",
    "def": "‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô",
    "spd": "‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß",
    "crit": "‡∏Ñ‡∏£‡∏¥",
    "exp_gain": "‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö EXP",
    "drop_items": "‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö"
  },
  "inventory": {
    "title": "‡∏Ñ‡∏•‡∏±‡∏á‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°",
    "use": "‡πÉ‡∏ä‡πâ",
    "no_item": "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°"
  },
  "character": {
    "title": "‡∏Ñ‡∏•‡∏±‡∏á‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£",
    "lock": "‡∏•‡πá‡∏≠‡∏Å",
    "unlock": "‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å",
    "upgrade": "‡∏≠‡∏±‡∏õ‡πÄ‡∏Å‡∏£‡∏î"
  },
  "gacha": {
    "draw1": "‡∏™‡∏∏‡πà‡∏° 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á",
    "draw10": "‡∏™‡∏∏‡πà‡∏° 10 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á",
    "result": "‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏ä‡∏≤"
  },
  "energy": {
    "energy": "‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô",
    "full": "‡πÄ‡∏ï‡πá‡∏°",
    "refill": "‡πÄ‡∏ï‡∏¥‡∏°‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô",
    "next": "‡∏≠‡∏µ‡∏Å {min} ‡∏ô‡∏≤‡∏ó‡∏µ"
  },
  "admin": {
    "panel": "Admin Panel",
    "user": "‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ",
    "item": "‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°",
    "quest": "‡πÄ‡∏Ñ‡∏ß‡∏™‡∏ï‡πå",
    "gacha": "‡∏Å‡∏≤‡∏ä‡∏≤",
    "shop": "‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤"
  }
}

‡∏ä‡πà‡∏ß‡∏¢‡∏£‡∏∑‡πâ‡∏≠‡πÑ‡∏ü‡∏•‡πå index.html ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà ‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏≠‡∏¢‡∏≤‡∏Å‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏•‡πä‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏ö‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏Å‡πà‡∏≠‡∏ô ‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πä‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°‡πÑ‡∏î‡πâ ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏à‡∏∏‡∏î‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Ç‡∏±‡∏î‡∏Å‡∏±‡∏ô ‡πÅ‡∏Å‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏Ç‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏â‡∏ö‡∏±‡∏ö‡πÄ‡∏ï‡πá‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
‡∏´‡πâ‡∏≤‡∏°‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏à‡∏∏‡∏î‡πÄ‡∏ä‡∏∑‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏∑‡πà‡∏ô‡πÜ‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏î‡∏ö‡∏±‡∏Ñ‡πÉ‡∏´‡∏°‡πà